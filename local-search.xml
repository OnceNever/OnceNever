<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Ollamaå®‰è£…é…ç½®ä¸ä½¿ç”¨</title>
    <link href="/2024/05/30/Ollama%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E4%B8%8E%E4%BD%BF%E7%94%A8/"/>
    <url>/2024/05/30/Ollama%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E4%B8%8E%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h3 id="åºè¨€"><a href="#åºè¨€" class="headerlink" title="åºè¨€"></a>åºè¨€</h3><p><strong>Ollama</strong>æ˜¯ä¸€ä¸ªå¿«é€Ÿåœ¨æœ¬åœ°å¯åŠ¨å¹¶è¿è¡Œå¤§å‹è¯­è¨€æ¨¡å‹çš„è„šæ‰‹æ¶ï¼Œæ—¨åœ¨ç®€åŒ–å¤§å‹è¯­è¨€æ¨¡å‹æœ¬åœ°éƒ¨ç½²å’Œè¿è¡Œçš„å·¥å…·ã€‚</p><p>å®˜ç½‘ï¼š<a href="https://ollama.com/">ollama.com</a></p><p>Githubï¼š<a href="https://github.com/ollama/ollama">ollama</a></p><h3 id="å¿«é€Ÿå¼€å§‹"><a href="#å¿«é€Ÿå¼€å§‹" class="headerlink" title="å¿«é€Ÿå¼€å§‹"></a>å¿«é€Ÿå¼€å§‹</h3><h4 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h4><p>ä»¥<em>Linux</em>ä¸ºä¾‹ï¼Œ<em>ollama</em>æä¾›äº†åœ¨çº¿å’Œç¦»çº¿å®‰è£…ä¸¤ç§æ–¹å¼ã€‚ç”±äºæœ¬äººæ²¡æœ‰<code>GPU</code>èµ„æºï¼Œ<em>ollama</em>é»˜è®¤å°†æ¨¡å‹è¿è¡Œåœ¨<code>CPU</code>ä¸Šã€‚</p><h5 id="åœ¨çº¿å®‰è£…"><a href="#åœ¨çº¿å®‰è£…" class="headerlink" title="åœ¨çº¿å®‰è£…"></a>åœ¨çº¿å®‰è£…</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">curl -fsSL https://ollama.com/install.sh | sh<br></code></pre></td></tr></table></figure><h5 id="ç¦»çº¿å®‰è£…"><a href="#ç¦»çº¿å®‰è£…" class="headerlink" title="ç¦»çº¿å®‰è£…"></a>ç¦»çº¿å®‰è£…</h5><ol><li><p>ä¸‹è½½<em>ollama</em>äºŒè¿›åˆ¶æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo curl -L https://ollama.com/download/ollama-linux-amd64 -o /usr/bin/ollama<br>sudo chmod +x /usr/bin/ollama<br></code></pre></td></tr></table></figure></li><li><p>å°†<em>ollama</em>ä½œä¸ºå¯åŠ¨æœåŠ¡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo useradd -r -s /bin/false -m -d /usr/share/ollama ollama<br></code></pre></td></tr></table></figure><p>åœ¨<code>/etc/systemd/system/ollama.service</code>åˆ›å»ºå¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">[Unit]</span><br><span class="hljs-attr">Description</span>=<span class="hljs-string">Ollama Service</span><br><span class="hljs-attr">After</span>=<span class="hljs-string">network-online.target</span><br><br><span class="hljs-attr">[Service]</span><br><span class="hljs-comment">## Environment=â€œOLLAMA_HOST=0.0.0.0:11434â€ ## å¼€å¯è¿™è¡Œé…ç½®å…è®¸è¿œç¨‹è®¿é—®</span><br><span class="hljs-attr">ExecStart</span>=<span class="hljs-string">/usr/bin/ollama serve</span><br><span class="hljs-attr">User</span>=<span class="hljs-string">ollama</span><br><span class="hljs-attr">Group</span>=<span class="hljs-string">ollama</span><br><span class="hljs-attr">Restart</span>=<span class="hljs-string">always</span><br><span class="hljs-attr">RestartSec</span>=<span class="hljs-string">3</span><br><br><span class="hljs-attr">[Install]</span><br><span class="hljs-attr">WantedBy</span>=<span class="hljs-string">default.target</span><br></code></pre></td></tr></table></figure></li><li><p>å¯åŠ¨æœåŠ¡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo systemctl daemon-reload<br>sudo systemctl enable ollama<br></code></pre></td></tr></table></figure></li></ol><h4 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h4><p>æˆ‘ä»¬å¯ä»¥åˆ°å®˜ç½‘çš„<a href="https://ollama.com/library">æ¨¡å‹åº“</a>ä¸­æŸ¥çœ‹å¯ç”¨çš„æ¨¡å‹ï¼Œ<code>llama3</code>æ˜¯ç›®å‰æ¯”è¾ƒå—æ¬¢è¿çš„å¼€æºæ¨¡å‹ä¹‹ä¸€ï¼Œä½†ç”±äºå…¶ç”¨äºè®­ç»ƒçš„ä¸­æ–‡è¯­æ–™è¾ƒå°‘ï¼Œå¯¹ä¸­æ–‡çš„æ”¯æŒä¸å¤Ÿå‹å¥½ï¼ˆè¯´ç€è¯´ç€å˜æˆè‹±æ–‡ï¼‰ï¼Œæ‰€ä»¥æˆ‘è¿™è¾¹é€‰äº†ä¸€ä¸ªä¸­æ–‡å¾®è°ƒåçš„<code>llama3</code><a href="https://ollama.com/wangshenzhi/llama3-8b-chinese-chat-ollama-q4">æ¨¡å‹</a>ã€‚</p><p>ç›´æ¥æ‰§è¡Œ<code>ollama run wangshenzhi/llama3-8b-chinese-chat-ollama-q4</code>ï¼Œå¦‚æœæ¨¡å‹ä¸å­˜åœ¨ä¼šè‡ªåŠ¨æ‹‰å–å¹¶å¯åŠ¨ï¼š</p><p><img src="https://image.seeyourface.cn/2024/05/image-20240530112629454.png" alt="image-20240530112629454"></p><p>å°±æ˜¯å¦‚æ­¤ç®€å•ï¼Œæˆ‘ä»¬å°±å·²ç»åœ¨æœ¬åœ°éƒ¨ç½²å¥½äº†ä¸€ä¸ªå¤§è¯­è¨€æ¨¡å‹ï¼</p><p>è¯•ç€å’Œå®ƒèŠèŠå§ï¼</p><p><img src="https://image.seeyourface.cn/2024/05/image-20240530113113026.png" alt="image-20240530113113026"></p><p>ä¸ä»…å¦‚æ­¤ï¼Œ<em>ollama</em>è¿˜æä¾›äº†ä¸°å¯Œçš„<em>API</em>ä¾›æˆ‘ä»¬ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š</p><p><img src="https://image.seeyourface.cn/2024/05/image-20240530113455240.png" alt="image-20240530113455240"></p><p>é»˜è®¤æ˜¯æµå¼è¿”å›ï¼Œä¹Ÿæä¾›äº†å¤šä¸ªå‚æ•°ä¾›æˆ‘ä»¬é€‰æ‹©ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p><p><img src="https://image.seeyourface.cn/2024/05/image-20240530113711563.png" alt="image-20240530113711563"></p><p>æ­é…*<a href="https://github.com/open-webui/open-webui">open-webui</a>*å¯ä»¥å®ç°ç±»ä¼¼<code>ChatGpt</code>å®˜ç½‘é¡µé¢çš„æ ·å¼ï¼Œä½¿ç”¨<code>docker</code>ä¸€é”®éƒ¨ç½²å°±å¥½ï¼Œä¸è¯¦ç»†è¯´æ˜ã€‚</p><p>webé¡µé¢ï¼š</p><p><img src="https://image.seeyourface.cn/2024/05/image-20240530114219449.png" alt="image-20240530114219449"></p><h4 id="å¾®è°ƒæ¨¡å‹"><a href="#å¾®è°ƒæ¨¡å‹" class="headerlink" title="å¾®è°ƒæ¨¡å‹"></a>å¾®è°ƒæ¨¡å‹</h4><p>åœ¨æ¨¡å‹æ¨ç†çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å‘ç°ä½¿ç”¨CPUè¿›è¡Œæ¨ç†æ—¶æ— æ³•è·‘æ»¡æœºå™¨ä¸Šçš„æ‰€æœ‰é€»è¾‘æ ¸å¿ƒï¼ˆåªä½¿ç”¨ä¸€åŠçš„é€»è¾‘æ ¸å¿ƒï¼‰ï¼ŒæŸ¥é˜…é¡¹ç›®<a href="https://github.com/ollama/ollama/issues/2929">issue</a>å¾—çŸ¥æœ‰äººé‡åˆ°å’Œæˆ‘ä¸€æ ·çš„é—®é¢˜ã€‚</p><p><img src="https://image.seeyourface.cn/2024/05/image-20240530115117395.png" alt="image-20240530115117395"></p><p>ä¾‹å¦‚æˆ‘çš„æœºå™¨æ˜¯8ä¸ªç‰©ç†æ ¸å¿ƒ16ä¸ªé€»è¾‘æ ¸å¿ƒï¼Œæ¨ç†æ—¶æ— è®ºå¦‚ä½•ä¹Ÿä¸ä¼šä½¿ç”¨è¶…è¿‡å…«ä¸ªæ ¸å¿ƒã€‚</p><p>å°½ç®¡è®©ç¨‹åºå ç”¨æ‰€æœ‰çš„æ ¸å¿ƒå¯èƒ½ä¼šå¯¼è‡´æŠ–åŠ¨å’Œæ€§èƒ½ä¸‹é™ï¼Œä½†æœ‰æ—¶å€™å°±æ˜¯å¦‚æ­¤ä»»æ€§ï¼šï¼‰</p><p><em>ollama</em>æœ‰ä¸€ä¸ª<code>num_thread</code>å‚æ•°ç”¨äºè®¾ç½®æ¨ç†çº¿ç¨‹æ•°ã€‚</p><p>ä¸€ç§å¯è¡Œæ–¹å¼æ˜¯åœ¨<strong>å‘½ä»¤è¡Œ</strong>ä¸­é€šè¿‡<code>SET</code>æŒ‡ä»¤ï¼Œæ˜¾ç¤ºè®¾ç½®æ¨ç†çº¿ç¨‹æ•°é‡ï¼š</p><p><img src="https://image.seeyourface.cn/2024/05/image-20240530120156018.png" alt="image-20240530120156018"></p><p>å†æ¬¡æ¨ç†ï¼Œå°±èƒ½çœ‹åˆ°è·‘æ»¡æ‰€æœ‰æ ¸å¿ƒï¼š</p><p><img src="https://image.seeyourface.cn/2024/05/image-20240530120330218.png" alt="image-20240530120330218"></p><p>ä½†æ˜¯ï¼Œè¿™ç§æ–¹å¼æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œåªåœ¨å‘½ä»¤è¡Œä¸­æœ‰ç”¨ï¼Œåªè¦é‡è·‘æˆ–è€…é€šè¿‡<em>API</em>è°ƒç”¨çš„æ–¹å¼å‚æ•°æ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ã€‚</p><p>ä¸€ç§æ›´å¥½çš„æ–¹å¼æ˜¯åœ¨æ„å»ºæ¨¡å‹æ—¶ï¼Œå°†<code>num_thread</code>å‚æ•°å½“ä½œä¸€éƒ¨åˆ†å†…å®¹ä¼ å…¥ï¼Œå¦‚æ­¤ä¸€æ¥æ„å»ºå‡ºæ¥çš„æ¨¡å‹å°±é»˜è®¤ä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ•°æ¨ç†ã€‚</p><p>å½“ç„¶ï¼Œæˆ‘ä»¬åœ¨æ„å»ºæ¨¡å‹æ—¶å¯é€‰æ‹©çš„å‚æ•°è¿˜æœ‰å¾ˆå¤šã€‚</p><h5 id="Modelfile"><a href="#Modelfile" class="headerlink" title="Modelfile"></a>Modelfile</h5><p>é€šè¿‡<code>Modelfile</code>æ¥æ„å»ºæ–°çš„æ¨¡å‹ã€‚</p><p>ä¸€ä¸ªå¯èƒ½çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-keyword">FROM</span> llama3<br><span class="hljs-comment"># sets the temperature to 1 [higher is more creative, lower is more coherent]</span><br>PARAMETER temperature 1<br><span class="hljs-comment"># sets the context window size to 4096, this controls how many tokens the LLM can use as context to generate the next token</span><br>PARAMETER num_ctx 4096<br><br><span class="hljs-comment"># sets a custom system message to specify the behavior of the chat assistant</span><span class="hljs-built_in"></span><br><span class="hljs-built_in">SYSTEM </span>You are Mario <span class="hljs-keyword">from</span> super mario bros, acting as an assistant.<br></code></pre></td></tr></table></figure><p>å¦‚æœä½ åªæƒ³åœ¨ä¸€ä¸ªå·²æœ‰çš„æ¨¡å‹ä¸Šç¨ä½œä¿®æ”¹ï¼Œå¯ä»¥ä½¿ç”¨<code>ollama show [modelName] --modelfile</code>æ¥æŸ¥çœ‹æŒ‡å®šæ¨¡å‹çš„<code>Modelfile</code></p><p><img src="https://image.seeyourface.cn/2024/05/image-20240530141209313.png" alt="image-20240530141209313"></p><p>ç„¶åå°†è¿™ä»½æ–‡ä»¶å†…å®¹å¤åˆ¶å‡ºæ¥ï¼ŒåŠ å…¥è‡ªå·±çš„ä¸€äº›å‚æ•°æˆ–è€…å¯¹å…¶ä¸­ä¸€äº›å‚æ•°åšé€‚å½“è°ƒæ•´ï¼Œå…·ä½“å‚æ•°åˆ—è¡¨å¯ä»¥å‚è€ƒ<a href="https://github.com/ollama/ollama/blob/main/docs/modelfile.md#valid-parameters-and-values">Valid Parameters and Values</a></p><p>ä¸ºäº†æµ‹è¯•æˆ‘ç®€å•åšäº†ä»¥ä¸‹è°ƒæ•´ï¼šæ–°å¢äº†<code>num_thread</code>å‚æ•°å¹¶ä¸”ä¿®æ”¹äº†SYSTEMéƒ¨åˆ†å†…å®¹ã€‚</p><p><img src="https://image.seeyourface.cn/2024/05/image-20240530142706131.png" alt="image-20240530142706131"></p><p>æ‰§è¡Œ <code>ollama create [guide-assistant] -f Modelfile</code> åˆ›å»ºæ–°æ¨¡å‹</p><p><img src="https://image.seeyourface.cn/2024/05/image-20240530143125333.png" alt="image-20240530143125333"></p><p>å¯åŠ¨æ¨¡å‹ï¼Œå¹¶æ‰§è¡Œæ¨ç†ä»»åŠ¡ï¼š</p><p><img src="https://image.seeyourface.cn/2024/05/image-20240530143417344.png" alt="image-20240530143417344"></p><p>å³ä½¿æ²¡æœ‰æ‰‹åŠ¨è®¾ç½®<code>num_thread</code>ï¼Œä¹Ÿæ˜¯è·‘æ»¡äº†16ä¸ªCPUæ ¸å¿ƒï¼š</p><p><img src="https://image.seeyourface.cn/2024/05/image-20240530143350868.png" alt="image-20240530143350868"></p><h5 id="å‘å¸ƒæ¨¡å‹"><a href="#å‘å¸ƒæ¨¡å‹" class="headerlink" title="å‘å¸ƒæ¨¡å‹"></a>å‘å¸ƒæ¨¡å‹</h5><p>éœ€è¦åœ¨<em>ollama</em>å®˜ç½‘ä¸Šæ³¨å†Œè´¦å·ï¼Œæ‰§è¡Œ<code>cat /usr/share/ollama/.ollama/id_ed25519.pub</code>å‘½ä»¤è·å–å…¬é’¥ã€‚</p><p>ä¹‹åå°†è·å–åˆ°çš„å…¬é’¥å¤åˆ¶ç²˜è´´åˆ°ä¸‹é¢çº¢æ¡†å†…ï¼š</p><p><img src="https://image.seeyourface.cn/2024/05/image-20240530143840189.png" alt="image-20240530143840189"></p><p>å°†æ¨¡å‹å¤åˆ¶åˆ°ä½ çš„ç”¨æˆ·åçš„å‘½åç©ºé—´ <code>ollama cp &#123;modelName&#125; &#123;ollama account&#125;/&#123;modelName&#125;</code></p><p>ç„¶åæ¨é€æ¨¡å‹<code>ollama push seeyourface/guide-assistant</code></p><p>ç„¶åå°±ç­‰æ¨é€å®Œæ¯•ï¼Œå°±å¯ä»¥åœ¨æˆ‘ä»¬åˆšæ‰æ³¨å†Œçš„è´¦å·ä¸‹çœ‹åˆ°è‡ªå·±å‘å¸ƒçš„æ¨¡å‹ã€‚</p><h3 id="ä¸€é”®å®‰è£…ollamaä¸æŒ‡å®šæ¨¡å‹"><a href="#ä¸€é”®å®‰è£…ollamaä¸æŒ‡å®šæ¨¡å‹" class="headerlink" title="ä¸€é”®å®‰è£…ollamaä¸æŒ‡å®šæ¨¡å‹"></a>ä¸€é”®å®‰è£…ollamaä¸æŒ‡å®šæ¨¡å‹</h3><p>å°½ç®¡<em>ollama</em>å·²ç»ååˆ†æ–¹ä¾¿ï¼Œä½†ä»ç„¶éœ€è¦æˆ‘ä»¬å»æ‰‹åŠ¨æ‹‰å–æ¨¡å‹ï¼Œæœ‰æ²¡æœ‰ä¸€ç§æ–¹å¼å¯ä»¥ä¸€é”®å®‰è£…<em>ollama</em>ç„¶ååŒæ—¶éƒ¨ç½²æŒ‡å®šçš„æ¨¡å‹ã€‚</p><p>å› ä¸º<em>ollama</em> **æš‚æ—¶ä¸æ”¯æŒ *<em>å°†æ¨¡å‹æ¨é€åˆ°ç§æœ‰ä»“åº“ï¼Œè€ƒè™‘åˆ°æœ‰äº›äººæˆ–è€…è¢«è¦æ±‚ä¸å…è®¸è®¿é—®å¢ƒå¤–ç½‘ç»œï¼Œæ‰€ä»¥å°±æ— æ³•é€šè¿‡ç›´æ¥æ‹‰å–</em>ollama*æ¨¡å‹ä»“åº“çš„æ–¹å¼æ¥åšã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†æ¨¡å‹æ–‡ä»¶å¯¼å‡ºçš„æ–¹å¼ï¼Œç„¶åå®‰è£…å®Œæˆ<em>ollama</em>åä»¥é‡æ–°åˆ›å»ºæ¨¡å‹çš„æ–¹å¼è¿˜åŸæ¨¡å‹ã€‚</p><p>æˆ‘æ˜¯é€šè¿‡<code>docker-compose</code>çš„æ–¹å¼æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ï¼š</p><h4 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h4><p>æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://image.seeyourface.cn/2024/05/image-20240530150803918.png" alt="image-20240530150803918"></p><ul><li><p>Dockerfileï¼šdocker-composeè¿è¡Œæ—¶æ„å»ºå®¹å™¨æ–‡ä»¶</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> ollama/ollama <span class="hljs-comment">##åŸºç¡€é•œåƒå¯ä»¥ä¿®æ”¹ä¸ºè‡ªå·±ç§æœ‰ä»“åº“ä¸­çš„é•œåƒï¼Œæˆ–è€…å¯ä»¥ç›´æ¥ä½¿ç”¨dockerå®˜æ–¹æä¾›çš„ollama/ollama</span><br><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./run_ollama.sh /tmp/run_ollama.sh</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./Modelfile /tmp/Modelfile</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./sha256-242ac8dd3eabcb1e5fcd3d78912eaf904f08bb6ecfed8bac9ac9a0b7a837fcb8 /tmp/sha256-242ac8dd3eabcb1e5fcd3d78912eaf904f08bb6ecfed8bac9ac9a0b7a837fcb8</span><br><br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /tmp</span><br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chmod</span> +x run_ollama.sh</span><br><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8000</span><br></code></pre></td></tr></table></figure></li><li><p>docker-composeï¼šå¯åŠ¨æ–‡ä»¶</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">version</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&#x27;3.5&#x27;</span><br><br><span class="hljs-attribute">services</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">ollama</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">build</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-attribute">context</span><span class="hljs-punctuation">:</span> <span class="hljs-string">.</span><br>      <span class="hljs-attribute">dockerfile</span><span class="hljs-punctuation">:</span> <span class="hljs-string">./Dockerfile</span><br>    <span class="hljs-attribute">image</span><span class="hljs-punctuation">:</span> <span class="hljs-string">ollama</span><br>    <span class="hljs-attribute">container_name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">ollama</span><br>    <span class="hljs-attribute">entrypoint</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/tmp/run_ollama.sh</span><br>    <span class="hljs-attribute">ports</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">8000:8000</span><br>    <span class="hljs-attribute">environment</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">OLLAMA_HOST=0.0.0.0:8000</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">OLLAMA_MODELS=/data/models</span><br>    <span class="hljs-attribute">volumes</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/data/models/:/data/models</span><br>    <span class="hljs-attribute">pull_policy</span><span class="hljs-punctuation">:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attribute">tty</span><span class="hljs-punctuation">:</span> <span class="hljs-string">true</span><br>    <span class="hljs-attribute">restart</span><span class="hljs-punctuation">:</span> <span class="hljs-string">always</span><br></code></pre></td></tr></table></figure></li><li><p>Modelfileï¼šæ¨¡å‹æ„å»ºæ–‡ä»¶</p></li><li><p>sha256-xxxï¼šæ¨¡å‹æ–‡ä»¶</p></li><li><p>run_ollama.shï¼šå¯åŠ¨å‘½ä»¤è„šæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Starting Ollama server...&quot;</span><br>ollama serve<br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;start create model...&quot;</span><br>ollama create dcas-assistant -f ./Modelfile<br>ollama run dcas-assistant<br></code></pre></td></tr></table></figure></li></ul><h4 id="ç¼–è¯‘æ‰§è¡Œ"><a href="#ç¼–è¯‘æ‰§è¡Œ" class="headerlink" title="ç¼–è¯‘æ‰§è¡Œ"></a>ç¼–è¯‘æ‰§è¡Œ</h4><p><img src="https://image.seeyourface.cn/2024/05/image-20240530153105574.png" alt="image-20240530153105574"></p><p>æœ€ç»ˆæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªæ„å»ºå¥½çš„é•œåƒä¸Šä¼ åˆ°ç§æœ‰ä»“åº“ï¼Œåˆ°æ—¶åªè¦æ‹‰å–è¿™ä¸ªé•œåƒå°±å¯ä»¥ç›´æ¥è¿è¡ŒæŒ‡å®šæ¨¡å‹ã€‚</p><p>ï¼šï¼‰</p>]]></content>
    
    
    <categories>
      
      <category>AI</category>
      
      <category>æ¡†æ¶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ¨¡å‹</tag>
      
      <tag>AI</tag>
      
      <tag>docker</tag>
      
      <tag>docker-compose</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JVMç±»åŠ è½½å™¨å’ŒåŒäº²å§”æ´¾æ¨¡å‹</title>
    <link href="/2024/01/06/JVM%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%92%8C%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B/"/>
    <url>/2024/01/06/JVM%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%92%8C%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h3 id="åºè¨€"><a href="#åºè¨€" class="headerlink" title="åºè¨€"></a>åºè¨€</h3><p>åœ¨äº†è§£ç±»åŠ è½½å™¨ä¹‹å‰é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“åœ¨<code>JVM</code>ä¸­ç±»åŠ è½½çš„è¿‡ç¨‹æ­¥éª¤ä¸ºï¼š<strong>åŠ è½½ -&gt; è¿æ¥ -&gt; åˆå§‹åŒ–</strong>ã€‚</p><p>è€Œè¿æ¥è¿‡ç¨‹åˆå¯ä»¥è¿›ä¸€æ­¥ç»†åˆ†ä¸ºä¸‰æ­¥ï¼š<strong>éªŒè¯ -&gt;  å‡†å¤‡ -&gt; è§£æ</strong>ã€‚</p><p><img src="https://image.seeyourface.cn/2024/01/e756e4b0cdae0889ccd514ce59cfefac.png" alt="JVMç±»åŠ è½½è¿‡ç¨‹"></p><p><strong>åŠ è½½</strong>æ˜¯ç±»åŠ è½½è¿‡ç¨‹çš„ç¬¬ä¸€æ­¥ï¼Œä¸»è¦å®Œæˆä¸‹é¢ 3 ä»¶äº‹æƒ…ï¼š</p><ol><li>é€šè¿‡å…¨ç±»åè·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ</li><li>å°†å­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬æ¢ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„</li><li>åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¯¥ç±»çš„ <code>Class</code> å¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™äº›æ•°æ®çš„è®¿é—®å…¥å£</li></ol><h3 id="ç±»åŠ è½½å™¨"><a href="#ç±»åŠ è½½å™¨" class="headerlink" title="ç±»åŠ è½½å™¨"></a>ç±»åŠ è½½å™¨</h3><h4 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h4><p>æ ¹æ®å®˜æ–¹æ–‡æ¡£å¯¹ç±»åŠ è½½å™¨çš„ä»‹ç»ï¼š</p><blockquote><p>A class loader is an object that is responsible for loading classes. The class ClassLoader is an abstract class. Given the binary name of a class, a class loader should attempt to locate or generate data that constitutes a definition for the class. A typical strategy is to transform the name into a file name and then read a â€œclass fileâ€ of that name from a file system.</p><p>Every Class object contains a reference to the ClassLoader that defined it.</p><p>Class objects for array classes are not created by class loaders, but are created automatically as required by the Java runtime. The class loader for an array class, as returned by Class.getClassLoader() is the same as the class loader for its element type; if the element type is a primitive type, then the array class has no class loader.</p></blockquote><p>æ„æ€æ˜¯ï¼š</p><blockquote><p>ç±»åŠ è½½å™¨æ˜¯ä¸€ä¸ªè´Ÿè´£åŠ è½½ç±»çš„å¯¹è±¡ã€‚<code>ClassLoader</code> æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ã€‚ç»™å®šç±»çš„äºŒè¿›åˆ¶åç§°ï¼Œç±»åŠ è½½å™¨åº”å°è¯•å®šä½æˆ–ç”Ÿæˆæ„æˆç±»å®šä¹‰çš„æ•°æ®ã€‚å…¸å‹çš„ç­–ç•¥æ˜¯å°†åç§°è½¬æ¢ä¸ºæ–‡ä»¶åï¼Œç„¶åä»æ–‡ä»¶ç³»ç»Ÿä¸­è¯»å–è¯¥åç§°çš„â€œç±»æ–‡ä»¶â€ã€‚</p><p>æ¯ä¸ª Java ç±»éƒ½æœ‰ä¸€ä¸ªå¼•ç”¨æŒ‡å‘åŠ è½½å®ƒçš„ <code>ClassLoader</code>ã€‚ä¸è¿‡ï¼Œ<strong>æ•°ç»„ç±»ä¸æ˜¯é€šè¿‡ <code>ClassLoader</code> åˆ›å»ºçš„</strong>ï¼Œè€Œæ˜¯ JVM åœ¨éœ€è¦çš„æ—¶å€™è‡ªåŠ¨åˆ›å»ºçš„ï¼Œæ•°ç»„ç±»é€šè¿‡<code>getClassLoader()</code>æ–¹æ³•è·å– <code>ClassLoader</code> çš„æ—¶å€™å’Œè¯¥æ•°ç»„çš„å…ƒç´ ç±»å‹çš„ <code>ClassLoader</code> æ˜¯ä¸€è‡´çš„ã€‚</p></blockquote><p>ä»ä¸Šé¢çš„ä»‹ç»å¯ä»¥çŸ¥é“:</p><ul><li><p>ç±»åŠ è½½å™¨æ˜¯ä¸€ä¸ªè´Ÿè´£åŠ è½½ç±»çš„å¯¹è±¡ï¼Œç”¨äºå®ç°ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„åŠ è½½è¿™ä¸€æ­¥ã€‚</p></li><li><p>æ¯ä¸ª Java ç±»éƒ½æœ‰ä¸€ä¸ªå¼•ç”¨æŒ‡å‘åŠ è½½å®ƒçš„ <code>ClassLoader</code>ã€‚</p></li><li><p>æ•°ç»„ç±»ä¸æ˜¯é€šè¿‡ <code>ClassLoader</code> åˆ›å»ºçš„ï¼ˆæ•°ç»„ç±»æ²¡æœ‰å¯¹åº”çš„äºŒè¿›åˆ¶å­—èŠ‚æµï¼‰ï¼Œæ˜¯ç”± JVM ç›´æ¥ç”Ÿæˆçš„ã€‚</p></li></ul><p>æ€»è€Œè¨€ä¹‹ï¼Œ<strong>ç±»åŠ è½½å™¨çš„ä¸»è¦ä½œç”¨å°±æ˜¯åŠ è½½ Java ç±»çš„å­—èŠ‚ç ï¼ˆ <code>.class</code> æ–‡ä»¶ï¼‰åˆ° JVM ä¸­ï¼ˆåœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¯¥ç±»çš„ <code>Class</code> å¯¹è±¡ï¼‰ã€‚</strong> å­—èŠ‚ç å¯ä»¥æ˜¯ Java æºç¨‹åºï¼ˆ<code>.java</code>æ–‡ä»¶ï¼‰ç»è¿‡ <code>javac</code> ç¼–è¯‘å¾—æ¥ï¼Œä¹Ÿå¯ä»¥æ˜¯é€šè¿‡å·¥å…·åŠ¨æ€ç”Ÿæˆæˆ–è€…é€šè¿‡ç½‘ç»œä¸‹è½½å¾—æ¥ã€‚</p><h4 id="åŠ è½½è§„åˆ™"><a href="#åŠ è½½è§„åˆ™" class="headerlink" title="åŠ è½½è§„åˆ™"></a>åŠ è½½è§„åˆ™</h4><p><code>JVM</code>å¯åŠ¨çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰çš„ç±»ï¼Œè€Œæ˜¯æ ¹æ®éœ€è¦å»åŠ¨æ€åŠ è½½ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¤§éƒ¨åˆ†ç±»åœ¨å…·ä½“ç”¨åˆ°çš„æ—¶å€™æ‰ä¼šå»åŠ è½½ï¼Œè¿™æ ·å¯¹å†…å­˜æ›´åŠ å‹å¥½ã€‚</p><p>å¯¹äºå·²ç»åŠ è½½çš„ç±»ä¼šè¢«æ”¾åœ¨ <code>ClassLoader</code> ä¸­ã€‚åœ¨ç±»åŠ è½½çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šé¦–å…ˆåˆ¤æ–­å½“å‰ç±»æ˜¯å¦è¢«åŠ è½½è¿‡ã€‚å·²ç»è¢«åŠ è½½çš„ç±»ä¼šç›´æ¥è¿”å›ï¼Œå¦åˆ™æ‰ä¼šå°è¯•åŠ è½½ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äº<strong>åŒä¸€ä¸ªç±»åŠ è½½å™¨æ¥è¯´</strong>ï¼Œç›¸åŒäºŒè¿›åˆ¶åç§°çš„ç±»åªä¼šè¢«åŠ è½½ä¸€æ¬¡ã€‚</p><p>åœ¨<code>JVM</code>ä¸­ï¼Œä¸€ä¸ªç±»çš„å”¯ä¸€æ€§æ˜¯éœ€è¦è¿™ä¸ªç±»æœ¬èº«å’Œç±»åŠ è½½ä¸€èµ·æ‰èƒ½ç¡®å®šçš„ï¼Œæ¯ä¸ªç±»åŠ è½½å™¨éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„å‘½åç©ºé—´ã€‚</p><p>ä¸åŒçš„ç±»åŠ è½½å™¨ï¼Œå³ä½¿æ˜¯åŒä¸€ä¸ªç±»å­—èŠ‚ç æ–‡ä»¶ï¼Œæœ€ååœ¨<code>JVM</code>é‡Œçš„ç±»å¯¹è±¡ä¹Ÿä¸æ˜¯åŒä¸€ä¸ªï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢è¿™æ®µä»£ç æ¥éªŒè¯è¿™ä¸ªç»“è®ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassLoaderTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IllegalAccessException,<br>            InstantiationException &#123;<br><br>        <span class="hljs-comment">// è‡ªå®šä¹‰ClassLoader</span><br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">myLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassLoader</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> name.substring(name.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>) + <span class="hljs-number">1</span>) + <span class="hljs-string">&quot;.class&quot;</span>;<br>                <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> getClass().getResourceAsStream(fileName);<br>                <span class="hljs-keyword">if</span> (inputStream == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.loadClass(name);<br>                &#125;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[inputStream.available()];<br>                    inputStream.read(b);<br>                    <span class="hljs-keyword">return</span> defineClass(name, b, <span class="hljs-number">0</span>, b.length);<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassNotFoundException</span>();<br>                &#125;<br>            &#125;<br>        &#125;;<br><br>        <span class="hljs-comment">// è‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">myClassLoaderTest</span> <span class="hljs-operator">=</span> myLoader.loadClass(<span class="hljs-string">&quot;cn.seeyourface.ClassLoaderTest&quot;</span>).newInstance();<br>        System.out.println(myClassLoaderTest.getClass());<br>        System.out.println(myClassLoaderTest <span class="hljs-keyword">instanceof</span> cn.seeyourface.ClassLoaderTest);<br><br>        <span class="hljs-type">ClassLoaderTest</span> <span class="hljs-variable">classLoaderTest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassLoaderTest</span>();<br>        System.out.println(classLoaderTest.getClass());<br>        System.out.println(classLoaderTest <span class="hljs-keyword">instanceof</span> cn.seeyourface.ClassLoaderTest);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">cn</span>.seeyourface.ClassLoaderTest<br><span class="hljs-literal">false</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">cn</span>.seeyourface.ClassLoaderTest<br><span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œä»£ç ä¸­ä½¿ç”¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼ˆ<code>myLoader</code>ï¼‰åŠ è½½çš„ç±»å’Œé€šè¿‡åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨åŠ è½½çš„ç±»ä¸æ˜¯åŒä¸€ä¸ªç±»ã€‚ç»¼ä¸Šï¼Œç±»åŠ è½½å™¨åœ¨<code>JVM</code>ä¸­çš„ä½œç”¨æœ‰ï¼š</p><ol><li>å°†ç±»çš„å­—èŠ‚ç æ–‡ä»¶ä»<code>JVM</code>å¤–éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­</li><li>ç¡®å®šä¸€ä¸ªç±»çš„å”¯ä¸€æ€§</li><li>æä¾›éš”ç¦»ç‰¹æ€§ï¼Œä¸ºä¸­é—´ä»¶å¼€å‘è€…æä¾›ä¾¿åˆ©ï¼Œä¾‹å¦‚<code>Tomcat</code></li></ol><h4 id="ç±»åŠ è½½å™¨æ€»ç»“"><a href="#ç±»åŠ è½½å™¨æ€»ç»“" class="headerlink" title="ç±»åŠ è½½å™¨æ€»ç»“"></a>ç±»åŠ è½½å™¨æ€»ç»“</h4><p>JVM ä¸­å†…ç½®äº†ä¸‰ä¸ªé‡è¦çš„ <code>ClassLoader</code>ï¼š</p><ul><li><p>**<code>BootstrapClassLoader</code>(å¯åŠ¨ç±»åŠ è½½å™¨)**ï¼šæœ€é¡¶å±‚çš„åŠ è½½ç±»ï¼Œç”± C++å®ç°ï¼Œé€šå¸¸è¡¨ç¤ºä¸º <code>null</code>ï¼Œå¹¶ä¸”æ²¡æœ‰çˆ¶çº§ï¼Œä¸»è¦ç”¨æ¥åŠ è½½ <code>JDK</code> å†…éƒ¨çš„æ ¸å¿ƒç±»åº“ï¼ˆ <code>%JAVA_HOME%/lib</code>ç›®å½•ä¸‹çš„ <code>rt.jar</code>ã€<code>resources.jar</code>ã€<code>charsets.jar</code>ç­‰ jar åŒ…å’Œç±»ï¼‰ä»¥åŠè¢« <code>-Xbootclasspath</code>å‚æ•°æŒ‡å®šçš„è·¯å¾„ä¸‹çš„æ‰€æœ‰ç±»ã€‚</p></li><li><p>**<code>ExtensionClassLoader</code>(æ‰©å±•ç±»åŠ è½½å™¨)**ï¼šä¸»è¦è´Ÿè´£åŠ è½½ <code>%JRE_HOME%/lib/ext</code> ç›®å½•ä¸‹çš„ jar åŒ…å’Œç±»ä»¥åŠè¢« <code>java.ext.dirs</code> ç³»ç»Ÿå˜é‡æ‰€æŒ‡å®šçš„è·¯å¾„ä¸‹çš„æ‰€æœ‰ç±»ã€‚</p></li><li><p>**<code>AppClassLoader</code>(åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨)**ï¼šé¢å‘æˆ‘ä»¬ç”¨æˆ·çš„åŠ è½½å™¨ï¼Œè´Ÿè´£åŠ è½½å½“å‰åº”ç”¨ç±»è·¯å¾„ <code>classpath</code> ä¸‹çš„æ‰€æœ‰ <code>jar</code> åŒ…å’Œç±»ã€‚</p></li></ul><blockquote><p>**<code>rt.jar</code>**ï¼šrt ä»£è¡¨<code>â€œRunTimeâ€</code>ï¼Œ<code>rt.jar</code>æ˜¯ <code>Java</code> åŸºç¡€ç±»åº“ï¼ŒåŒ…å« <code>Java doc</code> é‡Œé¢çœ‹åˆ°çš„æ‰€æœ‰çš„ç±»çš„ç±»æ–‡ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¸¸ç”¨å†…ç½®åº“ <code>java.xxx.*</code>éƒ½åœ¨é‡Œé¢ï¼Œæ¯”å¦‚<code>java.util.*</code>ã€<code>java.io.*</code>ã€<code>java.nio.*</code>ã€<code>java.lang.*</code>ã€<code>java.sql.*</code>ã€<code>java.math.*</code>ã€‚</p><p>Java 9 å¼•å…¥äº†æ¨¡å—ç³»ç»Ÿï¼Œå¹¶ä¸”ç•¥å¾®æ›´æ”¹äº†ä¸Šè¿°çš„ç±»åŠ è½½å™¨ã€‚æ‰©å±•ç±»åŠ è½½å™¨è¢«æ”¹åä¸ºå¹³å°ç±»åŠ è½½å™¨ï¼ˆplatform class loaderï¼‰ã€‚Java SE ä¸­é™¤äº†å°‘æ•°å‡ ä¸ªå…³é”®æ¨¡å—ï¼Œæ¯”å¦‚è¯´ <code>java.base</code> æ˜¯ç”±å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½ä¹‹å¤–ï¼Œå…¶ä»–çš„æ¨¡å—å‡ç”±å¹³å°ç±»åŠ è½½å™¨æ‰€åŠ è½½ã€‚</p></blockquote><p><img src="https://image.seeyourface.cn/2024/01/0c2e2eb7811f32d0b10a98c93f34e390.png" alt="ç±»åŠ è½½å™¨å±‚æ¬¡ç»“æ„"></p><p>é™¤äº† <code>BootstrapClassLoader</code> æ˜¯ JVM è‡ªèº«çš„ä¸€éƒ¨åˆ†ä¹‹å¤–ï¼Œå…¶ä»–æ‰€æœ‰çš„ç±»åŠ è½½å™¨éƒ½æ˜¯åœ¨ JVM å¤–éƒ¨å®ç°çš„ï¼Œå¹¶ä¸”å…¨éƒ½ç»§æ‰¿è‡ª <code>ClassLoader</code>æŠ½è±¡ç±»ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œä»¥ä¾¿è®©åº”ç”¨ç¨‹åºè‡ªå·±å†³å®šå¦‚ä½•å»è·å–æ‰€éœ€çš„ç±»ã€‚</p><p>æ¯ä¸ª <code>ClassLoader</code> å¯ä»¥é€šè¿‡<code>getParent()</code>è·å–å…¶çˆ¶ <code>ClassLoader</code>ï¼Œå¦‚æœè·å–åˆ° <code>ClassLoader</code> ä¸º<code>null</code>çš„è¯ï¼Œé‚£ä¹ˆè¯¥ç±»æ˜¯é€šè¿‡ <code>BootstrapClassLoader</code> åŠ è½½çš„ã€‚è¿™æ˜¯å› ä¸º<code>BootstrapClassLoader</code> ç”± C++ å®ç°ï¼Œç”±äºè¿™ä¸ª C++ å®ç°çš„ç±»åŠ è½½å™¨åœ¨ Java ä¸­æ˜¯æ²¡æœ‰ä¸ä¹‹å¯¹åº”çš„ç±»çš„ï¼Œæ‰€ä»¥æ‹¿åˆ°çš„ç»“æœæ˜¯ nullã€‚</p><p>é€šè¿‡ä¸‹é¢ä¾‹å­æ¥æ‰“å°ç±»åŠ è½½å™¨:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassLoaderTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> ClassLoaderTest.class.getClassLoader();<br><br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">tab</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;|--&quot;</span>);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">needContinue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">while</span> (needContinue)&#123;<br>            System.out.println(tab.toString() + classLoader);<br>            <span class="hljs-keyword">if</span>(classLoader == <span class="hljs-literal">null</span>)&#123;<br>                needContinue = <span class="hljs-literal">false</span>;<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                classLoader = classLoader.getParent();<br>                tab.append(<span class="hljs-string">&quot;--&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰“å°å†…å®¹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">|--sun.misc.Launcher$AppClassLoader@18b4aac2<br>|----sun.misc.Launcher$ExtClassLoader@511d50c0<br>|------<span class="hljs-literal">null</span><br></code></pre></td></tr></table></figure><p>ä»è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºï¼š</p><ul><li>æˆ‘ä»¬ç¼–å†™çš„ Java ç±» <code>ClassLoaderTest</code> çš„ <code>ClassLoader</code> æ˜¯<code>AppClassLoader</code>ï¼›</li><li><code>AppClassLoader</code>çš„çˆ¶ <code>ClassLoader</code> æ˜¯<code>ExtClassLoader</code>ï¼›</li><li><code>ExtClassLoader</code>çš„çˆ¶<code>ClassLoader</code>æ˜¯<code>Bootstrap ClassLoader</code>ï¼Œå› æ­¤è¾“å‡ºç»“æœä¸º nullã€‚</li></ul><h4 id="è‡ªå®šä¹‰ç±»åŠ è½½å™¨"><a href="#è‡ªå®šä¹‰ç±»åŠ è½½å™¨" class="headerlink" title="è‡ªå®šä¹‰ç±»åŠ è½½å™¨"></a>è‡ªå®šä¹‰ç±»åŠ è½½å™¨</h4><p>é™¤äº† <code>BootstrapClassLoader</code> å…¶ä»–ç±»åŠ è½½å™¨å‡ç”± Java å®ç°ä¸”å…¨éƒ¨ç»§æ‰¿è‡ª<code>java.lang.ClassLoader</code>ã€‚å¦‚æœæˆ‘ä»¬è¦è‡ªå®šä¹‰è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œä¹Ÿéœ€è¦ç»§æ‰¿ <code>ClassLoader</code>æŠ½è±¡ç±»ã€‚</p><p><code>ClassLoader</code> ç±»æœ‰ä¸¤ä¸ªå…³é”®çš„æ–¹æ³•ï¼š</p><ul><li><code>protected Class loadClass(String name, boolean resolve)</code>ï¼šåŠ è½½æŒ‡å®šäºŒè¿›åˆ¶åç§°çš„ç±»ï¼Œå®ç°äº†åŒäº²å§”æ´¾æœºåˆ¶ ã€‚<code>name</code> ä¸ºç±»çš„äºŒè¿›åˆ¶åç§°ï¼Œ<code>resolve</code> å¦‚æœä¸º trueï¼Œåœ¨åŠ è½½æ—¶è°ƒç”¨ <code>resolveClass(Class&lt;?&gt; c)</code> æ–¹æ³•è§£æè¯¥ç±»ã€‚</li><li><code>protected Class findClass(String name)</code>ï¼šæ ¹æ®ç±»çš„äºŒè¿›åˆ¶åç§°æ¥æŸ¥æ‰¾ç±»ï¼Œé»˜è®¤å®ç°æ˜¯ç©ºæ–¹æ³•ã€‚</li></ul><p>å®˜æ–¹ API æ–‡æ¡£ä¸­å†™åˆ°ï¼š</p><blockquote><p>Subclasses of <code>ClassLoader</code> are encouraged to override <code>findClass(String name)</code>, rather than this method.</p><p>å»ºè®® <code>ClassLoader</code>çš„å­ç±»é‡å†™ <code>findClass(String name)</code>æ–¹æ³•è€Œä¸æ˜¯<code>loadClass(String name, boolean resolve)</code> æ–¹æ³•ã€‚</p></blockquote><p>å¦‚æœæˆ‘ä»¬ä¸æƒ³æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼Œå°±é‡å†™ <code>ClassLoader</code> ç±»ä¸­çš„ <code>findClass()</code> æ–¹æ³•å³å¯ï¼Œæ— æ³•è¢«çˆ¶ç±»åŠ è½½å™¨åŠ è½½çš„ç±»æœ€ç»ˆä¼šé€šè¿‡è¿™ä¸ªæ–¹æ³•è¢«åŠ è½½ã€‚ä½†æ˜¯ï¼Œå¦‚æœæƒ³æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹åˆ™éœ€è¦é‡å†™ <code>loadClass()</code> æ–¹æ³•ã€‚</p><p>é€šè¿‡è‡ªå®šä¹‰ç±»åŠ è½½å™¨æˆ‘ä»¬å¯ä»¥æ»¡è¶³è‡ªå·±çš„ç‰¹æ®Šéœ€æ±‚ã€‚å°±æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ Java ç±»çš„å­—èŠ‚ç ï¼ˆ <code>.class</code> æ–‡ä»¶ï¼‰è¿›è¡ŒåŠ å¯†ï¼ŒåŠ è½½æ—¶å†åˆ©ç”¨è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨å¯¹å…¶è§£å¯†ã€‚</p><h3 id="åŒäº²å§”æ´¾æ¨¡å‹"><a href="#åŒäº²å§”æ´¾æ¨¡å‹" class="headerlink" title="åŒäº²å§”æ´¾æ¨¡å‹"></a>åŒäº²å§”æ´¾æ¨¡å‹</h3><h4 id="ä»‹ç»-1"><a href="#ä»‹ç»-1" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h4><p>å…‰å†…ç½®çš„ç±»åŠ è½½å™¨å°±æœ‰ä¸‰ç§ä¹‹å¤šï¼Œå½“æˆ‘ä»¬æƒ³è¦åŠ è½½ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œå…·ä½“æ˜¯å“ªä¸ªç±»åŠ è½½å™¨åŠ è½½å‘¢ï¼ŸåŒäº²å§”æ´¾æ¨¡å‹ä¼šç»™ä½ ç­”æ¡ˆã€‚</p><p>æ ¹æ®å®˜ç½‘çš„ä»‹ç»ï¼š</p><blockquote><p>The ClassLoader class uses a delegation model to search for classes and resources. Each instance of ClassLoader has an associated parent class loader. When requested to find a class or resource, a ClassLoader instance will delegate the search for the class or resource to its parent class loader before attempting to find the class or resource itself. The virtual machineâ€™s built-in class loader, called the â€œbootstrap class loaderâ€, does not itself have a parent but may serve as the parent of a ClassLoader instance.</p></blockquote><p>ç¿»è¯‘è¿‡æ¥å¤§æ¦‚çš„æ„æ€æ˜¯ï¼š</p><blockquote><p><code>ClassLoader</code> ç±»ä½¿ç”¨å§”æ‰˜æ¨¡å‹æ¥æœç´¢ç±»å’Œèµ„æºã€‚æ¯ä¸ª <code>ClassLoader</code> å®ä¾‹éƒ½æœ‰ä¸€ä¸ªç›¸å…³çš„çˆ¶ç±»åŠ è½½å™¨ã€‚éœ€è¦æŸ¥æ‰¾ç±»æˆ–èµ„æºæ—¶ï¼Œ<code>ClassLoader</code> å®ä¾‹ä¼šåœ¨è¯•å›¾äº²è‡ªæŸ¥æ‰¾ç±»æˆ–èµ„æºä¹‹å‰ï¼Œå°†æœç´¢ç±»æˆ–èµ„æºçš„ä»»åŠ¡å§”æ‰˜ç»™å…¶çˆ¶ç±»åŠ è½½å™¨ã€‚<br>è™šæ‹Ÿæœºä¸­è¢«ç§°ä¸º â€œ<code>bootstrap class loader</code>â€œçš„å†…ç½®ç±»åŠ è½½å™¨æœ¬èº«æ²¡æœ‰çˆ¶ç±»åŠ è½½å™¨ï¼Œä½†æ˜¯å¯ä»¥ä½œä¸º <code>ClassLoader</code> å®ä¾‹çš„çˆ¶ç±»åŠ è½½å™¨ã€‚</p></blockquote><p>ä»ä¸Šé¢çš„ä»‹ç»å¯ä»¥çœ‹å‡ºï¼š</p><ul><li><code>ClassLoader</code> ç±»ä½¿ç”¨å§”æ‰˜æ¨¡å‹æ¥æœç´¢ç±»å’Œèµ„æºã€‚</li><li>åŒäº²å§”æ´¾æ¨¡å‹è¦æ±‚é™¤äº†é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨å¤–ï¼Œå…¶ä½™çš„ç±»åŠ è½½å™¨éƒ½åº”æœ‰è‡ªå·±çš„çˆ¶ç±»åŠ è½½å™¨ã€‚</li><li><code>ClassLoader</code> å®ä¾‹ä¼šåœ¨è¯•å›¾äº²è‡ªæŸ¥æ‰¾ç±»æˆ–èµ„æºä¹‹å‰ï¼Œå°†æœç´¢ç±»æˆ–èµ„æºçš„ä»»åŠ¡å§”æ‰˜ç»™å…¶çˆ¶ç±»åŠ è½½å™¨ã€‚</li></ul><p>ä¸‹å›¾å±•ç¤ºçš„å„ç§ç±»åŠ è½½å™¨ä¹‹é—´çš„å±‚æ¬¡å…³ç³»è¢«ç§°ä¸ºç±»åŠ è½½å™¨çš„â€œ**åŒäº²å§”æ´¾æ¨¡å‹(Parents Delegation Model)**â€ã€‚</p><p><img src="https://image.seeyourface.cn/2024/01/0c2e2eb7811f32d0b10a98c93f34e390.png" alt="ç±»åŠ è½½å™¨å±‚æ¬¡ç»“æ„"></p><p><strong>æ³¨æ„ âš ï¸</strong>ï¼šåŒäº²å§”æ´¾æ¨¡å‹å¹¶ä¸æ˜¯ä¸€ç§å¼ºåˆ¶æ€§çš„çº¦æŸï¼Œåªæ˜¯ JDK å®˜æ–¹æ¨èçš„ä¸€ç§æ–¹å¼ã€‚å¦‚æœæˆ‘ä»¬å› ä¸ºæŸäº›ç‰¹æ®Šéœ€æ±‚æƒ³è¦æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œåæ–‡ä¼šä»‹ç»å…·ä½“çš„æ–¹æ³•ã€‚</p><p>å¦å¤–ï¼Œç±»åŠ è½½å™¨ä¹‹é—´çš„çˆ¶å­å…³ç³»ä¸€èˆ¬ä¸æ˜¯ä»¥ç»§æ‰¿çš„å…³ç³»æ¥å®ç°çš„ï¼Œè€Œæ˜¯é€šå¸¸ä½¿ç”¨ç»„åˆå…³ç³»æ¥å¤ç”¨çˆ¶åŠ è½½å™¨çš„ä»£ç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassLoader</span> &#123;<br>  ...<br>  <span class="hljs-comment">// ç»„åˆ</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ClassLoader parent;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-title function_">ClassLoader</span><span class="hljs-params">(ClassLoader parent)</span> &#123;<br>       <span class="hljs-built_in">this</span>(checkCreateClassLoader(), parent);<br>  &#125;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="åŒäº²å§”æ´¾æ¨¡å‹çš„æ‰§è¡Œæµç¨‹"><a href="#åŒäº²å§”æ´¾æ¨¡å‹çš„æ‰§è¡Œæµç¨‹" class="headerlink" title="åŒäº²å§”æ´¾æ¨¡å‹çš„æ‰§è¡Œæµç¨‹"></a>åŒäº²å§”æ´¾æ¨¡å‹çš„æ‰§è¡Œæµç¨‹</h4><p>åŒäº²å§”æ´¾æ¨¡å‹çš„å®ç°ä»£ç éå¸¸ç®€å•ï¼Œé€»è¾‘éå¸¸æ¸…æ™°ï¼Œéƒ½é›†ä¸­åœ¨ <code>java.lang.ClassLoader</code> çš„ <code>loadClass()</code> ä¸­ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="hljs-type">boolean</span> resolve)<br>    <span class="hljs-keyword">throws</span> ClassNotFoundException<br>&#123;<br>    <span class="hljs-keyword">synchronized</span> (getClassLoadingLock(name)) &#123;<br>        <span class="hljs-comment">//é¦–å…ˆï¼Œæ£€æŸ¥è¯¥ç±»æ˜¯å¦å·²ç»åŠ è½½è¿‡</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> findLoadedClass(name);<br>        <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//å¦‚æœ c ä¸º nullï¼Œåˆ™è¯´æ˜è¯¥ç±»æ²¡æœ‰è¢«åŠ è½½è¿‡</span><br>            <span class="hljs-type">long</span> <span class="hljs-variable">t0</span> <span class="hljs-operator">=</span> System.nanoTime();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-comment">//å½“çˆ¶ç±»çš„åŠ è½½å™¨ä¸ä¸ºç©ºï¼Œåˆ™é€šè¿‡çˆ¶ç±»çš„loadClassæ¥åŠ è½½è¯¥ç±»</span><br>                    c = parent.loadClass(name, <span class="hljs-literal">false</span>);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">//å½“çˆ¶ç±»çš„åŠ è½½å™¨ä¸ºç©ºï¼Œåˆ™è°ƒç”¨å¯åŠ¨ç±»åŠ è½½å™¨æ¥åŠ è½½è¯¥ç±»</span><br>                    c = findBootstrapClassOrNull(name);<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>                <span class="hljs-comment">//éç©ºçˆ¶ç±»çš„ç±»åŠ è½½å™¨æ— æ³•æ‰¾åˆ°ç›¸åº”çš„ç±»ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span><br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">//å½“çˆ¶ç±»åŠ è½½å™¨æ— æ³•åŠ è½½æ—¶ï¼Œåˆ™è°ƒç”¨findClassæ–¹æ³•æ¥åŠ è½½è¯¥ç±»</span><br>                <span class="hljs-comment">//ç”¨æˆ·å¯é€šè¿‡è¦†å†™è¯¥æ–¹æ³•ï¼Œæ¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨</span><br>                <span class="hljs-type">long</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> System.nanoTime();<br>                c = findClass(name);<br><br>                <span class="hljs-comment">//ç”¨äºç»Ÿè®¡ç±»åŠ è½½å™¨ç›¸å…³çš„ä¿¡æ¯</span><br>                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);<br>                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);<br>                sun.misc.PerfCounter.getFindClasses().increment();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (resolve) &#123;<br>            <span class="hljs-comment">//å¯¹ç±»è¿›è¡Œlinkæ“ä½œ</span><br>            resolveClass(c);<br>        &#125;<br>        <span class="hljs-keyword">return</span> c;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¯å½“ä¸€ä¸ªç±»åŠ è½½å™¨æ¥æ”¶åˆ°åŠ è½½è¯·æ±‚æ—¶ï¼Œå®ƒä¼šå…ˆå°†è¯·æ±‚è½¬å‘ç»™çˆ¶ç±»åŠ è½½å™¨ã€‚åœ¨çˆ¶ç±»åŠ è½½å™¨æ²¡æœ‰æ‰¾åˆ°æ‰€è¯·æ±‚çš„ç±»çš„æƒ…å†µä¸‹ï¼Œè¯¥ç±»åŠ è½½å™¨æ‰ä¼šå°è¯•å»åŠ è½½ã€‚</p><p>ç»“åˆæºç ï¼Œç®€å•æ€»ç»“ä¸€ä¸‹åŒäº²å§”æ´¾æ¨¡å‹çš„æ‰§è¡Œæµç¨‹ï¼š</p><ul><li>åœ¨ç±»åŠ è½½çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šé¦–å…ˆåˆ¤æ–­å½“å‰ç±»æ˜¯å¦è¢«åŠ è½½è¿‡ã€‚å·²ç»è¢«åŠ è½½çš„ç±»ä¼šç›´æ¥è¿”å›ï¼Œå¦åˆ™æ‰ä¼šå°è¯•åŠ è½½ï¼ˆæ¯ä¸ªçˆ¶ç±»åŠ è½½å™¨éƒ½ä¼šèµ°ä¸€éè¿™ä¸ªæµç¨‹ï¼‰ã€‚</li><li>ç±»åŠ è½½å™¨åœ¨è¿›è¡Œç±»åŠ è½½çš„æ—¶å€™ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨å»å®Œæˆï¼ˆè°ƒç”¨çˆ¶åŠ è½½å™¨ <code>loadClass()</code>æ–¹æ³•æ¥åŠ è½½ç±»ï¼‰ã€‚è¿™æ ·çš„è¯ï¼Œæ‰€æœ‰çš„è¯·æ±‚æœ€ç»ˆéƒ½ä¼šä¼ é€åˆ°é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ <code>BootstrapClassLoader</code> ä¸­ã€‚</li><li>åªæœ‰å½“çˆ¶åŠ è½½å™¨åé¦ˆè‡ªå·±æ— æ³•å®Œæˆè¿™ä¸ªåŠ è½½è¯·æ±‚ï¼ˆå®ƒçš„æœç´¢èŒƒå›´ä¸­æ²¡æœ‰æ‰¾åˆ°æ‰€éœ€çš„ç±»ï¼‰æ—¶ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½ï¼ˆè°ƒç”¨è‡ªå·±çš„ <code>findClass()</code> æ–¹æ³•æ¥åŠ è½½ç±»ï¼‰ã€‚</li><li>å¦‚æœå­ç±»åŠ è½½å™¨ä¹Ÿæ— æ³•åŠ è½½è¿™ä¸ªç±»ï¼Œé‚£ä¹ˆå®ƒä¼šæŠ›å‡ºä¸€ä¸ª <code>ClassNotFoundException</code> å¼‚å¸¸ã€‚</li></ul><p>ğŸŒˆ æ‹“å±•ï¼š</p><blockquote><p><strong>JVM åˆ¤å®šä¸¤ä¸ª Java ç±»æ˜¯å¦ç›¸åŒçš„å…·ä½“è§„åˆ™</strong>ï¼šJVM ä¸ä»…è¦çœ‹ç±»çš„å…¨åæ˜¯å¦ç›¸åŒï¼Œè¿˜è¦çœ‹åŠ è½½æ­¤ç±»çš„ç±»åŠ è½½å™¨æ˜¯å¦ä¸€æ ·ã€‚åªæœ‰ä¸¤è€…éƒ½ç›¸åŒçš„æƒ…å†µï¼Œæ‰è®¤ä¸ºä¸¤ä¸ªç±»æ˜¯ç›¸åŒçš„ã€‚å³ä½¿ä¸¤ä¸ªç±»æ¥æºäºåŒä¸€ä¸ª <code>Class</code> æ–‡ä»¶ï¼Œè¢«åŒä¸€ä¸ªè™šæ‹ŸæœºåŠ è½½ï¼Œåªè¦åŠ è½½å®ƒä»¬çš„ç±»åŠ è½½å™¨ä¸åŒï¼Œé‚£è¿™ä¸¤ä¸ªç±»å°±å¿…å®šä¸ç›¸åŒã€‚</p></blockquote><h4 id="æ‰“ç ´åŒäº²å§”æ´¾çš„æ–¹æ³•"><a href="#æ‰“ç ´åŒäº²å§”æ´¾çš„æ–¹æ³•" class="headerlink" title="æ‰“ç ´åŒäº²å§”æ´¾çš„æ–¹æ³•"></a>æ‰“ç ´åŒäº²å§”æ´¾çš„æ–¹æ³•</h4><p>è‡ªå®šä¹‰åŠ è½½å™¨çš„è¯ï¼Œéœ€è¦ç»§æ‰¿ <code>ClassLoader</code> ã€‚å¦‚æœæˆ‘ä»¬ä¸æƒ³æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼Œå°±é‡å†™ <code>ClassLoader</code> ç±»ä¸­çš„ <code>findClass()</code> æ–¹æ³•å³å¯ï¼Œæ— æ³•è¢«çˆ¶ç±»åŠ è½½å™¨åŠ è½½çš„ç±»æœ€ç»ˆä¼šé€šè¿‡è¿™ä¸ªæ–¹æ³•è¢«åŠ è½½ã€‚ä½†æ˜¯ï¼Œå¦‚æœæƒ³æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹åˆ™éœ€è¦é‡å†™ <code>loadClass()</code> æ–¹æ³•ã€‚</p><p>ä¸ºä»€ä¹ˆæ˜¯é‡å†™ <code>loadClass()</code> æ–¹æ³•æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹å‘¢ï¼ŸåŒäº²å§”æ´¾æ¨¡å‹çš„æ‰§è¡Œæµç¨‹å·²ç»è§£é‡Šäº†ï¼š</p><blockquote><p>ç±»åŠ è½½å™¨åœ¨è¿›è¡Œç±»åŠ è½½çš„æ—¶å€™ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨å»å®Œæˆï¼ˆè°ƒç”¨çˆ¶åŠ è½½å™¨ <code>loadClass()</code>æ–¹æ³•æ¥åŠ è½½ç±»ï¼‰ã€‚</p></blockquote><p>é‡å†™ <code>loadClass()</code>æ–¹æ³•ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ”¹å˜ä¼ ç»ŸåŒäº²å§”æ´¾æ¨¡å‹çš„æ‰§è¡Œæµç¨‹ã€‚ä¾‹å¦‚ï¼Œå­ç±»åŠ è½½å™¨å¯ä»¥åœ¨å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨ä¹‹å‰ï¼Œå…ˆè‡ªå·±å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œæˆ–è€…åœ¨çˆ¶ç±»åŠ è½½å™¨è¿”å›ä¹‹åï¼Œå†å°è¯•ä»å…¶ä»–åœ°æ–¹åŠ è½½è¿™ä¸ªç±»ã€‚å…·ä½“çš„è§„åˆ™ç”±æˆ‘ä»¬è‡ªå·±å®ç°ï¼Œæ ¹æ®é¡¹ç›®éœ€æ±‚å®šåˆ¶åŒ–ã€‚</p><p>æˆ‘ä»¬æ¯”è¾ƒç†Ÿæ‚‰çš„ Tomcat æœåŠ¡å™¨ä¸ºäº†èƒ½å¤Ÿä¼˜å…ˆåŠ è½½ Web åº”ç”¨ç›®å½•ä¸‹çš„ç±»ï¼Œç„¶åå†åŠ è½½å…¶ä»–ç›®å½•ä¸‹çš„ç±»ï¼Œå°±è‡ªå®šä¹‰äº†ç±»åŠ è½½å™¨ <code>WebAppClassLoader</code> æ¥æ‰“ç ´åŒäº²å§”æ‰˜æœºåˆ¶ã€‚è¿™ä¹Ÿæ˜¯ Tomcat ä¸‹ Web åº”ç”¨ä¹‹é—´çš„ç±»å®ç°éš”ç¦»çš„å…·ä½“åŸç†ã€‚</p><p><img src="https://image.seeyourface.cn/2024/01/6c83c58cc5b97edca3ef2db2abe6ae7b.png" alt="tomcat-class-loader-parents-delegation-model"></p><p>Tomcat è¿™å››ä¸ªè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨å¯¹åº”çš„ç›®å½•å¦‚ä¸‹ï¼š</p><ul><li><code>CommonClassLoader</code>å¯¹åº”<code>&lt;Tomcat&gt;/common/*</code></li><li><code>CatalinaClassLoader</code>å¯¹åº”<code>&lt;Tomcat &gt;/server/*</code></li><li><code>SharedClassLoader</code>å¯¹åº” <code>&lt;Tomcat &gt;/shared/*</code></li><li><code>WebAppClassloader</code>å¯¹åº” <code>&lt;Tomcat &gt;/webapps/&lt;app&gt;/WEB-INF/*</code></li></ul><p>ä»å›¾ä¸­çš„å§”æ´¾å…³ç³»ä¸­å¯ä»¥çœ‹å‡ºï¼š</p><ul><li><code>CommonClassLoader</code>ä½œä¸º <code>CatalinaClassLoader</code> å’Œ <code>SharedClassLoader</code> çš„çˆ¶åŠ è½½å™¨ã€‚<code>CommonClassLoader</code> èƒ½åŠ è½½çš„ç±»éƒ½å¯ä»¥è¢« <code>CatalinaClassLoader</code> å’Œ <code>SharedClassLoader</code> ä½¿ç”¨ã€‚å› æ­¤ï¼Œ<code>CommonClassLoader</code> æ˜¯ä¸ºäº†å®ç°å…¬å…±ç±»åº“ï¼ˆå¯ä»¥è¢«æ‰€æœ‰ Web åº”ç”¨å’Œ Tomcat å†…éƒ¨ç»„ä»¶ä½¿ç”¨çš„ç±»åº“ï¼‰çš„å…±äº«å’Œéš”ç¦»ã€‚</li><li><code>CatalinaClassLoader</code> å’Œ <code>SharedClassLoader</code> èƒ½åŠ è½½çš„ç±»åˆ™ä¸å¯¹æ–¹ç›¸äº’éš”ç¦»ã€‚<code>CatalinaClassLoader</code> ç”¨äºåŠ è½½ Tomcat è‡ªèº«çš„ç±»ï¼Œä¸ºäº†éš”ç¦» Tomcat æœ¬èº«çš„ç±»å’Œ Web åº”ç”¨çš„ç±»ã€‚<code>SharedClassLoader</code> ä½œä¸º <code>WebAppClassLoader</code> çš„çˆ¶åŠ è½½å™¨ï¼Œä¸“é—¨æ¥åŠ è½½ Web åº”ç”¨ä¹‹é—´å…±äº«çš„ç±»æ¯”å¦‚ Springã€Mybatisã€‚</li><li>æ¯ä¸ª Web åº”ç”¨éƒ½ä¼šåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ <code>WebAppClassLoader</code>ï¼Œå¹¶åœ¨å¯åŠ¨ Web åº”ç”¨çš„çº¿ç¨‹é‡Œè®¾ç½®çº¿ç¨‹çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ä¸º <code>WebAppClassLoader</code>ã€‚å„ä¸ª <code>WebAppClassLoader</code> å®ä¾‹ä¹‹é—´ç›¸äº’éš”ç¦»ï¼Œè¿›è€Œå®ç° Web åº”ç”¨ä¹‹é—´çš„ç±»éš”ã€‚</li></ul><p>å•çº¯ä¾é è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ²¡åŠæ³•æ»¡è¶³æŸäº›åœºæ™¯çš„è¦æ±‚ï¼Œä¾‹å¦‚ï¼Œæœ‰äº›æƒ…å†µä¸‹ï¼Œé«˜å±‚çš„ç±»åŠ è½½å™¨éœ€è¦åŠ è½½ä½å±‚çš„åŠ è½½å™¨æ‰èƒ½åŠ è½½çš„ç±»ã€‚</p><p>æ¯”å¦‚ï¼ŒSPI ä¸­ï¼ŒSPI çš„æ¥å£ï¼ˆå¦‚ <code>java.sql.Driver</code>ï¼‰æ˜¯ç”± Java æ ¸å¿ƒåº“æä¾›çš„ï¼Œç”±<code>BootstrapClassLoader</code> åŠ è½½ã€‚è€Œ SPI çš„å®ç°ï¼ˆå¦‚<code>com.mysql.cj.jdbc.Driver</code>ï¼‰æ˜¯ç”±ç¬¬ä¸‰æ–¹ä¾›åº”å•†æä¾›çš„ï¼Œå®ƒä»¬æ˜¯ç”±åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨æˆ–è€…è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ¥åŠ è½½çš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªç±»åŠå…¶ä¾èµ–ç±»ç”±åŒä¸€ä¸ªç±»åŠ è½½å™¨åŠ è½½ã€‚æ‰€ä»¥ï¼ŒåŠ è½½ SPI çš„æ¥å£çš„ç±»åŠ è½½å™¨ï¼ˆ<code>BootstrapClassLoader</code>ï¼‰ä¹Ÿä¼šç”¨æ¥åŠ è½½ SPI çš„å®ç°ã€‚æŒ‰ç…§åŒäº²å§”æ´¾æ¨¡å‹ï¼Œ<code>BootstrapClassLoader</code> æ˜¯æ— æ³•æ‰¾åˆ° SPI çš„å®ç°ç±»çš„ï¼Œå› ä¸ºå®ƒæ— æ³•å§”æ‰˜ç»™å­ç±»åŠ è½½å™¨å»å°è¯•åŠ è½½ã€‚</p><p>å†æ¯”å¦‚ï¼Œå‡è®¾æˆ‘ä»¬çš„é¡¹ç›®ä¸­æœ‰ Spring çš„ jar åŒ…ï¼Œç”±äºå…¶æ˜¯ Web åº”ç”¨ä¹‹é—´å…±äº«çš„ï¼Œå› æ­¤ä¼šç”± <code>SharedClassLoader</code> åŠ è½½ï¼ˆWeb æœåŠ¡å™¨æ˜¯ Tomcatï¼‰ã€‚æˆ‘ä»¬é¡¹ç›®ä¸­æœ‰ä¸€äº›ç”¨åˆ°äº† Spring çš„ä¸šåŠ¡ç±»ï¼Œæ¯”å¦‚å®ç°äº† Spring æä¾›çš„æ¥å£ã€ç”¨åˆ°äº† Spring æä¾›çš„æ³¨è§£ã€‚æ‰€ä»¥ï¼ŒåŠ è½½ Spring çš„ç±»åŠ è½½å™¨ï¼ˆä¹Ÿå°±æ˜¯ <code>SharedClassLoader</code>ï¼‰ä¹Ÿä¼šç”¨æ¥åŠ è½½è¿™äº›ä¸šåŠ¡ç±»ã€‚ä½†æ˜¯ä¸šåŠ¡ç±»åœ¨ Web åº”ç”¨ç›®å½•ä¸‹ï¼Œä¸åœ¨ <code>SharedClassLoader</code> çš„åŠ è½½è·¯å¾„ä¸‹ï¼Œæ‰€ä»¥ <code>SharedClassLoader</code> æ— æ³•æ‰¾åˆ°ä¸šåŠ¡ç±»ï¼Œä¹Ÿå°±æ— æ³•åŠ è½½å®ƒä»¬ã€‚</p><p>å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ è¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”¨åˆ° <strong>çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆ<code>ThreadContextClassLoader</code>ï¼‰</strong> äº†ã€‚</p><p>æ‹¿ Spring è¿™ä¸ªä¾‹å­æ¥è¯´ï¼Œå½“ Spring éœ€è¦åŠ è½½ä¸šåŠ¡ç±»çš„æ—¶å€™ï¼Œå®ƒä¸æ˜¯ç”¨è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œè€Œæ˜¯ç”¨å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ã€‚è¿˜è®°å¾—æˆ‘ä¸Šé¢è¯´çš„å—ï¼Ÿæ¯ä¸ª Web åº”ç”¨éƒ½ä¼šåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ <code>WebAppClassLoader</code>ï¼Œå¹¶åœ¨å¯åŠ¨ Web åº”ç”¨çš„çº¿ç¨‹é‡Œè®¾ç½®çº¿ç¨‹çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ä¸º <code>WebAppClassLoader</code>ã€‚è¿™æ ·å°±å¯ä»¥è®©é«˜å±‚çš„ç±»åŠ è½½å™¨ï¼ˆ<code>SharedClassLoader</code>ï¼‰å€ŸåŠ©å­ç±»åŠ è½½å™¨ï¼ˆ <code>WebAppClassLoader</code>ï¼‰æ¥åŠ è½½ä¸šåŠ¡ç±»ï¼Œç ´åäº† Java çš„ç±»åŠ è½½å§”æ‰˜æœºåˆ¶ï¼Œè®©åº”ç”¨é€†å‘ä½¿ç”¨ç±»åŠ è½½å™¨ã€‚</p><p>çº¿ç¨‹çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨çš„åŸç†æ˜¯å°†ä¸€ä¸ªç±»åŠ è½½å™¨ä¿å­˜åœ¨çº¿ç¨‹ç§æœ‰æ•°æ®é‡Œï¼Œè·Ÿçº¿ç¨‹ç»‘å®šï¼Œç„¶ååœ¨éœ€è¦çš„æ—¶å€™å–å‡ºæ¥ä½¿ç”¨ã€‚è¿™ä¸ªç±»åŠ è½½å™¨é€šå¸¸æ˜¯ç”±åº”ç”¨ç¨‹åºæˆ–è€…å®¹å™¨ï¼ˆå¦‚ Tomcatï¼‰è®¾ç½®çš„ã€‚</p><p><code>Java.lang.Thread</code> ä¸­çš„<code>getContextClassLoader()</code>å’Œ <code>setContextClassLoader(ClassLoader cl)</code>åˆ†åˆ«ç”¨æ¥è·å–å’Œè®¾ç½®çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ã€‚å¦‚æœæ²¡æœ‰é€šè¿‡<code>setContextClassLoader(ClassLoader cl)</code>è¿›è¡Œè®¾ç½®çš„è¯ï¼Œçº¿ç¨‹å°†ç»§æ‰¿å…¶çˆ¶çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ã€‚</p><p>Spring è·å–çº¿ç¨‹çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">cl = Thread.currentThread().getContextClassLoader();<br></code></pre></td></tr></table></figure><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span>æ·±å…¥åˆ†æ Java ClassLoader åŸç†ï¼š<a href="https://blog.csdn.net/xyang81/article/details/7292380">https://blog.csdn.net/xyang81/article/details/7292380</a><a href="#fnref:1" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:2" class="footnote-text"><span>Java ç±»åŠ è½½å™¨(ClassLoader)ï¼š<a href="http://gityuan.com/2016/01/24/java-classloader/">http://gityuan.com/2016/01/24/java-classloader/</a><a href="#fnref:2" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:3" class="footnote-text"><span>Class ClassLoader - Oracle å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/ClassLoader.html">https://docs.oracle.com/javase/8/docs/api/java/lang/ClassLoader.html</a><a href="#fnref:3" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:4" class="footnote-text"><span><a href="https://javaguide.cn/java/jvm/classloader.html">https://javaguide.cn/java/jvm/classloader.html</a><a href="#fnref:4" rev="footnote" class="footnote-backref"> â†©</a></span></span></li></ol></div></section>]]></content>
    
    
    <categories>
      
      <category>JVM</category>
      
      <category>ç±»åŠ è½½å™¨</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JVM</tag>
      
      <tag>ç±»åŠ è½½å™¨</tag>
      
      <tag>åŒäº²å§”æ´¾</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è®°ä¸€æ¬¡Spring bootæœ¬åœ°å¯åŠ¨æŠ¥IllegalAccessErrorå¼‚å¸¸åŸå› </title>
    <link href="/2024/01/05/%E8%AE%B0%E4%B8%80%E6%AC%A1Spring%20boot%E6%9C%AC%E5%9C%B0%E5%90%AF%E5%8A%A8%E6%8A%A5IllegalAccessError%E5%BC%82%E5%B8%B8%E5%8E%9F%E5%9B%A0/"/>
    <url>/2024/01/05/%E8%AE%B0%E4%B8%80%E6%AC%A1Spring%20boot%E6%9C%AC%E5%9C%B0%E5%90%AF%E5%8A%A8%E6%8A%A5IllegalAccessError%E5%BC%82%E5%B8%B8%E5%8E%9F%E5%9B%A0/</url>
    
    <content type="html"><![CDATA[<h3 id="åºè¨€"><a href="#åºè¨€" class="headerlink" title="åºè¨€"></a>åºè¨€</h3><p>æœ€è¿‘é¡¹ç›®æ¥å…¥å…¬å¸ä¸€ä¸ª <code>SSO</code> ç»Ÿä¸€èº«ä»½è®¤è¯ç»„ä»¶ï¼Œè¿™é‡Œç®€å•è¯´æ˜ä¸€ä¸‹ï¼š</p><p>ç»„ä»¶æä¾›çš„è‡ªåŠ¨é…ç½®ç±»å¯åŠ¨æ—¶å¦‚æœ <code>UserCenterActivated</code> è¿™ä¸ª<code>Bean</code>ä¸å­˜åœ¨çš„è¯ä¼šä½¿ç”¨ç»„ä»¶é»˜è®¤çš„ç”¨æˆ·æ¿€æ´»ç»„ä»¶ï¼Œç„¶åæˆ‘æ˜¯åœ¨é¡¹ç›®ä¸­å®ç°äº†è‡ªå·±çš„ä¸€ä¸ªç”¨æˆ·æ¿€æ´»ç±»å¹¶ç»§æ‰¿äº†<code>UserCenterActivated</code>æŠ½è±¡ç±»ã€‚</p><p><img src="https://image.seeyourface.cn/2024/01/image-20240105162049473.png" alt="image-20240105162049473"></p><p>é¡¹ç›®å¯åŠ¨æ—¶å¥‡æ€ªçš„å‡ºç°äº†ä»¥ä¸‹é”™è¯¯ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tex">class xxx.sso.support.<span class="hljs-built_in">$</span>Proxy130 cannot access its superinterface xxx.sso.support.AppRegistryInfo<br></code></pre></td></tr></table></figure><p>å¹¶ä¸”è¯¥æƒ…å†µåªåœ¨æœ¬åœ°å‡ºç°ï¼Œæ‰“åŒ…éƒ¨ç½²åˆ°æœåŠ¡å™¨å¹¶æœªå‡ºç°é—®é¢˜ã€‚</p><p>æ‰€ä»¥æˆ‘åˆ¤æ–­è‚¯èƒ½ä¸æœ¬åœ°çš„<code>maven</code>æ’ä»¶æœ‰å…³ï¼Œå› ä¸ºæœ‰äº›<code>maven</code>æ’ä»¶åªæœ‰åœ¨å¼€å‘ä¸­ç”Ÿæ•ˆã€‚</p><p>æœ€ç»ˆå®šä½åˆ°æ˜¯ç”±äº<code>spring-boot-devtools</code>è¿™ä¸ªæ’ä»¶å¯¼è‡´çš„ã€‚</p><h3 id="çƒ­éƒ¨ç½²æ’ä»¶"><a href="#çƒ­éƒ¨ç½²æ’ä»¶" class="headerlink" title="çƒ­éƒ¨ç½²æ’ä»¶"></a>çƒ­éƒ¨ç½²æ’ä»¶</h3><h4 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h4><p><code>spring-boot-devtools</code>æ’ä»¶æ”¯æŒåœ¨<code>spring-boot</code>å¼€å‘ä¸­å¯¹é¡¹ç›®ä¿®æ”¹çš„ä»£ç è¿›è¡Œå¿«é€Ÿéƒ¨ç½²ï¼Œè€Œæ— éœ€é‡å¯<code>JVM</code>çš„ä¸€æ¬¾å·¥å…·ã€‚</p><p>ä½¿ç”¨<code>spring-boot-devtools</code>ï¼Œå¯ä»¥å®ç°æŒ‡å®šç›®å½•ï¼ˆé»˜è®¤ä¸º<code>classpath</code>è·¯å¾„ï¼‰ä¸‹çš„æ–‡ä»¶è¿›è¡Œæ›´æ”¹åï¼Œé¡¹ç›®è‡ªåŠ¨é‡å¯ï¼Œæ›´æ”¹åçš„ä»£ç è‡ªåŠ¨ç”Ÿæ•ˆã€‚</p><h4 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h4><p>æ ¹æ®å®˜æ–¹çš„å®šä¹‰ï¼š<code>spring-boot-devtools</code>ä½¿ç”¨äº†ä¸¤ä¸ªç±»åŠ è½½å™¨<code>ClassLoader</code>ï¼Œä¸€ä¸ª<code>ClassLoader</code>åŠ è½½ä¸ä¼šå‘ç”Ÿæ›´æ”¹çš„ç±»ï¼ˆ<strong>ç¬¬ä¸‰æ–¹jaråŒ…</strong>ï¼‰ä¸€èˆ¬æ˜¯åº”ç”¨ç±»åŠ è½½å™¨ï¼Œæˆ‘ä»¬æš‚ä¸”å«ä»– <code>base ClassLoader</code>ï¼Œå¦ä¸€ä¸ª<code>ClassLoader</code>ï¼ˆ<code>restart ClassLoader</code>ï¼‰åŠ è½½ä¼šæ›´æ”¹çš„ç±»ï¼ˆ<strong>è‡ªå®šä¹‰çš„ç±»</strong>ï¼‰ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>IDE</code> ä¸­çš„ä»»ä½•æ‰“å¼€é¡¹ç›®éƒ½ä½¿ç”¨<code>restart</code>ç±»åŠ è½½å™¨åŠ è½½ï¼Œè€Œæ™®é€šçš„<code>jar</code> æ–‡ä»¶åˆ™ä½¿ç”¨<code>base</code>ç±»åŠ è½½å™¨åŠ è½½ã€‚å¦‚æœä½¿ç”¨ <code>mvn spring-boot:run</code> æˆ– <code>gradle bootRun</code>ï¼Œæƒ…å†µä¹Ÿæ˜¯å¦‚æ­¤: åŒ…å« <code>@SpringBootApplication</code> çš„é¡¹ç›®ä½¿ç”¨<code>restart</code>ç±»åŠ è½½å™¨åŠ è½½ï¼Œå…¶ä»–æ‰€æœ‰å†…å®¹ä½¿ç”¨<code>base</code>ç±»åŠ è½½å™¨åŠ è½½ã€‚</p><p><img src="https://image.seeyourface.cn/2024/01/image-20240105173751969.png" alt="image-20240105173751969"></p><p>è¿™å°±å¯¼è‡´æˆ‘é¡¹ç›®ä¸­çš„ä»£ç éƒ½æ˜¯ç”±<code>restart ClassLoader</code>åŠ è½½å™¨åŠ è½½çš„ï¼Œè€Œæˆ‘å¼•å…¥çš„ç»„ä»¶<code>jar</code>åŒ…æ˜¯ç”±<code>app ClassLoader</code>åŠ è½½çš„ï¼Œè¿™å°±å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›ç±»åŠ è½½é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤šæ¨¡å—é¡¹ç›®ä¸­ã€‚</p><p><code>SSO</code>ç»„ä»¶åœ¨ç¬¬ä¸‰æ–¹<code>jar</code>åŒ…ä¸­ï¼Œè¿™å°†å¯¼è‡´<code>DevTools</code>çš„é‡æ–°å¯åŠ¨ç±»åŠ è½½å™¨å‡ºç°é—®é¢˜ã€‚ä»£ç†å¯¹è±¡æ˜¯ç”±<code>restart</code>ç±»åŠ è½½å™¨åŠ è½½çš„ï¼Œä½†è¢«ä»£ç†å¯¹è±¡æœ¬èº«æ˜¯ç”±åº”ç”¨ç±»åŠ è½½å™¨åŠ è½½ï¼Œå› æ­¤ä¼šå¯¼è‡´<code>IllegalAccessError</code>ã€‚</p><h4 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h4><ul><li>å¤§åŠ›å‡ºå¥‡è¿¹ï¼Œåˆ æ‰æˆ–è€…æ³¨é‡Šæ‰<code>spring-boot-devtools</code>æ’ä»¶ã€‚</li><li>åœ¨<code>META-INF/spring-devtools.properties</code>ä¸­è®¾ç½®<code>restart.include.projectcommon=è¢«ä»£ç†å¯¹è±¡æ‰€åœ¨çš„jar</code>ï¼Œä¿è¯ä»£ç†å¯¹è±¡å’Œè¢«ä»£ç†å¯¹è±¡ä½¿ç”¨åŒä¸€ä¸ªç±»åŠ è½½å™¨ã€‚</li></ul><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#using.devtools.diagnosing-classloading-issues">https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#using.devtools.diagnosing-classloading-issues</a><a href="#fnref:1" rev="footnote" class="footnote-backref"> â†©</a></span></span></li></ol></div></section>]]></content>
    
    
    <categories>
      
      <category>é—®é¢˜è®°å½•</category>
      
    </categories>
    
    
    <tags>
      
      <tag>åŒäº²å§”æ´¾</tag>
      
      <tag>çƒ­éƒ¨ç½²</tag>
      
      <tag>devtools</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å°†ç™½å«–è¿›è¡Œåˆ°åº•â€”â€”è®°ä¸€æ¬¡ç½‘ç«™æœåŠ¡è¿ç§»å›½å¤–æœåŠ¡å™¨æµç¨‹</title>
    <link href="/2023/11/30/%E5%B0%86%E7%99%BD%E5%AB%96%E8%BF%9B%E8%A1%8C%E5%88%B0%E5%BA%95%E2%80%94%E2%80%94%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%BD%91%E7%AB%99%E6%9C%8D%E5%8A%A1%E8%BF%81%E7%A7%BB%E5%9B%BD%E5%A4%96%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%B5%81%E7%A8%8B/"/>
    <url>/2023/11/30/%E5%B0%86%E7%99%BD%E5%AB%96%E8%BF%9B%E8%A1%8C%E5%88%B0%E5%BA%95%E2%80%94%E2%80%94%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%BD%91%E7%AB%99%E6%9C%8D%E5%8A%A1%E8%BF%81%E7%A7%BB%E5%9B%BD%E5%A4%96%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%B5%81%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h3 id="åºè¨€"><a href="#åºè¨€" class="headerlink" title="åºè¨€"></a>åºè¨€</h3><p>å…ˆç®€å•ä»‹ç»ä¸€ä¸‹è¿™ä¸ªç½‘ç«™å§ï¼ŒåŸŸåæ˜¯å‡ å¹´å‰åœ¨é˜¿é‡Œäº‘ä¹°çš„ï¼Œå½“æ—¶ä¹Ÿå…¥æ‰‹äº†ä¸ªæœåŠ¡å™¨ç”¨äºéƒ¨ç½²æ¯•è®¾é¡¹ç›®ï¼Œä¸ºäº†èƒ½æ­£å¸¸è®¿é—®ç½‘ç«™ä¹Ÿæ˜¯å¤‡æ¡ˆè¿‡ä¸€æ¬¡ï¼ŒæœåŠ¡å™¨åˆ°æœŸä¹‹åå°±æ²¡ç®¡äº†ï¼Œä½†ä¸€ç›´æœ‰åœ¨ç»­åŸŸåã€‚</p><p>ä¸¤ä¸ªæœˆå‰ç”¨åŸŸåæ­äº†ä¸€ä¸ªåšå®¢ï¼ŒæœåŠ¡å™¨ç™½å«–çš„<code>Github Page</code>ï¼Œå›¾åºŠä½¿ç”¨çš„é˜¿é‡Œäº‘çš„<code>OSS</code>ã€‚ï¼ˆé‡ç‚¹ï¼šå…¬å¼€è®¿é—®ï¼ï¼‰</p><p>è¿è¡Œäº†å°ä¸¤æœˆéƒ½æ²¡ä»€ä¹ˆäº‹æƒ…ï¼Œç›´åˆ°åœ¨<code>V2</code>çœ‹åˆ°æœ‰äºº<code>OSS</code>å­˜å‚¨è¢«ç›—åˆ·ï¼ŒæŸå¤±å¥½å‡ åƒï¼Œå“å¾—æˆ‘èµ¶ç´§å¼€é€šäº†é˜¿é‡Œçš„<code>CDN</code>æœåŠ¡ï¼ŒæŠŠ<code>Bucket</code>ç§æœ‰åŒ–ï¼Œç„¶åç”¨<code>CND</code>å›æºåˆ°<code>OSS</code>å­˜å‚¨ï¼Œç»™<code>CND</code>åŠ ä¸Šäº†å„ç§æµé‡æ§åˆ¶ï¼Œè®¿é—®æ§åˆ¶ã€‚</p><p>æ­£å½“æˆ‘ä»¥ä¸ºä¸€åˆ‡éƒ½æ˜¯å¦‚æ­¤ç¾å¦™çš„æ—¶å€™ï¼Œé˜¿é‡Œäº‘ç»™æˆ‘å‘æ¥äº†ä¿¡æ¯ï¼Œä¸åˆ°ä¸€ä¸ªå°æ—¶å°±æŠŠ<code>CND</code>åŸŸåä¸‹çº¿äº†â€¦</p><p><img src="https://image.seeyourface.cn/2023/11/2831f367c963dcf89ec44173f06a6e3.jpg" alt="2831f367c963dcf89ec44173f06a6e3"></p><p>æ€»ä¹‹ï¼Œåªè¦å°†åŸŸåè§£æåˆ°äº†å›½å†…çš„ç©ºé—´å°±éœ€è¦å¤‡æ¡ˆï¼Œå¦åˆ™å°±ä¼šé™åˆ¶åŸŸåæ— æ³•è®¿é—®ã€‚</p><p>æ— å¥ˆäºå¤‡æ¡ˆæµç¨‹å®åœ¨ç¹çå†—é•¿ï¼Œå†µä¸”æˆ‘è¿™å°å°ç½‘ç«™æ ¹æœ¬æ²¡æœ‰å›½å†…æœåŠ¡å™¨ï¼Œå¤‡æ¡ˆè¿˜éœ€è¦å¦å¤–èŠ±è´¹é‡‘å¸è´­ä¹°æœåŠ¡ç ï¼Œæ—¢ç„¶å¦‚æ­¤ï¼Œé‚£å°±å°†ç™½å«–è¿›è¡Œåˆ°åº•ï¼</p><p>ç»è¿‡ä¸€ç•ªæœå¯»ï¼Œæˆ‘é€‰æ‹©ä½¿ç”¨ <code>Backblzae b2</code> ä½œä¸ºå›¾åºŠï¼Œä½¿ç”¨ <code>Cloudflare</code> åŸŸåæœåŠ¡å•†åš<code>DNS</code>è§£æå’Œ<code>CDN</code>ä»£ç†å·¥ä½œã€‚</p><h3 id="Backblaze"><a href="#Backblaze" class="headerlink" title="Backblaze"></a>Backblaze</h3><h4 id="ä¸ºä»€ä¹ˆé€‰æ‹©B2"><a href="#ä¸ºä»€ä¹ˆé€‰æ‹©B2" class="headerlink" title="ä¸ºä»€ä¹ˆé€‰æ‹©B2"></a>ä¸ºä»€ä¹ˆé€‰æ‹©B2</h4><p>æœ€ä¸»è¦çš„åŸå› æ˜¯å®ƒå…è´¹ã€ä¾¿å®œï¼</p><p>å­˜å‚¨å‰<code>10GB</code>å†…å®¹å®Œå…¨å…è´¹ï¼Œè¶…è¿‡<code>10GB</code>çš„éƒ¨åˆ†æ”¶å–<code>6$/month</code>çš„è´¹ç”¨ã€‚</p><p>å¯¹äºæˆ‘æ¥è¯´<code>10GB</code>çš„å­˜å‚¨å®¹é‡ç»å¯¹æ˜¯å¤Ÿå¤Ÿçš„ã€‚</p><h4 id="åˆ›å»ºBucket"><a href="#åˆ›å»ºBucket" class="headerlink" title="åˆ›å»ºBucket"></a>åˆ›å»ºBucket</h4><p>é¦–å…ˆä½ éœ€è¦æ³¨å†Œä¸€ä¸ªè´¦å·ï¼Œç„¶åç‚¹å‡»åˆ›å»ºæ¡¶ï¼Œå¡«å†™<code>Bucket</code>åç§°ï¼Œæ³¨æ„è¿™ä¸ªåç§°å¿…é¡»æ˜¯å”¯ä¸€çš„ã€‚</p><p>æ¡¶çš„è®¿é—®æƒé™è®¾ç½®ä¸º<code>Public</code>ï¼Œå‰©ä½™å‚æ•°å…¨éƒ¨é»˜è®¤å³å¯ã€‚</p><p><img src="https://image.seeyourface.cn/2023/11/image-20231130171713075.png" alt="image-20231130171713075"></p><p>åˆ›å»ºå®Œä¹‹åCORSè§„åˆ™é€‰æ‹©â€™ä¸æ‰€æœ‰HTTPSæ¥æºå…±äº«æ­¤å­˜å‚¨æ¡¶ä¸­çš„æ‰€æœ‰å†…å®¹â€™ã€‚</p><p><img src="https://image.seeyourface.cn/2023/11/image-20231130174423601.png" alt="image-20231130174423601"></p><p>æ¡¶è®¾å®šé»˜è®¤æ˜¯ä¸ç¼“å­˜ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®èµ„æºè¿‡æœŸæ—¶é—´ï¼š</p><p><img src="https://image.seeyourface.cn/2023/12/image-20231201092749937.png" alt="image-20231201092749937"></p><p>ç‚¹å‡»ä¸Šä¼ &#x2F;ä¸‹è½½æŒ‰é’®ï¼Œéšä¾¿ä¸Šä¼ ä¸€å¼ å›¾ç‰‡ï¼ŒæŸ¥çœ‹å›¾ç‰‡ä¿¡æ¯ï¼š</p><p><img src="https://image.seeyourface.cn/2023/11/image-20231130174840316.png" alt="image-20231130174840316"></p><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡å‹å¥½URLè®¿é—®è¿™å¼ å›¾ç‰‡ã€‚</p><p>è®°ä½å‹å¥½URLä¸­çš„åŸŸåéƒ¨åˆ†ï¼Œåç»­<code>Cloudflare</code>ä»£ç†æ—¶éœ€è¦ç”¨åˆ°ã€‚</p><h4 id="Picgoé…ç½®é»˜è®¤å›¾åºŠ"><a href="#Picgoé…ç½®é»˜è®¤å›¾åºŠ" class="headerlink" title="Picgoé…ç½®é»˜è®¤å›¾åºŠ"></a>Picgoé…ç½®é»˜è®¤å›¾åºŠ</h4><p>å¦‚æœä¸æƒ³æ¯æ¬¡ä¸Šä¼ æ–‡ä»¶éƒ½æ‰“å¼€<code>Backblaze</code>ç½‘ç«™ï¼Œå¯ä»¥ä½¿ç”¨<code>Pigco</code>è½¯ä»¶é…ç½®é»˜è®¤å›¾åºŠä¸Šä¼ ã€‚</p><h4 id="æ·»åŠ åº”ç”¨å¯†é’¥"><a href="#æ·»åŠ åº”ç”¨å¯†é’¥" class="headerlink" title="æ·»åŠ åº”ç”¨å¯†é’¥"></a>æ·»åŠ åº”ç”¨å¯†é’¥</h4><p>è¿›å…¥é¡µé¢å·¦ä¾§<code>Application keys</code>ç‚¹å‡» <code>Add a new Application Key</code>åˆ›å»ºä¸€ä¸ªåº”ç”¨å¯†é’¥ï¼Œéšä¾¿å¡«å†™ä¸€ä¸ªå¯†é’¥åå­—ç„¶åé€‰æ‹©è¦æˆæƒçš„<code>Bucket</code>å’Œè¯»å†™æƒé™ã€‚</p><p><img src="https://image.seeyourface.cn/2023/12/image-20231201142023112.png" alt="image-20231201142023112"></p><h4 id="é…ç½®Picgo"><a href="#é…ç½®Picgo" class="headerlink" title="é…ç½®Picgo"></a>é…ç½®Picgo</h4><p>æ’ä»¶è®¾ç½®ä¸­æœç´¢<code>S3</code>ä¸‹è½½å®‰è£…<code>amazon s3 uploader</code>æ’ä»¶ï¼Œå¡«å†™åˆšæ‰ç”Ÿæˆçš„åº”ç”¨å¯†é’¥å’ŒIDï¼Œåœ°åŒºå¡«å†™ä½ çš„<code>Bucket Endpoint</code>ç¬¬äºŒéƒ¨åˆ†çš„å†…å®¹ï¼Œä¾‹å¦‚æˆ‘è¿™é‡Œæ˜¯<code>us-east-005</code>ã€‚è‡ªå®šä¹‰èŠ‚ç‚¹å¡«å†™<code>Endpoint</code>ï¼Œè‡ªå®šä¹‰åŸŸåå¯ä»¥å¸®åŠ©æˆ‘ä»¬ä¸Šä¼ æˆåŠŸåå°†Endpointçš„åŸŸåæ›¿æ¢ä¸ºæˆ‘ä»¬è‡ªå·±çš„åŸŸåã€‚</p><p>é…ç½®å®Œæˆå°±å¯ä»¥ä¸Šä¼ å›¾ç‰‡äº†ã€‚</p><p><img src="https://image.seeyourface.cn/2023/12/image-20231201142431185.png" alt="image-20231201142431185"></p><h3 id="Cloudflare"><a href="#Cloudflare" class="headerlink" title="Cloudflare"></a>Cloudflare</h3><p>é€šè¿‡<code>Cloudflare</code>è®¿é—®<code>Backblaze</code>çš„æµé‡æ˜¯å®Œå…¨å…è´¹çš„ï¼Œåªä¸è¿‡ä¸ç»‘å®šå¡çš„è¯æ¯å¤©åªæœ‰2500æ¬¡å…è´¹è¯·æ±‚ã€‚</p><h4 id="æ·»åŠ åŸŸå"><a href="#æ·»åŠ åŸŸå" class="headerlink" title="æ·»åŠ åŸŸå"></a>æ·»åŠ åŸŸå</h4><p>å¦‚æœä½ æ²¡æœ‰åŸŸåï¼Œå¯ä»¥è´­ä¹°ä¸€ä¸ªåŸŸåï¼Œå¦‚æœä½ å·²ç»æœ‰ä¸€ä¸ªåŸŸåäº†ï¼Œåœ¨é¡µé¢å·¦ä¾§çš„<code>website</code>æ·»åŠ ä½ çš„é¡¶çº§åŸŸååˆ°<code>Cloudflare</code>ï¼Œç„¶ååœ¨ä½ çš„åŸŸåæ³¨å†Œå•†å°†ä½ çš„åŸŸåæœåŠ¡å™¨ä¿®æ”¹ä¸º<code>Cloudflare</code>æä¾›çš„æœåŠ¡å™¨ï¼ˆä¸€èˆ¬æ˜¯åœ¨åŸŸåç®¡ç†ä¸­ï¼‰ã€‚</p><p><img src="https://image.seeyourface.cn/2023/12/image-20231201144323838.png" alt="image-20231201144323838"></p><h4 id="æ·»åŠ åŸŸåè§£æè®°å½•"><a href="#æ·»åŠ åŸŸåè§£æè®°å½•" class="headerlink" title="æ·»åŠ åŸŸåè§£æè®°å½•"></a>æ·»åŠ åŸŸåè§£æè®°å½•</h4><p>ç¬¬ä¸€ä¸ªè¡¨ç¤ºå°†äºŒçº§åŸŸå<code>image.seeyourface.cn</code>è§£æåˆ°<code>Backblaze</code>çš„å›¾åºŠèŠ‚ç‚¹ï¼Œç¬¬äºŒä¸‰æ¡è¡¨ç¤ºå°†<code>seeyourface.cn</code>å’Œ<code>www.seeyourface.cn</code>è§£æåˆ°<code>github page</code>ã€‚</p><p>å³è¾¹é»„è‰²çš„äº‘æœµè¡¨ç¤º<code>Cloudflare</code>å°†ä»£ç†ä½ çš„è¯·æ±‚ï¼Œä¾‹å¦‚åšä¸€äº›ç¼“å­˜ç­–ç•¥ç­‰ç­‰ã€‚</p><p><img src="https://image.seeyourface.cn/2023/12/image-20231201144613653.png" alt="image-20231201144613653"></p><h4 id="å¼€å¯ä¸¥æ ¼çš„SSLåŠ å¯†æ¨¡å¼"><a href="#å¼€å¯ä¸¥æ ¼çš„SSLåŠ å¯†æ¨¡å¼" class="headerlink" title="å¼€å¯ä¸¥æ ¼çš„SSLåŠ å¯†æ¨¡å¼"></a>å¼€å¯ä¸¥æ ¼çš„SSLåŠ å¯†æ¨¡å¼</h4><p>å®Œæˆä¸Šé¢çš„æ­¥éª¤åï¼Œä½ å¯èƒ½æ— æ³•è®¿é—®ä½ çš„å›¾ç‰‡å’Œç½‘ç«™ï¼Œå› ä¸ºå›¾åºŠæ˜¯ä½¿ç”¨<code>https</code>è®¿é—®çš„ï¼Œ<code>github page</code>å¦‚æœå¼€å¯äº†å¼ºåˆ¶<code>https</code>è®¿é—®ï¼Œä½ å¯èƒ½ä¼šæ”¶åˆ°<code>301 Moved Permanently</code>çš„é”™è¯¯ä¿¡æ¯ã€‚</p><p>è¿™æ—¶å€™éœ€è¦ç‚¹å‡»å·¦ä¾§çš„<code>SSL/TLS</code>é¡µé¢ï¼Œå¼€å¯ä¸¥æ ¼åŠ å¯†æ¨¡å¼ã€‚ç¬¬ä¸‰ä¸ªé€‰é¡¹è¡¨ç¤ºæ¥å—è‡ªç­¾åè¯ä¹¦ï¼Œç¬¬å››ä¸ªè¡¨ç¤ºåªæ¥å—å—ä¿¡ä»»çš„è¯ä¹¦ã€‚</p><p><img src="https://image.seeyourface.cn/2023/12/image-20231201145728771.png" alt="image-20231201145728771"></p><p>è¿™æ—¶ä½ æ‰å¯ä»¥ä½¿ç”¨<code>https://image.yourdomain.com/file/&#123;bucketName&#125;/default.png</code>æ‰€ç¤ºæ ¼å¼æ¥è®¿é—®ä½ çš„å›¾ç‰‡ã€‚</p><p>è¿™ç§URLä¼šæš´éœ²æˆ‘ä»¬çš„<code>BucketName</code>ï¼Œ<code>Cloudflare</code>æä¾›äº†<code>URL Path</code>çš„è§„åˆ™è½¬æ¢ã€‚</p><h4 id="è¯·æ±‚è·¯å¾„è½¬æ¢"><a href="#è¯·æ±‚è·¯å¾„è½¬æ¢" class="headerlink" title="è¯·æ±‚è·¯å¾„è½¬æ¢"></a>è¯·æ±‚è·¯å¾„è½¬æ¢</h4><p>é€‰æ‹©å·¦ä¾§ï¼šRules -&gt; Transform Rules -&gt; Rewrite URL -&gt; Create Rule</p><p>è‡ªå®šä¹‰è¿‡æ»¤æ¡ä»¶ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tex">(http.host eq &quot;image.seeyourface.cn&quot; and http.request.uri.path ne &quot;/file/&#123;bucketName&#125;&quot;)<br></code></pre></td></tr></table></figure><p>åŒ¹é…æˆåŠŸåˆ™åŠ¨æ€é‡å†™ä¸ºï¼šconcat(â€œ&#x2F;file&#x2F;{bucketName}â€,http.request.uri.path)</p><p>æ›¿æ¢ä¸ºä½ è‡ªå·±çš„åŸŸåå’Œbucketåç§°</p><p><img src="https://image.seeyourface.cn/2023/12/image-20231201151642557.png" alt="image-20231201151642557"></p><p>ç„¶åå°±å¯ä»¥é€šè¿‡ä½ çš„åŸŸå + å›¾ç‰‡å­˜å‚¨è·¯å¾„æ¥è®¿é—®ä½ çš„å›¾ç‰‡ï¼Œè¿™æ ·å°±éšè—äº†ä½ çš„<code>Bucket</code>åç§°ã€‚</p><h4 id="æ¸…é™¤å“åº”å¤´"><a href="#æ¸…é™¤å“åº”å¤´" class="headerlink" title="æ¸…é™¤å“åº”å¤´"></a>æ¸…é™¤å“åº”å¤´</h4><p>ç›¸åŒçš„é¡µé¢é€‰æ‹©<code>Modify Response header</code>é¡µç­¾ï¼Œæ·»åŠ ä¸€æ¡è§„åˆ™ï¼š</p><p><img src="https://image.seeyourface.cn/2023/12/image-20231201153943747.png" alt="image-20231201153943747"></p><p>å†æ·»åŠ ä¸€æ¡è§„åˆ™ï¼Œè®©ä½ çš„<code>URL</code>å¯ä»¥åœ¨å¤–éƒ¨ä»»æ„è®¿é—®ï¼š</p><p><img src="https://image.seeyourface.cn/2023/12/image-20231201154051058.png" alt="image-20231201154051058"></p><p><img src="https://image.seeyourface.cn/2023/12/image-20231201154115816.png" alt="image-20231201154115816"></p><h3 id="ç»“å°¾"><a href="#ç»“å°¾" class="headerlink" title="ç»“å°¾"></a>ç»“å°¾</h3><p>æ­å–œä½ ï¼Œä½ å·²ç»å®Œæˆæ‰€æœ‰æ“ä½œï¼Œå¯ä»¥æ„‰å¿«è®¿é—®ä½ çš„ç½‘ç«™äº†ï¼</p><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="https://www.backblaze.com/blog/free-image-hosting-with-cloudflare-transform-rules-and-backblaze-b2/#:~:text=Backblaze%20only%20supports%20secure%20HTTPS%20connections%2C%20so%20the,Backblaze%20via%20HTTPS%2C%20and%20requires%20a%20CA-issued%20certificate">https://www.backblaze.com/blog/free-image-hosting-with-cloudflare-transform-rules-and-backblaze-b2/#:~:text=Backblaze%20only%20supports%20secure%20HTTPS%20connections%2C%20so%20the,Backblaze%20via%20HTTPS%2C%20and%20requires%20a%20CA-issued%20certificate</a>.<a href="#fnref:1" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:2" class="footnote-text"><span><a href="https://developers.cloudflare.com/ssl/troubleshooting/too-many-redirects/">https://developers.cloudflare.com/ssl/troubleshooting/too-many-redirects/</a><a href="#fnref:2" rev="footnote" class="footnote-backref"> â†©</a></span></span></li></ol></div></section>]]></content>
    
    
    <categories>
      
      <category>ç½‘ç«™</category>
      
      <category>è¿ç§»</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CDN</tag>
      
      <tag>å›¾åºŠ</tag>
      
      <tag>DNS</tag>
      
      <tag>è¿ç§»</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¦‚ä½•ä¼˜é›…åˆ‡æ¢è”è¡¨æŸ¥è¯¢è¡¨æ ¼æ‰€ä½¿ç”¨çš„Schema</title>
    <link href="/2023/11/16/%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E5%88%87%E6%8D%A2%E8%81%94%E8%A1%A8%E6%9F%A5%E8%AF%A2%E8%A1%A8%E6%A0%BC%E6%89%80%E4%BD%BF%E7%94%A8%E7%9A%84Schema/"/>
    <url>/2023/11/16/%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E5%88%87%E6%8D%A2%E8%81%94%E8%A1%A8%E6%9F%A5%E8%AF%A2%E8%A1%A8%E6%A0%BC%E6%89%80%E4%BD%BF%E7%94%A8%E7%9A%84Schema/</url>
    
    <content type="html"><![CDATA[<h3 id="åºè¨€"><a href="#åºè¨€" class="headerlink" title="åºè¨€"></a>åºè¨€</h3><p>å‰é¢æåˆ°è¿‡é€šè¿‡åŠ¨æ€æ•°æ®æºå®ç°å¤šä¸ªæ•°æ®æºä¹‹é—´çš„è¿æ¥ï¼Œæœ¬ä»¥ä¸ºèƒ½å¤Ÿå®ç°æˆ‘çš„å¤šç‰ˆæœ¬çŸ¥è¯†åº“åˆ‡æ¢éœ€æ±‚ã€‚</p><p>ä½†æ˜¯ï¼å¦‚æœä¸å‡ºæ„å¤–è‚¯å®šå°±è¦å‡ºæ„å¤–äº†ï¼</p><p>é¡¹ç›®ä¸­å­˜åœ¨å¤§é‡è”è¡¨æŸ¥è¯¢è¯­å¥ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">from</span> t1<br>         <span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span> t2 <span class="hljs-keyword">on</span> t1.template_id <span class="hljs-operator">=</span> t2.id<br>         <span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span> t3 <span class="hljs-keyword">on</span> t3.template_id <span class="hljs-operator">=</span> t2.id;<br></code></pre></td></tr></table></figure><p>å¯¹äºçŸ¥è¯†åº“ç‰ˆæœ¬çš„åˆ‡æ¢éœ€æ±‚ï¼Œ<code>t2</code>ã€<code>t3</code> æ˜¯çŸ¥è¯†åº“ä¸­çš„è¡¨ï¼Œå®ƒä»¬éœ€è¦æ ¹æ®çŸ¥è¯†åº“çš„æ›´æ–°è€Œä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„è¡¨ï¼Œè€Œ <code>t1</code> åˆ™æ˜¯é¡¹ç›®ä¸­çš„ä¸»è¡¨ï¼ˆå¯ä»¥ç†è§£ä¸ºä½œä¸šè¡¨ï¼‰ã€‚</p><p>å¦‚æœä½¿ç”¨åŠ¨æ€æ•°æ®æºçš„æ–¹å¼æ¥å®ç°è¿™ä¸ªéœ€æ±‚ï¼Œå› ä¸ºåŠ¨æ€æ•°æ®æºåˆ‡æ¢è¿æ¥æ—¶æ•´ä¸ª <code>sql</code> æ‰€å¤„çš„ç¯å¢ƒéƒ½ä¼šè¢«åˆ‡æ¢ï¼Œæ‰€ä»¥å°±éœ€è¦å°†é¡¹ç›®ä¸­æ‰€æœ‰è¿™ç§è”è¡¨æŸ¥è¯¢ç»™æ‹†å‡ºæ¥ï¼Œå®¹æ˜“é—æ¼ä¸è¯´ï¼Œè¿˜ååˆ†éº»çƒ¦ã€‚</p><p>é€šè¿‡å¤šæ•°æ®æºæ¥å®ç°çŸ¥è¯†ç‰ˆæœ¬åº“çš„åˆ‡æ¢è¡Œä¸é€šï¼Œé‚£æˆ‘ä»¬å¯ä»¥å°è¯•é€šè¿‡å¤š <code>Schema</code> æ¥å®ç°ï¼Œå› ä¸º <code>SQL</code> æ˜¯å¯ä»¥è·¨ <code>Schema</code> æ‰§è¡Œçš„ã€‚</p><p>æ‰€ä»¥æœ€ç»ˆçš„æ–¹æ¡ˆä¸»ä½“é€»è¾‘ä¸ºï¼š</p><ul><li>å®¢æˆ·ç«¯æ–°å»ºä½œä¸šæ—¶ç»‘å®šçŸ¥è¯†åº“ç‰ˆæœ¬</li><li>å®¢æˆ·ç«¯æ›´æ–°çŸ¥è¯†åº“æ—¶ï¼Œæ–°å»ºä¸€ä¸ª <code>Schema</code> ä¿å­˜æ–°ç‰ˆæœ¬çš„çŸ¥è¯†åº“è¡¨</li><li>æ‰§è¡Œ <code>SQL</code> æ—¶æ ¹æ®ä½œä¸š <code>id</code> è·å–å¯¹åº”çŸ¥è¯†åº“ç‰ˆæœ¬ï¼Œå°†æŸ¥è¯¢è¡¨æ›¿æ¢ä¸ºæŒ‡å®š <code>Schema</code> ä¸­çš„è¡¨</li></ul><h3 id="æœåŠ¡ç«¯è°ƒæ•´"><a href="#æœåŠ¡ç«¯è°ƒæ•´" class="headerlink" title="æœåŠ¡ç«¯è°ƒæ•´"></a>æœåŠ¡ç«¯è°ƒæ•´</h3><p>ç›¸è¾ƒäºåŸæ¥å¤‡ä»½æ—¶çš„ <code>TRUNCATE TABLE</code> å‘½ä»¤ï¼Œè°ƒæ•´ä¸ºæœåŠ¡ç«¯ç»™å½“å‰çŸ¥è¯†åº“ç‰ˆæœ¬æ‰“æ ‡ç­¾æ—¶ï¼Œå¤‡ä»½å‡ºå½“å‰çŸ¥è¯†åº“è¡¨å’Œæ•°æ®ï¼Œå¹¶æ·»åŠ åˆ›å»º <code>Schema</code> å‘½ä»¤ã€‚</p><h4 id="ç»„è£…SQL"><a href="#ç»„è£…SQL" class="headerlink" title="ç»„è£…SQL"></a>ç»„è£…SQL</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-variable">@Slf4j</span><br><span class="hljs-variable">@Component</span><br><span class="hljs-variable">@RequiredArgsConstructor</span><br>public class LibraryDumpHandler &#123;<br>    private <span class="hljs-keyword">final</span> Environment environment;<br>    private <span class="hljs-keyword">final</span> DcasProperties properties;<br><br>    <span class="hljs-operator">/</span><span class="hljs-operator">/</span> æ ¸å¿ƒçº¿ç¨‹æ•°<br>    private <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> CORE_THREADS <span class="hljs-operator">=</span> Runtime.getRuntime().availableProcessors() <span class="hljs-operator">+</span> <span class="hljs-number">1</span>;<br>    private <span class="hljs-keyword">final</span> ReentrantLock mainLock <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> ReentrantLock();<br><br>    public String dump(String version) &#123;<br>        mainLock.lock();<br>        ExecutorService executorService <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> ThreadPoolExecutor(<br>                CORE_THREADS, CORE_THREADS,<br>                <span class="hljs-number">0</span>,<br>                TimeUnit.MILLISECONDS,<br>                <span class="hljs-keyword">new</span> LinkedBlockingQueue<span class="hljs-operator">&lt;&gt;</span>(<span class="hljs-number">100</span>),<br>                <span class="hljs-keyword">new</span> ThreadFactoryBuilder().setNameFormat(&quot;dump-async-name-%d&quot;).setDaemon(<span class="hljs-literal">true</span>).build());<br>        try &#123;<br>            <span class="hljs-keyword">Set</span><span class="hljs-operator">&lt;</span>TableBean<span class="hljs-operator">&gt;</span> tableBeans <span class="hljs-operator">=</span> buildDumpTables();<br>            <span class="hljs-keyword">final</span> DataSource dataSource <span class="hljs-operator">=</span> getDataSource();<br>            Assert.notEmpty(tableBeans);<br>            <span class="hljs-operator">/</span><span class="hljs-operator">/</span> åˆ›å»ºå¼‚æ­¥ä»»åŠ¡å¹¶ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± æ‰§è¡Œ<br>            List<span class="hljs-operator">&lt;</span>CompletableFuture<span class="hljs-operator">&lt;</span>StrBuilder<span class="hljs-operator">&gt;&gt;</span> futureList <span class="hljs-operator">=</span> tableBeans.stream().map(bean <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span><br>                    CompletableFuture.supplyAsync(() <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> tableDump(dataSource, bean, version), executorService)<br>            ).<span class="hljs-keyword">collect</span>(Collectors.toList());<br>            CompletableFuture<span class="hljs-operator">&lt;</span>Void<span class="hljs-operator">&gt;</span> allFutures <span class="hljs-operator">=</span> CompletableFuture.allOf(futureList.toArray(<span class="hljs-keyword">new</span> CompletableFuture[<span class="hljs-number">0</span>]));<br>            <span class="hljs-operator">/</span><span class="hljs-operator">/</span> ç­‰å¾…æ‰€æœ‰å¼‚æ­¥ä»»åŠ¡å®Œæˆ<br>            allFutures.join();<br>            <span class="hljs-operator">/</span><span class="hljs-operator">/</span> åˆå¹¶æ‰€æœ‰å¼‚æ­¥ä»»åŠ¡ç»“æœ<br>            CompletableFuture<span class="hljs-operator">&lt;</span>StrBuilder<span class="hljs-operator">&gt;</span> mergedFuture <span class="hljs-operator">=</span> allFutures.thenApply(voidResult <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> &#123;<br>                StrBuilder mergedResult <span class="hljs-operator">=</span> StrBuilder.create();<br>                <span class="hljs-keyword">for</span> (CompletableFuture<span class="hljs-operator">&lt;</span>StrBuilder<span class="hljs-operator">&gt;</span> future : futureList) &#123;<br>                    try &#123;<br>                        mergedResult.append(future.get());<br>                    &#125; catch (InterruptedException <span class="hljs-operator">|</span> ExecutionException e) &#123;<br>                        log.error(e.getMessage());<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">return</span> mergedResult;<br>            &#125;);<br>            StrBuilder tableSqlBuilder <span class="hljs-operator">=</span> mergedFuture.get();<br>            <span class="hljs-operator">/</span><span class="hljs-operator">/</span> åˆ›å»ºschema <span class="hljs-keyword">sql</span><br>            StrBuilder schemaSqlBuilder <span class="hljs-operator">=</span> schemaBuilder(version);<br>            StrBuilder sqlBuilder <span class="hljs-operator">=</span> schemaSqlBuilder.append(StrUtil.LF).append(StrUtil.LF).append(tableSqlBuilder);<br>            <span class="hljs-operator">/</span><span class="hljs-operator">/</span> å¯¼å‡ºæ–‡ä»¶<br>            String path <span class="hljs-operator">=</span> properties.getDumpPath();<br>            FileUtil.mkdir(path);<br>            String fileName <span class="hljs-operator">=</span> String.format(&quot;contentLibrary-%s.sql&quot;, version);<br>            String absolutePath <span class="hljs-operator">=</span> Func.wrapFilePath(path) <span class="hljs-operator">+</span> fileName;<br>            File file <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> File(absolutePath);<br>            FileWriter sqlFile <span class="hljs-operator">=</span> FileWriter.create(file);<br>            sqlFile.write(sqlBuilder.toString());<br><br>            <span class="hljs-operator">/</span><span class="hljs-operator">/</span> å‰é¢çš„æ­¥éª¤æ­£å¸¸æ‰§è¡Œå†æ‰“åŒ…å›¾ç‰‡ã€<span class="hljs-keyword">sql</span>æƒé™æŸ¥è¯¢æ–‡ä»¶<br>            CompletableFuture.supplyAsync(() <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> zipFolder(properties.getSqlPath(), properties.getDumpPath(),&quot;sql.zip&quot;), executorService);<br>            CompletableFuture.supplyAsync(() <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> zipFolder(properties.getImagePath(), properties.getDumpPath(),&quot;images.zip&quot;), executorService);<br><br>            <span class="hljs-keyword">return</span> absolutePath;<br>        &#125; catch (Exception e) &#123;<br>            throw <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125; finally &#123;<br>            executorService.shutdown();<br>            mainLock.unlock();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ‰“åŒ…æ–‡ä»¶</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * @param targetPath éœ€è¦æ‰“åŒ…çš„æ–‡ä»¶ç›®å½•</span><br><span class="hljs-comment">     * @param destPath å‹ç¼©æ–‡ä»¶å­˜æ”¾è·¯å¾„</span><br><span class="hljs-comment">     * @param zipName å‹ç¼©æ–‡ä»¶å</span><br><span class="hljs-comment">     */</span><br>    private String zipFolder(String targetPath, String destPath, String zipName) &#123;<br>        FileUtil.mkdir(targetPath);<br>        log.info(&quot;[çŸ¥è¯†åº“å¤‡ä»½] å¼€å§‹å¤‡ä»½æ–‡ä»¶å¤¹ï¼Œpath:&#123;&#125;&quot;, targetPath);<br>        try (FileOutputStream fos <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> FileOutputStream(destPath <span class="hljs-operator">+</span> StrUtil.SLASH <span class="hljs-operator">+</span> zipName);<br>             ZipOutputStream zos <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> ZipOutputStream(fos)) &#123;<br>            <span class="hljs-operator">/</span><span class="hljs-operator">/</span> addTemplate files <span class="hljs-keyword">to</span> the ZIP file<br>            File directory <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> File(targetPath);<br>            File[] files <span class="hljs-operator">=</span> directory.listFiles();<br>            if (Objects.isNull(files) <span class="hljs-operator">||</span> files.length <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">0</span>) &#123;<br>                log.info(&quot;[çŸ¥è¯†åº“å¤‡ä»½] æ— éœ€å¤‡ä»½æ–‡ä»¶ï¼ŒtargetPath:&#123;&#125;&quot;, targetPath);<br>                <span class="hljs-keyword">return</span> zipName;<br>            &#125;<br>            <span class="hljs-keyword">for</span> (File file : files) &#123;<br>                if (<span class="hljs-operator">!</span>file.isDirectory()) &#123;<br>                    ZipEntry zipEntry <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> ZipEntry(file.getName());<br>                    zos.putNextEntry(zipEntry);<br><br>                    FileInputStream fis <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> FileInputStream(file);<br>                    byte[] buffer <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> byte[<span class="hljs-number">4096</span>];<br>                    <span class="hljs-type">int</span> length;<br>                    while ((length <span class="hljs-operator">=</span> fis.read(buffer)) <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>) &#123;<br>                        zos.write(buffer, <span class="hljs-number">0</span>, length);<br>                    &#125;<br>                    fis.close();<br>                    zos.closeEntry();<br>                    log.info(&quot;[çŸ¥è¯†åº“å¤‡ä»½] æ–‡ä»¶&#123;&#125;å¯¼å‡ºæˆåŠŸ&quot;, file.getName());<br>                &#125;<br>            &#125;<br>        &#125; catch (IOException ex) &#123;<br>           log.error(&quot;Error creating ZIP file: &#123;&#125;&quot;, ex.getMessage());<br>        &#125;<br>        <span class="hljs-keyword">return</span> zipName;<br>    &#125;<br><br>    <span class="hljs-operator">/</span><span class="hljs-operator">/</span> åˆ›å»º Schema<br>    private StrBuilder schemaBuilder(String schema) &#123;<br>        StrBuilder sqlBuilder <span class="hljs-operator">=</span> StrBuilder.create();<br>        sqlBuilder.append(&quot;CREATE SCHEMA IF NOT EXISTS &quot;).append(&quot;\&quot;&quot;).append(schema).append(&quot;\&quot;&quot;).append(CommonConst.SEMICOLON);<br>        <span class="hljs-keyword">return</span> sqlBuilder;<br>    &#125;<br><br>    private StrBuilder tableDump(DataSource ds, TableBean <span class="hljs-keyword">table</span>, String schema) &#123;<br>        Db db <span class="hljs-operator">=</span> DbUtil.use(ds);<br>        StrBuilder sqlBuilder <span class="hljs-operator">=</span> StrBuilder.create();<br>        try &#123;<br>            String tableName <span class="hljs-operator">=</span> table.getTableName();<br>            if (table.isNeedTruncate()) &#123;<br>                sqlBuilder.append(&quot;TRUNCATE &quot;).append(schema).append(StrUtil.DOT).append(tableName);<br>                sqlBuilder.append(CommonConst.SEMICOLON <span class="hljs-operator">+</span> StrUtil.LF);<br>            &#125;<br>            if (table.isNeedCreate()) &#123;<br>                <span class="hljs-operator">/</span><span class="hljs-operator">/</span> è¿™é‡Œæ³¨æ„ï¼Œç”±äºé¡¹ç›®ä½¿ç”¨çš„æ˜¯Pgsqlï¼Œæ²¡æœ‰MySQLé‚£ç§<span class="hljs-keyword">show</span> <span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span>å‘½ä»¤ï¼Œæ‰€ä»¥è‡ªå®šä¹‰äº†ä¸€ä¸ªå‘½ä»¤æ ¹æ®è¡¨åè·å–å»ºè¡¨è¯­å¥<br>                Entity createEntity <span class="hljs-operator">=</span> db.queryOne(&quot;SELECT show_create_table(&#x27;&quot; <span class="hljs-operator">+</span> tableName <span class="hljs-operator">+</span> &quot;&#x27;)&quot;);<br>                String showCreateTable <span class="hljs-operator">=</span> (String) createEntity.get(&quot;show_create_table&quot;);<br>                String oldTable <span class="hljs-operator">=</span> &quot;\&quot;&quot; + tableName + &quot;\&quot;&quot;;<br>                String newTable <span class="hljs-operator">=</span> &quot;\&quot;&quot; + schema + &quot;\&quot;.\&quot;&quot; + tableName + &quot;\&quot;&quot;;<br>                String createTableSql <span class="hljs-operator">=</span> StrUtil.replace(showCreateTable, oldTable, newTable);<br>                sqlBuilder.append(createTableSql);<br>                sqlBuilder.append(StrUtil.LF);<br>            &#125;<br>            if (table.isNeedInsert()) &#123;<br>                List<span class="hljs-operator">&lt;</span>Entity<span class="hljs-operator">&gt;</span> dataEntities <span class="hljs-operator">=</span> db.query(&quot;SELECT * FROM &quot; <span class="hljs-operator">+</span> tableName);<br>                <span class="hljs-keyword">for</span> (Entity dataEntity : dataEntities) &#123;<br>                    StrBuilder field <span class="hljs-operator">=</span> StrBuilder.create();<br>                    StrBuilder data <span class="hljs-operator">=</span> StrBuilder.create();<br>                    dataEntity.forEach((fieldName, fieldValue) <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> &#123;<br>                        String valueStr <span class="hljs-operator">=</span> StrUtil.toStringOrNull(fieldValue);<br>                        field.append(fieldName).append(&quot;, &quot;);<br>                        if (ObjectUtil.isNotNull(valueStr)) &#123;<br>                            <span class="hljs-operator">/</span><span class="hljs-operator">/</span> å€¼åŒ…å« <span class="hljs-string">&#x27; è½¬ä¹‰å¤„ç†</span><br><span class="hljs-string">                            valueStr = StrUtil.replace(valueStr, &quot;&#x27;</span>&quot;, &quot;<span class="hljs-string">&#x27;&#x27;</span>&quot;);<br>                            data.append(&quot;<span class="hljs-string">&#x27;&quot;).append(valueStr).append(&quot;&#x27;</span>&quot;);<br>                        &#125; else &#123;<br>                            data.append(&quot;<span class="hljs-keyword">NULL</span>&quot;);<br>                        &#125;<br>                        data.append(&quot;, &quot;);<br>                    &#125;);<br><br>                    sqlBuilder.append(&quot;<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> &quot;).append(&quot;\&quot;&quot;).append(schema).append(&quot;\&quot;&quot;).append(StrUtil.DOT).append(tableName).append(&quot;(&quot;);<br>                    // å»æ‰æœ€åçš„é€—å·å’Œç©ºæ ¼<br>                    String fieldStr = field.subString(0, field.length() - 2);<br>                    sqlBuilder.append(fieldStr);<br>                    sqlBuilder.append(&quot;) <span class="hljs-keyword">VALUES</span> (&quot;);<br>                    String dataStr = data.subString(0, data.length() - 2);<br>                    sqlBuilder.append(dataStr);<br>                    sqlBuilder.append(&quot;);&quot;);<br>                    sqlBuilder.append(StrUtil.LF);<br>                &#125;<br>            &#125;<br>            sqlBuilder.append(StrUtil.LF);<br>            sqlBuilder.append(StrUtil.LF);<br>            sqlBuilder.append(StrUtil.LF);<br>        &#125; catch (SQLException e) &#123;<br>            log.error(&quot;æ•°æ®è¡¨&#123;&#125;å¯¼å‡ºå¤±è´¥ï¼Œmsg:&#123;&#125;&quot;, table.getTableName(), e.getMessage());<br>            throw new RuntimeException(e);<br>        &#125;<br>        log.debug(&quot;æ•°æ®è¡¨&#123;&#125;å¯¼å‡ºæˆåŠŸ&quot;, table.getTableName());<br>        return sqlBuilder;<br>    &#125;<br><br>    // è·å–ç³»ç»Ÿæ•°æ®æº<br>    private DataSource getDataSource() &#123;<br>        DataSource ds;<br>        Assert.notNull(properties);<br>        try &#123;<br>            // ä¼˜å…ˆä½¿ç”¨db.settingé…ç½®<br>            ds = DSFactory.get();<br>        &#125; catch (Exception e) &#123;<br>            // é€šè¿‡è‡ªå·±çš„é…ç½®åˆ›å»ºæ•°æ®æºè¿æ¥æ± <br>            Setting setting = new Setting();<br>            setting.put(&quot;url&quot;, environment.getProperty(&quot;spring.datasource.url&quot;));<br>            setting.put(&quot;username&quot;, environment.getProperty(&quot;spring.datasource.username&quot;));<br>            setting.put(&quot;password&quot;, environment.getProperty(&quot;spring.datasource.password&quot;));<br>            try &#123;<br>                DSFactory dsFactory = DSFactory.create(setting);<br>                // è®¾ç½®å…¨å±€æ•°æ®æºå·¥å‚ï¼Œä¸‹æ¬¡è·å–æ— éœ€é‡æ–°åˆ›å»º<br>                DSFactory.setCurrentDSFactory(dsFactory);<br>                return DSFactory.get();<br>            &#125; catch (Exception ex) &#123;<br>                log.error(&quot;é€šè¿‡é…ç½®åˆ›å»ºæ•°æ®æºå¤±è´¥&quot;);<br>                throw new RuntimeException(ex);<br>            &#125;<br>        &#125;<br>        return ds;<br>    &#125;<br><br>    // ä»é¡¹ç›®é…ç½®æ–‡ä»¶ä¸­è·å–éœ€è¦å¤‡ä»½çš„è¡¨å°è£…æˆBean<br>    private Set&lt;TableBean&gt; buildDumpTables() &#123;<br>        SqlDumpProperties sqlDumpProperties = properties.getSqlDump();<br>        Assert.notNull(sqlDumpProperties);<br>        return Arrays.stream(sqlDumpProperties.getTables().split(StrUtil.COMMA)).map(table -&gt;<br>            TableBean.builder()<br>                    .tableName(table.trim())<br>                    .needCreate(sqlDumpProperties.isCreate())<br>                    .needInsert(sqlDumpProperties.isInsert())<br>                    .needTruncate(sqlDumpProperties.isTruncate())<br>                    .build()<br>        ).collect(Collectors.toSet());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="è‡ªå®šä¹‰æŸ¥è¯¢PGSQLå»ºè¡¨æ–¹æ³•"><a href="#è‡ªå®šä¹‰æŸ¥è¯¢PGSQLå»ºè¡¨æ–¹æ³•" class="headerlink" title="è‡ªå®šä¹‰æŸ¥è¯¢PGSQLå»ºè¡¨æ–¹æ³•"></a>è‡ªå®šä¹‰æŸ¥è¯¢PGSQLå»ºè¡¨æ–¹æ³•</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">function</span> show_create_table(in_table_name <span class="hljs-type">character</span> <span class="hljs-type">varying</span>) <span class="hljs-keyword">returns</span> text<br>    <span class="hljs-keyword">language</span> plpgsql<br><span class="hljs-keyword">as</span><br>$$<br><span class="hljs-keyword">DECLARE</span><br>    <span class="hljs-comment">-- the ddl we&#x27;re building</span><br>    v_table_ddl text;<br><br>    <span class="hljs-comment">-- data about the target table</span><br>    v_table_oid <span class="hljs-type">int</span>;<br><br>    v_table_type <span class="hljs-type">char</span>;<br>    v_partition_key <span class="hljs-type">varchar</span>;<br>    v_namespace <span class="hljs-type">varchar</span>;<br>    v_table_comment <span class="hljs-type">varchar</span>;<br><br>    <span class="hljs-comment">-- records for looping</span><br>    v_column_record record;<br>    v_constraint_record record;<br>    v_index_record record;<br>    v_column_comment_record record;<br>    v_index_comment_record record;<br>    v_constraint_comment_record record;<br><span class="hljs-keyword">BEGIN</span><br>    <span class="hljs-comment">-- grab the oid of the table;</span><br><span class="hljs-keyword">SELECT</span> c.oid, c.relkind, n.nspname <span class="hljs-keyword">INTO</span> v_table_oid, v_table_type, v_namespace<br><span class="hljs-keyword">FROM</span> pg_catalog.pg_class c<br>         <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> pg_catalog.pg_namespace n <span class="hljs-keyword">ON</span> n.oid <span class="hljs-operator">=</span> c.relnamespace<br><span class="hljs-keyword">WHERE</span> c.relkind <span class="hljs-keyword">in</span> (<span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;p&#x27;</span>)<br>  <span class="hljs-keyword">AND</span> c.relname <span class="hljs-operator">=</span> in_table_name <span class="hljs-comment">-- the table name</span><br>  <span class="hljs-keyword">AND</span> pg_catalog.pg_table_is_visible(c.oid); <span class="hljs-comment">-- the schema</span><br><br><span class="hljs-comment">-- throw an error if table was not found</span><br>IF (v_table_oid <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>) <span class="hljs-keyword">THEN</span><br>        RAISE EXCEPTION <span class="hljs-string">&#x27;table does not exist&#x27;</span>;<br><span class="hljs-keyword">END</span> IF;<br><br>    <span class="hljs-comment">-- start the create definition</span><br>    v_table_ddl :<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;CREATE TABLE &quot;&#x27;</span> <span class="hljs-operator">||</span> in_table_name <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;&quot; (&#x27;</span> <span class="hljs-operator">||</span> E<span class="hljs-string">&#x27;\n&#x27;</span>;<br><br>    <span class="hljs-comment">-- define all of the columns in the table;</span><br><span class="hljs-keyword">FOR</span> v_column_record <span class="hljs-keyword">IN</span><br><span class="hljs-keyword">SELECT</span><br>    c.column_name,<br>    c.data_type,<br>    c.character_maximum_length,<br>    c.is_nullable,<br>    c.column_default<br><span class="hljs-keyword">FROM</span> information_schema.columns c<br><span class="hljs-keyword">WHERE</span> table_name <span class="hljs-operator">=</span> in_table_name <span class="hljs-keyword">and</span> table_schema <span class="hljs-operator">=</span> v_namespace<br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ordinal_position<br>    LOOP<br>            v_table_ddl :<span class="hljs-operator">=</span> v_table_ddl <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;  &#x27;</span> <span class="hljs-comment">-- <span class="hljs-doctag">note:</span> two char spacer to start, to indent the column</span><br>                               <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;&quot;&#x27;</span> <span class="hljs-operator">||</span> v_column_record.column_name <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;&quot; &#x27;</span><br>                               <span class="hljs-operator">||</span> v_column_record.data_type <span class="hljs-operator">||</span> <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> v_column_record.character_maximum_length <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">THEN</span> (<span class="hljs-string">&#x27;(&#x27;</span> <span class="hljs-operator">||</span> v_column_record.character_maximum_length <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;)&#x27;</span>) <span class="hljs-keyword">ELSE</span> <span class="hljs-string">&#x27;&#x27;</span> <span class="hljs-keyword">END</span> <span class="hljs-operator">||</span> <span class="hljs-string">&#x27; &#x27;</span><br>                               <span class="hljs-operator">||</span> <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> v_column_record.is_nullable <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;NO&#x27;</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27;NOT NULL&#x27;</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-string">&#x27;NULL&#x27;</span> <span class="hljs-keyword">END</span><br>                               <span class="hljs-operator">||</span> <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> v_column_record.column_default <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">THEN</span> (<span class="hljs-string">&#x27; DEFAULT &#x27;</span> <span class="hljs-operator">||</span> v_column_record.column_default) <span class="hljs-keyword">ELSE</span> <span class="hljs-string">&#x27;&#x27;</span> <span class="hljs-keyword">END</span><br>                               <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;,&#x27;</span> <span class="hljs-operator">||</span> E<span class="hljs-string">&#x27;\n&#x27;</span>;<br><span class="hljs-keyword">END</span> LOOP;<br><br>    <span class="hljs-comment">-- define all the constraints in the;</span><br><span class="hljs-keyword">FOR</span> v_constraint_record <span class="hljs-keyword">IN</span><br><span class="hljs-keyword">SELECT</span><br>    con.conname <span class="hljs-keyword">as</span> constraint_name,<br>    con.contype <span class="hljs-keyword">as</span> constraint_type,<br>    <span class="hljs-keyword">CASE</span><br>        <span class="hljs-keyword">WHEN</span> con.contype <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;p&#x27;</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-comment">-- primary key constraint</span><br>        <span class="hljs-keyword">WHEN</span> con.contype <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;u&#x27;</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">2</span> <span class="hljs-comment">-- unique constraint</span><br>        <span class="hljs-keyword">WHEN</span> con.contype <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;f&#x27;</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">3</span> <span class="hljs-comment">-- foreign key constraint</span><br>        <span class="hljs-keyword">WHEN</span> con.contype <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;c&#x27;</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">4</span><br>        <span class="hljs-keyword">ELSE</span> <span class="hljs-number">5</span><br>        <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> type_rank,<br>    pg_get_constraintdef(con.oid) <span class="hljs-keyword">as</span> constraint_definition<br><span class="hljs-keyword">FROM</span> pg_catalog.pg_constraint con<br>         <span class="hljs-keyword">JOIN</span> pg_catalog.pg_class rel <span class="hljs-keyword">ON</span> rel.oid <span class="hljs-operator">=</span> con.conrelid<br>         <span class="hljs-keyword">JOIN</span> pg_catalog.pg_namespace nsp <span class="hljs-keyword">ON</span> nsp.oid <span class="hljs-operator">=</span> connamespace<br><span class="hljs-keyword">WHERE</span> rel.relname <span class="hljs-operator">=</span> in_table_name<br>  <span class="hljs-keyword">AND</span> pg_catalog.pg_table_is_visible(rel.oid)<br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> type_rank<br>    LOOP<br>            IF v_constraint_record.constraint_type <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;p&#x27;</span> <span class="hljs-keyword">THEN</span><br>                v_table_ddl :<span class="hljs-operator">=</span> v_table_ddl <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;  &#x27;</span><br>                                   <span class="hljs-operator">||</span> v_constraint_record.constraint_definition<br>                                   <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;,&#x27;</span> <span class="hljs-operator">||</span> E<span class="hljs-string">&#x27;\n&#x27;</span>;<br><span class="hljs-keyword">ELSE</span><br>                v_table_ddl :<span class="hljs-operator">=</span> v_table_ddl <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;  &#x27;</span> <span class="hljs-comment">-- <span class="hljs-doctag">note:</span> two char spacer to start, to indent the column</span><br>                                   <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;CONSTRAINT&#x27;</span> <span class="hljs-operator">||</span> <span class="hljs-string">&#x27; &#x27;</span><br>                                   <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;&quot;&#x27;</span> <span class="hljs-operator">||</span> v_constraint_record.constraint_name <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;&quot; &#x27;</span><br>                                   <span class="hljs-operator">||</span> v_constraint_record.constraint_definition<br>                                   <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;,&#x27;</span> <span class="hljs-operator">||</span> E<span class="hljs-string">&#x27;\n&#x27;</span>;<br><span class="hljs-keyword">END</span> IF;<br><span class="hljs-keyword">END</span> LOOP;<br><br>    <span class="hljs-comment">-- drop the last comma before ending the create statement</span><br>    v_table_ddl <span class="hljs-operator">=</span> substr(v_table_ddl, <span class="hljs-number">0</span>, length(v_table_ddl) <span class="hljs-operator">-</span> <span class="hljs-number">1</span>) <span class="hljs-operator">||</span> E<span class="hljs-string">&#x27;\n&#x27;</span>;<br><br>    <span class="hljs-comment">-- end the create definition</span><br>    v_table_ddl :<span class="hljs-operator">=</span> v_table_ddl <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;)&#x27;</span>;<br><br>    IF v_table_type <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;p&#x27;</span> <span class="hljs-keyword">THEN</span><br><span class="hljs-keyword">SELECT</span> pg_get_partkeydef(v_table_oid) <span class="hljs-keyword">INTO</span> v_partition_key;<br>IF v_partition_key <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">THEN</span><br>            v_table_ddl :<span class="hljs-operator">=</span> v_table_ddl <span class="hljs-operator">||</span> <span class="hljs-string">&#x27; PARTITION BY &#x27;</span> <span class="hljs-operator">||</span> v_partition_key;<br><span class="hljs-keyword">END</span> IF;<br><span class="hljs-keyword">END</span> IF;<br><br>    v_table_ddl :<span class="hljs-operator">=</span> v_table_ddl <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;;&#x27;</span> <span class="hljs-operator">||</span> E<span class="hljs-string">&#x27;\n&#x27;</span>;<br><br>    <span class="hljs-comment">-- suffix create statement with all of the indexes on the table</span><br><span class="hljs-keyword">FOR</span> v_index_record <span class="hljs-keyword">IN</span><br><span class="hljs-keyword">SELECT</span> regexp_replace(idx.indexdef, <span class="hljs-string">&#x27; &quot;?&#x27;</span> <span class="hljs-operator">||</span> idx.schemaname <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;&quot;?\.&#x27;</span> <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;&quot;?&#x27;</span> <span class="hljs-operator">||</span> idx.tablename <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;&quot;?&#x27;</span>, <span class="hljs-string">&#x27; &quot;&#x27;</span> <span class="hljs-operator">||</span> idx.tablename <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;&quot; &#x27;</span>) <span class="hljs-keyword">AS</span> indexdef<br><span class="hljs-keyword">FROM</span> pg_indexes idx<br>         <span class="hljs-keyword">JOIN</span> (<br>    <span class="hljs-keyword">SELECT</span> ns.nspname, cls.relname<br>    <span class="hljs-keyword">FROM</span> pg_catalog.pg_class cls<br>             <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> pg_catalog.pg_namespace ns <span class="hljs-keyword">ON</span> ns.oid <span class="hljs-operator">=</span> cls.relnamespace<br>    <span class="hljs-keyword">WHERE</span> pg_catalog.pg_table_is_visible(cls.oid)<br>) t <span class="hljs-keyword">ON</span> idx.schemaname <span class="hljs-operator">=</span> t.nspname <span class="hljs-keyword">AND</span> idx.tablename <span class="hljs-operator">=</span> t.relname<br><span class="hljs-keyword">WHERE</span> idx.tablename <span class="hljs-operator">=</span> in_table_name<br>  <span class="hljs-keyword">AND</span> idx.indexname <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (<br>    <span class="hljs-keyword">select</span> con.conname<br>    <span class="hljs-keyword">FROM</span> pg_catalog.pg_constraint con<br>             <span class="hljs-keyword">JOIN</span> pg_catalog.pg_class rel <span class="hljs-keyword">ON</span> rel.oid <span class="hljs-operator">=</span> con.conrelid<br>             <span class="hljs-keyword">JOIN</span> pg_catalog.pg_namespace nsp <span class="hljs-keyword">ON</span> nsp.oid <span class="hljs-operator">=</span> connamespace<br>    <span class="hljs-keyword">WHERE</span> rel.relname <span class="hljs-operator">=</span> in_table_name<br>      <span class="hljs-keyword">AND</span> pg_catalog.pg_table_is_visible(rel.oid)<br>)<br>    LOOP<br>            v_table_ddl :<span class="hljs-operator">=</span> v_table_ddl<br>                               <span class="hljs-operator">||</span> v_index_record.indexdef<br>                               <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;;&#x27;</span> <span class="hljs-operator">||</span> E<span class="hljs-string">&#x27;\n&#x27;</span>;<br><span class="hljs-keyword">END</span> LOOP;<br><br>    <span class="hljs-comment">-- comment on table</span><br><span class="hljs-keyword">SELECT</span> description <span class="hljs-keyword">INTO</span> v_table_comment<br><span class="hljs-keyword">FROM</span> pg_catalog.pg_description<br><span class="hljs-keyword">WHERE</span> objoid <span class="hljs-operator">=</span> v_table_oid <span class="hljs-keyword">AND</span> objsubid <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>IF v_table_comment <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">THEN</span><br>        v_table_ddl :<span class="hljs-operator">=</span> v_table_ddl <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;COMMENT ON TABLE &quot;&#x27;</span> <span class="hljs-operator">||</span> in_table_name <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;&quot; IS &#x27;&#x27;&#x27;</span> <span class="hljs-operator">||</span> replace(v_table_comment, <span class="hljs-string">&#x27;&#x27;&#x27;&#x27;</span>, <span class="hljs-string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span>) <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;&#x27;&#x27;;&#x27;</span> <span class="hljs-operator">||</span> E<span class="hljs-string">&#x27;\n&#x27;</span>;<br><span class="hljs-keyword">END</span> IF;<br><br>    <span class="hljs-comment">-- comment on column</span><br><span class="hljs-keyword">FOR</span> v_column_comment_record <span class="hljs-keyword">IN</span><br><span class="hljs-keyword">SELECT</span> col.column_name, d.description<br><span class="hljs-keyword">FROM</span> information_schema.columns col<br>         <span class="hljs-keyword">JOIN</span> pg_catalog.pg_class c <span class="hljs-keyword">ON</span> c.relname <span class="hljs-operator">=</span> col.table_name<br>         <span class="hljs-keyword">JOIN</span> pg_catalog.pg_namespace nsp <span class="hljs-keyword">ON</span> nsp.oid <span class="hljs-operator">=</span> c.relnamespace <span class="hljs-keyword">AND</span> col.table_schema <span class="hljs-operator">=</span> nsp.nspname<br>         <span class="hljs-keyword">JOIN</span> pg_catalog.pg_description d <span class="hljs-keyword">ON</span> d.objoid <span class="hljs-operator">=</span> c.oid <span class="hljs-keyword">AND</span> d.objsubid <span class="hljs-operator">=</span> col.ordinal_position<br><span class="hljs-keyword">WHERE</span> c.oid <span class="hljs-operator">=</span> v_table_oid<br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> col.ordinal_position<br>    LOOP<br>            v_table_ddl :<span class="hljs-operator">=</span> v_table_ddl <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;COMMENT ON COLUMN &quot;&#x27;</span> <span class="hljs-operator">||</span> in_table_name <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;&quot;.&quot;&#x27;</span><br>                               <span class="hljs-operator">||</span> v_column_comment_record.column_name <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;&quot; IS &#x27;&#x27;&#x27;</span><br>                               <span class="hljs-operator">||</span> replace(v_column_comment_record.description, <span class="hljs-string">&#x27;&#x27;&#x27;&#x27;</span>, <span class="hljs-string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span>) <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;&#x27;&#x27;;&#x27;</span> <span class="hljs-operator">||</span> E<span class="hljs-string">&#x27;\n&#x27;</span>;<br><span class="hljs-keyword">END</span> LOOP;<br><br>    <span class="hljs-comment">-- comment on index</span><br><span class="hljs-keyword">FOR</span> v_index_comment_record <span class="hljs-keyword">IN</span><br><span class="hljs-keyword">SELECT</span> c.relname, d.description<br><span class="hljs-keyword">FROM</span> pg_catalog.pg_index idx<br>         <span class="hljs-keyword">JOIN</span> pg_catalog.pg_class c <span class="hljs-keyword">ON</span> idx.indexrelid <span class="hljs-operator">=</span> c.oid<br>         <span class="hljs-keyword">JOIN</span> pg_catalog.pg_description d <span class="hljs-keyword">ON</span> idx.indexrelid <span class="hljs-operator">=</span> d.objoid<br><span class="hljs-keyword">WHERE</span> idx.indrelid <span class="hljs-operator">=</span> v_table_oid<br>    LOOP<br>            v_table_ddl :<span class="hljs-operator">=</span> v_table_ddl <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;COMMENT ON INDEX &quot;&#x27;</span><br>                               <span class="hljs-operator">||</span> v_index_comment_record.relname <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;&quot; IS &#x27;&#x27;&#x27;</span><br>                               <span class="hljs-operator">||</span> replace(v_index_comment_record.description, <span class="hljs-string">&#x27;&#x27;&#x27;&#x27;</span>, <span class="hljs-string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span>) <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;&#x27;&#x27;;&#x27;</span> <span class="hljs-operator">||</span> E<span class="hljs-string">&#x27;\n&#x27;</span>;<br><span class="hljs-keyword">END</span> LOOP;<br><br>    <span class="hljs-comment">-- comment on constraint</span><br><span class="hljs-keyword">FOR</span> v_constraint_comment_record <span class="hljs-keyword">IN</span><br><span class="hljs-keyword">SELECT</span><br>    con.conname,<br>    pg_description.description<br><span class="hljs-keyword">FROM</span> pg_catalog.pg_constraint con<br>         <span class="hljs-keyword">JOIN</span> pg_catalog.pg_class rel <span class="hljs-keyword">ON</span> rel.oid <span class="hljs-operator">=</span> con.conrelid<br>         <span class="hljs-keyword">JOIN</span> pg_catalog.pg_namespace nsp <span class="hljs-keyword">ON</span> nsp.oid <span class="hljs-operator">=</span> connamespace<br>         <span class="hljs-keyword">JOIN</span> pg_catalog.pg_description <span class="hljs-keyword">ON</span> pg_description.objoid <span class="hljs-operator">=</span> con.oid<br><span class="hljs-keyword">WHERE</span> rel.oid <span class="hljs-operator">=</span> v_table_oid<br>    LOOP<br>            v_table_ddl :<span class="hljs-operator">=</span> v_table_ddl <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;COMMENT ON CONSTRAINT &quot;&#x27;</span><br>                               <span class="hljs-operator">||</span> v_constraint_comment_record.conname <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;&quot; ON &quot;&#x27;</span> <span class="hljs-operator">||</span> in_table_name <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;&quot; IS &#x27;&#x27;&#x27;</span><br>                               <span class="hljs-operator">||</span> replace(v_constraint_comment_record.description, <span class="hljs-string">&#x27;&#x27;&#x27;&#x27;</span>, <span class="hljs-string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span>) <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;&#x27;&#x27;;&#x27;</span> <span class="hljs-operator">||</span> E<span class="hljs-string">&#x27;\n&#x27;</span>;<br><span class="hljs-keyword">END</span> LOOP;<br><br>    <span class="hljs-comment">-- return the ddl</span><br><span class="hljs-keyword">RETURN</span> v_table_ddl;<br><span class="hljs-keyword">END</span><br>$$;<br><br><span class="hljs-comment">-- æ›¿æ¢ä¸ºä½ çš„ç”¨æˆ·</span><br><span class="hljs-keyword">alter</span> <span class="hljs-keyword">function</span> show_create_table(<span class="hljs-type">varchar</span>) owner <span class="hljs-keyword">to</span> your_user;<br></code></pre></td></tr></table></figure><h3 id="å®¢æˆ·ç«¯è°ƒæ•´"><a href="#å®¢æˆ·ç«¯è°ƒæ•´" class="headerlink" title="å®¢æˆ·ç«¯è°ƒæ•´"></a>å®¢æˆ·ç«¯è°ƒæ•´</h3><h4 id="ä¸Šä¸‹æ–‡"><a href="#ä¸Šä¸‹æ–‡" class="headerlink" title="ä¸Šä¸‹æ–‡"></a>ä¸Šä¸‹æ–‡</h4><p>å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªæ ˆç»“æ„ä¿å­˜çŸ¥è¯†åº“ç‰ˆæœ¬ç”¨äºå¤„ç† <code>Schema</code> åˆ‡æ¢çš„åµŒå¥—æƒ…å†µï¼Œä¾‹å¦‚ï¼š</p><ol><li>åœ¨æŸä¸ªä¸šåŠ¡é€»è¾‘ä¸­éœ€è¦åˆ‡æ¢åˆ°<code>Schema A</code>ã€‚</li><li>åœ¨è¿™ä¸ªä¸šåŠ¡é€»è¾‘çš„æŸä¸ªæ–¹æ³•å†…éƒ¨è°ƒç”¨äº†å¦ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•éœ€è¦åˆ‡æ¢åˆ°<code>Schema B</code>ã€‚</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicSchemaContextHolder</span> &#123;<br><br>    <span class="hljs-comment">// ä¿å­˜çŸ¥è¯†åº“ç‰ˆæœ¬</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Deque&lt;String&gt;&gt; SCHEME_KEY_HOLDER = TransmittableThreadLocal.withInitial(ArrayDeque::<span class="hljs-keyword">new</span>);<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">DynamicSchemaContextHolder</span><span class="hljs-params">()</span> &#123;&#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">peek</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> SCHEME_KEY_HOLDER.get().peek();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">push</span><span class="hljs-params">(String ds)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">schemeKeyStr</span> <span class="hljs-operator">=</span> StrUtil.isEmpty(ds) ? StrUtil.EMPTY : ds;<br>        SCHEME_KEY_HOLDER.get().push(schemeKeyStr);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">poll</span><span class="hljs-params">()</span> &#123;<br>        Deque&lt;String&gt; deque = SCHEME_KEY_HOLDER.get();<br>        deque.poll();<br>        <span class="hljs-keyword">if</span> (deque.isEmpty()) &#123;<br>            SCHEME_KEY_HOLDER.remove();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> &#123;<br>        SCHEME_KEY_HOLDER.remove();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ç®¡ç†å™¨"><a href="#ç®¡ç†å™¨" class="headerlink" title="ç®¡ç†å™¨"></a>ç®¡ç†å™¨</h4><p>ä½¿ç”¨ä¸€ä¸ª <code>Manager</code> ç®¡ç†ä»¥ä¸‹å±æ€§ï¼š</p><ul><li>é»˜è®¤ <code>Schema</code> ï¼Œæ ¹æ®ç‰ˆæœ¬å·æ— æ³•æ‰¾åˆ°å¯¹åº” <code>Schema</code> æ—¶åˆ‡æ¢åˆ°é»˜è®¤ <code>Schema</code></li><li>çŸ¥è¯†åº“è¡¨ï¼ŒåŠ¨æ€åˆ‡æ¢ <code>Schema</code> æ—¶éœ€è¦åˆ¤æ–­è¡¨æ˜¯å¦å­˜åœ¨è¯¥é›†åˆä¸­ï¼Œå­˜åœ¨å³æ›¿æ¢ï¼Œå¦åˆ™é»˜è®¤ä½¿ç”¨<code>public Schema</code></li><li>çŸ¥è¯†åº“ç‰ˆæœ¬å¯¹åº”çš„ <code>Schema</code> åç§°</li><li>çŸ¥è¯†åº“ç‰ˆæœ¬å¯¹åº”çš„ä½œä¸šï¼ˆä¸€å¯¹å¤šï¼‰</li></ul><p>è¿™ä¸ªç±»çš„ä¸»è¦ä½œç”¨æ˜¯æ›´æ–°çŸ¥è¯†åº“æ—¶ï¼Œå°†æ·»åŠ çš„çŸ¥è¯†åº“å’ŒSchemaä¿å­˜èµ·æ¥ï¼Œæ‹¦æˆªå™¨ä¸­æ ¹æ®ç‰ˆæœ¬å·è·å–<code>Schema</code> ç­‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@RequiredArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicSchemaManager</span> &#123;<br>    <span class="hljs-comment">// é»˜è®¤schema</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_SCHEMA</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;public&quot;</span>;<br><br>    <span class="hljs-comment">// æœ€æ–°ç‰ˆæœ¬çŸ¥è¯†åº“</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">LATEST_VERSION</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;public&quot;</span>;<br>    <span class="hljs-comment">// ä¿å­˜çŸ¥è¯†åº“ç›¸å…³çš„è¡¨ï¼Œç”¨äºåœ¨sqlä¸­åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ‡æ¢schemaï¼Œå­˜åœ¨æ­¤é›†åˆä¸­çš„è¡¨éœ€è¦åˆ‡æ¢schema</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Set&lt;String&gt; SYNC_TABLE_NAMES = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>    <span class="hljs-comment">// key: version, value: schemaName</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, String&gt; SCHEME_KEY_MAP = Maps.newConcurrentMap();<br>    <span class="hljs-comment">// key:version, value:operationId</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Multimap&lt;String, String&gt; VERSION_WORK = Multimaps.newMultimap(Maps.newHashMap(), HashSet::<span class="hljs-keyword">new</span>);<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CoOperationMapper coOperationMapper;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LibrarySyncConfigMapper librarySyncConfigMapper;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LibrarySyncTablesMapper librarySyncTablesMapper;<br><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        List&lt;LibrarySyncConfig&gt; configs = librarySyncConfigMapper.selectList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;());<br>        <span class="hljs-keyword">if</span> (CollUtil.isNotEmpty(configs))<br>            configs.forEach(config -&gt; &#123;<br>                SCHEME_KEY_MAP.put(config.getVersion(), config.getSchemaName());<br>                log.info(<span class="hljs-string">&quot;dynamic-schema - add a schema named [&#123;&#125;] success&quot;</span>, config.getSchemaName());<br>                <span class="hljs-keyword">if</span> (config.getIsLatest()) &#123;<br>                    LATEST_VERSION = config.getVersion();<br>                    log.info(<span class="hljs-string">&quot;dynamic-schema - set the latest schema named [&#123;&#125;] success&quot;</span>, config.getSchemaName());<br>                &#125;<br>            &#125;);<br>        Set&lt;String&gt; librarySyncTables = librarySyncTablesMapper.selectSyncTableNames();<br>        SYNC_TABLE_NAMES.addAll(librarySyncTables);<br>        List&lt;Pair&lt;String, String&gt;&gt; pairs = coOperationMapper.selectLibraryVersion();<br>        <span class="hljs-keyword">if</span> (CollUtil.isNotEmpty(pairs))<br>            pairs.forEach(pair -&gt; VERSION_WORK.put(pair.getKey(), pair.getValue()));<br>        log.info(<span class="hljs-string">&quot;dynamic-schema - init success&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * æ ¹æ®ç‰ˆæœ¬å·è·å–schema</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSchema</span><span class="hljs-params">(String version)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StrUtil.isEmpty(version)) &#123;<br>            <span class="hljs-keyword">return</span> determineDefaultSchema();<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">schemaName</span> <span class="hljs-operator">=</span> SCHEME_KEY_MAP.get(version);<br>        <span class="hljs-keyword">if</span> (StrUtil.isEmpty(schemaName)) &#123;<br>            schemaName = determineDefaultSchema();<br>            log.warn(<span class="hljs-string">&quot;dynamic-schema - can not find the schema named [&#123;&#125;], switch to the default schema [&#123;&#125;]&quot;</span>, version, schemaName);<br>        &#125;<br>        log.debug(<span class="hljs-string">&quot;dynamic-schema - switch to the schema named [&#123;&#125;]&quot;</span>, schemaName);<br>        <span class="hljs-keyword">return</span> schemaName;<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * é€‰æ‹©é»˜è®¤schema</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">determineDefaultSchema</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> DEFAULT_SCHEMA;<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * æ·»åŠ schema</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addSchema</span><span class="hljs-params">(String version, String schemaName)</span> &#123;<br>        SCHEME_KEY_MAP.put(version, schemaName);<br>        log.info(<span class="hljs-string">&quot;dynamic-schema - add a schema named [&#123;&#125;] success&quot;</span>, schemaName);<br>        LATEST_VERSION = version;<br>        log.info(<span class="hljs-string">&quot;dynamic-schema - set the latest schema named [&#123;&#125;] success&quot;</span>, schemaName);<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * åˆ é™¤schema</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeSchema</span><span class="hljs-params">(String version)</span> &#123;<br>        SCHEME_KEY_MAP.remove(version);<br>        log.info(<span class="hljs-string">&quot;dynamic-schema - remove a schema named [&#123;&#125;] success&quot;</span>, version);<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * åˆ¤æ–­sqlä¸­æ˜¯å¦åŒ…å«éœ€è¦åˆ‡æ¢schemaçš„è¡¨</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isContainsSyncTable</span><span class="hljs-params">(String sql)</span> &#123;<br>        <span class="hljs-keyword">return</span> SYNC_TABLE_NAMES.stream().map(String::toLowerCase).anyMatch(sql::contains);<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * è·å–éœ€è¦åˆ‡æ¢schemaçš„è¡¨</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Set&lt;String&gt; <span class="hljs-title function_">getSyncTableNames</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> SYNC_TABLE_NAMES;<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * è·å–ç‰ˆæœ¬å·</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getVersion</span><span class="hljs-params">(String operationId)</span> &#123;<br>        <span class="hljs-keyword">if</span> (!VERSION_WORK.containsValue(operationId))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Collection&lt;String&gt;&gt; entry : VERSION_WORK.asMap().entrySet()) &#123;<br>            Collection&lt;String&gt; values = entry.getValue();<br>            <span class="hljs-keyword">if</span> (values.contains(operationId))<br>                <span class="hljs-keyword">return</span> entry.getKey();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * è·å–æœ€æ–°ç‰ˆæœ¬å·</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> String <span class="hljs-title function_">getLatestVersion</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> LATEST_VERSION;<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * æ·»åŠ ç‰ˆæœ¬å·</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addVersion</span><span class="hljs-params">(String version, String operationId)</span> &#123;<br>        VERSION_WORK.put(version, operationId);<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * åˆ é™¤ç‰ˆæœ¬å·ä¸­çš„ä½œä¸šid</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeVersionWork</span><span class="hljs-params">(String operationId)</span> &#123;<br>        <span class="hljs-keyword">if</span> (!VERSION_WORK.containsValue(operationId))<br>            <span class="hljs-keyword">return</span>;<br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Collection&lt;String&gt;&gt; entry : VERSION_WORK.asMap().entrySet()) &#123;<br>            Collection&lt;String&gt; values = entry.getValue();<br>            <span class="hljs-keyword">if</span> (values.contains(operationId)) &#123;<br>                values.remove(operationId);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="è‡ªå®šä¹‰åˆ‡æ¢æ³¨è§£"><a href="#è‡ªå®šä¹‰åˆ‡æ¢æ³¨è§£" class="headerlink" title="è‡ªå®šä¹‰åˆ‡æ¢æ³¨è§£"></a>è‡ªå®šä¹‰åˆ‡æ¢æ³¨è§£</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(&#123;ElementType.METHOD&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> SchemaSwitch &#123;<br><br>    <span class="hljs-comment">// æŒ‡å®šåŒ…å«ä½œä¸šidçš„ç±»ï¼Œä½œä¸šidç”¨äºæŸ¥æ‰¾çŸ¥è¯†åº“ç‰ˆæœ¬</span><br>    Class&lt;?&gt; value() <span class="hljs-keyword">default</span> LatestVersion.class;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆ‡é¢"><a href="#åˆ‡é¢" class="headerlink" title="åˆ‡é¢"></a>åˆ‡é¢</h3><p>è·å–æ³¨è§£ä¸Šé…ç½®çš„ <code>Class</code>ï¼Œå› ä¸ºè¯¥<code>Class</code> é…ç½®ä¸ºåŒ…å«ä½œä¸š <code>id</code> çš„ç±»ã€‚</p><p>é€šè¿‡åå°„è·å–ä½œä¸š <code>id</code>ï¼Œé€šè¿‡ä½œä¸š <code>id</code> è·å–å¯¹åº”çš„çŸ¥è¯†åº“ç‰ˆæœ¬ï¼Œå¦‚æœç‰ˆæœ¬å·ä¸ä¸ºç©ºï¼Œåˆ™æ”¾å…¥åˆ°å½“å‰çº¿ç¨‹çš„æœ¬åœ°çº¿ç¨‹å˜é‡ä¸­ã€‚</p><p>è¿™é‡Œæ³¨æ„æ–¹æ³•æ‰§è¡Œå®Œä¹‹åè¦è°ƒç”¨ <code>clear()</code> æ¸…ç†ï¼Œé˜²æ­¢å†…å­˜æº¢å‡ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Aspect</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SchemaAspect</span> &#123;<br><br>    <span class="hljs-meta">@Pointcut(&quot;@annotation(com.dcas.common.annotation.SchemaSwitch)&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">switchSchema</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Around(&quot;switchSchema()&quot;)</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint pointcut)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">operationId</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">MethodSignature</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> (MethodSignature)pointcut.getSignature();<br>        <span class="hljs-type">SchemaSwitch</span> <span class="hljs-variable">annotation</span> <span class="hljs-operator">=</span> signature.getMethod().getAnnotation(SchemaSwitch.class);<br>        Class&lt;?&gt; clazz = annotation.value();<br>        <span class="hljs-keyword">if</span> (clazz == LatestVersion.class) &#123;<br>            <span class="hljs-comment">// é»˜è®¤åˆ‡æ¢æœ€æ–°ç‰ˆæœ¬çŸ¥è¯†åº“</span><br>            version = DynamicSchemaManager.getLatestVersion();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            Object[] args = pointcut.getArgs();<br>            <span class="hljs-keyword">for</span> (Object arg : args) &#123;<br>                <span class="hljs-keyword">if</span> (arg.getClass() != clazz)<br>                    <span class="hljs-keyword">continue</span>;<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> JSONObject.parseObject(JSON.toJSONString(arg), clazz);<br>                <span class="hljs-keyword">if</span> (clazz == String.class || clazz == Integer.class) &#123;<br>                    operationId = obj.toString();<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    operationId = ReflectUtil.getFieldValue(obj, <span class="hljs-string">&quot;operationId&quot;</span>).toString();<br>                &#125;<br>                <span class="hljs-keyword">if</span> (StrUtil.isEmpty(operationId))<br>                    <span class="hljs-keyword">continue</span>;<br>                version = DynamicSchemaManager.getVersion(operationId);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (StrUtil.isNotEmpty(version))<br>            DynamicSchemaContextHolder.push(version);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> pointcut.proceed();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            DynamicSchemaContextHolder.clear();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åŠ¨æ€æ›¿æ¢"><a href="#åŠ¨æ€æ›¿æ¢" class="headerlink" title="åŠ¨æ€æ›¿æ¢"></a>åŠ¨æ€æ›¿æ¢</h3><p>å‰é¢æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯ä¸ºäº†æ¥ä¸‹æ¥çš„è¿™ä¸€æ­¥åšé“ºå«ï¼Œè¦åŠ¨æ€åˆ‡æ¢çŸ¥è¯†åº“ç›¸å…³è¡¨æ‰€åœ¨çš„<code>Schema</code>ï¼Œæˆ‘ä»¬ç°åœ¨å·²ç»å°†çŸ¥è¯†åº“ç‰ˆæœ¬æ”¾å…¥åˆ°äº†æœ¬åœ°çº¿ç¨‹å˜é‡ï¼Œåªéœ€è¦é€šè¿‡ <code>DynamicSchemaManager</code> çš„ <code>getSchema(String version)</code> æ–¹æ³•è·å–ç‰ˆæœ¬å¯¹åº”çš„ <code>schema</code> åç§°ï¼Œç„¶åå°†åç§°è®¾ç½®åˆ° <code>sql </code>çš„è¡¨åå‰é¢ã€‚</p><h4 id="å ä½ç¬¦"><a href="#å ä½ç¬¦" class="headerlink" title="å ä½ç¬¦"></a>å ä½ç¬¦</h4><p>å¾ˆå®¹æ˜“æƒ³åˆ°çš„ä¸€ç§æ–¹æ³•å°±æ˜¯åœ¨ <code>xxxMapper.xml</code> æ–‡ä»¶ä¸­éœ€è¦åŠ¨æ€åˆ‡æ¢ <code>Schema</code> çš„è¡¨åå‰é¢åŠ ä¸Šå ä½ç¬¦ï¼Œç„¶åå°† <code>Schema</code> åç§°é€šè¿‡å‚æ•°ä¼ å…¥ã€‚</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">T <span class="hljs-title function_">methodA</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;schema&quot;)</span> String schema)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">from</span> t1<br>         <span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span> #&#123;schema&#125;.t2 <span class="hljs-keyword">on</span> t1.template_id <span class="hljs-operator">=</span> t2.id<br>         <span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span> #&#123;schema&#125; <span class="hljs-keyword">on</span> t3.template_id <span class="hljs-operator">=</span> t2.id;<br></code></pre></td></tr></table></figure><p>é¢ã€‚ã€‚ã€‚å…„å¼Ÿï¼Œå‰é¢éƒ½æŒºå¥½çš„ï¼Œæ€ä¹ˆåˆ°ä½ è¿™è¿™ä¹ˆæ‹‰äº†ï¼Ÿ</p><p>è¿™ç§æ–¹æ³•æ— ç–‘æœ‰å¤§é‡çš„æ”¹åŠ¨ï¼Œè€Œä¸”å¯¹äºæ¯æ¬¡æ–°å¢æ–¹æ³•ä¹Ÿè¦åŒæ­¥ä¿®æ”¹ï¼Œåˆ«è¯´ä½ ä»¬æˆ‘éƒ½å¿ä¸äº†ã€‚</p><p>éš¾é“è¿˜æœ‰æ›´å¥½çš„åŠæ³•ï¼Ÿ</p><h3 id="æ‹¦æˆªå™¨"><a href="#æ‹¦æˆªå™¨" class="headerlink" title="æ‹¦æˆªå™¨"></a>æ‹¦æˆªå™¨</h3><p><code>org.apache.ibatis.plugin.Interceptor</code> æ˜¯ <code>MyBatis</code> æä¾›çš„æ‹¦æˆªå™¨æ¥å£ï¼Œå¯ä»¥ç”¨äºåœ¨ <code>MyBatis</code> æ‰§è¡Œ <code>SQL</code> è¯­å¥çš„å„ä¸ªé˜¶æ®µè¿›è¡Œæ‹¦æˆªå’Œå¹²é¢„ã€‚</p><p>é€šè¿‡å®ç°è¿™ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <code>SQL</code> è¯­å¥æ‰§è¡Œå‰åï¼Œä»¥åŠæ‰§è¡ŒæœŸé—´åšä¸€äº›é¢å¤–çš„å¤„ç†ã€‚</p><p>ç”±äºæˆ‘çš„é¡¹ç›®ä¸­ä½¿ç”¨äº† <code>MybatisPlus</code>, å·²ç»å®ç°äº†æ‹¦æˆªå™¨æ¥å£ï¼Œå¦å¤–åšäº†ä¸€å±‚å°è£…ï¼Œæä¾›äº†<code>InnerInterceptor</code> æ¥å£ï¼Œåªéœ€è¦å®ç°è¿™ä¸ªæ¥å£å°±å¯ä»¥å¯¹å¾…æ‰§è¡Œçš„ <code>SQL</code> è¿›è¡Œä¸€äº›ä¿®æ”¹é€»è¾‘ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20231116175130355.png" alt="image-20231116175130355"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SchemaSelectInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InnerInterceptor</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeQuery</span><span class="hljs-params">(Executor executor, MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> boundSql.getSql();<br>        <span class="hljs-comment">// ç®€å•åˆ¤æ–­sqlä¸­æ˜¯å¦åŒ…å«æ¶‰åŠçš„çŸ¥è¯†åº“è¡¨ï¼Œä¸åŒ…å«çš„è¯å°±ä¸ç”¨è§£æäº†</span><br>        <span class="hljs-keyword">if</span> (!isContainsSyncTable(sql)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> DynamicSchemaContextHolder.peek();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">schema</span> <span class="hljs-operator">=</span> DynamicSchemaManager.getSchema(version);<br>        <span class="hljs-type">PGSQLStatementParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PGSQLStatementParser</span>(sql);<br>        <span class="hljs-type">SQLStatement</span> <span class="hljs-variable">sqlStatement</span> <span class="hljs-operator">=</span> parser.parseStatement();<br>        <span class="hljs-comment">// è®¿é—®å™¨</span><br>        <span class="hljs-type">SchemaSwitchVisitorAdapter</span> <span class="hljs-variable">visitor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SchemaSwitchVisitorAdapter</span>(schema, DynamicSchemaManager.getSyncTableNames());<br>        sqlStatement.accept(visitor);<br>        PluginUtils.mpBoundSql(boundSql).sql(SQLUtils.toSQLString(sqlStatement, DbType.postgresql));<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isContainsSyncTable</span><span class="hljs-params">(String sql)</span> &#123;<br>        <span class="hljs-keyword">return</span> DynamicSchemaManager.isContainsSyncTable(sql.toLowerCase());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ç°åœ¨èƒ½æ‹¦æˆªæ‰§è¡Œå‰çš„ <code>SQL</code>ï¼Œç°åœ¨å‰©ä¸‹çš„é¦–è¦ä»»åŠ¡å°±æ˜¯å°†éœ€è¦æ›¿æ¢<code>schema</code>çš„è¡¨æ­£ç¡®æ›¿æ¢ï¼Œè€ƒè™‘åˆ°æœ‰ä¸€äº›è¡¨æœ‰å¾ˆç›¸ä¼¼çš„åç§°ï¼Œä¸èƒ½ç®€å•è¿›è¡Œ <code>replace</code>ã€‚</p><p>è¿™é‡Œæˆ‘ä½¿ç”¨äº†é˜¿é‡Œ <code>Druid</code> æ•°æ®æºæä¾›çš„ <code>SQL</code> è§£æå™¨ <code>PGSQLStatementParser</code>ï¼Œæˆ‘ä»¬å…ˆå¤§æ¦‚åˆ¤æ–­æœ‰æ²¡æœ‰éœ€è¦æ›¿æ¢çš„è¡¨ï¼Œæ²¡æœ‰çš„è¯å°±æ²¡å¿…è¦è¿›è¡Œè§£æäº†ã€‚</p><p>ç„¶åè‡ªå®šä¹‰ä¸€ä¸ª <code>AST</code> èŠ‚ç‚¹è®¿é—®å™¨ <code>SchemaSwitchVisitorAdapter</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SchemaSwitchVisitorAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PGASTVisitorAdapter</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DOUBLE_QUOTE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;\&quot;&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String schema;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;String&gt; syncTables;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">visit</span><span class="hljs-params">(SQLExprTableSource x)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> StrUtil.removeAll(x.getExpr().toString(), DOUBLE_QUOTE);<br>        <span class="hljs-keyword">if</span> (syncTables.stream().anyMatch(tableName::equalsIgnoreCase))<br>            x.setExpr(DOUBLE_QUOTE + schema + DOUBLE_QUOTE + StrUtil.DOT + tableName);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡æ„é€ å‡½æ•°ä¼ å…¥å¾…æ›¿æ¢çš„ <code>Schema</code> å’ŒçŸ¥è¯†åº“çš„è¡¨ï¼Œåˆ¤æ–­å½“å‰è®¿é—®çš„è¡¨æ˜¯å¦å­˜åœ¨äºçŸ¥è¯†åº“è¡¨ä¸­ï¼Œå¦‚æœæ˜¯çš„è¯å°±åœ¨å‰é¢åŠ ä¸Šè¦æ›¿æ¢çš„ <code>Schema</code>ã€‚</p><p>é€šè¿‡è¿™ç§æ“ä½œï¼Œæˆ‘ä»¬æ— éœ€ä¿®æ”¹åŸå…ˆçš„ä»»ä½• <code>SQL</code>ã€‚</p><p>æœ€åä¸è¦å¿˜è®°åœ¨é…ç½®ç±»ä¸­åŠ å…¥æˆ‘ä»¬è‡ªå®šä¹‰çš„æ‹¦æˆªå™¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableTransactionManagement(proxyTargetClass = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisPlusConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();<br>        <span class="hljs-comment">// schemaé€‰æ‹©ç»„ä»¶</span><br>        interceptor.addInnerInterceptor(schemaSelectInterceptor());<br>        <span class="hljs-keyword">return</span> interceptor;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * schemaé€‰æ‹©ç»„ä»¶</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> SchemaSelectInterceptor <span class="hljs-title function_">schemaSelectInterceptor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SchemaSelectInterceptor</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æœ€ç»ˆæ•ˆæœ"><a href="#æœ€ç»ˆæ•ˆæœ" class="headerlink" title="æœ€ç»ˆæ•ˆæœ"></a>æœ€ç»ˆæ•ˆæœ</h3><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs tex">18:03:23.208 [http-nio-8080-exec-55] DEBUG c.d.s.m.DynamicSchemaManager - [getSchema,80] - dynamic-schema - switch to the schema named [20231115171241]<br>18:03:23.213 [http-nio-8080-exec-55] DEBUG c.d.s.m.A.qryByTemplateType - [debug,137] - ==&gt;  Preparing: SELECT t1.&quot;name&quot;, t4.bp<span class="hljs-built_in">_</span>code, t4.&quot;stage&quot;, t4.&quot;process&quot;, t4.dimension , t4.&quot;content&quot;, t4.&quot;level&quot;, t6.id AS itemId FROM &quot;20231115171241&quot;.analysis<span class="hljs-built_in">_</span>template t1 INNER JOIN &quot;20231115171241&quot;.standard<span class="hljs-built_in">_</span>template<span class="hljs-built_in">_</span>relevance t2 ON t1.&quot;id&quot; = t2.template<span class="hljs-built_in">_</span>id INNER JOIN &quot;20231115171241&quot;.standard t3 ON t2.standard<span class="hljs-built_in">_</span>id = t3.&quot;id&quot; AND t3.&quot;enable&quot; = true INNER JOIN &quot;20231115171241&quot;.standard<span class="hljs-built_in">_</span>item t4 ON t3.&quot;id&quot; = t4.standard<span class="hljs-built_in">_</span>id LEFT JOIN &quot;20231115171241&quot;.clause<span class="hljs-built_in">_</span>item<span class="hljs-built_in">_</span>relevance t5 ON t4.&quot;id&quot; = t5.clause<span class="hljs-built_in">_</span>id LEFT JOIN &quot;20231115171241&quot;.item t6 ON t5.item<span class="hljs-built_in">_</span>id = t6.id AND t6.status = 0 WHERE t1.&quot;type&quot; = ? AND t4.&quot;level&quot; = ?<br>18:03:23.213 [http-nio-8080-exec-55] DEBUG c.d.s.m.A.qryByTemplateType - [debug,137] - ==&gt; Parameters: 1(Integer), 3(Integer)<br>18:03:23.255 [http-nio-8080-exec-55] DEBUG c.d.s.m.A.qryByTemplateType - [debug,137] - &lt;==      Total: 385<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ä¸­é—´ä»¶</category>
      
      <category>åŠ¨æ€æ•°æ®æº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>åŠ¨æ€æ•°æ®æº</tag>
      
      <tag>Schema</tag>
      
      <tag>è”è¡¨æŸ¥è¯¢åˆ‡æ¢</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åŠ¨æ€æ•°æ®æºå®ç°å¤šç‰ˆæœ¬å†…å®¹åº“åˆ‡æ¢</title>
    <link href="/2023/11/10/%E5%8A%A8%E6%80%81%E6%95%B0%E6%8D%AE%E6%BA%90%E5%AE%9E%E7%8E%B0%E5%A4%9A%E7%89%88%E6%9C%AC%E5%86%85%E5%AE%B9%E5%BA%93%E5%88%87%E6%8D%A2/"/>
    <url>/2023/11/10/%E5%8A%A8%E6%80%81%E6%95%B0%E6%8D%AE%E6%BA%90%E5%AE%9E%E7%8E%B0%E5%A4%9A%E7%89%88%E6%9C%AC%E5%86%85%E5%AE%B9%E5%BA%93%E5%88%87%E6%8D%A2/</url>
    
    <content type="html"><![CDATA[<h3 id="åºè¨€"><a href="#åºè¨€" class="headerlink" title="åºè¨€"></a>åºè¨€</h3><p>æœ€è¿‘æœ‰ä¸€ä¸ªåŸºäºC&#x2F;Sï¼ˆå®¢æˆ·&#x2F;æœåŠ¡ç«¯ï¼‰ç»“æ„çš„å¤šç‰ˆæœ¬å†…å®¹æ§åˆ¶çš„éœ€æ±‚ã€‚æœåŠ¡ç«¯ä¸ºæ‰€æœ‰å®¢æˆ·ç«¯æä¾›çŸ¥è¯†åº“å†…å®¹æ”¯æŒï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡å‰å°é¡µé¢åœ¨çº¿æ›´æ–°æœåŠ¡ç«¯çš„çŸ¥è¯†åº“å†…å®¹ï¼Œå®¢æˆ·ç«¯éœ€è¦ä½¿ç”¨çŸ¥è¯†åº“çš„å†…å®¹è¿›è¡Œä¸€ç³»åˆ—çš„æ“ä½œï¼Œå…·ä½“åšä»€ä¹ˆæ“ä½œä¸æ˜¯é‡ç‚¹ã€‚</p><p>ç°åœ¨é—®é¢˜æ˜¯äº§å“éœ€è¦æ”¯æŒåœ¨æ—§ç‰ˆæœ¬çš„çŸ¥è¯†åº“åˆ›å»ºçš„ä½œä¸šæ›´æ–°åä»»ç„¶ä½¿ç”¨æ—§ç‰ˆæœ¬çŸ¥è¯†åº“å†…å®¹ï¼Œè€Œåˆ›å»ºæ–°ä½œä¸šæ—¶ä½¿ç”¨æ›´æ–°çš„çŸ¥è¯†åº“å†…å®¹</p><p>ç»è¿‡éœ€æ±‚åˆ†æä¹‹åå†³å®šä½¿ç”¨åŠ¨æ€æ•°æ®æºæ¥å¤„ç†ä¸åŒä½œä¸šè®¿é—®ä¸åŒçŸ¥è¯†åº“å†…å®¹çš„æ–¹å¼ä»è€Œè§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><h3 id="æ•°æ®æºè¿æ¥"><a href="#æ•°æ®æºè¿æ¥" class="headerlink" title="æ•°æ®æºè¿æ¥"></a>æ•°æ®æºè¿æ¥</h3><p>åœ¨ <code>Spring</code> æ¡†æ¶ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ <code>DataSource</code> å¯¹è±¡æ¥ç®¡ç†æ•°æ®åº“è¿æ¥ã€‚<code>javax.sql.DataSource</code> æ˜¯ä¸€ä¸ª <code>Java</code> æ¥å£ï¼Œå®ƒæä¾›äº†ä¸æ•°æ®åº“è¿æ¥ç›¸å…³çš„æ–¹æ³•å’ŒåŠŸèƒ½ã€‚å®ƒæ˜¯è¿æ¥æ•°æ®åº“çš„ä¸€ç§æ–¹å¼ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªæ¥å£æ¥è·å–æ•°æ®åº“è¿æ¥ï¼Œæ‰§è¡Œ <code>SQL</code> æŸ¥è¯¢å’Œæ›´æ–°ç­‰æ“ä½œã€‚</p><p>ä¼ ç»Ÿçš„ <code>JDBC</code> è®¿é—®æ•°æ®åº“æŠ€æœ¯ï¼Œæ¯æ¬¡è®¿é—®æ•°æ®åº“éƒ½éœ€è¦é€šè¿‡æ•°æ®åº“é©±åŠ¨å™¨ <code>Driver</code> å’Œæ•°æ®åº“åç§°ä»¥åŠå¯†ç ç­‰ç­‰èµ„æºå»ºç«‹æ•°æ®åº“è¿æ¥ã€‚é¢‘ç¹çš„å»ºç«‹æ•°æ®åº“è¿æ¥ä¸æ–­å¼€æ•°æ®åº“ï¼Œè¿™æ ·ä¼šæ¶ˆè€—å¤§é‡çš„ç³»ç»Ÿèµ„æºå’Œæ—¶é—´ï¼Œé™ä½æ€§èƒ½ï¼Œéœ€è¦ä¸€å®šçš„å†…å­˜å’Œ CPU å¼€é”€ã€‚</p><p>é€šè¿‡å»ºç«‹æ•°æ®åº“è¿æ¥æ± ï¼Œå°†è¿™äº›æ•°æ®åº“è¿æ¥ä¿å­˜åœ¨æ•°æ®è¿æ¥æ± ä¸­ï¼Œè®¿é—®æ•°æ®åº“æ—¶ï¼Œåªéœ€è¦ä»æ•°æ®åº“è¿æ¥æ± ä¸­è·å–ç©ºé—²çš„æ•°æ®åº“è¿æ¥ï¼Œå½“ç¨‹åºå‘˜è®¿é—®æ•°æ®åº“ç»“æŸæ—¶ï¼Œæ•°æ®è¿æ¥ä¼šæ”¾å›æ•°æ®åº“è¿æ¥æ± ä¸­ï¼Œä»è€Œå¤§å¤§æé«˜ç³»ç»Ÿæ€§èƒ½ã€‚</p><h3 id="SpringBootå®˜æ–¹æä¾›çš„åŠ¨æ€æ•°æ®æº"><a href="#SpringBootå®˜æ–¹æä¾›çš„åŠ¨æ€æ•°æ®æº" class="headerlink" title="SpringBootå®˜æ–¹æä¾›çš„åŠ¨æ€æ•°æ®æº"></a>SpringBootå®˜æ–¹æä¾›çš„åŠ¨æ€æ•°æ®æº</h3><p><code>AbstractRoutingDataSource</code> æ˜¯ <code>springboot</code> å®˜æ–¹æä¾›ç»™æˆ‘ä»¬çš„å¤šæ•°æ®æºåˆ‡æ¢ç­–ç•¥ï¼Œä¸‹é¢ä»‹ç»ä¸€ä¸‹è¯¥ç±»ä¸­çš„æ ¸å¿ƒå±æ€§å’Œæ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractRoutingDataSource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractDataSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span> &#123;<br><br>    <span class="hljs-comment">// ç›®æ ‡æ•°æ®æºï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰éœ€è¦è¿›è¡Œåˆ‡æ¢çš„æ‰€æœ‰æ•°æ®æºä¿å­˜åœ¨è¿™ä¸ªmapä¸­</span><br><span class="hljs-meta">@Nullable</span><br><span class="hljs-keyword">private</span> Map&lt;Object, Object&gt; targetDataSources;<br><br>    <span class="hljs-comment">// é»˜è®¤çš„æ•°æ®æºï¼Œæ— ä»»ä½•åˆ‡æ¢æ“ä½œæ—¶ä½¿ç”¨é»˜è®¤æ•°æ®åº“åŠäº‹ç‰©ä¸Šä¸‹æ–‡</span><br><span class="hljs-meta">@Nullable</span><br><span class="hljs-keyword">private</span> Object defaultTargetDataSource;<br><br>    <span class="hljs-comment">// å½“åˆ‡æ¢çš„æ•°æ®åº“ä¸å­˜åœ¨æ—¶æ˜¯å¦å›é€€åˆ°é»˜è®¤æ•°æ®åº“</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">lenientFallback</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-comment">// é€šè¿‡JNDIå¯»æ‰¾æ•°æ®æºçš„é»˜è®¤å®ç°</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">DataSourceLookup</span> <span class="hljs-variable">dataSourceLookup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JndiDataSourceLookup</span>();<br><br>    <span class="hljs-comment">// å°†targetDataSourcesè½¬åŒ–ä¸ºDataSource</span><br><span class="hljs-meta">@Nullable</span><br><span class="hljs-keyword">private</span> Map&lt;Object, DataSource&gt; resolvedDataSources;<br><br><span class="hljs-meta">@Nullable</span><br><span class="hljs-keyword">private</span> DataSource resolvedDefaultDataSource;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    * å®ç°InitializingBeanç±»çš„æ–¹æ³•ï¼Œåˆå§‹åŒ–beanåä¼šè°ƒç”¨ï¼Œå°†targetDataSourcesè½¬åŒ–ä¸ºresolvedDataSources</span><br><span class="hljs-comment">    */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.targetDataSources == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Property &#x27;targetDataSources&#x27; is required&quot;</span>);<br>&#125;<br><span class="hljs-built_in">this</span>.resolvedDataSources = CollectionUtils.newHashMap(<span class="hljs-built_in">this</span>.targetDataSources.size());<br><span class="hljs-built_in">this</span>.targetDataSources.forEach((key, value) -&gt; &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">lookupKey</span> <span class="hljs-operator">=</span> resolveSpecifiedLookupKey(key);<br><span class="hljs-type">DataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> resolveSpecifiedDataSource(value);<br><span class="hljs-built_in">this</span>.resolvedDataSources.put(lookupKey, dataSource);<br>&#125;);<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.defaultTargetDataSource != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-built_in">this</span>.resolvedDefaultDataSource = resolveSpecifiedDataSource(<span class="hljs-built_in">this</span>.defaultTargetDataSource);<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// æ ¹æ®keyè·å–æ•°æ®æºï¼Œkeyä¸€èˆ¬å­˜æ”¾åœ¨å½“å‰çº¿ç¨‹çš„ThreadLoaclä¸­</span><br><span class="hljs-keyword">protected</span> DataSource <span class="hljs-title function_">determineTargetDataSource</span><span class="hljs-params">()</span> &#123;<br>Assert.notNull(<span class="hljs-built_in">this</span>.resolvedDataSources, <span class="hljs-string">&quot;DataSource router not initialized&quot;</span>);<br>        <span class="hljs-comment">// è·å–å½“å‰çº¿ç¨‹å¯¹åº”æ•°æ®æºçš„æ ‡è¯†key</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">lookupKey</span> <span class="hljs-operator">=</span> determineCurrentLookupKey();<br>        <span class="hljs-comment">// ä»æ•°æ®æºé›†åˆä¸­è·å–æ•°æ®æºå¯¹è±¡</span><br><span class="hljs-type">DataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.resolvedDataSources.get(lookupKey);<br>        <span class="hljs-comment">// å¦‚æœæ•°æ®æºä¸å­˜åœ¨ï¼Œåˆ™å›é€€åˆ°é»˜è®¤æ•°æ®æº</span><br><span class="hljs-keyword">if</span> (dataSource == <span class="hljs-literal">null</span> &amp;&amp; (<span class="hljs-built_in">this</span>.lenientFallback || lookupKey == <span class="hljs-literal">null</span>)) &#123;<br>dataSource = <span class="hljs-built_in">this</span>.resolvedDefaultDataSource;<br>&#125;<br>        <span class="hljs-comment">// å¦‚æœæ•°æ®æºä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span><br><span class="hljs-keyword">if</span> (dataSource == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;Cannot determine target DataSource for lookup key [&quot;</span> + lookupKey + <span class="hljs-string">&quot;]&quot;</span>);<br>&#125;<br><span class="hljs-keyword">return</span> dataSource;<br>&#125;<br><br>    <span class="hljs-comment">// è¿™ä¸ªæ–¹æ³•æ˜¯è®©æˆ‘ä»¬å®ç°è¿”å›å½“å‰è¦åˆ‡æ¢çš„æ•°æ®æºçš„key</span><br><span class="hljs-meta">@Nullable</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> Object <span class="hljs-title function_">determineCurrentLookupKey</span><span class="hljs-params">()</span>;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥ä½¿ç”¨ <code>spring boot</code> å®˜æ–¹æä¾›çš„å¤šæ•°æ®æºåˆ‡æ¢ç­–ç•¥åªéœ€è¦å®ç° <code>AbstractRoutingDataSource</code> ç±»ç„¶åé‡å†™ <code>determineCurrentLookupKey()</code> æ–¹æ³•å³å¯ã€‚</p><p>å®˜æ–¹æä¾›çš„å¤šæ•°æ®æºåˆ‡æ¢ç­–ç•¥ç›¸å¯¹è¾ƒç®€å•ï¼Œè¿˜æœ‰ä¸€ç§ç¬¬ä¸‰æ–¹æä¾›çš„åŠ¨æ€æ•°æ®æºä¹Ÿæ˜¯ä¸‹é¢é‡ç‚¹è¦ä»‹ç»çš„ã€‚</p><h3 id="è‹ç±³è±†åŠ¨æ€æ•°æ®æº"><a href="#è‹ç±³è±†åŠ¨æ€æ•°æ®æº" class="headerlink" title="è‹ç±³è±†åŠ¨æ€æ•°æ®æº"></a>è‹ç±³è±†åŠ¨æ€æ•°æ®æº</h3><p>ä¸€èˆ¬çš„å®ç°æ–¹å¼æ˜¯é€šè¿‡ <code>ThreadLocal</code> å’Œæ³¨è§£ï¼Œé€šè¿‡ <code>AOP</code> åˆ‡é¢åœ¨éœ€è¦åˆ‡æ¢æ•°æ®æºçš„åœ°æ–¹è®¾ç½®éœ€è¦åˆ‡æ¢çš„æ•°æ®æºçš„keyå³å¯ï¼Œæ³¨æ„ <code>ThreadLocal</code> è®¾ç½®ä½¿ç”¨å®Œåéœ€è¦æ¸…ç†ï¼Œå¦åˆ™å¯èƒ½é€ æˆå†…å­˜æº¢å‡ºã€‚</p><p>è¿™é‡Œä¸»è¦ä»‹ç»é€šè¿‡ <code>baomidou</code> çš„ <code>dynamic-datasource</code> æ¥é…ç½®å¤šæ•°æ®æºåˆ‡æ¢æ“ä½œï¼Œè‡ªå®šä¹‰é…ç½®æ•°æ®æ¥æºä»¥åŠåŠ¨æ€å¢å‡æ•°æ®æºã€‚ </p><p>ç”±äºé¡¹ç›®ä¸­ä½¿ç”¨äº† <code>Druid</code> åšæ•°æ®åº“è¿æ¥æ± ï¼Œæ‰€ä»¥ä¼šä¸€å¹¶ä»‹ç» <code>Druid</code> å’Œ <code>dynamic-datasource</code> çš„æ•´åˆæ–¹å¼ã€‚</p><h3 id="ä¾èµ–"><a href="#ä¾èµ–" class="headerlink" title="ä¾èµ–"></a>ä¾èµ–</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.14<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dynamic-datasource-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-comment"># æ•°æ®æºé…ç½®</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-comment"># druidçš„å…¨å±€é…ç½®</span><br>    <span class="hljs-attr">druid:</span><br>      <span class="hljs-attr">filter:</span><br>        <span class="hljs-attr">stat:</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-comment"># æ…¢SQLè®°å½•</span><br>          <span class="hljs-attr">log-slow-sql:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">slow-sql-millis:</span> <span class="hljs-number">1000</span><br>          <span class="hljs-attr">merge-sql:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">wall:</span><br>          <span class="hljs-attr">config:</span><br>            <span class="hljs-attr">multi-statement-allow:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">webStatFilter:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">statViewServlet:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-comment"># è®¾ç½®ç™½åå•ï¼Œä¸å¡«åˆ™å…è®¸æ‰€æœ‰è®¿é—®</span><br>        <span class="hljs-attr">allow:</span><br>        <span class="hljs-attr">url-pattern:</span> <span class="hljs-string">/druid/*</span><br>        <span class="hljs-comment"># æ§åˆ¶å°ç®¡ç†ç”¨æˆ·åå’Œå¯†ç </span><br>        <span class="hljs-attr">login-username:</span> <span class="hljs-string">admin</span><br>        <span class="hljs-attr">login-password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">dynamic:</span><br>      <span class="hljs-attr">primary:</span> <span class="hljs-string">master</span><br>      <span class="hljs-attr">strict:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">datasource:</span><br>        <span class="hljs-attr">master:</span><br>          <span class="hljs-attr">type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span><br>          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:postgresql://ip:port/database_1?useUnicode=true&amp;characterEncoding=UTF-8&amp;allowMultiQueries=true&amp;serverTimezone=Asia/Shanghai&amp;reWriteBatchedInserts=true</span><br>          <span class="hljs-attr">username:</span> <span class="hljs-string">user_1</span><br>          <span class="hljs-attr">password:</span> <span class="hljs-string">password</span><br>          <span class="hljs-attr">driverClassName:</span> <span class="hljs-string">org.postgresql.Driver</span><br><span class="hljs-comment">#        slave:</span><br><span class="hljs-comment">#          type: com.alibaba.druid.pool.DruidDataSource</span><br><span class="hljs-comment">#          url: jdbc:postgresql://ip:port/database_2?useUnicode=true&amp;characterEncoding=UTF-8&amp;allowMultiQueries=true&amp;serverTimezone=Asia/Shanghai&amp;reWriteBatchedInserts=true</span><br><span class="hljs-comment">#          username: user_2</span><br><span class="hljs-comment">#          password: password</span><br>      <span class="hljs-attr">druid:</span><br>        <span class="hljs-comment"># åˆå§‹è¿æ¥æ•°</span><br>        <span class="hljs-attr">initialSize:</span> <span class="hljs-number">5</span><br>        <span class="hljs-comment"># æœ€å°è¿æ¥æ± æ•°é‡</span><br>        <span class="hljs-attr">minIdle:</span> <span class="hljs-number">10</span><br>        <span class="hljs-comment"># æœ€å¤§è¿æ¥æ± æ•°é‡</span><br>        <span class="hljs-attr">maxActive:</span> <span class="hljs-number">20</span><br>        <span class="hljs-comment"># é…ç½®è·å–è¿æ¥ç­‰å¾…è¶…æ—¶çš„æ—¶é—´</span><br>        <span class="hljs-attr">maxWait:</span> <span class="hljs-number">60000</span><br>        <span class="hljs-comment"># é…ç½®é—´éš”å¤šä¹…æ‰è¿›è¡Œä¸€æ¬¡æ£€æµ‹ï¼Œæ£€æµ‹éœ€è¦å…³é—­çš„ç©ºé—²è¿æ¥ï¼Œå•ä½æ˜¯æ¯«ç§’</span><br>        <span class="hljs-attr">timeBetweenEvictionRunsMillis:</span> <span class="hljs-number">60000</span><br>        <span class="hljs-comment"># é…ç½®ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å°ç”Ÿå­˜çš„æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’</span><br>        <span class="hljs-attr">minEvictableIdleTimeMillis:</span> <span class="hljs-number">300000</span><br>        <span class="hljs-comment"># é…ç½®ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å¤§ç”Ÿå­˜çš„æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’</span><br>        <span class="hljs-attr">maxEvictableIdleTimeMillis:</span> <span class="hljs-number">900000</span><br>        <span class="hljs-comment"># é…ç½®æ£€æµ‹è¿æ¥æ˜¯å¦æœ‰æ•ˆ</span><br>        <span class="hljs-attr">validationQuery:</span> <span class="hljs-string">SELECT</span> <span class="hljs-string">version()</span><br>        <span class="hljs-attr">testWhileIdle:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">testOnBorrow:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">testOnReturn:</span> <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure><p>åˆ°è¿™ä¸€æ­¥å…¶å®æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ <code>@DS (&quot;é…ç½®çš„æ•°æ®åº“åç§°&quot;)</code>  æ³¨è§£æ¥åˆ‡æ¢æ•°æ®æºäº†ã€‚</p><p>æ³¨è§£å¯ä»¥é…ç½®åœ¨ç±»å’Œæ–¹æ³•ä¸Šé¢ï¼Œé…ç½®åœ¨æ–¹æ³•ä¸Šé¢çš„æ³¨è§£ä¼˜å…ˆçº§å¤§äºé…ç½®åœ¨ç±»ä¸Šé¢çš„æ³¨è§£ã€‚</p><h3 id="è‡ªå®šä¹‰æ•°æ®æºé…ç½®æ¥æº"><a href="#è‡ªå®šä¹‰æ•°æ®æºé…ç½®æ¥æº" class="headerlink" title="è‡ªå®šä¹‰æ•°æ®æºé…ç½®æ¥æº"></a>è‡ªå®šä¹‰æ•°æ®æºé…ç½®æ¥æº</h3><p>æœ‰æ—¶å€™æˆ‘ä»¬å¹¶ä¸å›ºå®šæ•°æ®æºçš„åŠ è½½ä½ç½®ã€‚ä¾‹å¦‚åœ¨ä¸Šè¿°åœºæ™¯ä¸­ï¼Œæ¯æ¬¡æ›´æ–°ä¸€æ¬¡çŸ¥è¯†åº“éƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªæ•°æ®æºè¿æ¥ï¼Œç„¶åå°†è¿™ä¸ªè¿æ¥å­˜å…¥ <code>master</code> åº“ï¼Œæˆ‘ä»¬ä¸å¯èƒ½æ¯æ¬¡æ–°å¢ä¸€ä¸ªè¿æ¥å°±å°†æ•°æ®æºè¿æ¥é…ç½®åˆ°<code>yml</code> æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥å°±éœ€è¦ç³»ç»Ÿå¯åŠ¨æ—¶ä¸»åŠ¨ä»åˆ«çš„åœ°æ–¹è·å–æ•°æ®æºè¿æ¥ï¼Œè¿™é‡Œæˆ‘ä» <code>master</code> åº“è·å–ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹å®ƒçš„æ ¸å¿ƒç±» <code>DynamicRoutingDataSource</code> çš„æºç  ï¼Œé™¤äº† <code>springboot</code> å®˜æ–¹æä¾›çš„å¤šæ•°æ®æºåˆ‡æ¢æ“ä½œä¹‹å¤–ï¼Œå®ƒè¿˜æ‰©å±•æä¾›äº†æ•°æ®æºåˆ†ç»„ã€åŠ¨æ€æ–°å¢æˆ–åˆ é™¤æ•°æ®æºè¿æ¥ç­‰æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicRoutingDataSource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractRoutingDataSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span>, DisposableBean &#123;<br>    <span class="hljs-comment">// å…¶ä»–å±æ€§å’Œæ–¹æ³•åˆ é™¤ï¼Œåªä¿ç•™æ ¸å¿ƒæ–¹æ³•å±æ€§</span><br>    <span class="hljs-comment">// æ‰€æœ‰æ•°æ®åº“</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, DataSource&gt; dataSourceMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br>    <span class="hljs-comment">// åˆ†ç»„æ•°æ®åº“</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, GroupDataSource&gt; groupDataSources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br>    <span class="hljs-comment">// æ•°æ®æºåŠ è½½æ¥å£</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;DynamicDataSourceProvider&gt; providers;<br>    <br><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// æ£€æŸ¥å¼€å¯äº†é…ç½®ä½†æ²¡æœ‰ç›¸å…³ä¾èµ–</span><br>        checkEnv();<br>        <span class="hljs-comment">// æ·»åŠ å¹¶åˆ†ç»„æ•°æ®æº</span><br>        Map&lt;String, DataSource&gt; dataSources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">16</span>);<br>        <span class="hljs-keyword">for</span> (DynamicDataSourceProvider provider : providers) &#123;<br>            Map&lt;String, DataSource&gt; dsMap = provider.loadDataSources();<br>            <span class="hljs-keyword">if</span> (dsMap != <span class="hljs-literal">null</span>) &#123;<br>                dataSources.putAll(dsMap);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, DataSource&gt; dsItem : dataSources.entrySet()) &#123;<br>            addDataSource(dsItem.getKey(), dsItem.getValue());<br>        &#125;<br>        <span class="hljs-comment">// æ£€æµ‹é»˜è®¤æ•°æ®æºæ˜¯å¦è®¾ç½®</span><br>        <span class="hljs-keyword">if</span> (groupDataSources.containsKey(primary)) &#123;<br>            log.info(<span class="hljs-string">&quot;dynamic-datasource initial loaded [&#123;&#125;] datasource,primary group datasource named [&#123;&#125;]&quot;</span>, dataSources.size(), primary);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dataSourceMap.containsKey(primary)) &#123;<br>            log.info(<span class="hljs-string">&quot;dynamic-datasource initial loaded [&#123;&#125;] datasource,primary datasource named [&#123;&#125;]&quot;</span>, dataSources.size(), primary);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            log.warn(<span class="hljs-string">&quot;dynamic-datasource initial loaded [&#123;&#125;] datasource,Please add your primary datasource or check your configuration&quot;</span>, dataSources.size());<br>        &#125;<br>    &#125;    <br>&#125;    <br></code></pre></td></tr></table></figure><p>æ³¨æ„ <code>afterPropertiesSet()</code> æ–¹æ³•ä¸­å¾ªç¯éå†äº† <code>providers</code> è¿™ä¸ªå®ä¾‹å˜é‡ï¼Œå¹¶å°†<code>loadDataSources()</code> æ–¹æ³•è¿”å›çš„æ•°æ®æºæ·»åŠ åˆ° <code>dataSourceMap</code> ä¸­ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çŒœæµ‹ <code>DynamicDataSourceProvider</code> æ˜¯ç”¨æ¥åŠ è½½æ•°æ®æºè¿æ¥çš„æ¥å£ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20231113102320148.png" alt="image-20231113102320148"></p><p>æœç„¶ï¼Œä¸å‡ºæˆ‘ä»¬æ‰€æ–™ã€‚å®ƒæœ‰ä¸€ä¸ªé»˜è®¤çš„å®ç°ç±»ä» <code>yml</code> é…ç½®æ–‡ä»¶ä¸­è¯»å–æ•°æ®æºè¿æ¥ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20231113102557770.png" alt="image-20231113102557770"></p><p>è¿™ä¸ªé»˜è®¤çš„å®ç°ç±»ä¸­å…·ä½“æ˜¯å¦‚ä½•åˆ›å»ºæ•°æ®æºçš„ä¸æ˜¯æˆ‘ä»¬å…³æ³¨çš„é‡ç‚¹ï¼Œæˆ‘ä»¬ä¸»è¦çœ‹å®ƒæ˜¯ä½•æ—¶åŠ è½½çš„ï¼Œå¼„æ˜ç™½è¿™ä¸€ç‚¹é‚£æˆ‘ä»¬å°±å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªæ•°æ®æºåŠ è½½ç±»ï¼ŒåŠ è½½æˆ‘ä»¬æ‰€éœ€è¦çš„æ•°æ®æºè¿æ¥ã€‚</p><p>æˆ‘ä»¬ä»å¼•å…¥çš„ <code>starter</code> å‡ºå‘ï¼Œåœ¨ <code>META_INF/spring.factories</code> æ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°è‡ªåŠ¨é…ç½®ç±»ã€‚</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="hljs-string">\</span><br><span class="hljs-string">com.baomidou.dynamic.datasource.spring.boot.autoconfigure.DynamicDataSourceAutoConfiguration</span><br></code></pre></td></tr></table></figure><p>ç‚¹è¿›å»è¿™ä¸ªé…ç½®ç±»ï¼Œå¯ä»¥çœ‹åˆ°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableConfigurationProperties(DynamicDataSourceProperties.class)</span><br><span class="hljs-meta">@AutoConfigureBefore(value = DataSourceAutoConfiguration.class, name = &quot;com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceAutoConfigure&quot;)</span><br><span class="hljs-meta">@Import(&#123;DruidDynamicDataSourceConfiguration.class, DynamicDataSourceCreatorAutoConfiguration.class, DynamicDataSourceAopConfiguration.class, DynamicDataSourceAssistConfiguration.class&#125;)</span><br><span class="hljs-meta">@ConditionalOnProperty(prefix = DynamicDataSourceProperties.PREFIX, name = &quot;enabled&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicDataSourceAutoConfiguration</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DynamicDataSourceProperties properties;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;DynamicDataSourcePropertiesCustomizer&gt; dataSourcePropertiesCustomizers;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DynamicDataSourceAutoConfiguration</span><span class="hljs-params">(</span><br><span class="hljs-params">            DynamicDataSourceProperties properties,</span><br><span class="hljs-params">            ObjectProvider&lt;List&lt;DynamicDataSourcePropertiesCustomizer&gt;&gt; dataSourcePropertiesCustomizers)</span> &#123;<br>        <span class="hljs-built_in">this</span>.properties = properties;<br>        <span class="hljs-built_in">this</span>.dataSourcePropertiesCustomizers = dataSourcePropertiesCustomizers.getIfAvailable();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@ConditionalOnMissingBean</span><br>    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">dataSource</span><span class="hljs-params">(List&lt;DynamicDataSourceProvider&gt; providers)</span> &#123;<br>        <span class="hljs-type">DynamicRoutingDataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicRoutingDataSource</span>(providers);<br>        dataSource.setPrimary(properties.getPrimary());<br>        dataSource.setStrict(properties.getStrict());<br>        dataSource.setStrategy(properties.getStrategy());<br>        dataSource.setP6spy(properties.getP6spy());<br>        dataSource.setSeata(properties.getSeata());<br>        dataSource.setGraceDestroy(properties.getGraceDestroy());<br>        <span class="hljs-keyword">return</span> dataSource;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(dataSourcePropertiesCustomizers)) &#123;<br>            <span class="hljs-keyword">for</span> (DynamicDataSourcePropertiesCustomizer customizer : dataSourcePropertiesCustomizers) &#123;<br>                customizer.customize(properties);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åˆå§‹åŒ– <code>dataSource</code> ä¸­ä¼ å…¥äº†å…¥å‚ <code>providers</code> ï¼Œé‚£è¿™ä¸ª <code>providers</code> æ˜¯ä»å“ªæ¥çš„å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å‘ç°é…ç½®ç±»ä¸Šé¢æœ‰ä¸€ä¸ª <code>@Import</code> æ³¨è§£ï¼Œå¼•å…¥äº†å…¶ä»–é…ç½®ï¼Œè¿›å…¥æœ€åä¸€ä¸ª <code>DynamicDataSourceAssistConfiguration</code> é…ç½®ç±»ï¼Œå¯ä»¥å‘ç°åœ¨è¿™é‡Œæ³¨å…¥äº†é»˜è®¤çš„ <code>yml provider</code></p><p><img src="https://image.seeyourface.cn/migrate/image-20231113104316481.png" alt="image-20231113104316481"></p><p>æ‰€ä»¥æˆ‘ä»¬ä¹Ÿå®šä¹‰ä¸€ä¸ªè‡ªåŠ¨é…ç½®ç±»ï¼Œç„¶åå°†æˆ‘ä»¬è‡ªå·±çš„ <code>provider</code> äº¤ç»™ <code>spring</code> å®¹å™¨ç®¡ç†ã€‚</p><p>åŒæ—¶è¿™é‡Œé»˜è®¤å®ç°äº†ä¸€ä¸ªæŠ½è±¡ç±» <code>provider</code> ä¾›æˆ‘ä»¬ä½¿ç”¨ï¼Œæˆ‘ä»¬ä¸å¿…å»å®ç° <code>DynamicDataSourceProvider</code> æ¥å£ï¼Œåªéœ€è¦å®ç°è¿™ä¸ªæŠ½è±¡ç±»ç„¶åé‡å†™ <code>executeStmt()</code> æ–¹æ³•é€šè¿‡é»˜è®¤æ•°æ®æºæ‰§è¡Œ <code>SQL</code> è·å–æ•°æ®åº“ä¸­çš„è¿æ¥å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomDynamicDataSourceProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractJdbcDataSourceProvider</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">PATTERN</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;/([^/]+)\\?&quot;</span>);<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DataSourceProperty dataSourceProperty;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CustomDynamicDataSourceProvider</span><span class="hljs-params">(DefaultDataSourceCreator defaultDataSourceCreator, DataSourceProperty dataSourceProperty)</span> &#123;<br>        <span class="hljs-built_in">super</span>(defaultDataSourceCreator, dataSourceProperty.getDriverClassName(),<br>                dataSourceProperty.getUrl(), dataSourceProperty.getUsername(), dataSourceProperty.getPassword());<br>        <span class="hljs-built_in">this</span>.dataSourceProperty = dataSourceProperty;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> Map&lt;String, DataSourceProperty&gt; <span class="hljs-title function_">executeStmt</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        Map&lt;String, DataSourceProperty&gt; dataSourcePropertiesMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">ResultSet</span> <span class="hljs-variable">resultSet</span> <span class="hljs-operator">=</span> statement.executeQuery(<span class="hljs-string">&quot;select * from library_sync_config where is_used = true&quot;</span>);<br>        <span class="hljs-keyword">if</span> (Objects.nonNull(resultSet)) &#123;<br>            <span class="hljs-keyword">while</span> (resultSet.next()) &#123;<br>                <span class="hljs-type">DataSourceProperty</span> <span class="hljs-variable">newProperty</span> <span class="hljs-operator">=</span> BeanUtil.copyProperties(dataSourceProperty, DataSourceProperty.class);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> resultSet.getString(<span class="hljs-string">&quot;version&quot;</span>);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">configName</span> <span class="hljs-operator">=</span> resultSet.getString(<span class="hljs-string">&quot;config_name&quot;</span>);<br>                <span class="hljs-comment">// æ›¿æ¢urlä¸­çš„æ•°æ®åº“åç§°ï¼Œå…¶ä»–å±æ€§éƒ½å’Œmasterä¸€è‡´</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> replaceDatabaseName(dataSourceProperty.getUrl(), configName);<br>                newProperty.setPoolName(version);<br>                dataSourcePropertiesMap.put(version, newProperty);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> dataSourcePropertiesMap;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">replaceDatabaseName</span><span class="hljs-params">(String url, String newDatabaseName)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">oldDatabaseName</span> <span class="hljs-operator">=</span> parseDatabaseName(url);<br>        <span class="hljs-keyword">return</span> url.replaceFirst(<span class="hljs-string">&quot;(?i)&quot;</span> + oldDatabaseName, newDatabaseName);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">parseDatabaseName</span><span class="hljs-params">(String url)</span> &#123;<br>        <span class="hljs-comment">// ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–æ•°æ®åº“å</span><br>        <span class="hljs-type">Matcher</span> <span class="hljs-variable">matcher</span> <span class="hljs-operator">=</span> PATTERN.matcher(url);<br><br>        <span class="hljs-keyword">if</span> (matcher.find()) &#123;<br>            <span class="hljs-keyword">return</span> matcher.group(<span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå› ä¸ºæˆ‘æ˜¯é€šè¿‡æ›´æ–°çŸ¥è¯†åº“æ“ä½œå†åˆ›å»ºä¸€ä¸ªåŒçº§åˆ«çš„æ•°æ®åº“ï¼Œæ‰€ä»¥é™¤äº†åº“åå…¶ä»–ä¿¡æ¯éƒ½æ˜¯ä¸€è‡´çš„ï¼Œæ–°è¿æ¥åªéœ€è¦æ›¿æ¢åº“åå³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableConfigurationProperties(&#123;DynamicDataSourceProperties.class&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicDataSourceConfig</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DynamicDataSourceProperties properties;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DynamicDataSourceConfig</span><span class="hljs-params">(DynamicDataSourceProperties properties)</span> &#123;<br>        <span class="hljs-built_in">this</span>.properties = properties;<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@Primary</span><br>    <span class="hljs-keyword">public</span> DynamicDataSourceProvider <span class="hljs-title function_">dynamicDataSourceProvider</span><span class="hljs-params">(DefaultDataSourceCreator defaultDataSourceCreator)</span> &#123;<br>        Map&lt;String, DataSourceProperty&gt; datasource = <span class="hljs-built_in">this</span>.properties.getDatasource();<br>        <span class="hljs-comment">// å¿…é¡»é…ç½®masteræ•°æ®æºï¼Œé€šè¿‡masteræ•°æ®æºåˆ›å»ºå…¶ä»–è¿æ¥æ·»åŠ è‡³æ•°æ®åº“è¿æ¥æ± </span><br>        <span class="hljs-type">DataSourceProperty</span> <span class="hljs-variable">master</span> <span class="hljs-operator">=</span> datasource.get(<span class="hljs-string">&quot;master&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomDynamicDataSourceProvider</span>(defaultDataSourceCreator, master);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡æ§åˆ¶å°æ‰“å°çš„æ—¥å¿—æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶é…ç½®æ–‡ä»¶åªé…ç½®äº†ä¸€ä¸ªæ•°æ®è¿æ¥ï¼Œä½†ç³»ç»Ÿå¯åŠ¨æ—¶é€šè¿‡å…¶å®ƒåœ°æ–¹æ–°å¢äº†ä¸€ä¸ªé…ç½®è¿æ¥ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20231113110534993.png" alt="image-20231113110534993"></p><h3 id="è‡ªå®šä¹‰å¤„ç†é€»è¾‘"><a href="#è‡ªå®šä¹‰å¤„ç†é€»è¾‘" class="headerlink" title="è‡ªå®šä¹‰å¤„ç†é€»è¾‘"></a>è‡ªå®šä¹‰å¤„ç†é€»è¾‘</h3><p>åŠ¨æ€æ•°æ®æºé€šè¿‡æ‹¦æˆªæ·»åŠ äº† <code>@DS(xxx)</code> æ³¨è§£çš„ç±»æˆ–æ–¹æ³•ï¼Œæ ¹æ®æ³¨è§£è®¾ç½®çš„å€¼é€‰å–å¯¹åº”æ•°æ®æºè¿æ¥ã€‚</p><p>é€šè¿‡é…ç½®ç±» <code>DynamicDataSourceAopConfiguration</code> å‘ç°æœ‰ä¸¤ä¸ªä¸»è¦çš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// æ„é€ æ•°æ®æºå¤„ç†å™¨ï¼Œé»˜è®¤ä¼šåˆ›å»ºä¸‰ä¸ªprocessorï¼Œå¹¶ä»¥æ‰§è¡Œé“¾çš„æ–¹å¼è®¾ç½®å¥½æ‰§è¡Œé¡ºåº</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@ConditionalOnMissingBean</span><br><span class="hljs-keyword">public</span> DsProcessor <span class="hljs-title function_">dsProcessor</span><span class="hljs-params">(BeanFactory beanFactory)</span> &#123;<br>    <span class="hljs-type">DsProcessor</span> <span class="hljs-variable">headerProcessor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DsHeaderProcessor</span>();<br>    <span class="hljs-type">DsProcessor</span> <span class="hljs-variable">sessionProcessor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DsSessionProcessor</span>();<br>    <span class="hljs-type">DsSpelExpressionProcessor</span> <span class="hljs-variable">spelExpressionProcessor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DsSpelExpressionProcessor</span>();<br>    spelExpressionProcessor.setBeanResolver(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanFactoryResolver</span>(beanFactory));<br>    headerProcessor.setNextProcessor(sessionProcessor);<br>    sessionProcessor.setNextProcessor(spelExpressionProcessor);<br>    <span class="hljs-keyword">return</span> headerProcessor;<br>&#125;<br><br><span class="hljs-comment">//åˆ›å»ºAdvisorå¯¹è±¡ï¼ŒæŒ‡å®šæ‹¦æˆªå™¨å’Œéœ€è¦æ‹¦æˆªçš„æ³¨è§£</span><br><span class="hljs-meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@ConditionalOnProperty(prefix = DynamicDataSourceProperties.PREFIX + &quot;.aop&quot;, name = &quot;enabled&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</span><br><span class="hljs-keyword">public</span> Advisor <span class="hljs-title function_">dynamicDatasourceAnnotationAdvisor</span><span class="hljs-params">(DsProcessor dsProcessor)</span> &#123;<br>    <span class="hljs-type">DynamicDatasourceAopProperties</span> <span class="hljs-variable">aopProperties</span> <span class="hljs-operator">=</span> properties.getAop();<br>    <span class="hljs-type">DynamicDataSourceAnnotationInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicDataSourceAnnotationInterceptor</span>(aopProperties.getAllowedPublicOnly(), dsProcessor);<br>    <span class="hljs-type">DynamicDataSourceAnnotationAdvisor</span> <span class="hljs-variable">advisor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicDataSourceAnnotationAdvisor</span>(interceptor, DS.class);<br>    advisor.setOrder(aopProperties.getOrder());<br>    <span class="hljs-keyword">return</span> advisor;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>DsProcessor</code> æ˜¯ä¸€ä¸ªå¤„ç†å™¨çš„æŠ½è±¡ç±»ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°ä½•æ—¶åŒ¹é…è¿™ä¸ªå¤„ç†å™¨ï¼Œä»¥åŠæ ¹æ®ä¼ å…¥çš„keyå†³å®šè¦åŒ¹é…å“ªä¸ªæ•°æ®æºè¿æ¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DsProcessor</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ä¸‹ä¸€ä¸ªæ‰§è¡Œå™¨</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> DsProcessor nextProcessor;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è®¾ç½®ä¸‹ä¸€ä¸ªæ‰§è¡Œå™¨</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dsProcessor æ‰§è¡Œå™¨</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNextProcessor</span><span class="hljs-params">(DsProcessor dsProcessor)</span> &#123;<br>        <span class="hljs-built_in">this</span>.nextProcessor = dsProcessor;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æŠ½è±¡åŒ¹é…æ¡ä»¶ åŒ¹é…æ‰ä¼šèµ°å½“å‰æ‰§è¡Œå™¨å¦åˆ™èµ°ä¸‹ä¸€çº§æ‰§è¡Œå™¨</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key DSæ³¨è§£é‡Œçš„å†…å®¹</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> æ˜¯å¦åŒ¹é…</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(String key)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å†³å®šæ•°æ®æº</span><br><span class="hljs-comment">     * &lt;pre&gt;</span><br><span class="hljs-comment">     *     è°ƒç”¨åº•å±‚doDetermineDatasourceï¼Œ</span><br><span class="hljs-comment">     *     å¦‚æœè¿”å›çš„æ˜¯nullåˆ™ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªï¼Œå¦åˆ™ç›´æ¥è¿”å›</span><br><span class="hljs-comment">     * &lt;/pre&gt;</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> invocation æ–¹æ³•æ‰§è¡Œä¿¡æ¯</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key        DSæ³¨è§£é‡Œçš„å†…å®¹</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> æ•°æ®æºåç§°</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">determineDatasource</span><span class="hljs-params">(MethodInvocation invocation, String key)</span> &#123;<br>        <span class="hljs-keyword">if</span> (matches(key)) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">datasource</span> <span class="hljs-operator">=</span> doDetermineDatasource(invocation, key);<br>            <span class="hljs-keyword">if</span> (datasource == <span class="hljs-literal">null</span> &amp;&amp; nextProcessor != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> nextProcessor.determineDatasource(invocation, key);<br>            &#125;<br>            <span class="hljs-keyword">return</span> datasource;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (nextProcessor != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> nextProcessor.determineDatasource(invocation, key);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æŠ½è±¡æœ€ç»ˆå†³å®šæ•°æ®æº</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> invocation æ–¹æ³•æ‰§è¡Œä¿¡æ¯</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key        DSæ³¨è§£é‡Œçš„å†…å®¹</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> æ•°æ®æºåç§°</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title function_">doDetermineDatasource</span><span class="hljs-params">(MethodInvocation invocation, String key)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­åˆ›å»ºè‡ªå·±çš„ <code>Processor</code> å³å¯è‡ªå®šä¹‰æ•°æ®æºçš„å¤„ç†é€»è¾‘ï¼Œå½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å®šä¹‰å¤šä¸ª <code>Processor</code> å½¢æˆä¸€æ¡æ‰§è¡Œé“¾ã€‚</p><p>æˆ‘ä»¬å®šä¹‰å¥½è‡ªå·±çš„ <code>Processor</code> ä¹‹åå› ä¸º <code>@ConditionalOnMissingBean</code> æ³¨è§£é»˜è®¤çš„å¤„ç†å™¨å°±ä¸ä¼šç”Ÿæ•ˆäº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> DsProcessor <span class="hljs-title function_">dsProcessor</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyProcessor</span>();<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyProcessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DsProcessor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-comment">// å®šä¹‰ä½•æ—¶åŒ¹é…è¿™ä¸ªå¤„ç†å™¨</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">doDetermineDatasource</span><span class="hljs-params">(MethodInvocation invocation, String key)</span> &#123;<br>        <span class="hljs-comment">// è‡ªå·±çš„å¤„ç†é€»è¾‘</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åŠ¨æ€å¢å‡æ•°æ®æº"><a href="#åŠ¨æ€å¢å‡æ•°æ®æº" class="headerlink" title="åŠ¨æ€å¢å‡æ•°æ®æº"></a>åŠ¨æ€å¢å‡æ•°æ®æº</h3><p><code>DynamicRoutingDataSource</code> ç»„ä»¶ä¸­æä¾›äº† <code>addDataSource()</code> å’Œ <code>removeDataSource()</code> ä¸¤ä¸ªæ–¹æ³•ï¼Œä½¿ç”¨æ—¶åªéœ€è¦æ³¨å…¥è¯¥ç»„ä»¶è°ƒç”¨æŒ‡å®šæ–¹æ³•å³å¯ï¼Œååˆ†æ–¹ä¾¿ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>ä¸­é—´ä»¶</category>
      
      <category>åŠ¨æ€æ•°æ®æº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>åŠ¨æ€æ•°æ®æº</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç®€å•å·¥å‚+è´£ä»»é“¾æ¨¡å¼å®ç°ä»»åŠ¡å®Œæ•´æ€§æ ¡éªŒ</title>
    <link href="/2023/10/27/%E7%AE%80%E5%8D%95%E5%B7%A5%E5%8E%82+%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F%E5%AE%9E%E7%8E%B0%E4%BB%BB%E5%8A%A1%E5%AE%8C%E6%95%B4%E6%80%A7%E6%A0%A1%E9%AA%8C/"/>
    <url>/2023/10/27/%E7%AE%80%E5%8D%95%E5%B7%A5%E5%8E%82+%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F%E5%AE%9E%E7%8E%B0%E4%BB%BB%E5%8A%A1%E5%AE%8C%E6%95%B4%E6%80%A7%E6%A0%A1%E9%AA%8C/</url>
    
    <content type="html"><![CDATA[<h3 id="åºè¨€"><a href="#åºè¨€" class="headerlink" title="åºè¨€"></a>åºè¨€</h3><p>ç°åœ¨æœ‰è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼š</p><p>ä½œä¸šç»“é¡¹æ—¶éœ€è¦å¯¹æ¯ä¸ª <code>Label</code> ä¸­çš„æ•°æ®å®Œæ•´æ€§è¿›è¡Œæ ¡éªŒã€‚ä½ å¯ä»¥å°† <code>Label</code> ç†è§£ä¸ºä¸åŒçš„æ ‡ç­¾ï¼Œæ¯ä¸ªæ ‡ç­¾ä¸­éƒ½éœ€è¦å®Œæˆç‰¹å®šçš„å†…å®¹ï¼Œä¸€ä¸ªä½œä¸šå¯ä»¥é…ç½®å¤šä¸ª <code>Label</code> ã€‚</p><p>çœ‹åˆ°è¿™ä¸ªéœ€æ±‚ï¼Œæˆ‘ä»¬äºŒè¯ä¸è¯´ï¼Œç›´æ¥åœ¨ä½œä¸šç»“é¡¹æ¥å£ä¸­æ–°å¢ä»£ç ï¼Œå¯¹æ¯ä¸ª <code>Label</code> è¿›è¡Œæ ¡éªŒæ“ä½œã€‚</p><p>è¿™æ ·æœ‰é—®é¢˜å—ï¼Ÿå½“ç„¶æ²¡é—®é¢˜ï¼ï¼ˆä½ çœ‹ç€è¢«ä»£ç å¡æ»¡çš„ç±»å¿ƒè™šçš„è¯´åˆ°ï¼‰</p><p>ä¸€é¡¿æ“ä½œçŒ›å¦‚è™ï¼Œä»£ç  <code>Review</code> éª‚æˆç‹— ~</p><p>ä½œä¸ºä¸€åä¼˜é›…ï¼ˆè‡ªè®¤ä¸ºï¼‰çš„ç¨‹åºå‘˜ï¼Œç»ä¸å…è®¸è¿™ç§æƒ…å†µå‡ºç°ï¼</p><p>è¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦è€ƒè™‘ä½¿ç”¨è®¾è®¡æ¨¡å¼æ¥åº”å¯¹äº†ã€‚</p><p>ä½¿ç”¨äº†è®¾è®¡æ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥åšåˆ°åœ¨ç»“é¡¹æ–¹æ³•ä¸­åªæ–°å¢ä¸€è¡Œä»£ç å³å¯å®ç°éœ€æ±‚ï¼ˆæ­ªå˜´æˆ˜ç¥ï¼‰~</p><h3 id="æ€ä¹ˆé€‰æ‹©è®¾è®¡æ¨¡å¼"><a href="#æ€ä¹ˆé€‰æ‹©è®¾è®¡æ¨¡å¼" class="headerlink" title="æ€ä¹ˆé€‰æ‹©è®¾è®¡æ¨¡å¼"></a>æ€ä¹ˆé€‰æ‹©è®¾è®¡æ¨¡å¼</h3><p>ä½¿ç”¨è®¾è®¡æ¨¡å¼çš„éš¾ç‚¹å¾€å¾€åœ¨äºå¦‚ä½•é€‰ç”¨ï¼Œå› ä¸ºåªæœ‰é€‰å¯¹äº†æ–¹æ³•æ‰èƒ½äº‹åŠåŠŸå€ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬å¯¹æ¯ä¸ª <code>Label</code> éƒ½æœ‰ä¸åŒçš„å¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸ºæ¯ä¸ª <code>Label</code> éƒ½éœ€è¦æ–°å»ºä¸€ä¸ª <code>handler</code> ï¼Œå°†æ¯ä¸ª <code>Label</code> çš„æ ¡éªŒæ“ä½œè§£è€¦å’Œéš”ç¦»ï¼Œä½¿å®ƒä»¬äº’ä¸å½±å“ï¼Œå°†æ¥è¦å¯¹å…¶ä¸­æŸä¸ª <code>Label</code> ä¿®æ”¹æ—¶ï¼Œä¹Ÿå¯ä»¥åšå°½é‡å°‘çš„æ“ä½œã€‚ </p><p>åŒæ—¶æˆ‘ä»¬å¯ä»¥å°†æ‰€æœ‰ <code>Label</code> çš„æ ¡éªŒæ“ä½œä¸²æˆä¸€æ¡æ‰§è¡Œé“¾æ¡ï¼Œåªè¦æŸä¸ªèŠ‚ç‚¹æ ¡éªŒåˆ°ä¸æ»¡è¶³æ¡ä»¶å³å¯æå‰é€€å‡ºï¼Œè€Œä¸éœ€è¦å†æ‰§è¡Œåç»­æ“ä½œã€‚å¯¹äºæ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹åˆ™è¿›å…¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ç»§ç»­æ ¡éªŒã€‚ç›´åˆ°æ‰€æœ‰ <code>Label</code> æ ¡éªŒå®Œæ¯•ã€‚</p><p>éƒ½è¯´åˆ°è¿™ä¸ªä»½ä¸Šäº†ï¼Œæƒ³å¿…å¤§å®¶ä¹ŸçŸ¥é“ä»€ä¹ˆè®¾è®¡æ¨¡å¼é€‚åˆå®ç°è¿™ä¸ªéœ€æ±‚äº†ï¼Œæ²¡é”™ï¼Œå°±æ˜¯ç®€å•å·¥å‚æ¨¡å¼å’Œè´£ä»»é“¾æ¨¡å¼ã€‚</p><p>æœ¬æ–‡ä¸å¯¹ä¸Šè¿°ä¸¤ä¸ªæ¨¡å¼åšè¯¦ç»†ä»‹ç»ï¼Œç›´æ¥ä¸Šä»£ç ã€‚</p><h3 id="ç®€å•å·¥å‚"><a href="#ç®€å•å·¥å‚" class="headerlink" title="ç®€å•å·¥å‚"></a>ç®€å•å·¥å‚</h3><p>æˆ‘ä»¬éœ€è¦å¯¹ä¸åŒçš„ <code>Label</code> è·å–ä¸åŒçš„ <code>handler</code> å¤„ç†ç±»ï¼Œä¸€èˆ¬æˆ‘ä»¬å¯ä»¥é€šè¿‡ç­–ç•¥æ¨¡å¼ + ç®€å•å·¥å‚çš„æ–¹å¼æ¥æ ¹æ® <code>Label</code> æ ‡ç­¾ç±»å‹æ¥åˆ›å»º <code>handler</code> å¤„ç†ç±»ã€‚</p><p>è¿™é‡Œæˆ‘é€šè¿‡å°†æ‰€æœ‰ <code>handler</code> å®ç°ç±»äº¤ç”± <code>spring</code> å®¹å™¨ç®¡ç†ï¼Œå†æ ¹æ®éœ€è¦é€šè¿‡ <code>Label</code> ç±»å‹è·å–ï¼Œè€Œä¸å¿…æ¯æ¬¡è·å–éƒ½å»åˆ›å»ºã€‚</p><h4 id="å®šä¹‰æ‰€æœ‰å¤„ç†ç±»çš„è¶…ç±»"><a href="#å®šä¹‰æ‰€æœ‰å¤„ç†ç±»çš„è¶…ç±»" class="headerlink" title="å®šä¹‰æ‰€æœ‰å¤„ç†ç±»çš„è¶…ç±»"></a>å®šä¹‰æ‰€æœ‰å¤„ç†ç±»çš„è¶…ç±»</h4><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªè¢«æ‰€æœ‰ <code>Label</code> ç»§æ‰¿çš„è¶…ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperationResultHandler</span> &#123;<br><br>    <span class="hljs-keyword">protected</span> OperationResultHandler handler;<br><br>    <span class="hljs-comment">// è®¾ç½®ä¸‹ä¸€ä¸ªæ‰§è¡ŒèŠ‚ç‚¹</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSuperior</span><span class="hljs-params">(OperationResultHandler handler)</span> &#123;<br>        <span class="hljs-built_in">this</span>.handler = handler;<br>    &#125;<br><br>    <span class="hljs-comment">// è¿”å›å½“å‰å®ç°ç±»çš„type</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> LabelEnum <span class="hljs-title function_">getType</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-comment">// æ‰§è¡Œå…·ä½“çš„æ ¡éªŒæ“ä½œ</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> Pair&lt;Boolean, LabelEnum&gt; <span class="hljs-title function_">handler</span><span class="hljs-params">(DutyRequest request)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å®šä¹‰å„ä¸ªLabelçš„å®ç°ç±»"><a href="#å®šä¹‰å„ä¸ªLabelçš„å®ç°ç±»" class="headerlink" title="å®šä¹‰å„ä¸ªLabelçš„å®ç°ç±»"></a>å®šä¹‰å„ä¸ªLabelçš„å®ç°ç±»</h4><p>ç”±äº <code>Label</code> æ•°é‡æ¯”è¾ƒå¤šï¼Œè¿™é‡Œåªåˆ—ä¸¾ä¸€ä¸ªå®ç°ç±»ï¼Œæ‰€æœ‰å®ç°ç±»é™¤å…·ä½“æ ¡éªŒé€»è¾‘å¤–å‡ä¸€è‡´ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@RequiredArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrganizeVerifyHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OperationResultHandler</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> QuestionnaireMapper questionnaireMapper;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> LabelEnum <span class="hljs-title function_">getType</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> LabelEnum.ZZDY;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Pair&lt;Boolean, LabelEnum&gt; <span class="hljs-title function_">handler</span><span class="hljs-params">(DutyRequest request)</span> &#123;<br>        <span class="hljs-comment">// å¦‚æœä½œä¸šåŒ…å«å½“å‰èŠ‚ç‚¹æ‰å¯¹å½“å‰èŠ‚ç‚¹æ ¡éªŒï¼Œå¦åˆ™è¿›å…¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span><br>        <span class="hljs-keyword">if</span> (request.getServiceIds().contains(getType().getCode())) &#123;<br>            <span class="hljs-comment">// å…·ä½“çš„æ ¡éªŒé€»è¾‘ï¼Œä¸æ»¡è¶³ç›´æ¥è·³å‡ºï¼Œæ»¡è¶³ä¸”ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ä¸ºç©ºç»§ç»­æ ¡éªŒ</span><br>            <span class="hljs-type">Integer</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> questionnaireMapper.selectCount(<span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;Questionnaire&gt;()<br>                    .eq(<span class="hljs-string">&quot;operation_id&quot;</span>, request.getOperationId())<br>                    .eq(<span class="hljs-string">&quot;object_id&quot;</span>, getType().getCode())<br>                    .eq(<span class="hljs-string">&quot;finished&quot;</span>, <span class="hljs-literal">false</span>));<br>            <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Pair</span>&lt;&gt;(Boolean.FALSE, getType());<br>        &#125;<br>        <span class="hljs-comment">// ä¸‹ä¸€ä¸ªæµç¨‹é“¾ä¸ä¸ºç©ºç»§ç»­æ ¡éªŒï¼Œå¦åˆ™ä¸ºæœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿”å›trueæ ¡éªŒé€šè¿‡</span><br>        <span class="hljs-keyword">if</span> (handler != <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">return</span> handler.handler(request);<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Pair</span>&lt;&gt;(Boolean.TRUE, getType());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Springå®¹å™¨ç®¡ç†"><a href="#Springå®¹å™¨ç®¡ç†" class="headerlink" title="Springå®¹å™¨ç®¡ç†"></a>Springå®¹å™¨ç®¡ç†</h3><p>æˆ‘ä»¬å¯ä»¥å°†æ‰€æœ‰ <code>Label</code> çš„å®ç°ç±»äº¤ç»™ <code>Spring</code> å®¹å™¨ç®¡ç†ï¼Œ åŒ…æ‹¬ç”Ÿäº§ <code>handler</code> çš„å·¥å‚ï¼Œéœ€è¦ä½¿ç”¨æ—¶å†é€šè¿‡ <code>getHandler()</code> æ–¹æ³•ä¼ å…¥å…¥å‚ <code>Label</code> çš„ç±»å‹è·å–ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperationResultHandlerFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span>, ApplicationContextAware &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ApplicationContext applicationContext;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;LabelEnum, Supplier&lt;OperationResultHandler&gt;&gt; BEAN_MAP = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ ¹æ®labelæ ‡ç­¾è·å–å¯¹åº”çš„å¤„ç†å™¨</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> type &#123;<span class="hljs-doctag">@see</span> LabelEnum&#125;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> return handler with type, null if not found</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> OperationResultHandler <span class="hljs-title function_">getHandler</span><span class="hljs-params">(LabelEnum type)</span> &#123;<br>        Supplier&lt;OperationResultHandler&gt; supplier = BEAN_MAP.get(type);<br>        <span class="hljs-keyword">return</span> Objects.isNull(supplier) ? <span class="hljs-literal">null</span> : supplier.get();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> &#123;<br>        applicationContext.getBeansOfType(OperationResultHandler.class).values()<br>                .forEach(bean -&gt; BEAN_MAP.put(bean.getType(), () -&gt; bean));<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicationContext</span><span class="hljs-params">(<span class="hljs-meta">@NotNull</span> ApplicationContext applicationContext)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        OperationResultHandlerFactory.applicationContext = applicationContext;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="è´£ä»»é“¾"><a href="#è´£ä»»é“¾" class="headerlink" title="è´£ä»»é“¾"></a>è´£ä»»é“¾</h3><h4 id="å„èŠ‚ç‚¹å…¬å…±å…¥å‚"><a href="#å„èŠ‚ç‚¹å…¬å…±å…¥å‚" class="headerlink" title="å„èŠ‚ç‚¹å…¬å…±å…¥å‚"></a>å„èŠ‚ç‚¹å…¬å…±å…¥å‚</h4><p>å®šä¹‰æ¯ä¸ª Label å®ç°ç±»éœ€è¦ç”¨çš„å…¬å…±å‚æ•°ï¼Œéšç€è´£ä»»é“¾ä¸€ç›´ä¼ é€’ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DutyRequest</span> &#123;<br><br>    <span class="hljs-comment">// ä½œä¸šid</span><br>    <span class="hljs-keyword">private</span> String operationId;<br><br>    <span class="hljs-comment">// å½“å‰ä½œä¸šåŒ…å«çš„labelç±»å‹</span><br>    <span class="hljs-keyword">private</span> Set&lt;Long&gt; serviceIds;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DutyRequest</span><span class="hljs-params">(String operationId, Set&lt;Long&gt; serviceIds)</span> &#123;<br>        <span class="hljs-built_in">this</span>.operationId = operationId;<br>        <span class="hljs-built_in">this</span>.serviceIds = serviceIds;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æ„å»ºè´£ä»»é“¾"><a href="#æ„å»ºè´£ä»»é“¾" class="headerlink" title="æ„å»ºè´£ä»»é“¾"></a>æ„å»ºè´£ä»»é“¾</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@RequiredArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperationAbilityHandler</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CoOperationMapper coOperationMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ ¹æ®ä½œä¸šidè·å–ä½œä¸šæ‰§è¡Œåˆ—è¡¨æ„å»ºä½œä¸šæ£€æµ‹é“¾ï¼ŒæŒ‰é¡ºåºæ£€æµ‹æ‰€æœ‰æ ‡ç­¾æ˜¯å¦å®Œæˆï¼ˆæ˜¯å¦æœ‰æ•°æ®ï¼‰</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> operation ä½œä¸šid</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">abilityChainVerify</span><span class="hljs-params">(String operation)</span>&#123;<br>        <span class="hljs-comment">// ä½œä¸šæ‰§è¡Œåˆ—è¡¨</span><br>        <span class="hljs-type">CoOperation</span> <span class="hljs-variable">coOperation</span> <span class="hljs-operator">=</span> coOperationMapper.selectById(operation);<br>        <span class="hljs-keyword">if</span> (Objects.isNull(coOperation))<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceException</span>(<span class="hljs-string">&quot;ä½œä¸šä¸å­˜åœ¨&quot;</span>);<br>        Set&lt;Long&gt; serviceIds = StrUtil.split(coOperation.getServiceContent(), StrUtil.COMMA).stream().map(Long::parseLong).collect(Collectors.toSet());<br>        serviceIds.add(LabelEnum.XTDY.getCode());<br>        <span class="hljs-type">DutyRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DutyRequest</span>(operation, serviceIds);<br><br>        <span class="hljs-comment">// æ ‡ç­¾åˆ—è¡¨ï¼ˆæœ‰åºï¼‰</span><br>        List&lt;LabelEnum&gt; labels = Arrays.stream(LabelEnum.values()).filter(l -&gt; l.getPCode() != <span class="hljs-number">0L</span>).collect(Collectors.toList());<br><br>        <span class="hljs-type">OperationResultHandler</span> <span class="hljs-variable">head</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">OperationResultHandler</span> <span class="hljs-variable">currentHandler</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-comment">// æ„å»ºä½œä¸šæ£€æµ‹é“¾</span><br>        <span class="hljs-keyword">for</span> (LabelEnum label : labels) &#123;<br>            <span class="hljs-type">OperationResultHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> OperationResultHandlerFactory.getHandler(label);<br><br>            <span class="hljs-keyword">if</span> (handler != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">if</span> (currentHandler == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-comment">// å¦‚æœå½“å‰å¤„ç†ç¨‹åºä¸ºç©ºï¼Œè¡¨ç¤ºè¿™æ˜¯è´£ä»»é“¾çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span><br>                    head = handler;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">// å°†å½“å‰å¤„ç†ç¨‹åºçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹è®¾ç½®ä¸ºæ–°çš„å¤„ç†ç¨‹åº</span><br>                    currentHandler.setSuperior(handler);<br>                &#125;<br>                currentHandler = handler;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">assert</span> head != <span class="hljs-literal">null</span>;<br>        Pair&lt;Boolean, LabelEnum&gt; pair = head.handler(request);<br>        <span class="hljs-keyword">if</span> (!pair.getKey())<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceException</span>(String.format(<span class="hljs-string">&quot;ä½œä¸šç»“æœæ ¡éªŒä¸é€šè¿‡ï¼Œ[%s]åŠŸèƒ½æœªå®Œæˆ&quot;</span>, pair.getValue().getName()));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ³¨å…¥æ£€æµ‹ä»£ç "><a href="#æ³¨å…¥æ£€æµ‹ä»£ç " class="headerlink" title="æ³¨å…¥æ£€æµ‹ä»£ç "></a>æ³¨å…¥æ£€æµ‹ä»£ç </h3><p>ç„¶åæˆ‘ä»¬åªéœ€è¦åœ¨åŸæ–¹æ³•ä¸­åˆé€‚ä½ç½®å¼•å…¥ä¸€è¡Œä»£ç å³å¯å®Œæˆä½œä¸šçš„å®Œæ•´æ€§æ ¡éªŒï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">operationAbilityHandler.abilityChainVerify(operation.getOperationId());<br></code></pre></td></tr></table></figure><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>é€šè¿‡ä½¿ç”¨è®¾è®¡æ¨¡å¼ï¼Œæˆ‘ä»¬å°†å„ä¸ªæ¨¡å—çš„è€¦åˆåº¦é™åˆ°æœ€ä½ï¼Œæœ‰åˆ©äºåç»­çš„ç»´æŠ¤å’Œè¿­ä»£å·¥ä½œã€‚</p>]]></content>
    
    
    <categories>
      
      <category>è®¾è®¡æ¨¡å¼</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç®€å•å·¥å‚æ¨¡å¼</tag>
      
      <tag>è´£ä»»é“¾æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MySQL Generated Columns</title>
    <link href="/2023/10/26/MySQL%20Generated%20Columns/"/>
    <url>/2023/10/26/MySQL%20Generated%20Columns/</url>
    
    <content type="html"><![CDATA[<h3 id="åºè¨€"><a href="#åºè¨€" class="headerlink" title="åºè¨€"></a>åºè¨€</h3><p><code>MySQL 5.7</code> å¼•å…¥äº†ç”Ÿæˆåˆ—ï¼ˆ<code>Generated Columns</code> è¿˜æœ‰ä¸€ç§è™šæ‹Ÿåˆ—çš„å«æ³•ï¼‰çš„æ”¯æŒã€‚ç”Ÿæˆåˆ—ä¸­çš„å€¼ç”±åˆ—å®šä¹‰çš„è¡¨è¾¾å¼è®¡ç®—å¾—å‡ºã€‚</p><h3 id="åˆ›å»ºç”Ÿæˆåˆ—"><a href="#åˆ›å»ºç”Ÿæˆåˆ—" class="headerlink" title="åˆ›å»ºç”Ÿæˆåˆ—"></a>åˆ›å»ºç”Ÿæˆåˆ—</h3><p>åˆ›å»ºç”Ÿæˆçš„åˆ—è¯­æ³•å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">col_name data_type [GENERATED ALWAYS] <span class="hljs-keyword">AS</span> (expr)<br>  [VIRTUAL <span class="hljs-operator">|</span> STORED] [<span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">NULL</span>]<br>  [<span class="hljs-keyword">UNIQUE</span> [KEY]] [[<span class="hljs-keyword">PRIMARY</span>] KEY]<br>  [COMMENT <span class="hljs-string">&#x27;string&#x27;</span>]<br></code></pre></td></tr></table></figure><p><code>AS (expr)</code> è¡¨ç¤ºç”Ÿæˆåˆ—çš„åŒæ—¶å®šä¹‰ç”¨äºè®¡ç®—ç”Ÿæˆåˆ—å€¼çš„è¡¨è¾¾å¼ã€‚</p><p><code>AS</code> å‰é¢å¯ä»¥é€‰æ‹©æ€§çš„åŠ ä¸Š <code>GENERATED ALWAYS</code>ï¼Œä½¿åˆ—çš„ç”Ÿæˆæ€§è´¨æ›´åŠ æ˜ç¡®ã€‚</p><p>å…³é”®å­— <code>VIRTUAL</code> æˆ– <code>STORED</code> è¡¨ç¤ºåˆ—å€¼çš„å­˜å‚¨æ–¹å¼ï¼Œå®ƒå¯¹åˆ—çš„ä½¿ç”¨æœ‰å½±å“ï¼š</p><ul><li><code>VIRTUAL</code> : åˆ—å€¼ä¸ä¼šè¢«å­˜å‚¨ï¼Œä¸å ç”¨ä»»ä½•å­˜å‚¨ç©ºé—´ã€‚è€Œæ˜¯åœ¨è¯»å–è¡Œæ—¶è®¡ç®—ï¼ŒåŒæ—¶åœ¨æ‰§è¡Œè§¦å‘å™¨ï¼ˆç‰¹åˆ«æ˜¯ BEFORE è§¦å‘å™¨ï¼Œå®ƒä»¬åœ¨æ’å…¥ã€æ›´æ–°æˆ–åˆ é™¤æ“ä½œä¹‹å‰æ‰§è¡Œï¼‰ä¹‹åï¼Œè™šæ‹Ÿåˆ—çš„å€¼ä¼šè¢«è®¡ç®—ã€‚è¿™æ˜¯å› ä¸ºè™šæ‹Ÿåˆ—çš„å€¼é€šå¸¸<strong>ä¾èµ–äºå…¶ä»–åˆ—çš„å€¼æˆ–ç‰¹å®šçš„è¡¨è¾¾å¼</strong>ï¼Œè€Œè¿™äº›å€¼å¯èƒ½ä¼šåœ¨è§¦å‘å™¨ä¸­è¿›è¡Œä¿®æ”¹ã€‚å› æ­¤ï¼Œè™šæ‹Ÿåˆ—çš„å€¼éœ€è¦åœ¨è§¦å‘å™¨æ‰§è¡Œä¹‹åè®¡ç®—ï¼Œä»¥ç¡®ä¿å®ƒä»¬åæ˜ æœ€æ–°çš„æ•°æ®ã€‚<code>InnoDB</code> æ”¯æŒè™šæ‹Ÿåˆ—ä¸Šçš„äºŒçº§ç´¢å¼•ã€‚</li><li><code>STORED</code> : æ’å…¥æˆ–æ›´æ–°è¡Œæ—¶ï¼Œä¼šè®¡ç®—å¹¶å­˜å‚¨åˆ—å€¼ã€‚å­˜å‚¨åˆ—éœ€è¦å­˜å‚¨ç©ºé—´ï¼Œå¹¶å¯ç¼–åˆ¶ç´¢å¼•ã€‚</li></ul><p>å¦‚æœä»¥ä¸Šä¸¤ä¸ªå…³é”®å­—éƒ½æœªæŒ‡å®šï¼Œåˆ™é»˜è®¤ä¸º <code>VIRTUAL</code>ã€‚</p><p>å…è®¸åœ¨è¡¨ä¸­æ··åˆä½¿ç”¨ <code>VIRTUAL</code> åˆ—å’Œ <code>STORED</code> åˆ—ã€‚</p><p>è¿˜å¯ä»¥ç»™å‡ºå…¶ä»–å±æ€§ï¼Œä¾‹å¦‚ç”Ÿæˆåˆ—æ˜¯å¦éœ€è¦å»ºç«‹ç´¢å¼•æˆ–æ˜¯å¦å¯ä»¥ä¸º <code>NULL</code>ï¼Œä»¥åŠæä¾›åˆ—æ³¨é‡Šç­‰ã€‚</p><p>å¯¹äº <code>CREATE TABLE ...LIKE</code>ï¼Œç›®æ ‡è¡¨ä¼š<strong>ä¿ç•™</strong>åŸå§‹è¡¨ä¸­ç”Ÿæˆçš„åˆ—ä¿¡æ¯ã€‚</p><p>å¯¹äº <code>CREATE TABLE ...SELECT</code> ï¼Œç›®æ ‡è¡¨<strong>ä¸ä¿ç•™</strong>å…³äºé€‰è‡ªè¡¨ä¸­çš„åˆ—æ˜¯å¦ä¸ºç”Ÿæˆåˆ—çš„ä¿¡æ¯ã€‚è¯­å¥çš„ SELECT éƒ¨åˆ†ä¸èƒ½ä¸ºç›®æ ‡è¡¨ä¸­çš„ç”Ÿæˆåˆ—èµ‹å€¼ã€‚</p><p>ä¸‹é¢è¿™ä¸ªç®€å•çš„ä¾‹å­åˆ›å»ºäº†ä¸€ä¸ªè¡¨ï¼Œè¯¥è¡¨å­˜å‚¨äº† <code>sidea</code> å’Œ <code>sidb</code> åˆ—ä¸­ç›´è§’ä¸‰è§’å½¢è¾¹çš„é•¿åº¦ï¼Œå¹¶è®¡ç®—<code>sidec</code> ä¸­æ–œè¾¹çš„é•¿åº¦ï¼ˆå…¶ä»–ä¸¤è¾¹çš„å¹³æ–¹å’Œçš„å¹³æ–¹æ ¹ï¼‰ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> triangle (<br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>   sidea <span class="hljs-keyword">DOUBLE</span>,<br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>   sideb <span class="hljs-keyword">DOUBLE</span>,<br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>   sidec <span class="hljs-keyword">DOUBLE</span> <span class="hljs-keyword">AS</span> (<span class="hljs-built_in">SQRT</span>(sidea <span class="hljs-operator">*</span> sidea <span class="hljs-operator">+</span> sideb <span class="hljs-operator">*</span> sideb))<br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> );<br>Query OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.12</span> sec)<br></code></pre></td></tr></table></figure><p>æ’å…¥æ•°æ®ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> triangle (sidea, sideb) <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>),(<span class="hljs-number">3</span>,<span class="hljs-number">4</span>),(<span class="hljs-number">6</span>,<span class="hljs-number">8</span>);<br></code></pre></td></tr></table></figure><p>ä»è¯¥è¡¨ä¸­æŸ¥è¯¢ä¼šå¾—åˆ°ä»¥ä¸‹ç»“æœï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> triangle;<br><span class="hljs-operator">+</span><span class="hljs-comment">-------+-------+--------------------+</span><br><span class="hljs-operator">|</span> sidea <span class="hljs-operator">|</span> sideb <span class="hljs-operator">|</span> sidec              <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------+-------+--------------------+</span><br><span class="hljs-operator">|</span>     <span class="hljs-number">1</span> <span class="hljs-operator">|</span>     <span class="hljs-number">1</span> <span class="hljs-operator">|</span> <span class="hljs-number">1.4142135623730951</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>     <span class="hljs-number">3</span> <span class="hljs-operator">|</span>     <span class="hljs-number">4</span> <span class="hljs-operator">|</span>                  <span class="hljs-number">5</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>     <span class="hljs-number">6</span> <span class="hljs-operator">|</span>     <span class="hljs-number">8</span> <span class="hljs-operator">|</span>                 <span class="hljs-number">10</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------+-------+--------------------+</span><br></code></pre></td></tr></table></figure><p>ä»»ä½•ä½¿ç”¨ <code>triangle</code> è¡¨çš„åº”ç”¨ç¨‹åºéƒ½å¯ä»¥ç›´æ¥è®¿é—®æ–œè¾¹å€¼ï¼Œè€Œæ— éœ€æŒ‡å®šè®¡ç®—æ–œè¾¹å€¼çš„è¡¨è¾¾å¼ã€‚</p><h3 id="ç”Ÿæˆåˆ—è¡¨è¾¾å¼è§„åˆ™"><a href="#ç”Ÿæˆåˆ—è¡¨è¾¾å¼è§„åˆ™" class="headerlink" title="ç”Ÿæˆåˆ—è¡¨è¾¾å¼è§„åˆ™"></a>ç”Ÿæˆåˆ—è¡¨è¾¾å¼è§„åˆ™</h3><p>å¦‚æœè¡¨è¾¾å¼ä¸­åŒ…å«ä¸è¢«å…è®¸çš„ç»“æ„ï¼Œåˆ™ä¼šå‘ç”Ÿé”™è¯¯ï¼Œæ‰€ä»¥ç”Ÿæˆçš„åˆ—è¡¨è¾¾å¼å¿…é¡»éµå®ˆä»¥ä¸‹è§„åˆ™ï¼š</p><ul><li>å…è®¸ä½¿ç”¨å­—é¢é‡ã€ç¡®å®šæ€§å†…ç½®å‡½æ•°å’Œè¿ç®—ç¬¦ã€‚<strong>å¦‚æœåœ¨è¡¨æ ¼æ•°æ®ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œå¤šæ¬¡è°ƒç”¨åªä¼šäº§ç”Ÿç›¸åŒçš„ç»“æœï¼Œè€Œä¸æ‰€è¿æ¥çš„ç”¨æˆ·æ— å…³ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°å°±æ˜¯ç¡®å®šçš„</strong>ã€‚</li><li>ä¸å…è®¸ä½¿ç”¨å­˜å‚¨å‡½æ•°å’Œå¯åŠ è½½å‡½æ•°ã€‚</li><li>ä¸å…è®¸ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°å‚æ•°ã€‚</li><li>ä¸å…è®¸ä½¿ç”¨å˜é‡ï¼ˆåŒ…æ‹¬ç³»ç»Ÿå˜é‡ã€ç”¨æˆ·å®šä¹‰å˜é‡å’Œå­˜å‚¨çš„ç¨‹åºå±€éƒ¨å˜é‡ï¼‰ã€‚</li><li>ä¸å…è®¸ä½¿ç”¨å­æŸ¥è¯¢ã€‚</li><li>ç”Ÿæˆåˆ—çš„å®šä¹‰<strong>å¯ä»¥å¼•ç”¨å…¶ä»–ç”Ÿæˆåˆ—ï¼Œä½†åªèƒ½å¼•ç”¨è¡¨å®šä¹‰ä¸­è¾ƒæ—©å‡ºç°çš„ç”Ÿæˆåˆ—</strong>ã€‚ç”Ÿæˆçš„åˆ—å®šä¹‰å¯ä»¥å¼•ç”¨è¡¨ä¸­çš„<strong>ä»»ä½•åŸºç¡€ï¼ˆéç”Ÿæˆï¼‰åˆ—</strong>ï¼Œæ— è®ºå…¶å®šä¹‰å‡ºç°çš„æ—¶é—´æ˜¯æ—©è¿˜æ˜¯æ™šã€‚</li><li>ç”Ÿæˆçš„åˆ—å®šä¹‰ä¸­ä¸èƒ½ä½¿ç”¨ <code>AUTO_INCREMENT</code> å±æ€§ã€‚</li><li>åœ¨ç”Ÿæˆåˆ—å®šä¹‰ä¸­ï¼Œ<code>AUTO_INCREMENT</code> åˆ—ä¸èƒ½è¢«ä½œä¸ºåŸºåˆ—ã€‚</li><li>å¦‚æœè¡¨è¾¾å¼æ±‚å€¼å¯¼è‡´æˆªæ–­æˆ–ä¸ºå‡½æ•°æä¾›äº†ä¸æ­£ç¡®çš„è¾“å…¥ï¼Œåˆ™ <code>CREATE TABLE</code> è¯­å¥å°†ä»¥é”™è¯¯ç»“æŸï¼Œ<code>DDL</code> æ“ä½œå°†è¢«æ‹’ç»ã€‚</li></ul><blockquote><p>æ³¨æ„ï¼šå¦‚æœè¡¨è¾¾å¼æ±‚å€¼çš„æ•°æ®ç±»å‹ä¸å£°æ˜çš„åˆ—ç±»å‹ä¸åŒï¼Œåˆ™ä¼šæ ¹æ® <code>MySQL</code> é»˜è®¤çš„éšå¼ç±»å‹è½¬æ¢è§„åˆ™å¼ºåˆ¶è½¬æ¢ä¸ºå£°æ˜çš„ç±»å‹ã€‚</p><p>è¡¨è¾¾å¼è®¡ç®—ä½¿ç”¨è®¡ç®—æ—¶æœ‰æ•ˆçš„ <code>SQL</code> æ¨¡å¼ã€‚å¦‚æœè¡¨è¾¾å¼å®šä¹‰çš„ä»»ä½•éƒ¨åˆ†ä¾èµ–äº <code>SQL</code> æ¨¡å¼ï¼Œé‚£ä¹ˆé™¤éåœ¨æ‰€æœ‰ä½¿ç”¨è¿‡ç¨‹ä¸­ <code>SQL</code> æ¨¡å¼éƒ½ç›¸åŒï¼Œå¦åˆ™ä¸åŒçš„è¡¨æ ¼ä½¿ç”¨è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°ä¸åŒçš„ç»“æœã€‚</p></blockquote><h4 id="çº¦æŸ"><a href="#çº¦æŸ" class="headerlink" title="çº¦æŸ"></a>çº¦æŸ</h4><ul><li>å­˜å‚¨ç”Ÿæˆåˆ—ä¸Šçš„å¤–é”®çº¦æŸä¸èƒ½ä½¿ç”¨ <code>CASCADE</code>ã€<code>SET NULL</code> æˆ– <code>SET DEFAULT</code> ä½œä¸º <code>ON UPDATE</code> å¼•ç”¨æ“ä½œï¼Œä¹Ÿä¸èƒ½ä½¿ç”¨ <code>SET NULL</code> æˆ– <code>SET DEFAULT</code> ä½œä¸º <code>ON DELETE</code> å¼•ç”¨æ“ä½œã€‚</li><li>å­˜å‚¨ç”Ÿæˆåˆ—çš„åŸºåˆ—ä¸Šçš„å¤–é”®çº¦æŸä¸èƒ½ä½¿ç”¨ <code>CASCADE</code>ã€<code>SET NULL</code> æˆ– <code>SET DEFAULT</code> ä½œä¸º <code>ON UPDATE</code> æˆ– <code>ON DELETE</code> å¼•ç”¨æ“ä½œã€‚</li><li>å¤–é”®çº¦æŸä¸èƒ½å¼•ç”¨è™šæ‹Ÿç”Ÿæˆçš„åˆ—ã€‚</li><li>å¯¹äº <code>INSERT</code>ã€<code>REPLACE</code> å’Œ <code>UPDATE</code>ï¼Œå¦‚æœç”Ÿæˆçš„åˆ—è¢«æ˜ç¡®æ’å…¥ã€æ›¿æ¢æˆ–æ›´æ–°ï¼Œåˆ™å”¯ä¸€å…è®¸çš„å€¼æ˜¯ <code>DEFAULT</code>ã€‚</li></ul><p>è§†å›¾ä¸­çš„ç”Ÿæˆåˆ—è¢«è®¤ä¸ºæ˜¯å¯æ›´æ–°çš„ï¼Œå› ä¸ºå¯ä»¥å¯¹å…¶è¿›è¡Œèµ‹å€¼ã€‚ä½†æ˜¯ï¼Œå¦‚æœè¦æ˜¾å¼æ›´æ–°è¯¥åˆ—ï¼Œåˆ™å”¯ä¸€å…è®¸çš„å€¼æ˜¯ <code>DEFAULT</code>ã€‚</p><h3 id="ç”Ÿæˆåˆ—ä½¿ç”¨åœºæ™¯"><a href="#ç”Ÿæˆåˆ—ä½¿ç”¨åœºæ™¯" class="headerlink" title="ç”Ÿæˆåˆ—ä½¿ç”¨åœºæ™¯"></a>ç”Ÿæˆåˆ—ä½¿ç”¨åœºæ™¯</h3><p>ç”Ÿæˆåˆ—æœ‰å‡ ç§ä½¿ç”¨æƒ…å†µï¼Œæ¯”å¦‚ä¸‹é¢è¿™äº›ï¼š</p><ul><li>è™šæ‹Ÿç”Ÿæˆåˆ—å¯ä»¥ç”¨æ¥ç®€åŒ–å’Œç»Ÿä¸€æŸ¥è¯¢ã€‚ä¸€ä¸ªå¤æ‚çš„æ¡ä»¶å¯ä»¥å®šä¹‰ä¸ºä¸€ä¸ªç”Ÿæˆåˆ—ï¼Œå¹¶åœ¨è¡¨çš„å¤šä¸ªæŸ¥è¯¢ä¸­å¼•ç”¨ï¼Œä»¥ç¡®ä¿æ‰€æœ‰æŸ¥è¯¢éƒ½ä½¿ç”¨å®Œå…¨ç›¸åŒçš„æ¡ä»¶ã€‚</li><li>å­˜å‚¨ç”Ÿæˆçš„åˆ—å¯ç”¨ä½œç‰©åŒ–ç¼“å­˜ï¼Œç”¨äºå¤„ç†è®¡ç®—æˆæœ¬è¾ƒé«˜çš„å¤æ‚æ¡ä»¶ã€‚</li><li>ç”Ÿæˆåˆ—å¯ä»¥æ¨¡æ‹Ÿå‡½æ•°å¼ç´¢å¼•ï¼šä½¿ç”¨ç”Ÿæˆçš„åˆ—æ¥å®šä¹‰å‡½æ•°è¡¨è¾¾å¼å¹¶ä¸ºå…¶å»ºç«‹ç´¢å¼•ã€‚è¿™å¯¹äºå¤„ç†æ— æ³•ç›´æ¥å»ºç«‹ç´¢å¼•çš„åˆ—ç±»å‹ï¼ˆå¦‚ <code>JSON</code> åˆ—ï¼‰éå¸¸æœ‰ç”¨ã€‚å¯¹äºå­˜å‚¨ç”Ÿæˆåˆ—ï¼Œè¿™ç§æ–¹æ³•çš„ç¼ºç‚¹æ˜¯è¦å­˜å‚¨ä¸¤æ¬¡å€¼ï¼Œä¸€æ¬¡æ˜¯ç”Ÿæˆåˆ—çš„å€¼ï¼Œå¦ä¸€æ¬¡æ˜¯ç´¢å¼•ä¸­çš„å€¼ã€‚</li><li>å¦‚æœç”Ÿæˆçš„åˆ—æœ‰ç´¢å¼•ï¼Œä¼˜åŒ–å™¨ä¼šè¯†åˆ«ä¸åˆ—å®šä¹‰ç›¸åŒ¹é…çš„æŸ¥è¯¢è¡¨è¾¾å¼ï¼Œå³ä½¿æŸ¥è¯¢æ²¡æœ‰ç›´æ¥å¼•ç”¨åˆ—åï¼ŒæŸ¥è¯¢æ‰§è¡Œè¿‡ç¨‹ä¸­ä¹Ÿä¼šé…Œæƒ…ä½¿ç”¨åˆ—ç´¢å¼•ã€‚</li></ul><p>ä¸¾ä¾‹ï¼š</p><p>å‡è®¾è¡¨ <code>t1</code> åŒ…å«åå’Œå§“ä¸¤åˆ—ï¼Œåº”ç”¨ç¨‹åºç»å¸¸ä½¿ç”¨è¿™æ ·çš„è¡¨è¾¾å¼æ¥æ„é€ å…¨åï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> CONCAT(first_name,<span class="hljs-string">&#x27; &#x27;</span>,last_name) <span class="hljs-keyword">AS</span> full_name <span class="hljs-keyword">FROM</span> t1;<br></code></pre></td></tr></table></figure><p>é¿å…å†™å‡ºè¡¨è¾¾å¼çš„ä¸€ç§æ–¹æ³•æ˜¯åœ¨ <code>t1</code> ä¸Šåˆ›å»ºè§†å›¾ <code>v1</code>ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥é€‰æ‹© <code>full_name</code>ï¼Œè€Œæ— éœ€ä½¿ç”¨è¡¨è¾¾å¼ï¼Œä»è€Œç®€åŒ–äº†åº”ç”¨ç¨‹åºï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> v1 <span class="hljs-keyword">AS</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>, CONCAT(first_name,<span class="hljs-string">&#x27; &#x27;</span>,last_name) <span class="hljs-keyword">AS</span> full_name <span class="hljs-keyword">FROM</span> t1;<br><br><span class="hljs-keyword">SELECT</span> full_name <span class="hljs-keyword">FROM</span> v1;<br></code></pre></td></tr></table></figure><p>ç”Ÿæˆåˆ—è¿˜èƒ½è®©åº”ç”¨ç¨‹åºç›´æ¥é€‰æ‹© <code>full_name</code>ï¼Œè€Œæ— éœ€å®šä¹‰è§†å›¾ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t1 (<br>  first_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">10</span>),<br>  last_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">10</span>),<br>  full_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">AS</span> (CONCAT(first_name,<span class="hljs-string">&#x27; &#x27;</span>,last_name))<br>);<br><br><span class="hljs-keyword">SELECT</span> full_name <span class="hljs-keyword">FROM</span> t1;<br></code></pre></td></tr></table></figure><h3 id="ç”Ÿæˆåˆ—ä½¿ç”¨ç´¢å¼•"><a href="#ç”Ÿæˆåˆ—ä½¿ç”¨ç´¢å¼•" class="headerlink" title="ç”Ÿæˆåˆ—ä½¿ç”¨ç´¢å¼•"></a>ç”Ÿæˆåˆ—ä½¿ç”¨ç´¢å¼•</h3><p>ä¸Šä¸€ç¯‡æ–‡ç« æ‰€æåˆ°ï¼Œ<code>JSON</code> åˆ—æ— æ³•ç›´æ¥å»ºç«‹ç´¢å¼•ã€‚è¦åˆ›å»ºé—´æ¥å¼•ç”¨æ­¤ç±»åˆ—çš„ç´¢å¼•ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªç”Ÿæˆåˆ—æ¥æå–åº”è¢«ç´¢å¼•çš„ä¿¡æ¯ï¼Œç„¶ååœ¨ç”Ÿæˆåˆ—ä¸Šåˆ›å»ºç´¢å¼•ã€‚</p><p>ä¸‹é¢çš„ä¾‹å­æˆ‘ä»¬å°†åœ¨ç”Ÿæˆåˆ—ä¸Šåˆ›å»ºé—´æ¥å¼•ç”¨ <code>JSON</code> åˆ—çš„ç´¢å¼•ï¼š</p><p>é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç­çº§è¡¨ï¼Œ<code>student</code> ä¿å­˜å­¦ç”Ÿä¿¡æ¯ï¼Œ<code>g</code> è¡¨ç¤ºå¼•ç”¨ <code>student</code> ä¸­çš„ <code>id</code> ç”Ÿæˆçš„è™šæ‹Ÿåˆ—ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> CLASS (<br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>          student JSON,    <br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>          g <span class="hljs-type">INT</span> GENERATED ALWAYS <span class="hljs-keyword">AS</span> (student <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> &quot;$.id&quot;),<br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>          INDEX i (g)<br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> );<br>Query OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.33</span> sec)<br></code></pre></td></tr></table></figure><p>å¾€è¡¨ä¸­æ’å…¥æ•°æ®ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> CLASS(student) <span class="hljs-keyword">VALUES</span> <br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>          (<span class="hljs-string">&#x27;&#123;&quot;id&quot;: &quot;1&quot;, &quot;name&quot;: &quot;å°ç‹&quot;&#125;&#x27;</span>), (<span class="hljs-string">&#x27;&#123;&quot;id&quot;: &quot;2&quot;, &quot;name&quot;: &quot;å°æ&quot;&#125;&#x27;</span>), <br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>          (<span class="hljs-string">&#x27;&#123;&quot;id&quot;: &quot;3&quot;, &quot;name&quot;: &quot;è€å¼ &quot;&#125;&#x27;</span>), (<span class="hljs-string">&#x27;&#123;&quot;id&quot;: &quot;4&quot;, &quot;name&quot;: &quot;è€èµµ&quot;&#125;&#x27;</span>); <br>Query OK, <span class="hljs-number">4</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.03</span> sec)<br></code></pre></td></tr></table></figure><p>æŸ¥è¯¢ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> student<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span>&quot;$.name&quot; <span class="hljs-keyword">AS</span> NAME  <br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>          <span class="hljs-keyword">FROM</span> CLASS <span class="hljs-keyword">WHERE</span> g <span class="hljs-operator">&gt;</span> <span class="hljs-number">2</span>;   <br><span class="hljs-operator">+</span><span class="hljs-comment">------+</span><br><span class="hljs-operator">|</span> NAME <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------+</span><br><span class="hljs-operator">|</span> è€å¼  <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> è€èµµ <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------+</span><br></code></pre></td></tr></table></figure><p>ç„¶åæ¥çœ‹ä¸€ä¸‹è¿™æ¡ <code>SQL</code> è¯­å¥çš„æ‰§è¡Œè®¡åˆ’ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> EXPLAIN <span class="hljs-keyword">SELECT</span> student<span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>&quot;$.name&quot; <span class="hljs-keyword">AS</span> NAME <br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>          <span class="hljs-keyword">FROM</span> CLASS <span class="hljs-keyword">WHERE</span> g <span class="hljs-operator">&gt;</span> <span class="hljs-number">2</span>;<br><span class="hljs-operator">+</span><span class="hljs-comment">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-------------+</span><br><span class="hljs-operator">|</span> id <span class="hljs-operator">|</span> select_type <span class="hljs-operator">|</span> <span class="hljs-keyword">table</span> <span class="hljs-operator">|</span> partitions <span class="hljs-operator">|</span> type  <span class="hljs-operator">|</span> possible_keys <span class="hljs-operator">|</span> key  <span class="hljs-operator">|</span> key_len <span class="hljs-operator">|</span> <span class="hljs-keyword">ref</span>  <span class="hljs-operator">|</span> <span class="hljs-keyword">rows</span> <span class="hljs-operator">|</span> filtered <span class="hljs-operator">|</span> Extra       <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-------------+</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">1</span> <span class="hljs-operator">|</span> SIMPLE      <span class="hljs-operator">|</span> CLASS <span class="hljs-operator">|</span> <span class="hljs-keyword">NULL</span>       <span class="hljs-operator">|</span> <span class="hljs-keyword">range</span> <span class="hljs-operator">|</span> i             <span class="hljs-operator">|</span> i    <span class="hljs-operator">|</span> <span class="hljs-number">5</span>       <span class="hljs-operator">|</span> <span class="hljs-keyword">NULL</span> <span class="hljs-operator">|</span>    <span class="hljs-number">2</span> <span class="hljs-operator">|</span>   <span class="hljs-number">100.00</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">Using</span> <span class="hljs-keyword">where</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-------------+</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ¡æŸ¥è¯¢è¯­å¥ä½¿ç”¨åˆ°äº†ç´¢å¼• <code>i</code> , ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹ç”Ÿæˆåˆ—ä¸­å¼•ç”¨ <code>JSON</code> ä¸­çš„å±æ€§å¹¶å»ºç«‹ç´¢å¼•é—´æ¥è¾¾åˆ°å¯¹ <code>JSON</code> ä¸­çš„å±æ€§å»ºç«‹ç´¢å¼•çš„æ•ˆæœã€‚</p>]]></content>
    
    
    <categories>
      
      <category>æ•°æ®åº“</category>
      
      <category>MySQL</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ•°æ®åº“</tag>
      
      <tag>MySQL</tag>
      
      <tag>æ•°æ®ç±»å‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MySQL JSON Data Type</title>
    <link href="/2023/10/17/MySQL%20JSON%20Data%20Type/"/>
    <url>/2023/10/17/MySQL%20JSON%20Data%20Type/</url>
    
    <content type="html"><![CDATA[<h3 id="åºè¨€"><a href="#åºè¨€" class="headerlink" title="åºè¨€"></a>åºè¨€</h3><p><code>MySQL</code> åœ¨ <code>5.7.8</code> ç‰ˆæœ¬ä¸­é¦–æ¬¡å¼•å…¥ <code>JSON</code> æ•°æ®ç±»å‹ã€‚è¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥æ›´å¥½åœ°å¤„ç†å’Œæ“ä½œ <code>JSON</code> æ•°æ®ï¼ŒåŒ…æ‹¬å­˜å‚¨ã€æŸ¥è¯¢å’Œç´¢å¼• <code>JSON</code> æ•°æ®ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œè¦å¤„ç† <code>JSON</code> æ•°æ®ï¼Œé€šå¸¸éœ€è¦å°†å…¶å­˜å‚¨ä¸ºæ–‡æœ¬ï¼Œå¹¶ä½¿ç”¨å­—ç¬¦ä¸²å‡½æ•°è¿›è¡Œæ“ä½œã€‚ç¨‹åºä¸­æˆ‘ä»¬ä¹Ÿæ— æ³•ç›´æ¥ä½¿ç”¨ä»æ•°æ®åº“è·å–çš„ <code>JSON</code> æ•°æ®ï¼Œéœ€è¦è¿›ä¸€æ­¥è½¬åŒ–ï¼Œååˆ†ä¸æ–¹ä¾¿ã€‚</p><p><code>JSON</code> æ•°æ®ç±»å‹ç›¸å¯¹äºå°† <code>JSON</code> æ ¼å¼å­—ç¬¦ä¸²å­˜å‚¨åœ¨å­—ç¬¦ä¸²åˆ—ä¸­å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p><ul><li>åœ¨ <code>JSON</code> åˆ—ä¸­å­˜å‚¨çš„ <code>JSON</code> æ–‡æ¡£ä¼šè‡ªåŠ¨è¿›è¡ŒéªŒè¯ï¼Œ<strong>æ— æ•ˆçš„æ–‡æ¡£ä¼šå¼•å‘é”™è¯¯</strong>ã€‚</li><li>ç»è¿‡ä¼˜åŒ–çš„å­˜å‚¨æ ¼å¼ã€‚å­˜å‚¨åœ¨ <code>JSON</code> åˆ—ä¸­çš„ <code>JSON</code> æ–‡æ¡£è¢«è½¬æ¢ä¸ºå†…éƒ¨æ ¼å¼ï¼Œå…è®¸å¿«é€Ÿè¯»å–æ–‡æ¡£å…ƒç´ ã€‚å½“æœåŠ¡å™¨éœ€è¦è¯»å–å­˜å‚¨åœ¨äºŒè¿›åˆ¶æ ¼å¼ä¸­çš„ <code>JSON</code> å€¼æ—¶ï¼Œ<strong>æ— éœ€ä»æ–‡æœ¬è¡¨ç¤ºä¸­è§£æè¯¥å€¼</strong>ã€‚äºŒè¿›åˆ¶æ ¼å¼è¢«æ„é€ æˆå…è®¸æœåŠ¡å™¨<strong>ç›´æ¥é€šè¿‡é”®æˆ–æ•°ç»„ç´¢å¼•æŸ¥æ‰¾å­å¯¹è±¡æˆ–åµŒå¥—å€¼</strong>ï¼Œè€Œä¸éœ€è¦è¯»å–æ–‡æ¡£ä¸­å®ƒä»¬ä¹‹å‰æˆ–ä¹‹åçš„æ‰€æœ‰å€¼ã€‚</li></ul><p>éšç€ <code>MySQL</code> çš„ç‰ˆæœ¬æ›´æ–°ï¼Œ<code>JSON</code> æ•°æ®ç±»å‹çš„åŠŸèƒ½å’Œæ€§èƒ½ä¹Ÿå¾—åˆ°äº†æ”¹è¿›ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±ä»¥ <code>MySQL 8.0.26</code> ç‰ˆæœ¬ä¸­ <code>InnoDB</code> å­˜å‚¨å¼•æ“ä¸ºä¾‹æ¢è®¨ä¸€ä¸‹ <code>JSON</code> æ ¼å¼çš„æ•°æ®ç±»å‹ã€‚</p><h3 id="åˆ›å»ºJSONå€¼"><a href="#åˆ›å»ºJSONå€¼" class="headerlink" title="åˆ›å»ºJSONå€¼"></a>åˆ›å»ºJSONå€¼</h3><p>åœ¨ <code>MySQL</code> ä¸­ï¼Œ<code>JSON</code> å€¼å°†è¢«å†™ä¸ºå­—ç¬¦ä¸²ã€‚<code>MySQL</code>è§£æä»»ä½•åœ¨éœ€è¦ <code>JSON</code> å€¼çš„ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨çš„å­—ç¬¦ä¸²ï¼Œå¦‚æœå®ƒä¸æ˜¯æœ‰æ•ˆçš„ <code>JSON</code>ï¼Œåˆ™ä¼šäº§ç”Ÿé”™è¯¯ã€‚</p><p>è¿™äº›ä¸Šä¸‹æ–‡åŒ…æ‹¬å°†å€¼æ’å…¥å…·æœ‰ <code>JSON</code> æ•°æ®ç±»å‹çš„åˆ—ä¸­ï¼Œå¹¶å°†å‚æ•°ä¼ é€’ç»™æœŸæœ› <code>JSON</code> å€¼çš„å‡½æ•°ï¼ˆé€šå¸¸åœ¨<code>MySQL JSON</code> å‡½æ•°çš„æ–‡æ¡£ä¸­æ˜¾ç¤ºä¸º <code>json_doc</code> æˆ– <code>json_val</code> ï¼‰ï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š</p><ul><li><p>å¦‚æœå€¼æ˜¯æœ‰æ•ˆçš„ <code>JSON</code> å€¼ï¼Œåˆ™å°è¯•å°†å€¼æ’å…¥ <code>JSON</code> åˆ—ä¼šæˆåŠŸï¼Œå¦åˆ™ï¼Œä¾¿ä¼šå¤±è´¥ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> json_test<br>(<br>    id        <span class="hljs-type">int</span> auto_increment comment <span class="hljs-string">&#x27;ä¸»é”®&#x27;</span><br>        <span class="hljs-keyword">primary</span> key,<br>    json_info json <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;jsonæ ¼å¼ä¿¡æ¯&#x27;</span><br>);<br><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> json_test(json_info) <span class="hljs-keyword">values</span> (<span class="hljs-string">&#x27;&#123;&quot;name&quot;: &quot;å°æ˜&quot;, &quot;age&quot;: 18, &quot;sex&quot; : 1&#125;&#x27;</span>);<br><span class="hljs-number">1</span> <span class="hljs-type">row</span> affected <span class="hljs-keyword">in</span> <span class="hljs-number">52</span> ms<br><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> json_test(json_info) <span class="hljs-keyword">values</span> (<span class="hljs-string">&#x27;&#123;&quot;name&quot;: &quot;å°çº¢&quot;, &quot;age&quot;: 20, &quot;sex&quot;&#125;&#x27;</span>);<br>Data truncation: Invalid JSON text: &quot;Missing a colon after a name of object member.&quot; <span class="hljs-keyword">at</span> position <span class="hljs-number">35</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">for</span> <span class="hljs-keyword">column</span> <span class="hljs-string">&#x27;json_test.json_info&#x27;</span>.<br></code></pre></td></tr></table></figure></li><li><p><code>JSON_TYPE()</code> å‡½æ•°éœ€è¦ä¸€ä¸ª <code>JSON</code> å‚æ•°ï¼Œå¹¶å°è¯•å°†å…¶è§£æä¸º <code>JSON</code> å€¼ã€‚å¦‚æœæœ‰æ•ˆï¼Œå®ƒä¼šè¿”å›å€¼çš„ <code>JSON</code> ç±»å‹ï¼Œå¦åˆ™ä¼šäº§ç”Ÿé”™è¯¯ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_TYPE(<span class="hljs-string">&#x27;[&quot;åƒé¥­&quot;, false, 20]&#x27;</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">----------------------------------+</span><br><span class="hljs-operator">|</span> JSON_TYPE(<span class="hljs-string">&#x27;[&quot;åƒé¥­&quot;, false, 20]&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----------------------------------+</span><br><span class="hljs-operator">|</span> <span class="hljs-keyword">ARRAY</span>                            <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----------------------------------+</span><br><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_TYPE(<span class="hljs-string">&#x27;&quot;ä½ å¥½&quot;&#x27;</span>);              <br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------+</span><br><span class="hljs-operator">|</span> JSON_TYPE(<span class="hljs-string">&#x27;&quot;ä½ å¥½&quot;&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------+</span><br><span class="hljs-operator">|</span> STRING              <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------+</span><br><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_TYPE(<span class="hljs-string">&#x27;ä½ å¥½&#x27;</span>);   <br>ERROR <span class="hljs-number">3141</span> (<span class="hljs-number">22032</span>): Invalid JSON text <span class="hljs-keyword">in</span> argument <span class="hljs-number">1</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">function</span> json_type: &quot;Invalid value.&quot; <span class="hljs-keyword">at</span> position <span class="hljs-number">0.</span><br></code></pre></td></tr></table></figure></li></ul><p>æ‰‹åŠ¨è¾“å…¥ <code>JSON</code> æ ¼å¼å­—ç¬¦ä¸²éå¸¸å®¹æ˜“å‡ºé”™ï¼Œ<code>MySQL</code> ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€äº›æ–¹æ³•ä½œä¸ºä»£æ›¿æ–¹æ¡ˆï¼š</p><ul><li><p><code>JSON_ARRAY()</code> è·å–ä¸€ä¸ªï¼ˆå¯èƒ½ä¸ºç©ºï¼‰å€¼åˆ—è¡¨ï¼Œå¹¶è¿”å›ä¸€ä¸ªåŒ…å«è¿™äº›å€¼çš„ <code>JSON</code> æ•°ç»„ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">JSON_ARRAY</span>(<span class="hljs-string">&#x27;æ•°ç»„&#x27;</span>, <span class="hljs-number">123</span>, NOW()); <br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------+</span><br><span class="hljs-operator">|</span> <span class="hljs-built_in">JSON_ARRAY</span>(<span class="hljs-string">&#x27;æ•°ç»„&#x27;</span>, <span class="hljs-number">123</span>, NOW())              <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------+</span><br><span class="hljs-operator">|</span> [&quot;æ•°ç»„&quot;, <span class="hljs-number">123</span>, &quot;2023-10-18 11:30:59.000000&quot;] <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------+</span><br></code></pre></td></tr></table></figure></li><li><p><code>JSON_OBJECT()</code> è·å–é”®å€¼å¯¹çš„åˆ—è¡¨ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰ï¼Œå¹¶è¿”å›åŒ…å«è¿™äº›é”®å€¼å¯¹çš„ <code>JSON</code> å¯¹è±¡ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">JSON_OBJECT</span>(<span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;å°çº¢&#x27;</span>, <span class="hljs-string">&#x27;age&#x27;</span>, <span class="hljs-number">20</span>, <span class="hljs-string">&#x27;sex&#x27;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------------------+</span><br><span class="hljs-operator">|</span> <span class="hljs-built_in">JSON_OBJECT</span>(<span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;å°çº¢&#x27;</span>, <span class="hljs-string">&#x27;age&#x27;</span>, <span class="hljs-number">20</span>, <span class="hljs-string">&#x27;sex&#x27;</span>, <span class="hljs-number">0</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------------------+</span><br><span class="hljs-operator">|</span> &#123;&quot;age&quot;: <span class="hljs-number">20</span>, &quot;sex&quot;: <span class="hljs-number">0</span>, &quot;name&quot;: &quot;å°çº¢&quot;&#125;            <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------------------+</span><br></code></pre></td></tr></table></figure></li><li><p><code>JSON_MERGE_PRESERVE()</code> è·å–ä¸¤ä¸ªæˆ–å¤šä¸ª <code>JSON</code> æ–‡æ¡£å¹¶è¿”å›ç»„åˆç»“æœï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_MERGE_PRESERVE(<span class="hljs-string">&#x27;[&quot;ä½ å¥½&quot;, true]&#x27;</span>, <span class="hljs-string">&#x27;&#123;&quot;name&quot;: &quot;æå››&quot;&#125;&#x27;</span>);  <br><span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------------------+</span><br><span class="hljs-operator">|</span> JSON_MERGE_PRESERVE(<span class="hljs-string">&#x27;[&quot;ä½ å¥½&quot;, true]&#x27;</span>, <span class="hljs-string">&#x27;&#123;&quot;name&quot;: &quot;æå››&quot;&#125;&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------------------+</span><br><span class="hljs-operator">|</span> [&quot;ä½ å¥½&quot;, <span class="hljs-literal">true</span>, &#123;&quot;name&quot;: &quot;æå››&quot;&#125;]                          <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------------------+</span><br></code></pre></td></tr></table></figure></li><li><p><code>JSON</code> å€¼å¯ä»¥åˆ†é…ç»™ç”¨æˆ·å®šä¹‰çš„å˜é‡ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SET</span> <span class="hljs-variable">@j</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">JSON_OBJECT</span>(<span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;è€æ&#x27;</span>); <br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-variable">@j</span>;<br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+</span><br><span class="hljs-operator">|</span> <span class="hljs-variable">@j</span>               <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+</span><br><span class="hljs-operator">|</span> &#123;&quot;name&quot;: &quot;è€æ&quot;&#125; <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+</span><br></code></pre></td></tr></table></figure><p>ç„¶è€Œï¼Œç”¨æˆ·å®šä¹‰çš„å˜é‡ä¸èƒ½æ˜¯ <code>JSON</code> æ•°æ®ç±»å‹ï¼Œå› æ­¤å°½ç®¡å‰é¢ç¤ºä¾‹ä¸­çš„ <code>@j</code> çœ‹èµ·æ¥åƒ <code>JSON</code> å€¼ï¼Œå¹¶ä¸”å…·æœ‰ä¸ <code>JSON</code> å€¼ç›¸åŒçš„å­—ç¬¦é›†å’Œæ’åºè§„åˆ™ï¼Œä½†å®ƒæ²¡æœ‰ <code>JSON</code> æ•°æ®ç±»å‹ã€‚ç›¸åï¼Œ<code>JSON_OBJECT()</code> çš„ç»“æœåœ¨åˆ†é…ç»™å˜é‡æ—¶ä¼š<strong>è½¬æ¢ä¸ºå­—ç¬¦ä¸²</strong>ã€‚</p><p>é€šè¿‡è½¬æ¢ <code>JSON</code> å€¼ç”Ÿæˆçš„å­—ç¬¦ä¸²å…·æœ‰ <code>utf8mb4</code> å­—ç¬¦é›†å’Œ <code>utf8mb4_bin</code>æ’åºè§„åˆ™ï¼›ç”±äº <code>utf8mb4_bin </code>æ˜¯äºŒè¿›åˆ¶æ’åºè§„åˆ™ï¼Œ<strong>å› æ­¤ <code>JSON</code> å€¼çš„æ¯”è¾ƒåŒºåˆ†å¤§å°å†™</strong>:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> CHARSET(<span class="hljs-variable">@j</span>), <span class="hljs-keyword">COLLATION</span>(<span class="hljs-variable">@j</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">-------------+---------------+</span><br><span class="hljs-operator">|</span> CHARSET(<span class="hljs-variable">@j</span>) <span class="hljs-operator">|</span> <span class="hljs-keyword">COLLATION</span>(<span class="hljs-variable">@j</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------+---------------+</span><br><span class="hljs-operator">|</span> utf8mb4     <span class="hljs-operator">|</span> utf8mb4_bin   <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------+---------------+</span><br><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">JSON_ARRAY</span>(<span class="hljs-string">&#x27;x&#x27;</span>) <span class="hljs-operator">=</span> <span class="hljs-built_in">JSON_ARRAY</span>(<span class="hljs-string">&#x27;X&#x27;</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------+</span><br><span class="hljs-operator">|</span> <span class="hljs-built_in">JSON_ARRAY</span>(<span class="hljs-string">&#x27;x&#x27;</span>) <span class="hljs-operator">=</span> <span class="hljs-built_in">JSON_ARRAY</span>(<span class="hljs-string">&#x27;X&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------+</span><br><span class="hljs-operator">|</span>                                 <span class="hljs-number">0</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------+</span><br></code></pre></td></tr></table></figure></li></ul><p>æœ‰æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ <code>JSON</code> æ–‡æ¡£ä¸­æ’å…¥å¼•å·å­—ç¬¦ï¼ˆâ€œ æˆ– â€ï¼‰ã€‚</p><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¸Œæœ›å°†è¿™è¡Œå­—ç¬¦ä¸²ä»¥ <code>key/value</code> é”®å€¼å¯¹çš„æ–¹å¼æ’å…¥åˆ° <code>JSON</code> æ–‡æ¡£ä¸­ã€‚</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tex">mascot: The MySQL mascot is a dolphin named &quot;Sakila&quot;.<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ä¸€ç§ä½œä¸º <code>JSON</code> å¯¹è±¡æ’å…¥è¡¨ä¸­çš„ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ <code>MySQL JSON_object()</code> å‡½æ•°ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¿…é¡»ä½¿ç”¨åæ–œæ å¯¹æ¯ä¸ªå¼•å·å­—ç¬¦è¿›è¡Œè½¬ä¹‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> json_test(json_info) <span class="hljs-keyword">VALUES</span>(<span class="hljs-built_in">JSON_OBJECT</span>(&quot;mascot&quot;, &quot;Our mascot is a dolphin named \&quot;Sakila\&quot;.&quot;));<br></code></pre></td></tr></table></figure><p>å¦‚æœå°†å€¼ä½œä¸º <code>JSON</code> å¯¹è±¡æ–‡å­—æ’å…¥ï¼Œåˆ™æ­¤æ“ä½œçš„æ–¹å¼ä¸æ­¤ä¸åŒï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¿…é¡»ä½¿ç”¨åŒåæ–œæ è½¬ä¹‰åºåˆ—ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> json_test(json_info) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;&#123;&quot;mascot&quot;: &quot;Our mascot is a dolphin named \\&quot;Sakila\\&quot;.&quot;&#125;&#x27;</span>);<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨åŒåæ–œæ å¯ä»¥é˜²æ­¢ <code>MySQL</code> æ‰§è¡Œè½¬ä¹‰åºåˆ—å¤„ç†ï¼Œè€Œæ˜¯å°†å­—ç¬¦ä¸²æ–‡æœ¬ä¼ é€’ç»™å­˜å‚¨å¼•æ“è¿›è¡Œå¤„ç†ã€‚ä»¥åˆšæ‰æ˜¾ç¤ºçš„ä»»ä½•ä¸€ç§æ–¹å¼æ’å…¥ <code>JSON</code> å¯¹è±¡åï¼Œé€šè¿‡æ‰§è¡Œç®€å•çš„ <code>SELECT</code> æŸ¥è¯¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>JSON</code> åˆ—å€¼ä¸­å­˜åœ¨åæ–œæ ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> json_info <span class="hljs-keyword">from</span> json_test;<br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------------------+</span><br><span class="hljs-operator">|</span> json_info                                               <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------------------+</span><br><span class="hljs-operator">|</span> &#123;&quot;mascot&quot;: &quot;Our mascot is a dolphin named \&quot;Sakila\&quot;.&quot;&#125; <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------------------+</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åˆ—è·¯å¾„æ“ä½œç¬¦ <code>-&gt;</code> æ¥æŸ¥æ‰¾è¿™ä¸ªä½¿ç”¨ <code>mascot</code> ä½œä¸ºå…³é”®å­—çš„ç‰¹å®šå¥å­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> json_info<span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>&quot;$.mascot&quot; <span class="hljs-keyword">FROM</span> json_test; <br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------+</span><br><span class="hljs-operator">|</span> json_info<span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>&quot;$.mascot&quot;                       <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------+</span><br><span class="hljs-operator">|</span> &quot;Our mascot is a dolphin named \&quot;Sakila\&quot;.&quot; <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------+</span><br></code></pre></td></tr></table></figure><p>è¿™å°†ä¼šä¿ç•™åæ–œæ ä»¥åŠå‘¨å›´çš„å¼•å·ã€‚è¦ä½¿ç”¨å‰ç¥¥ç‰©ä½œä¸ºé”®æ˜¾ç¤ºæ‰€éœ€çš„å€¼ï¼Œä½†ä¸åŒ…æ‹¬å‘¨å›´çš„å¼•å·æˆ–ä»»ä½•è½¬ä¹‰ç¬¦ï¼Œå¯ä»¥ä½¿ç”¨å†…è”è·¯å¾„è¿ç®—ç¬¦ <code>-&gt;&gt;</code>ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> json_info<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span>&quot;$.mascot&quot; <span class="hljs-keyword">FROM</span> json_test; <br><span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------+</span><br><span class="hljs-operator">|</span> json_info<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span>&quot;$.mascot&quot;                  <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------+</span><br><span class="hljs-operator">|</span> Our mascot <span class="hljs-keyword">is</span> a dolphin named &quot;Sakila&quot;. <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------+</span><br></code></pre></td></tr></table></figure><blockquote><p>å¦‚æœå¯ç”¨äº† <code>NO_BACKSLASH_ESCAPES</code> æœåŠ¡å™¨ <code>SQL</code> æ¨¡å¼ï¼Œåˆ™ä¸Šä¸€ä¸ªç¤ºä¾‹å°†æ— æ³•æ­£å¸¸å·¥ä½œã€‚å¦‚æœè®¾ç½®äº†æ­¤æ¨¡å¼ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å•ä¸ªåæ–œæ è€Œä¸æ˜¯åŒåæ–œæ æ¥æ’å…¥ <code>JSON</code> å¯¹è±¡æ–‡å­—ï¼Œå¹¶ä¿ç•™åæ–œæ ã€‚å¦‚æœåœ¨æ‰§è¡Œæ’å…¥æ—¶ä½¿ç”¨ <code>JSON_OBJECT()</code> å‡½æ•°ï¼Œå¹¶ä¸”è®¾ç½®äº†æ­¤æ¨¡å¼ï¼Œåˆ™å¿…é¡»äº¤æ›¿ä½¿ç”¨å•å¼•å·å’ŒåŒå¼•å·ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> json_test(json_info) <span class="hljs-keyword">VALUES</span> (<span class="hljs-built_in">JSON_OBJECT</span>(<span class="hljs-string">&#x27;mascot&#x27;</span>, <span class="hljs-string">&#x27;Our mascot is a dolphin named &quot;Sakila&quot;.&#x27;</span>));<br></code></pre></td></tr></table></figure></blockquote><h3 id="JSON-å€¼çš„è§„èŒƒåŒ–ã€åˆå¹¶å’Œè‡ªåŠ¨åŒ…è£…"><a href="#JSON-å€¼çš„è§„èŒƒåŒ–ã€åˆå¹¶å’Œè‡ªåŠ¨åŒ…è£…" class="headerlink" title="JSON å€¼çš„è§„èŒƒåŒ–ã€åˆå¹¶å’Œè‡ªåŠ¨åŒ…è£…"></a>JSON å€¼çš„è§„èŒƒåŒ–ã€åˆå¹¶å’Œè‡ªåŠ¨åŒ…è£…</h3><h4 id="è§„èŒƒåŒ–"><a href="#è§„èŒƒåŒ–" class="headerlink" title="è§„èŒƒåŒ–"></a>è§„èŒƒåŒ–</h4><p>å½“ä¸€ä¸ªå­—ç¬¦ä¸²è¢«è§£æä¸ºä¸€ä¸ªæœ‰æ•ˆçš„ <code>JSON</code> æ–‡æ¡£æ—¶ï¼ŒåŒæ—¶ä¹Ÿä¼šè¢«è§„èŒƒåŒ–ã€‚è¿™æ„å‘³ç€ï¼Œä»å·¦åˆ°å³è¯»å–æ—¶ï¼Œä¸æ–‡æ¡£åé¢é‡å¤çš„é”®ä¼šè¢«ä¸¢å¼ƒã€‚æ‰€ä»¥ä¸‹é¢çš„ <code>JSON_OBJECT()</code> è°ƒç”¨äº§ç”Ÿçš„å¯¹è±¡å€¼åªåŒ…å«ç¬¬äºŒä¸ª <code>key1</code> å…ƒç´ ã€‚</p><blockquote><p>RFC 7159 å»ºè®®é‡‡ç”¨è¿™ç§ â€œæœ€åä¸€ä¸ªé‡å¤é”®è·èƒœ â€œçš„è¡Œä¸ºï¼Œå¤§å¤šæ•° JavaScript è§£æå™¨éƒ½é‡‡ç”¨äº†è¿™ç§è¡Œä¸ºã€‚</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">JSON_OBJECT</span>(<span class="hljs-string">&#x27;key1&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;key2&#x27;</span>, <span class="hljs-string">&#x27;abc&#x27;</span>, <span class="hljs-string">&#x27;key1&#x27;</span>, <span class="hljs-string">&#x27;def&#x27;</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">------------------------------------------------------+</span><br><span class="hljs-operator">|</span> <span class="hljs-built_in">JSON_OBJECT</span>(<span class="hljs-string">&#x27;key1&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;key2&#x27;</span>, <span class="hljs-string">&#x27;abc&#x27;</span>, <span class="hljs-string">&#x27;key1&#x27;</span>, <span class="hljs-string">&#x27;def&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------------------------------------------+</span><br><span class="hljs-operator">|</span> &#123;&quot;key1&quot;: &quot;def&quot;, &quot;key2&quot;: &quot;abc&quot;&#125;                       <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------------------------------------------+</span><br><br><span class="hljs-comment">-- è¿™å¯¹äºåœ¨ `JSON` åˆ—ä¸­æ’å…¥å€¼åŒæ ·æœ‰æ•ˆã€‚</span><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> json_test(json_info) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;&#123;&quot;x&quot;: 17, &quot;x&quot;: &quot;red&quot;&#125;&#x27;</span>), (<span class="hljs-string">&#x27;&#123;&quot;x&quot;: 17, &quot;x&quot;: &quot;red&quot;, &quot;x&quot;: [3, 5, 7]&#125;&#x27;</span>);<br>Query OK, <span class="hljs-number">2</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.04</span> sec)<br>Records: <span class="hljs-number">2</span>  Duplicates: <span class="hljs-number">0</span>  Warnings: <span class="hljs-number">0</span><br><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> json_info <span class="hljs-keyword">from</span> json_test;<br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------------------+</span><br><span class="hljs-operator">|</span> json_info                                               <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------------------+</span><br><span class="hljs-operator">|</span> &#123;&quot;x&quot;: &quot;red&quot;&#125;                                            <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> &#123;&quot;x&quot;: [<span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>]&#125;                                        <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------------------+</span><br></code></pre></td></tr></table></figure><blockquote><p><strong>æ³¨æ„</strong>ï¼šåœ¨ <code>MySQL 8.0.3</code> ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œé‡å¤é”®çš„å¤„ç†ç­–ç•¥ä¸ä¸Šé¢æ°å¥½ç›¸åï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œ <code>first duplicate key wins</code> çš„è§„èŒƒåŒ–å¤„ç†ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">JSON_OBJECT</span>(<span class="hljs-string">&#x27;key1&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;key2&#x27;</span>, <span class="hljs-string">&#x27;abc&#x27;</span>, <span class="hljs-string">&#x27;key1&#x27;</span>, <span class="hljs-string">&#x27;def&#x27;</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">------------------------------------------------------+</span><br><span class="hljs-operator">|</span> <span class="hljs-built_in">JSON_OBJECT</span>(<span class="hljs-string">&#x27;key1&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;key2&#x27;</span>, <span class="hljs-string">&#x27;abc&#x27;</span>, <span class="hljs-string">&#x27;key1&#x27;</span>, <span class="hljs-string">&#x27;def&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------------------------------------------+</span><br><span class="hljs-operator">|</span> &#123;&quot;key1&quot;: <span class="hljs-number">1</span>, &quot;key2&quot;: &quot;abc&quot;&#125;                           <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------------------------------------------+</span><br><br><span class="hljs-comment">-- è¿™å¯¹äºåœ¨ `JSON` åˆ—ä¸­æ’å…¥å€¼åŒæ ·æœ‰æ•ˆã€‚</span><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> json_test(json_info) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;&#123;&quot;x&quot;: 17, &quot;x&quot;: &quot;red&quot;&#125;&#x27;</span>), (<span class="hljs-string">&#x27;&#123;&quot;x&quot;: 17, &quot;x&quot;: &quot;red&quot;, &quot;x&quot;: [3, 5, 7]&#125;&#x27;</span>);<br>Query OK, <span class="hljs-number">2</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.04</span> sec)<br>Records: <span class="hljs-number">2</span>  Duplicates: <span class="hljs-number">0</span>  Warnings: <span class="hljs-number">0</span><br><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> json_info <span class="hljs-keyword">from</span> json_test;<br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------------------+</span><br><span class="hljs-operator">|</span> json_info                                               <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------------------+</span><br><span class="hljs-operator">|</span> &#123;&quot;x&quot;: <span class="hljs-number">17</span>&#125;                                               <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> &#123;&quot;x&quot;: <span class="hljs-number">17</span>&#125;                                               <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------------------+</span><br></code></pre></td></tr></table></figure></blockquote><p><code>MySQL</code> è¿˜ä¼šä¸¢å¼ƒåŸå§‹ <code>JSON</code> æ–‡æ¡£ä¸­é”®ã€å€¼æˆ–å…ƒç´ ä¹‹é—´çš„å¤šä½™ç©ºç™½ï¼Œä¸ºäº†<strong>æé«˜å¯è¯»æ€§</strong>ä¼šåœ¨æ˜¾ç¤ºæ—¶ï¼Œåœ¨æ¯ä¸ªé€—å·ï¼ˆ,ï¼‰æˆ–å†’å·ï¼ˆ:ï¼‰åä¿ç•™ï¼ˆæˆ–åœ¨å¿…è¦æ—¶æ’å…¥ï¼‰ä¸€ä¸ªç©ºæ ¼ã€‚æˆ‘ä»¬æ—¥å¸¸å¼€å‘æ—¶åœ¨ç¬¦å·å’Œé€—å·åé¢ä¿ç•™ä¸€ä¸ªç©ºæ ¼ä¹Ÿæ˜¯ä¸ºäº†æé«˜å¯è¯»æ€§ã€‚</p><p><strong>å¯¹äºä½¿ç”¨ <code>MySQL</code> å‡½æ•°ç”Ÿæˆçš„ <code>JSON</code> å€¼æ€»æ˜¯è¿”å›è§„èŒƒåŒ–çš„å¤„ç†ã€‚</strong></p><p>ä¸ºäº†æé«˜æŸ¥æ‰¾æ•ˆç‡ï¼Œ<code>MySQL</code> è¿˜ä¼šå¯¹ <code>JSON</code> å¯¹è±¡çš„é”®è¿›è¡Œæ’åºã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§æ’åºçš„ç»“æœå¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè€Œä¸”ä¸èƒ½ä¿è¯åœ¨ä¸åŒç‰ˆæœ¬ä¸­ä¿æŒä¸€è‡´ã€‚</p><h4 id="JSONå€¼åˆå¹¶"><a href="#JSONå€¼åˆå¹¶" class="headerlink" title="JSONå€¼åˆå¹¶"></a>JSONå€¼åˆå¹¶</h4><p><code>MySQL 8.0.3</code>ï¼ˆåŠæ›´é«˜ç‰ˆæœ¬ï¼‰æ”¯æŒä¸¤ç§åˆå¹¶ç®—æ³•ï¼Œç”±å‡½æ•° <code>JSON_MERGE_PRESERVE()</code> å’Œ <code>JSON_MERGE_PATCH()</code> å®ç°</p><p>å®ƒä»¬åœ¨å¤„ç†é‡å¤é”®çš„æ–¹å¼ä¸Šæœ‰æ‰€ä¸åŒï¼š</p><ul><li><code>JSON_MERGE_PRESERVE()</code> ä¼šä¿ç•™é‡å¤é”®çš„å€¼ã€‚</li><li><code>JSON_MERGE_PATCH()</code> ä¼šä¸¢å¼ƒé™¤æœ€åä¸€ä¸ªå€¼ä»¥å¤–çš„æ‰€æœ‰é‡å¤å€¼ã€‚</li></ul><blockquote><p><code>JSON_MERGE_PRESERVE()</code> ä¸ <code>MySQL</code> ä»¥å‰ç‰ˆæœ¬ä¸­çš„ <code>JSON_MERGE()</code> å‡½æ•°ç›¸åŒï¼ˆ<code>MySQL 8.0.3</code> ä¸­é‡æ–°å‘½åï¼‰ã€‚åœ¨ <code>MySQL 8.0</code> ä¸­ï¼Œ<code>JSON_MERGE()</code> ä½œä¸º <code>JSON_MERGE_PRESERVE()</code> çš„åˆ«åä»å—æ”¯æŒï¼Œä½†å·²è¢«å¼ƒç”¨ï¼Œå¹¶å¯èƒ½åœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­åˆ é™¤ã€‚</p></blockquote><h5 id="åˆå¹¶æ•°ç»„"><a href="#åˆå¹¶æ•°ç»„" class="headerlink" title="åˆå¹¶æ•°ç»„"></a>åˆå¹¶æ•°ç»„</h5><p>åœ¨ç”±å¤šä¸ªæ•°ç»„ç»„åˆçš„ä¸Šä¸‹æ–‡ä¸­ï¼Œè¿™äº›æ•°ç»„ä¼šåˆå¹¶ä¸ºä¸€ä¸ªæ•°ç»„ã€‚</p><ul><li><p><code>JSON_MERGE_PRESERVE()</code> é€šè¿‡å°†åé¢å‘½åçš„æ•°ç»„è¿æ¥åˆ°ç¬¬ä¸€ä¸ªæ•°ç»„çš„æœ«å°¾æ¥å®ç°è¿™ä¸€åŠŸèƒ½ã€‚ä¹Ÿå°±æ˜¯ä»å·¦å¾€å³ï¼Œå°†å¤šä¸ªæ•°ç»„ä¸­çš„å…ƒç´ é¦–å°¾ç›¸è¿ï¼Œæœ€ç»ˆåˆå¹¶ä¸ºä¸€ä¸ªæ•°ç»„ã€‚</p></li><li><p><code>JSON_MERGE_PATCH()</code> <strong>å°†æ¯ä¸ªæ•°ç»„è§†ä¸ºç”±å•ä¸ªå…ƒç´ ç»„æˆçš„æ•°ç»„</strong>ï¼ˆå› æ­¤æ¯ä¸ªæ•°ç»„çš„ç´¢å¼•ä¸º 0ï¼‰ï¼Œç„¶ååº”ç”¨ <code>last duplicate key wins</code> é€»è¾‘ï¼Œåªé€‰æ‹©æœ€åä¸€ä¸ªæ•°ç»„ã€‚</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> <br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> JSON_MERGE_PRESERVE(<span class="hljs-string">&#x27;[1, 2]&#x27;</span>, <span class="hljs-string">&#x27;[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]&#x27;</span>, <span class="hljs-string">&#x27;[true, false]&#x27;</span>) <span class="hljs-keyword">AS</span> Preserve,<br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> JSON_MERGE_PATCH(<span class="hljs-string">&#x27;[1, 2]&#x27;</span>, <span class="hljs-string">&#x27;[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]&#x27;</span>, <span class="hljs-string">&#x27;[true, false]&#x27;</span>) <span class="hljs-keyword">AS</span> Patch;<br><span class="hljs-operator">+</span><span class="hljs-comment">------------------------------------+---------------+</span><br><span class="hljs-operator">|</span> Preserve                           <span class="hljs-operator">|</span> Patch         <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------------------------+---------------+</span><br><span class="hljs-operator">|</span> [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>] <span class="hljs-operator">|</span> [<span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>] <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------------------------+---------------+</span><br></code></pre></td></tr></table></figure><h5 id="åˆå¹¶å¯¹è±¡"><a href="#åˆå¹¶å¯¹è±¡" class="headerlink" title="åˆå¹¶å¯¹è±¡"></a>åˆå¹¶å¯¹è±¡</h5><p>å¤šä¸ªå¯¹è±¡åˆå¹¶åäº§ç”Ÿä¸€ä¸ªå¯¹è±¡ã€‚</p><ul><li><code>JSON_MERGE_PRESERVE()</code> åœ¨å¤„ç†å…·æœ‰ç›¸åŒé”®çš„å¤šä¸ªå¯¹è±¡æ—¶ï¼Œä¼šå°†è¯¥é”®çš„æ‰€æœ‰å”¯ä¸€å€¼ç»„åˆå¹¶åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œè¢«å½“ä½œç»“æœä¸­è¯¥é”®çš„å€¼ã€‚</li><li><code>JSON_MERGE_PATCH()</code> ä¼šä»å·¦åˆ°å³ä¸¢å¼ƒé”®å€¼é‡å¤çš„å€¼ï¼Œå› æ­¤ç»“æœåªåŒ…å«è¯¥é”®å€¼çš„æœ€åä¸€ä¸ªå€¼ã€‚</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span><br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> JSON_MERGE_PRESERVE(<span class="hljs-string">&#x27;&#123;&quot;a&quot;: 1, &quot;b&quot;: 2&#125;&#x27;</span>, <span class="hljs-string">&#x27;&#123;&quot;c&quot;: 3, &quot;a&quot;: 4&#125;&#x27;</span>, <span class="hljs-string">&#x27;&#123;&quot;c&quot;: 5, &quot;d&quot;: 3&#125;&#x27;</span>) <span class="hljs-keyword">AS</span> Preserve,<br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> JSON_MERGE_PATCH(<span class="hljs-string">&#x27;&#123;&quot;a&quot;: 3, &quot;b&quot;: 2&#125;&#x27;</span>, <span class="hljs-string">&#x27;&#123;&quot;c&quot;: 3, &quot;a&quot;: 4&#125;&#x27;</span>, <span class="hljs-string">&#x27;&#123;&quot;c&quot;: 5, &quot;d&quot;: 3&#125;&#x27;</span>) <span class="hljs-keyword">AS</span> Patch;<br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------------+----------------------------------+</span><br><span class="hljs-operator">|</span> Preserve                                   <span class="hljs-operator">|</span> Patch                            <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------------+----------------------------------+</span><br><span class="hljs-operator">|</span> &#123;&quot;a&quot;: [<span class="hljs-number">1</span>, <span class="hljs-number">4</span>], &quot;b&quot;: <span class="hljs-number">2</span>, &quot;c&quot;: [<span class="hljs-number">3</span>, <span class="hljs-number">5</span>], &quot;d&quot;: <span class="hljs-number">3</span>&#125; <span class="hljs-operator">|</span> &#123;&quot;a&quot;: <span class="hljs-number">4</span>, &quot;b&quot;: <span class="hljs-number">2</span>, &quot;c&quot;: <span class="hljs-number">5</span>, &quot;d&quot;: <span class="hljs-number">3</span>&#125; <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------------+----------------------------------+</span><br></code></pre></td></tr></table></figure><h5 id="åˆå¹¶å…ƒç´ "><a href="#åˆå¹¶å…ƒç´ " class="headerlink" title="åˆå¹¶å…ƒç´ "></a>åˆå¹¶å…ƒç´ </h5><p>åœ¨éœ€è¦æ•°ç»„å€¼çš„ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨çš„éæ•°ç»„å€¼å°†è¢«è‡ªåŠ¨å°è£…ï¼Œç„¶åå°†å…¶è½¬åŒ–ä¸ºç”± <code>[</code> å’Œ <code>]</code>å­—ç¬¦åŒ…å›´çš„æ•°ç»„ã€‚</p><p>åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæ¯ä¸ªå‚æ•°éƒ½è¢«è‡ªåŠ¨å°è£…ä¸ºä¸€ä¸ªæ•°ç»„ï¼ˆ[1], [2]ï¼‰ï¼Œä¸å‰ä¸¤ç§æƒ…å†µä¸€æ ·ï¼Œ<code>JSON_MERGE_PRESERVE()</code> ä¼šåˆå¹¶å…·æœ‰ç›¸åŒé”®å€¼çš„å€¼ï¼Œè€Œ <code>JSON_MERGE_PATCH()</code> åˆ™ä¼šä¸¢å¼ƒé™¤æœ€åä¸€ä¸ªé”®å€¼å¤–çš„æ‰€æœ‰é‡å¤é”®å€¼ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span><br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> JSON_MERGE_PRESERVE(<span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>) <span class="hljs-keyword">AS</span> Preserve,<br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> JSON_MERGE_PATCH(<span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>) <span class="hljs-keyword">AS</span> Patch;<br><span class="hljs-operator">+</span><span class="hljs-comment">----------+-------+</span><br><span class="hljs-operator">|</span> Preserve <span class="hljs-operator">|</span> Patch <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----------+-------+</span><br><span class="hljs-operator">|</span> [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]   <span class="hljs-operator">|</span> <span class="hljs-number">2</span>     <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----------+-------+</span><br></code></pre></td></tr></table></figure><h5 id="æ•°ç»„å’Œå¯¹è±¡åˆå¹¶"><a href="#æ•°ç»„å’Œå¯¹è±¡åˆå¹¶" class="headerlink" title="æ•°ç»„å’Œå¯¹è±¡åˆå¹¶"></a>æ•°ç»„å’Œå¯¹è±¡åˆå¹¶</h5><p>æ•°ç»„å’Œå¯¹è±¡å€¼çš„åˆå¹¶æ–¹å¼æ˜¯å°†å¯¹è±¡è‡ªåŠ¨å°è£…ä¸ºæ•°ç»„ï¼Œå¹¶æ ¹æ®é€‰æ‹©çš„åˆå¹¶å‡½æ•°ï¼ˆ<code>JSON_MERGE_PRESERVE()</code> æˆ–  <code>JSON_MERGE_PATCH()</code> ï¼‰ï¼Œåˆ†åˆ«é€šè¿‡åˆå¹¶å€¼æˆ– â€œæœ€åä¸€ä¸ªé‡å¤é”®è·èƒœâ€çš„æ–¹å¼åˆå¹¶æ•°ç»„ï¼Œå¦‚æœ¬ç¤ºä¾‹æ‰€ç¤ºï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> <br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> JSON_MERGE_PRESERVE(<span class="hljs-string">&#x27;[10, 20]&#x27;</span>, <span class="hljs-string">&#x27;&#123;&quot;a&quot;: &quot;x&quot;, &quot;b&quot;: &quot;y&quot;&#125;&#x27;</span>) <span class="hljs-keyword">AS</span> Preserve,<br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> JSON_MERGE_PATCH(<span class="hljs-string">&#x27;[10, 20]&#x27;</span>, <span class="hljs-string">&#x27;&#123;&quot;a&quot;: &quot;x&quot;, &quot;b&quot;: &quot;y&quot;&#125;&#x27;</span>) <span class="hljs-keyword">AS</span> Patch; <br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------+----------------------+</span><br><span class="hljs-operator">|</span> Preserve                       <span class="hljs-operator">|</span> Patch                <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------+----------------------+</span><br><span class="hljs-operator">|</span> [<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, &#123;&quot;a&quot;: &quot;x&quot;, &quot;b&quot;: &quot;y&quot;&#125;] <span class="hljs-operator">|</span> &#123;&quot;a&quot;: &quot;x&quot;, &quot;b&quot;: &quot;y&quot;&#125; <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------+----------------------+</span><br></code></pre></td></tr></table></figure><h3 id="æœç´¢å’Œä¿®æ”¹-JSON-å€¼"><a href="#æœç´¢å’Œä¿®æ”¹-JSON-å€¼" class="headerlink" title="æœç´¢å’Œä¿®æ”¹ JSON å€¼"></a>æœç´¢å’Œä¿®æ”¹ JSON å€¼</h3><h4 id="è·¯å¾„è¡¨è¾¾å¼"><a href="#è·¯å¾„è¡¨è¾¾å¼" class="headerlink" title="è·¯å¾„è¡¨è¾¾å¼"></a>è·¯å¾„è¡¨è¾¾å¼</h4><p><code>JSON</code> è·¯å¾„è¡¨è¾¾å¼å¯¹äºæå–æˆ–ä¿®æ”¹ <code>JSON</code> æ–‡æ¡£éƒ¨åˆ†å†…å®¹çš„å‡½æ•°éå¸¸æœ‰ç”¨ï¼Œå®ƒå¯ä»¥æŒ‡å®šåœ¨æ–‡æ¡£ä¸­çš„å“ªä¸ªä½ç½®è¿›è¡Œæ“ä½œã€‚ä¾‹å¦‚ï¼Œä¸‹é¢çš„æŸ¥è¯¢ä» <code>JSON</code> æ–‡æ¡£ä¸­æå–é”®ä¸º <code>name</code> çš„æˆå‘˜å€¼ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_EXTRACT(<span class="hljs-string">&#x27;&#123;&quot;name&quot;: &quot;å°æ˜&quot;, &quot;age&quot; : 18, &quot;sex&quot; : 1&#125;&#x27;</span>, <span class="hljs-string">&#x27;$.name&#x27;</span>); <br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------------------------+</span><br><span class="hljs-operator">|</span> JSON_EXTRACT(<span class="hljs-string">&#x27;&#123;&quot;name&quot;: &quot;å°æ˜&quot;, &quot;age&quot; : 18, &quot;sex&quot; : 1&#125;&#x27;</span>, <span class="hljs-string">&#x27;$.name&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------------------------+</span><br><span class="hljs-operator">|</span> &quot;å°æ˜&quot;                                                            <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------------------------+</span><br></code></pre></td></tr></table></figure><p>è·¯å¾„è¯­æ³•ä½¿ç”¨å‰å¯¼ <code>$</code> å­—ç¬¦æ¥è¡¨ç¤ºæ‰€è€ƒè™‘çš„ <code>JSON</code> æ–‡æ¡£ï¼Œåé¢è¿˜å¯é€‰æ‹©ä½¿ç”¨é€‰æ‹©å™¨æ¥ç»§ç»­è¡¨ç¤ºæ–‡æ¡£ä¸­æ›´å…·ä½“çš„éƒ¨åˆ†ï¼š</p><ul><li><p>é”®ååé¢çš„å¥ç‚¹è¡¨ç¤ºå¯¹è±¡ä¸­å…·æœ‰ç»™å®šé”®çš„æˆå‘˜ã€‚<strong>å¦‚æœä¸å¸¦å¼•å·çš„é”®ååœ¨è·¯å¾„è¡¨è¾¾å¼ä¸­ä¸åˆæ³•ï¼ˆä¾‹å¦‚åŒ…å«ç©ºæ ¼ï¼‰ï¼Œåˆ™é”®åå¿…é¡»ç”¨åŒå¼•å·æŒ‡å®š</strong>ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- é”®åä¸åˆæ³•</span><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_EXTRACT(<span class="hljs-string">&#x27;&#123;&quot;na me&quot;: &quot;å°æ˜&quot;, &quot;age&quot; : 18, &quot;sex&quot; : 1&#125;&#x27;</span>, <span class="hljs-string">&#x27;$.na me&#x27;</span>);<br>ERROR <span class="hljs-number">3143</span> (<span class="hljs-number">42000</span>): Invalid JSON path expression. The error <span class="hljs-keyword">is</span> around <span class="hljs-type">character</span> position <span class="hljs-number">5.</span><br><br><span class="hljs-comment">-- éœ€è¦ä½¿ç”¨åŒå¼•å·åŒ…è£¹</span><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_EXTRACT(<span class="hljs-string">&#x27;&#123;&quot;na me&quot;: &quot;å°æ˜&quot;, &quot;age&quot; : 18, &quot;sex&quot; : 1&#125;&#x27;</span>, <span class="hljs-string">&#x27;$.&quot;na me&quot;&#x27;</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------------------------------+</span><br><span class="hljs-operator">|</span> JSON_EXTRACT(<span class="hljs-string">&#x27;&#123;&quot;na me&quot;: &quot;å°æ˜&quot;, &quot;age&quot; : 18, &quot;sex&quot; : 1&#125;&#x27;</span>, <span class="hljs-string">&#x27;$.&quot;na me&quot;&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------------------------------+</span><br><span class="hljs-operator">|</span> &quot;å°æ˜&quot;                                                                <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------------------------------+</span><br></code></pre></td></tr></table></figure></li><li><p>å°†<code>[N]</code> é™„åŠ åˆ°é€‰æ‹©æ•°ç»„çš„è·¯å¾„ä¸Šï¼ˆä¾‹å¦‚ <code>$</code>ï¼‰è¡¨ç¤ºæŒ‡å®šæ•°ç»„ä¸­ä½ç½®ä¸º <code>N</code> çš„å€¼ã€‚æ•°ç»„ä½ç½®æ˜¯ä»¥ 0 å¼€å¤´çš„æ•´æ•°ã€‚å¦‚æœ <code>path</code> æ²¡æœ‰é€‰æ‹©æ•°ç»„å€¼ï¼Œåˆ™ <code>path</code> çš„å€¼ä¸ <code>path[0]</code> ç›¸åŒï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_SET(<span class="hljs-string">&#x27;&quot;x&quot;&#x27;</span>, <span class="hljs-string">&#x27;$[0]&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">------------------------------+</span><br><span class="hljs-operator">|</span> JSON_SET(<span class="hljs-string">&#x27;&quot;x&quot;&#x27;</span>, <span class="hljs-string">&#x27;$[0]&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------------------+</span><br><span class="hljs-operator">|</span> &quot;a&quot;                          <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------------------+</span><br><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_SET(<span class="hljs-string">&#x27;&quot;x&quot;&#x27;</span>, <span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>);    <br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------+</span><br><span class="hljs-operator">|</span> JSON_SET(<span class="hljs-string">&#x27;&quot;x&quot;&#x27;</span>, <span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------+</span><br><span class="hljs-operator">|</span> &quot;a&quot;                       <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------+</span><br><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_SET(<span class="hljs-string">&#x27;&quot;x&quot;&#x27;</span>, <span class="hljs-string">&#x27;$[1]&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>);  <br><span class="hljs-operator">+</span><span class="hljs-comment">------------------------------+</span><br><span class="hljs-operator">|</span> JSON_SET(<span class="hljs-string">&#x27;&quot;x&quot;&#x27;</span>, <span class="hljs-string">&#x27;$[1]&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------------------+</span><br><span class="hljs-operator">|</span> [&quot;x&quot;, &quot;a&quot;]                   <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------------------+</span><br></code></pre></td></tr></table></figure></li><li><p><code>[M to N]</code> æŒ‡å®šæ•°ç»„å€¼çš„å­é›†æˆ–èŒƒå›´ï¼Œä»ä½ç½® M çš„å€¼å¼€å§‹ï¼Œåˆ°ä½ç½® N çš„å€¼ç»“æŸã€‚</p><blockquote><p><code>last</code> ä½œä¸ºæœ€å³è¾¹æ•°ç»„å…ƒç´ ç´¢å¼•åŒæ ·è¢«æ”¯æŒï¼Œ</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_SET(<span class="hljs-string">&#x27;&#123;&quot;name&quot;: &quot;John&quot;, &quot;age&quot;: 30, &quot;city&quot;: &quot;New York&quot;&#125;&#x27;</span>, <span class="hljs-string">&#x27;$[last]&#x27;</span>, <span class="hljs-string">&#x27;Los Angeles&#x27;</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------------------------------------------------+</span><br><span class="hljs-operator">|</span> JSON_SET(<span class="hljs-string">&#x27;&#123;&quot;name&quot;: &quot;John&quot;, &quot;age&quot;: 30, &quot;city&quot;: &quot;New York&quot;&#125;&#x27;</span>, <span class="hljs-string">&#x27;$[last]&#x27;</span>, <span class="hljs-string">&#x27;Los Angeles&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------------------------------------------------+</span><br><span class="hljs-operator">|</span> &quot;Los Angeles&quot;                                                                         <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------------------------------------------------+</span><br></code></pre></td></tr></table></figure></li><li><p>è·¯å¾„å¯ä»¥åŒ…å« <code>*</code> æˆ– <code>**</code> é€šé…ç¬¦ï¼š</p><ul><li><code>.[*]</code>è¡¨ç¤ºä¸º <code>JSON</code> å¯¹è±¡ä¸­æ‰€æœ‰æˆå‘˜çš„å€¼ã€‚</li><li><code>[*]</code> è¡¨ç¤ºä¸º <code>JSON</code> æ•°ç»„ä¸­æ‰€æœ‰å…ƒç´ çš„å€¼ã€‚</li><li><em><code>prefix</code>**<code>suffix </code></em> ä¼šåŒ¹é…ä»¥æŒ‡å®šå‰ç¼€å¼€å¤´ã€ä»¥æŒ‡å®šåç¼€ç»“å°¾çš„æ‰€æœ‰è·¯å¾„ã€‚</li></ul></li><li><p>è·å–æ–‡æ¡£ä¸­ä¸å­˜åœ¨çš„è·¯å¾„ï¼ˆæ±‚å€¼ä¸ºä¸å­˜åœ¨çš„æ•°æ®ï¼‰æ—¶ä¼šè¿”å› <code>NULL</code>ã€‚</p></li></ul><p>ä¸¾ä¸ªä¾‹å­ï¼šæˆ‘ä»¬ä½¿ç”¨ <code>$</code> æ¥è¡¨ç¤ºä¸‹é¢è¿™ä¸ªåŒ…å«ä¸‰ä¸ªå…ƒç´ çš„ <code>JSON</code> æ•°ç»„ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">[</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;a&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">5</span><span class="hljs-punctuation">,</span> <span class="hljs-number">6</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;b&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">[</span><span class="hljs-number">99</span><span class="hljs-punctuation">,</span> <span class="hljs-number">100</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure><ul><li><code>$[0]</code> è¡¨ç¤º <code>3</code>.</li><li><code>$[1]</code> è¡¨ç¤º  <code>&#123;&quot;a&quot;: [5, 6], &quot;b&quot;: 10&#125;</code>.</li><li><code>$[2]</code> è¡¨ç¤º <code>[99, 100]</code>.</li><li><code>$[3]</code> è¿”å›çš„ç»“æœä¸º <code>NULL</code> ï¼ˆå®ƒæŒ‡çš„æ˜¯ç¬¬å››ä¸ªæ•°ç»„å…ƒç´ ï¼Œè¯¥å…ƒç´ ä¸å­˜åœ¨ï¼‰ã€‚</li></ul><p>ç”±äº <code>$[1]</code> å’Œ <code>$[2]</code>  è¡¨ç¤ºéæ ‡é‡å€¼ï¼Œå› æ­¤å®ƒä»¬å¯ä»¥ç”¨ä½œé€‰æ‹©åµŒå¥—å€¼çš„æ›´å…·ä½“è·¯å¾„è¡¨è¾¾å¼çš„åŸºç¡€ã€‚ä¾‹å­ï¼š</p><ul><li><code>$[1].a</code> è¡¨ç¤º <code>[5, 6]</code>.</li><li><code>$[1].b</code> è¡¨ç¤º <code>10</code>.</li><li><code>$[2][0]</code> è¡¨ç¤º <code>99</code>.</li></ul><p>ä½¿ç”¨é€šé…ç¬¦çš„è·¯å¾„è®¡ç®—ç»“æœä¸ºå¯ä»¥åŒ…å«å¤šä¸ªå€¼çš„æ•°ç»„ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_EXTRACT(<span class="hljs-string">&#x27;&#123;&quot;a&quot;: 1, &quot;b&quot;: 2, &quot;c&quot;: [3, 4, 5]&#125;&#x27;</span>, <span class="hljs-string">&#x27;$.*&#x27;</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------------------+</span><br><span class="hljs-operator">|</span> JSON_EXTRACT(<span class="hljs-string">&#x27;&#123;&quot;a&quot;: 1, &quot;b&quot;: 2, &quot;c&quot;: [3, 4, 5]&#125;&#x27;</span>, <span class="hljs-string">&#x27;$.*&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------------------+</span><br><span class="hljs-operator">|</span> [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]]                                       <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------------------+</span><br><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_EXTRACT(<span class="hljs-string">&#x27;&#123;&quot;a&quot;: 1, &quot;b&quot;: 2, &quot;c&quot;: [3, 4, 5]&#125;&#x27;</span>, <span class="hljs-string">&#x27;$.c[*]&#x27;</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">------------------------------------------------------------+</span><br><span class="hljs-operator">|</span> JSON_EXTRACT(<span class="hljs-string">&#x27;&#123;&quot;a&quot;: 1, &quot;b&quot;: 2, &quot;c&quot;: [3, 4, 5]&#125;&#x27;</span>, <span class="hljs-string">&#x27;$.c[*]&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------------------------------------------------+</span><br><span class="hljs-operator">|</span> [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]                                                  <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------------------------------------------------+</span><br></code></pre></td></tr></table></figure><p>åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œè·¯å¾„<code>$**.b</code> è¡¨ç¤ºä¸ºå¤šä¸ªè·¯å¾„ï¼ˆ<code>$.a.b</code>å’Œ <code>$.c.b</code>ï¼‰å¹¶ç”ŸæˆåŒ¹é…è·¯å¾„å€¼çš„æ•°ç»„ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_EXTRACT(<span class="hljs-string">&#x27;&#123;&quot;a&quot;: &#123;&quot;b&quot;: 1&#125;, &quot;c&quot;: &#123;&quot;b&quot;: 2&#125;&#125;&#x27;</span>, <span class="hljs-string">&#x27;$**.b&#x27;</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------------------+</span><br><span class="hljs-operator">|</span> JSON_EXTRACT(<span class="hljs-string">&#x27;&#123;&quot;a&quot;: &#123;&quot;b&quot;: 1&#125;, &quot;c&quot;: &#123;&quot;b&quot;: 2&#125;&#125;&#x27;</span>, <span class="hljs-string">&#x27;$**.b&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------------------+</span><br><span class="hljs-operator">|</span> [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]                                                  <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------------------------------------------------+</span><br></code></pre></td></tr></table></figure><p><strong>JSON æ•°ç»„çš„èŒƒå›´ã€‚</strong> å¯ä»¥ä½¿ç”¨å¸¦æœ‰ <code>to</code> å…³é”®å­—çš„èŒƒå›´æ¥æŒ‡å®š <code>JSON</code> æ•°ç»„çš„å­é›†ã€‚ä¾‹å¦‚ï¼Œ<code>$[1 to 3]</code>åŒ…å«æ•°ç»„çš„ç¬¬äºŒä¸ªã€ç¬¬ä¸‰ä¸ªå’Œç¬¬å››ä¸ªå…ƒç´ ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_EXTRACT(<span class="hljs-string">&#x27;[1, 2, 3, 4, 5]&#x27;</span>, <span class="hljs-string">&#x27;$[1 to 3]&#x27;</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">----------------------------------------------+</span><br><span class="hljs-operator">|</span> JSON_EXTRACT(<span class="hljs-string">&#x27;[1, 2, 3, 4, 5]&#x27;</span>, <span class="hljs-string">&#x27;$[1 to 3]&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----------------------------------------------+</span><br><span class="hljs-operator">|</span> [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]                                    <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----------------------------------------------+</span><br></code></pre></td></tr></table></figure><p>è¯­æ³• <code>M to N</code>ï¼Œå…¶ä¸­ M å’Œ N åˆ†åˆ«æ˜¯ <code>JSON</code> æ•°ç»„å…ƒç´ æ‰€å–èŒƒå›´çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªç´¢å¼•ã€‚æ•°ç»„å…ƒç´ çš„ç´¢å¼•ä» 0 å¼€å§‹ã€‚</p><p>æœ€å³è¾¹çš„æ•°ç»„å…ƒç´ ï¼š <code>last</code> å…³é”®å­—æ˜¯æ•°ç»„ä¸­æœ€åä¸€ä¸ªå…ƒç´ ç´¢å¼•çš„ä»£åè¯ã€‚<code>last - N</code> å½¢å¼çš„è¡¨è¾¾å¼å¯ç”¨äºç›¸å¯¹å¯»å€å’ŒèŒƒå›´å®šä¹‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_EXTRACT(<span class="hljs-string">&#x27;[1, 2, 3, 4, 5]&#x27;</span>, <span class="hljs-string">&#x27;$[last-3 to last-1]&#x27;</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------------------------+</span><br><span class="hljs-operator">|</span> JSON_EXTRACT(<span class="hljs-string">&#x27;[1, 2, 3, 4, 5]&#x27;</span>, <span class="hljs-string">&#x27;$[last-3 to last-1]&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------------------------+</span><br><span class="hljs-operator">|</span> [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]                                              <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------------------------+</span><br></code></pre></td></tr></table></figure><p>å¦‚æœè·¯å¾„è¡¨è¾¾å¼æ˜¯é’ˆå¯¹ä¸€ä¸ªéæ•°ç»„çš„å€¼è¿›è¡Œæ±‚å€¼ï¼Œæ±‚å€¼ç»“æœä¸è¯¥å€¼è¢«åŒ…åœ¨å•å…ƒç´ æ•°ç»„ä¸­çš„ç»“æœç›¸åŒï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_REPLACE(<span class="hljs-string">&#x27;&quot;Sakila&quot;&#x27;</span>, <span class="hljs-string">&#x27;$[last]&#x27;</span>, <span class="hljs-number">10</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------+</span><br><span class="hljs-operator">|</span> JSON_REPLACE(<span class="hljs-string">&#x27;&quot;Sakila&quot;&#x27;</span>, <span class="hljs-string">&#x27;$[last]&#x27;</span>, <span class="hljs-number">10</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------+</span><br><span class="hljs-operator">|</span> <span class="hljs-number">10</span>                                      <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------+</span><br></code></pre></td></tr></table></figure><h4 id="JSONå€¼æœç´¢"><a href="#JSONå€¼æœç´¢" class="headerlink" title="JSONå€¼æœç´¢"></a>JSONå€¼æœç´¢</h4><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¸¦æœ‰ <code>JSON</code> åˆ—æ ‡è¯†ç¬¦å’Œ <code>JSON</code> è·¯å¾„è¡¨è¾¾å¼çš„ <code>column-&gt;path</code> ä½œä¸º <code>JSON_EXTRACT(column,path)</code> çš„åŒä¹‰è¯ã€‚</p><ul><li><p><code>JSON_CONTAINS (target, candidate[, path])</code></p><p>é€šè¿‡è¿”å› 1 æˆ– 0 è¡¨ç¤ºç»™å®šçš„ <code>candidate</code> æ˜¯å¦åŒ…å«åœ¨ç›®æ ‡ <code>JSON</code> æ–‡æ¡£ä¸­ï¼Œæˆ–è€…ï¼ˆå¦‚æœæä¾›äº†è·¯å¾„å‚æ•°ï¼‰å€™é€‰æ–‡æ¡£æ˜¯å¦åœ¨ç›®æ ‡æ–‡æ¡£çš„ç‰¹å®šè·¯å¾„ä¸­æ‰¾åˆ°ã€‚å¦‚æœä»»ä½•å‚æ•°ä¸º NULLï¼Œæˆ–è€…è·¯å¾„å‚æ•°æœªæŒ‡å®šç›®æ ‡æ–‡æ¡£çš„æŸä¸ªéƒ¨åˆ†ï¼Œåˆ™è¿”å› NULLã€‚å¦‚æœç›®æ ‡æˆ–å€™é€‰å¯¹è±¡ä¸æ˜¯æœ‰æ•ˆçš„ JSON æ–‡æ¡£ï¼Œæˆ–è€…è·¯å¾„å‚æ•°ä¸æ˜¯æœ‰æ•ˆçš„è·¯å¾„è¡¨è¾¾å¼æˆ–åŒ…å« * æˆ– ** é€šé…ç¬¦ï¼Œåˆ™ä¼šå‘ç”Ÿé”™è¯¯ã€‚ä»…æ£€æŸ¥è·¯å¾„ä¸­æ˜¯å¦å­˜åœ¨<strong>ä»»ä½•æ•°æ®</strong>ï¼Œè¯·æ”¹ç”¨ <code>JSON_CONTAINS_PATH()</code>ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SET</span> <span class="hljs-variable">@j</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;&#123;&quot;a&quot;: 1, &quot;b&quot;: 2, &quot;c&quot;: &#123;&quot;d&quot;: 4&#125;&#125;&#x27;</span>;<br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SET</span> <span class="hljs-variable">@j2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;1&#x27;</span>;<br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_CONTAINS(<span class="hljs-variable">@j</span>, <span class="hljs-variable">@j2</span>, <span class="hljs-string">&#x27;$.a&#x27;</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+</span><br><span class="hljs-operator">|</span> JSON_CONTAINS(<span class="hljs-variable">@j</span>, <span class="hljs-variable">@j2</span>, <span class="hljs-string">&#x27;$.a&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+</span><br><span class="hljs-operator">|</span>                             <span class="hljs-number">1</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+</span><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_CONTAINS(<span class="hljs-variable">@j</span>, <span class="hljs-variable">@j2</span>, <span class="hljs-string">&#x27;$.b&#x27;</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+</span><br><span class="hljs-operator">|</span> JSON_CONTAINS(<span class="hljs-variable">@j</span>, <span class="hljs-variable">@j2</span>, <span class="hljs-string">&#x27;$.b&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+</span><br><span class="hljs-operator">|</span>                             <span class="hljs-number">0</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+</span><br><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SET</span> <span class="hljs-variable">@j2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;&#123;&quot;d&quot;: 4&#125;&#x27;</span>;<br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_CONTAINS(<span class="hljs-variable">@j</span>, <span class="hljs-variable">@j2</span>, <span class="hljs-string">&#x27;$.a&#x27;</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+</span><br><span class="hljs-operator">|</span> JSON_CONTAINS(<span class="hljs-variable">@j</span>, <span class="hljs-variable">@j2</span>, <span class="hljs-string">&#x27;$.a&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+</span><br><span class="hljs-operator">|</span>                             <span class="hljs-number">0</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+</span><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_CONTAINS(<span class="hljs-variable">@j</span>, <span class="hljs-variable">@j2</span>, <span class="hljs-string">&#x27;$.c&#x27;</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+</span><br><span class="hljs-operator">|</span> JSON_CONTAINS(<span class="hljs-variable">@j</span>, <span class="hljs-variable">@j2</span>, <span class="hljs-string">&#x27;$.c&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+</span><br><span class="hljs-operator">|</span>                             <span class="hljs-number">1</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+</span><br></code></pre></td></tr></table></figure></li><li><p><code>JSON_EXTRACT(json_doc, path[, path] ...)</code></p><p>ä» <code>JSON</code> æ–‡æ¡£è¿”å›æ•°æ®ï¼Œè¯¥æ•°æ®æ˜¯ä»ä¸å‚æ•° <em><code>path</code></em>  åŒ¹é…çš„æ–‡æ¡£éƒ¨åˆ†ä¸­é€‰æ‹©çš„ã€‚å¦‚æœæœ‰ä»»ä½•å‚æ•° <code>NULL</code>æˆ–æ²¡æœ‰è·¯å¾„åœ¨æ–‡æ¡£ä¸­æ‰¾åˆ°å€¼ï¼Œåˆ™è¿”å› <code>NULL</code>ã€‚å¦‚æœå‚æ•°ä¸æ˜¯æœ‰æ•ˆçš„ <code>JSON</code> æ–‡æ¡£æˆ–ä»»ä½• <code>path</code> å‚æ•°éƒ½ä¸æ˜¯æœ‰æ•ˆçš„è·¯å¾„è¡¨è¾¾å¼ï¼Œ åˆ™ä¼šå‘ç”Ÿé”™è¯¯ ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_EXTRACT(<span class="hljs-string">&#x27;[10, 20, [30, 40]]&#x27;</span>, <span class="hljs-string">&#x27;$[1]&#x27;</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------------+</span><br><span class="hljs-operator">|</span> JSON_EXTRACT(<span class="hljs-string">&#x27;[10, 20, [30, 40]]&#x27;</span>, <span class="hljs-string">&#x27;$[1]&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------------+</span><br><span class="hljs-operator">|</span> <span class="hljs-number">20</span>                                         <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------------+</span><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_EXTRACT(<span class="hljs-string">&#x27;[10, 20, [30, 40]]&#x27;</span>, <span class="hljs-string">&#x27;$[1]&#x27;</span>, <span class="hljs-string">&#x27;$[0]&#x27;</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">----------------------------------------------------+</span><br><span class="hljs-operator">|</span> JSON_EXTRACT(<span class="hljs-string">&#x27;[10, 20, [30, 40]]&#x27;</span>, <span class="hljs-string">&#x27;$[1]&#x27;</span>, <span class="hljs-string">&#x27;$[0]&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----------------------------------------------------+</span><br><span class="hljs-operator">|</span> [<span class="hljs-number">20</span>, <span class="hljs-number">10</span>]                                           <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----------------------------------------------------+</span><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_EXTRACT(<span class="hljs-string">&#x27;[10, 20, [30, 40]]&#x27;</span>, <span class="hljs-string">&#x27;$[2][*]&#x27;</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------+</span><br><span class="hljs-operator">|</span> JSON_EXTRACT(<span class="hljs-string">&#x27;[10, 20, [30, 40]]&#x27;</span>, <span class="hljs-string">&#x27;$[2][*]&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------+</span><br><span class="hljs-operator">|</span> [<span class="hljs-number">30</span>, <span class="hljs-number">40</span>]                                      <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------+</span><br></code></pre></td></tr></table></figure><p>MySQL æ”¯æŒ <code>-&gt;</code> è¿ç®—ç¬¦ä½œä¸ºæ­¤å‡½æ•°çš„ç®€å†™å½¢å¼ï¼Œå®ƒå¯ä»¥ä¸ 2 ä¸ªå‚æ•°ä¸€èµ·ä½¿ç”¨ï¼Œå…¶ä¸­å·¦ä¾§æ˜¯ <code>JSON</code> åˆ—æ ‡è¯†ç¬¦ï¼ˆä¸æ˜¯è¡¨è¾¾å¼ï¼‰ï¼Œå³ä¾§æ˜¯è¦åœ¨åˆ—ä¸­åŒ¹é…çš„ <code>JSON</code> è·¯å¾„ã€‚</p></li><li><p><code>column</code> <em>-&gt;</em><code>path</code> ï¼ˆæ­¤åŠŸèƒ½ä¸é™äº <code>SELECT</code>ï¼‰</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> c, JSON_EXTRACT(c, &quot;$.id&quot;), g<br>     <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">FROM</span> jemp<br>     <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">WHERE</span> JSON_EXTRACT(c, &quot;$.id&quot;) <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span><br>     <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> JSON_EXTRACT(c, &quot;$.name&quot;);<br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+-----------+------+</span><br><span class="hljs-operator">|</span> c                             <span class="hljs-operator">|</span> c<span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>&quot;$.id&quot; <span class="hljs-operator">|</span> g    <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+-----------+------+</span><br><span class="hljs-operator">|</span> &#123;&quot;id&quot;: &quot;3&quot;, &quot;name&quot;: &quot;Barney&quot;&#125; <span class="hljs-operator">|</span> &quot;3&quot;       <span class="hljs-operator">|</span>    <span class="hljs-number">3</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> &#123;&quot;id&quot;: &quot;4&quot;, &quot;name&quot;: &quot;Betty&quot;&#125;  <span class="hljs-operator">|</span> &quot;4&quot;       <span class="hljs-operator">|</span>    <span class="hljs-number">4</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> &#123;&quot;id&quot;: &quot;2&quot;, &quot;name&quot;: &quot;Wilma&quot;&#125;  <span class="hljs-operator">|</span> &quot;2&quot;       <span class="hljs-operator">|</span>    <span class="hljs-number">2</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+-----------+------+</span><br><span class="hljs-number">3</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> c, c<span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>&quot;$.id&quot;, g<br>     <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">FROM</span> jemp<br>     <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">WHERE</span> c<span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>&quot;$.id&quot; <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span><br>     <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c<span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>&quot;$.name&quot;;<br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+-----------+------+</span><br><span class="hljs-operator">|</span> c                             <span class="hljs-operator">|</span> c<span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>&quot;$.id&quot; <span class="hljs-operator">|</span> g    <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+-----------+------+</span><br><span class="hljs-operator">|</span> &#123;&quot;id&quot;: &quot;3&quot;, &quot;name&quot;: &quot;Barney&quot;&#125; <span class="hljs-operator">|</span> &quot;3&quot;       <span class="hljs-operator">|</span>    <span class="hljs-number">3</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> &#123;&quot;id&quot;: &quot;4&quot;, &quot;name&quot;: &quot;Betty&quot;&#125;  <span class="hljs-operator">|</span> &quot;4&quot;       <span class="hljs-operator">|</span>    <span class="hljs-number">4</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> &#123;&quot;id&quot;: &quot;2&quot;, &quot;name&quot;: &quot;Wilma&quot;&#125;  <span class="hljs-operator">|</span> &quot;2&quot;       <span class="hljs-operator">|</span>    <span class="hljs-number">2</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+-----------+------+</span><br></code></pre></td></tr></table></figure></li><li><p><code>column -&gt;&gt; path</code></p><p>è¿™æ˜¯ä¸€ä¸ªæ”¹è¿›çš„ã€ä¸å¸¦å¼•å·çš„æå–è¿ç®—ç¬¦ã€‚è™½ç„¶è¯¥<code>-&gt;</code>è¿ç®—ç¬¦åªæ˜¯æå–ä¸€ä¸ªå€¼ï¼Œä½†è¯¥<code>-&gt;&gt;</code>è¿ç®—ç¬¦è¿˜å–æ¶ˆæå–å¼•ç”¨çš„ç»“æœã€‚è¯¥è¿ç®—ç¬¦å¯ä»¥åœ¨ä»»ä½•å…è®¸çš„<code>-&gt;&gt;</code>åœ°æ–¹ä½¿ç”¨ ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> jemp <span class="hljs-keyword">WHERE</span> g <span class="hljs-operator">&gt;</span> <span class="hljs-number">2</span>;<br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+------+</span><br><span class="hljs-operator">|</span> c                             <span class="hljs-operator">|</span> g    <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+------+</span><br><span class="hljs-operator">|</span> &#123;&quot;id&quot;: &quot;3&quot;, &quot;name&quot;: &quot;Barney&quot;&#125; <span class="hljs-operator">|</span>    <span class="hljs-number">3</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> &#123;&quot;id&quot;: &quot;4&quot;, &quot;name&quot;: &quot;Betty&quot;&#125;  <span class="hljs-operator">|</span>    <span class="hljs-number">4</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------+------+</span><br><span class="hljs-number">2</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.01</span> sec)<br><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> c<span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span><span class="hljs-string">&#x27;$.name&#x27;</span> <span class="hljs-keyword">AS</span> name<br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>     <span class="hljs-keyword">FROM</span> jemp <span class="hljs-keyword">WHERE</span> g <span class="hljs-operator">&gt;</span> <span class="hljs-number">2</span>;<br><span class="hljs-operator">+</span><span class="hljs-comment">----------+</span><br><span class="hljs-operator">|</span> name     <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----------+</span><br><span class="hljs-operator">|</span> &quot;Barney&quot; <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> &quot;Betty&quot;  <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----------+</span><br><span class="hljs-number">2</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> JSON_UNQUOTE(c<span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span><span class="hljs-string">&#x27;$.name&#x27;</span>) <span class="hljs-keyword">AS</span> name<br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>     <span class="hljs-keyword">FROM</span> jemp <span class="hljs-keyword">WHERE</span> g <span class="hljs-operator">&gt;</span> <span class="hljs-number">2</span>;<br><span class="hljs-operator">+</span><span class="hljs-comment">--------+</span><br><span class="hljs-operator">|</span> name   <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------+</span><br><span class="hljs-operator">|</span> Barney <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> Betty  <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------+</span><br><span class="hljs-number">2</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> c<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span><span class="hljs-string">&#x27;$.name&#x27;</span> <span class="hljs-keyword">AS</span> name<br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>     <span class="hljs-keyword">FROM</span> jemp <span class="hljs-keyword">WHERE</span> g <span class="hljs-operator">&gt;</span> <span class="hljs-number">2</span>;<br><span class="hljs-operator">+</span><span class="hljs-comment">--------+</span><br><span class="hljs-operator">|</span> name   <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------+</span><br><span class="hljs-operator">|</span> Barney <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> Betty  <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------+</span><br><span class="hljs-number">2</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br></code></pre></td></tr></table></figure></li><li><p><code>JSON_VALUE(json_doc, path)</code></p><p>ä»æŒ‡å®šæ–‡æ¡£ä¸­ç»™å®šè·¯å¾„å¤„çš„ <code>JSON</code> æ–‡æ¡£ä¸­æå–å€¼ï¼Œå¹¶è¿”å›æå–çš„å€¼ï¼Œå¯ä»¥é€‰æ‹©å°†å…¶è½¬æ¢ä¸ºæ‰€éœ€çš„ç±»å‹ã€‚å®Œæ•´çš„è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-built_in">JSON_VALUE</span>(json_doc, path [RETURNING type] [on_empty] [on_error])<br><br>on_empty:<br>    &#123;<span class="hljs-keyword">NULL</span> <span class="hljs-operator">|</span> ERROR <span class="hljs-operator">|</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">value</span>&#125; <span class="hljs-keyword">ON</span> <span class="hljs-keyword">EMPTY</span><br><br>on_error:<br>    &#123;<span class="hljs-keyword">NULL</span> <span class="hljs-operator">|</span> ERROR <span class="hljs-operator">|</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">value</span>&#125; <span class="hljs-keyword">ON</span> ERROR<br></code></pre></td></tr></table></figure><p>ä¾‹å­ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">JSON_VALUE</span>(<span class="hljs-string">&#x27;&#123;&quot;fname&quot;: &quot;Joe&quot;, &quot;lname&quot;: &quot;Palmer&quot;&#125;&#x27;</span>, <span class="hljs-string">&#x27;$.fname&#x27;</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------------------------------+</span><br><span class="hljs-operator">|</span> <span class="hljs-built_in">JSON_VALUE</span>(<span class="hljs-string">&#x27;&#123;&quot;fname&quot;: &quot;Joe&quot;, &quot;lname&quot;: &quot;Palmer&quot;&#125;&#x27;</span>, <span class="hljs-string">&#x27;$.fname&#x27;</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------------------------------+</span><br><span class="hljs-operator">|</span> Joe                                                          <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------------------------------+</span><br><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">JSON_VALUE</span>(<span class="hljs-string">&#x27;&#123;&quot;item&quot;: &quot;shoes&quot;, &quot;price&quot;: &quot;49.95&quot;&#125;&#x27;</span>, <span class="hljs-string">&#x27;$.price&#x27;</span><br>    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> RETURNING <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">4</span>,<span class="hljs-number">2</span>)) <span class="hljs-keyword">AS</span> price;<br><span class="hljs-operator">+</span><span class="hljs-comment">-------+</span><br><span class="hljs-operator">|</span> price <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------+</span><br><span class="hljs-operator">|</span> <span class="hljs-number">49.95</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------+</span><br></code></pre></td></tr></table></figure></li></ul><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="https://dev.mysql.com/doc/refman/8.0/en/json.html">https://dev.mysql.com/doc/refman/8.0/en/json.html</a><a href="#fnref:1" rev="footnote" class="footnote-backref"> â†©</a></span></span></li></ol></div></section>]]></content>
    
    
    <categories>
      
      <category>æ•°æ®åº“</category>
      
      <category>MySQL</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ•°æ®åº“</tag>
      
      <tag>MySQL</tag>
      
      <tag>æ•°æ®ç±»å‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CompletableFuture-ä¸€ç§å¼‚æ­¥ä»»åŠ¡ç¼–æ’è§£å†³æ–¹æ¡ˆ</title>
    <link href="/2023/10/13/CompletableFuture-%E4%B8%80%E7%A7%8D%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E7%BC%96%E6%8E%92%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
    <url>/2023/10/13/CompletableFuture-%E4%B8%80%E7%A7%8D%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E7%BC%96%E6%8E%92%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</url>
    
    <content type="html"><![CDATA[<h3 id="åºè¨€"><a href="#åºè¨€" class="headerlink" title="åºè¨€"></a>åºè¨€</h3><p>å¤šçº¿ç¨‹ä¸»è¦æ˜¯é€šè¿‡æé«˜å¯¹ <code>CPU</code> çš„åˆ©ç”¨ç‡ä»è€Œæå‡å¤šä»»åŠ¡å¤„ç†çš„æ•ˆç‡ï¼Œä»¥æ»¡è¶³ç”¨æˆ·çš„å‹å¥½ä½“éªŒã€‚</p><p>æ ¹æ® <code>Oracle</code> å®˜æ–¹æ–‡æ¡£çš„æè¿°ï¼š<code>JAVA</code> ä¸­åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼æœ‰ä¸¤ç§ï¼š</p><ol><li>ç»§æ‰¿ <code>java.lang.Thread</code> ç±»ã€‚ï¼ˆ <code>Thread</code> ç±»æœ¬è´¨ä¸Šä¹Ÿæ˜¯å®ç°äº† <code>Runnable</code> æ¥å£ï¼‰</li><li>å®ç° <code>java.lang.Runnable</code> æ¥å£ã€‚</li></ol><p>ä½†æ˜¯ï¼Œè¿™ä¸¤ç§æ–¹æ³•éƒ½å­˜åœ¨ä¸€ä¸ªç¼ºé™·â€”â€”æ²¡æœ‰è¿”å›å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æ— æ³•å¾—çŸ¥çº¿ç¨‹æ‰§è¡Œç»“æœã€‚</p><h3 id="Futureæ¨¡å‹"><a href="#Futureæ¨¡å‹" class="headerlink" title="Futureæ¨¡å‹"></a>Futureæ¨¡å‹</h3><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ<code>JDK1.5</code> å¼•å…¥äº† <code>Future</code> å’Œ <code>Callable</code> æ¥å£ï¼Œæˆ‘ä»¬åªéœ€è¦å°†åˆ›å»ºçš„ä»»åŠ¡ <code>submit</code> åˆ°çº¿ç¨‹æ± ï¼Œä¹‹åæˆ‘ä»¬å¯ä»¥æ‰§è¡Œå…¶ä»–ä¸šåŠ¡é€»è¾‘ï¼Œæ ¹æ®éœ€è¦å†é€šè¿‡ <code>java.util.concurrent.Future#get()</code> æ–¹æ³•å°±èƒ½å¤Ÿå¾—åˆ°ä»»åŠ¡æ‰§è¡Œçš„è¿”å›å€¼ï¼ŒèŠ‚çº¦ç¨‹åºçš„è¿è¡Œæ—¶é—´ã€‚</p><p>é€šè¿‡ä¸€ä¸ªä¾‹å­å¿«é€Ÿäº†è§£ <code>Future</code> æ¨¡å‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨Executorsåˆ›å»ºçº¿ç¨‹æ± </span><br>    <span class="hljs-comment">// å®é™…é¡¹ç›®ä¸­ï¼Œä¸æ¨èä½¿ç”¨Executorsåˆ›å»ºçº¿ç¨‹æ± ï¼Œå…¶å†…éƒ¨ä½¿ç”¨çš„æ˜¯æ— ç•Œé˜Ÿåˆ—ï¼Œå®¹æ˜“é€ æˆOOM</span><br>    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br>    <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    <br>    Future&lt;String&gt; future1 = executorService.submit(() -&gt; &#123;<br>        <span class="hljs-comment">// æ¨¡æ‹Ÿä»»åŠ¡1æ‰§è¡Œè€—æ—¶</span><br>        Thread.sleep(<span class="hljs-number">300</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ä»»åŠ¡1æ‰§è¡Œå®Œæˆ&quot;</span>;<br>    &#125;);<br>    <br>    Future&lt;String&gt; future2 = executorService.submit(() -&gt; &#123;<br>        <span class="hljs-comment">// æ¨¡æ‹Ÿä»»åŠ¡2æ‰§è¡Œè€—æ—¶</span><br>        Thread.sleep(<span class="hljs-number">500</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ä»»åŠ¡2æ‰§è¡Œå®Œæˆ&quot;</span>;<br>    &#125;);<br>    <br>    <span class="hljs-comment">// æ¨¡æ‹Ÿä¸»çº¿ç¨‹å¤„ç†å…¶ä»–ä¸šåŠ¡è€—æ—¶</span><br>    Thread.sleep(<span class="hljs-number">300</span>);<br>    <br>    <span class="hljs-comment">// è·å–ä»»åŠ¡1æ‰§è¡Œç»“æœ</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">result1</span> <span class="hljs-operator">=</span> future1.get();<br>    System.out.println(result1);<br>    <br>    <span class="hljs-comment">// è·å–ä»»åŠ¡2æ‰§è¡Œç»“æœ</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">result2</span> <span class="hljs-operator">=</span> future2.get();<br>    System.out.println(result2);<br>    <br>    <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    System.out.println(<span class="hljs-string">&quot;æ€»è€—æ—¶ï¼š&quot;</span> + (end - start) + <span class="hljs-string">&quot;ms&quot;</span>);<br>    <br>    executorService.shutdown();<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tex">ä»»åŠ¡1æ‰§è¡Œå®Œæˆ<br>ä»»åŠ¡2æ‰§è¡Œå®Œæˆ<br>æ€»è€—æ—¶ï¼š564ms<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œåˆç†ä½¿ç”¨å¼‚æ­¥ä»»åŠ¡å¯ä»¥å¤§å¤§æé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚</p><h3 id="Futureçš„å±€é™æ€§"><a href="#Futureçš„å±€é™æ€§" class="headerlink" title="Futureçš„å±€é™æ€§"></a>Futureçš„å±€é™æ€§</h3><p>ä»ä¸Šé¢å®ä¾‹çš„è¾“å‡ºæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨ <code>java.util.concurrent.Future#get()</code> æ–¹æ³•ä¼šä¸€ç›´é˜»å¡ä¸»çº¿ç¨‹ã€‚</p><p>ç®€å•ä¸šåŠ¡ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>Future</code> çš„å¦ä¸€ä¸ªé‡è½½æ–¹æ³• <code>get(long, TimeUnit)</code> æ¥è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œé¿å…ä¸»çº¿ç¨‹è¢«æ°¸è¿œé˜»å¡ã€‚</p><p><code>get()</code> æ–¹æ³•åŸæ–‡æè¿°ï¼š</p><blockquote><p>Waits if necessary for the computation to complete, and then retrieves its result.</p></blockquote><p>å½“ç„¶ <code>Future</code> è¿˜è´´å¿ƒçš„æä¾›äº†ä¸€ä¸ª <code>isDone()</code> æ–¹æ³•ï¼Œå¯ä»¥åœ¨ç¨‹åºä¸­<strong>è½®è¯¢</strong>è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œç­‰å¾…å¤„ç†å®Œæˆåå†è°ƒç”¨ <code>get()</code> æ–¹æ³•è·å–è¿”å›å€¼ã€‚</p><p>æ³¨æ„ï¼å¦‚æœä»»åŠ¡å®Œæˆï¼Œè°ƒç”¨ <code>isDone()</code> æ–¹æ³•å°†è¿”å› <code>true</code> ï¼Œ<strong>ä½†å®Œæˆå¯èƒ½æ˜¯ç”±äºæ­£å¸¸ç»ˆæ­¢ã€å¼‚å¸¸æˆ–å–æ¶ˆâ€”â€”åœ¨æ‰€æœ‰è¿™äº›æƒ…å†µä¸‹ï¼Œæ­¤æ–¹æ³•éƒ½å°†è¿”å›true</strong>ã€‚</p><p>è€Œå¯¹äº <code>JDK8</code> ä¸­çš„ <code>isDone()</code> æ–¹æ³•è¿˜å­˜åœ¨è¿™æ ·ä¸€ä¸ª <code>BUG</code>ï¼Œç›®å‰å·²åœ¨ <code>JDK9</code> ä¿®å¤ï¼Œå¤§å®¶æ„Ÿå…´è¶£å¯ä»¥å»çœ‹çœ‹ã€‚<a href="https://bugs.openjdk.org/browse/JDK-8073704">JDK-8073704</a></p><p><code>isDone()</code> æ–¹æ³•åŸæ–‡æè¿°ï¼š</p><blockquote><p>Returns true if this task completed. Completion may be due to normal termination, an exception, or cancellation â€“ in all of these cases, this method will return true.</p></blockquote><p>ä½†æ— è®ºæ˜¯å“ªç§æ–¹æ³•ï¼Œ<code>Future</code> å¯¹äºå¤„ç†ç»“æœçš„è·å–ä¼¼ä¹éƒ½æ˜¾å¾—ä¸å¤Ÿå‹å¥½ã€‚</p><p><strong>é˜»å¡çš„æ–¹å¼å’Œå¼‚æ­¥ç¼–ç¨‹çš„è®¾è®¡ç†å¿µç›¸è¿èƒŒï¼Œè€Œè½®è¯¢çš„æ–¹å¼åˆä¼šæ— è°“çš„è€—è´¹CPUèµ„æº</strong>ã€‚</p><p>é‚£ä¹ˆ~ å°±åªèƒ½åˆ°æ­¤ä¸ºæ­¢äº†å—ï¼Ÿ</p><p>å½“ç„¶ä¸æ˜¯ï¼Œ<code>Doug Lea</code> å¤§ç¥åœ¨ <code>JDK8</code> åˆç»™æˆ‘ä»¬å¸¦æ¥äº†å¹¶å‘ç¼–ç¨‹ç¥å™¨â€”â€” <code>CompletableFuture</code> ã€‚</p><h3 id="CompletableFuture"><a href="#CompletableFuture" class="headerlink" title="CompletableFuture"></a>CompletableFuture</h3><p><code>JAVA8</code> å¼•å…¥çš„ <code>CompletableFuture</code>  è§£å†³äº† <code>Future</code> åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸æ”¯æŒå¼‚æ­¥ä»»åŠ¡çš„ç¼–æ’ç»„åˆä»¥åŠé˜»å¡è·å–ä»»åŠ¡è¿”å›å€¼çš„é—®é¢˜ã€‚</p><p>é™¤äº†æä¾›æ›´ä¸ºå¥½ç”¨çš„ <code>Future</code> ç‰¹æ€§ä¹‹å¤–ï¼Œ<code>CompletableFuture</code> è¿˜æä¾›äº†å‡½æ•°å¼ç¼–ç¨‹ã€å¼‚æ­¥ä»»åŠ¡ç¼–æ’ç»„åˆï¼ˆå¯ä»¥å°†å¤šä¸ªå¼‚æ­¥ä»»åŠ¡ä¸²è”èµ·æ¥ï¼Œç»„æˆä¸€ä¸ªå®Œæ•´çš„é“¾å¼è°ƒç”¨ï¼‰ç­‰èƒ½åŠ›ã€‚</p><p><code>CompletableFuture</code> ç±»ç»“æ„ç¤ºæ„å›¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CompletableFuture</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Future</span>&lt;T&gt;, CompletionStage&lt;T&gt; &#123;&#125;<br></code></pre></td></tr></table></figure><p><img src="https://image.seeyourface.cn/migrate/image-20231013170446028.png" alt="image-20231013170446028"></p><p><code>CompletableFuture</code> åŒæ—¶å®ç°äº† <code>Future</code> å’Œ <code>CompletionStage</code> æ¥å£:</p><p><code>CompletionStage</code> æ¥å£æè¿°äº†ä¸€ä¸ªå¼‚æ­¥è®¡ç®—çš„é˜¶æ®µã€‚å¤šä¸ªè®¡ç®—å¯ä»¥åˆ†æˆå¤šä¸ªé˜¶æ®µæˆ–æ­¥éª¤ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡å®ƒå°†æ‰€æœ‰æ­¥éª¤ç»„åˆèµ·æ¥ï¼Œå½¢æˆå¼‚æ­¥è®¡ç®—çš„æµæ°´çº¿ã€‚</p><p><code>CompletableFuture</code> é€šè¿‡ç»§æ‰¿ <code>CompletionStage</code> è·å–å…¶æä¾›çš„å‡½æ•°å¼èƒ½åŠ›ã€‚ä»è¿™ä¸ªæ¥å£çš„æ–¹æ³•å‚æ•°å¯ä»¥å‘ç°å…¶å¤§é‡ä½¿ç”¨äº† <code>Java8</code> å¼•å…¥çš„å‡½æ•°å¼ç¼–ç¨‹ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20231013171231135.png" alt="image-20231013171231135"></p><h3 id="CompletableFutureä½¿ç”¨"><a href="#CompletableFutureä½¿ç”¨" class="headerlink" title="CompletableFutureä½¿ç”¨"></a>CompletableFutureä½¿ç”¨</h3><h4 id="å®ä¾‹åŒ–"><a href="#å®ä¾‹åŒ–" class="headerlink" title="å®ä¾‹åŒ–"></a>å®ä¾‹åŒ–</h4><p>æœ‰ä¸¤ç§å¸¸è§çš„åˆ›å»º <code>CompletableFuture</code> å¯¹è±¡çš„æ–¹æ³•ï¼š</p><ol><li>é€šè¿‡ <code>new</code> å…³é”®å­—ã€‚</li><li>åŸºäº <code>CompletableFuture</code> è‡ªå¸¦çš„é™æ€å·¥å‚æ–¹æ³•ï¼š<code>runAsync()</code>ã€<code>supplyAsync()</code> ã€‚</li></ol><h5 id="new-å…³é”®å­—"><a href="#new-å…³é”®å­—" class="headerlink" title="new å…³é”®å­—"></a>new å…³é”®å­—</h5><p>é€šè¿‡ <code>new</code> å…³é”®å­—åˆ›å»º <code>CompletableFuture</code> å¯¹è±¡è¿™ç§ä½¿ç”¨æ–¹å¼å¯ä»¥çœ‹ä½œæ˜¯å°† <code>CompletableFuture</code> å½“åš <code>Future</code> æ¥ä½¿ç”¨ã€‚</p><p>ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// å¯ä»¥å°†completableFutureçœ‹æˆæ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œé‡Œé¢å­˜æ”¾å¼‚æ­¥è¿ç®—çš„è¿”å›ç»“æœ</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> CompletableFuture&lt;String&gt; completableFuture = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFuture</span>&lt;&gt;();<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">2</span>);<br>    <br>    <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    <br>    executorService.execute(() -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">600</span>);<br>            <span class="hljs-comment">// åœ¨æœªæ¥æŸä¸ªæ—¶åˆ»ï¼Œçº¿ç¨‹å¤„ç†å®Œäº†æœ€ç»ˆçš„ç»“æœï¼Œå°†ç»“æœæ”¾å…¥completableFuture</span><br>            completableFuture.complete(<span class="hljs-string">&quot;i am ready&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException ignore) &#123;<br>        &#125;<br>    &#125;);<br>    <br>    executorService.execute(() -&gt; &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// é€šè¿‡completableFutureçš„isDoneæ–¹æ³•åˆ¤æ–­å¼‚æ­¥è¿ç®—æ˜¯å¦ç»“æŸ</span><br>                <span class="hljs-keyword">if</span> (completableFuture.isDone()) &#123;<br>                    <span class="hljs-comment">// ä»completableFutureä¸­è·å–å¼‚æ­¥è¿ç®—çš„ç»“æœ</span><br>                    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> completableFuture.get();<br>                    System.out.println(result);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                Thread.sleep(<span class="hljs-number">100</span>);<br>                System.out.println(<span class="hljs-string">&quot;wait&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>        &#125;<br>    &#125;);<br>    <br>    <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    System.out.println(<span class="hljs-string">&quot;è€—æ—¶ï¼š&quot;</span> + (end - start));<br>    <br>    executorService.shutdown();<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs tex">è€—æ—¶ï¼š41<br>wait<br>wait<br>wait<br>wait<br>wait<br>wait<br>i am ready<br></code></pre></td></tr></table></figure><h5 id="é™æ€å·¥å‚æ–¹æ³•"><a href="#é™æ€å·¥å‚æ–¹æ³•" class="headerlink" title="é™æ€å·¥å‚æ–¹æ³•"></a>é™æ€å·¥å‚æ–¹æ³•</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">runAsync</span><span class="hljs-params">(Runnable runnable)</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="hljs-title function_">supplyAsync</span><span class="hljs-params">(Supplier&lt;U&gt; supplier)</span>;<br><br><span class="hljs-comment">// æ¨èä½¿ç”¨ä¸‹é¢è‡ªå®šä¹‰çº¿ç¨‹æ± çš„æ–¹å¼</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">runAsync</span><span class="hljs-params">(Runnable runnable,Executor executor)</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="hljs-title function_">supplyAsync</span><span class="hljs-params">(Supplier&lt;U&gt; supplier,Executor executor)</span>;<br></code></pre></td></tr></table></figure><p>é™æ€å·¥å‚å®ä¾‹åŒ–æœ‰ä¸¤ç§æ ¼å¼ï¼Œä¸€ç§æ˜¯supplyå¼€å¤´çš„æ–¹æ³•ï¼Œä¸€ç§æ˜¯runå¼€å¤´çš„æ–¹æ³•ï¼š</p><ul><li>supplyå¼€å¤´ï¼šæ–¹æ³•æ¥æ”¶çš„å‚æ•°æ˜¯ <code>Supplier&lt;U&gt;</code> ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œ<code>U</code> æ˜¯è¿”å›ç»“æœå€¼çš„ç±»å‹ã€‚å½“ä½ éœ€è¦å¼‚æ­¥æ“ä½œä¸”å…³å¿ƒè¿”å›ç»“æœçš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ <code>supplyAsync()</code> æ–¹æ³•ã€‚</li><li>runå¼€å¤´ï¼šæ–¹æ³•æ¥æ”¶çš„å‚æ•°æ˜¯ <code>Runnable</code> ï¼Œè¿™æ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œä¸å…è®¸è¿”å›å€¼ã€‚å½“ä½ éœ€è¦å¼‚æ­¥æ“ä½œä¸”ä¸å…³å¿ƒè¿”å›ç»“æœçš„æ—¶å€™å¯ä»¥ä½¿ç”¨ <code>runAsync()</code> æ–¹æ³•ã€‚</li></ul><blockquote><p>åœ¨é™æ€å·¥å‚å®ä¾‹åŒ–æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥æŒ‡å®šExecutorå‚æ•°çš„ï¼Œå½“æˆ‘ä»¬ä¸æŒ‡å®šçš„è¯ï¼Œæˆ‘ä»¬æ‰€å¼€çš„å¹¶è¡Œçº¿ç¨‹ä½¿ç”¨çš„æ˜¯é»˜è®¤ç³»ç»ŸåŠå…¬å…±çº¿ç¨‹æ±  <code>ForkJoinPool.commonPool()</code> ï¼Œå®ƒæ˜¯è¢«å½“å‰  <code>JVM</code>ï¼ˆè¿›ç¨‹ï¼‰ä¸Šçš„æ‰€æœ‰ <code>CompletableFuture</code>ã€å¹¶è¡Œ <code>Stream</code> æ‰€å…±äº«çš„ï¼Œ<code>commonPool</code>  çš„ç›®æ ‡åœºæ™¯æ˜¯éé˜»å¡çš„ CPU å¯†é›†å‹ä»»åŠ¡ï¼Œå…¶çº¿ç¨‹æ•°é»˜è®¤ä¸º CPU æ•°é‡å‡1ï¼Œæ‰€ä»¥å¯¹äºæˆ‘ä»¬ç”¨ <code>java</code> å¸¸åšçš„IOå¯†é›†å‹ä»»åŠ¡ï¼Œé»˜è®¤çº¿ç¨‹æ± æ˜¯è¿œè¿œä¸å¤Ÿä½¿ç”¨çš„ï¼›</p><p>åœ¨åŒæ ¸åŠä»¥ä¸‹æœºå™¨ä¸Šï¼Œé»˜è®¤çº¿ç¨‹æ± åˆä¼š<strong>é€€åŒ–</strong>ä¸ºç»™æ¯ä¸ªä»»åŠ¡åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œç›¸å½“äºæ²¡æœ‰çº¿ç¨‹æ± ã€‚</p></blockquote><h4 id="å¼‚æ­¥ä»»åŠ¡å›è°ƒ"><a href="#å¼‚æ­¥ä»»åŠ¡å›è°ƒ" class="headerlink" title="å¼‚æ­¥ä»»åŠ¡å›è°ƒ"></a>å¼‚æ­¥ä»»åŠ¡å›è°ƒ</h4><h5 id="thenRun-thenRunAsync"><a href="#thenRun-thenRunAsync" class="headerlink" title="thenRun()&#x2F;thenRunAsync()"></a>thenRun()&#x2F;thenRunAsync()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ç»§ç»­æ²¿ç”¨ä¸Šä¸€ä¸ªä»»åŠ¡çš„çº¿ç¨‹æ± </span><br><span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">thenRun</span><span class="hljs-params">(Runnable action)</span> &#123;<br><span class="hljs-keyword">return</span> uniRunStage(<span class="hljs-literal">null</span>, action);<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨é»˜è®¤çº¿ç¨‹æ±  ForkJoinPool.commonPool()</span><br><span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">thenRunAsync</span><span class="hljs-params">(Runnable action)</span> &#123;<br>    <span class="hljs-keyword">return</span> uniRunStage(asyncPool, action);<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± </span><br><span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">thenRunAsync</span><span class="hljs-params">(Runnable action, Executor executor)</span> &#123;<br>    <span class="hljs-keyword">return</span> uniRunStage(screenExecutor(executor), action);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥æ”¶ä¸€ä¸ª <code>Runnable</code> å‚æ•°ï¼Œå³å®ŒæˆæŸä¸ªä»»åŠ¡åæ‰§è¡Œå›è°ƒæ–¹æ³•æ¥ç€æ‰§è¡Œç¬¬äºŒä¸ªä»»åŠ¡ï¼Œå‰åä»»åŠ¡ä¹‹é—´æ²¡æœ‰å‚æ•°ä¼ é€’ï¼Œç¬¬äºŒä¸ªä»»åŠ¡ä¹Ÿæ²¡æœ‰è¿”å›å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">3</span>);<br><br>CompletableFuture&lt;Void&gt; future1 = CompletableFuture.runAsync(() -&gt; <br>        System.out.printf(<span class="hljs-string">&quot;%s-æ‰§è¡Œç¬¬ä¸€ä¸ªæ–¹æ³•%n&quot;</span>, Thread.currentThread().getName()), executorService);<br><br><span class="hljs-comment">// æ²¿ç”¨ä¸Šä¸€ä¸ªä»»åŠ¡çš„çº¿ç¨‹æ± </span><br> CompletableFuture&lt;Void&gt; future2 = future1.thenRun(() -&gt; <br>         System.out.printf(<span class="hljs-string">&quot;%s-æ‰§è¡Œç¬¬äºŒä¸ªæ–¹æ³•%n&quot;</span>, Thread.currentThread().getName()));<br><span class="hljs-comment">// è¾“å‡º</span><br><span class="hljs-comment">// pool-1-thread-1-æ‰§è¡Œç¬¬ä¸€ä¸ªæ–¹æ³•</span><br><span class="hljs-comment">// pool-1-thread-1-æ‰§è¡Œç¬¬äºŒä¸ªæ–¹æ³•</span><br><br><span class="hljs-comment">// ä½¿ç”¨é»˜è®¤çš„çº¿ç¨‹æ± </span><br><span class="hljs-comment">//CompletableFuture&lt;Void&gt; future2 = future1.thenRunAsync(() -&gt;</span><br><span class="hljs-comment">//  System.out.printf(&quot;%s-æ‰§è¡Œç¬¬äºŒä¸ªæ–¹æ³•%n&quot;, Thread.currentThread().getName()));</span><br><span class="hljs-comment">// è¾“å‡º</span><br><span class="hljs-comment">// pool-1-thread-1-æ‰§è¡Œç¬¬ä¸€ä¸ªæ–¹æ³•</span><br><span class="hljs-comment">// ForkJoinPool.commonPool-worker-9-æ‰§è¡Œç¬¬äºŒä¸ªæ–¹æ³•</span><br><br><span class="hljs-comment">//ExecutorService executorService2 = Executors.newFixedThreadPool(3);</span><br><span class="hljs-comment">// ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± </span><br><span class="hljs-comment">//CompletableFuture&lt;Void&gt; future2 = future1.thenRunAsync(() -&gt;</span><br><span class="hljs-comment">//        System.out.printf(&quot;%s-æ‰§è¡Œç¬¬äºŒä¸ªæ–¹æ³•%n&quot;, Thread.currentThread().getName()), executorService2)</span><br><span class="hljs-comment">// è¾“å‡º</span><br><span class="hljs-comment">// pool-1-thread-1-æ‰§è¡Œç¬¬ä¸€ä¸ªæ–¹æ³•</span><br><span class="hljs-comment">// pool-2-thread-1-æ‰§è¡Œç¬¬äºŒä¸ªæ–¹æ³•</span><br><br>executorService.shutdown();<br></code></pre></td></tr></table></figure><h5 id="thenAccept-thenAcceptAsync"><a href="#thenAccept-thenAcceptAsync" class="headerlink" title="thenAccept()&#x2F;thenAcceptAsync()"></a>thenAccept()&#x2F;thenAcceptAsync()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">thenAccept</span><span class="hljs-params">(Consumer&lt;? <span class="hljs-built_in">super</span> T&gt; action)</span> &#123;<br>    <span class="hljs-keyword">return</span> uniAcceptStage(<span class="hljs-literal">null</span>, action);<br>&#125;<br><br><span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">thenAcceptAsync</span><span class="hljs-params">(Consumer&lt;? <span class="hljs-built_in">super</span> T&gt; action)</span> &#123;<br>    <span class="hljs-keyword">return</span> uniAcceptStage(asyncPool, action);<br>&#125;<br><br><span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">thenAcceptAsync</span><span class="hljs-params">(Consumer&lt;? <span class="hljs-built_in">super</span> T&gt; action,</span><br><span class="hljs-params">                                               Executor executor)</span> &#123;<br>    <span class="hljs-keyword">return</span> uniAcceptStage(screenExecutor(executor), action);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>Consumer&lt;? super T&gt; action</code> è¡¨ç¤ºå…¶å¯ä»¥æ¥å— <code>T</code> ç±»å‹æˆ– <code>T</code> çš„è¶…ç±»å‹çš„å‚æ•°ã€‚è¿™æ˜¯ä¸ºäº†æé«˜é€šç”¨æ€§ï¼Œå…è®¸ä½ ä¼ é€’æ›´å¹¿æ³›çš„ç±»å‹ä½œä¸ºå‚æ•°ã€‚å¹¶ä¸”å›è°ƒæ–¹æ³•æ‰§è¡Œå®Œæ¯•åæ²¡æœ‰è¿”å›å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">3</span>);<br><br>CompletableFuture&lt;Integer&gt; future1 = CompletableFuture.supplyAsync(() -&gt; <span class="hljs-number">1</span>, executorService);<br><br><span class="hljs-comment">// future1çš„è¿”å›å€¼æ˜¯ Integerï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ä¼ å…¥å®ƒçš„è¶…ç±»Number</span><br>future1.thenAccept((Number n) -&gt; System.out.println(n.doubleValue() + <span class="hljs-number">10</span>)); <span class="hljs-comment">// 11.0</span><br><br>executorService.shutdown();<br></code></pre></td></tr></table></figure><h5 id="thenApply-thenApplyAsync"><a href="#thenApply-thenApplyAsync" class="headerlink" title="thenApply()&#x2F;thenApplyAsync()"></a>thenApply()&#x2F;thenApplyAsync()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="hljs-title function_">thenApply</span><span class="hljs-params">(</span><br><span class="hljs-params">    Function&lt;? <span class="hljs-built_in">super</span> T,? extends U&gt; fn)</span> &#123;<br>    <span class="hljs-keyword">return</span> uniApplyStage(<span class="hljs-literal">null</span>, fn);<br>&#125;<br><br><span class="hljs-keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="hljs-title function_">thenApplyAsync</span><span class="hljs-params">(</span><br><span class="hljs-params">    Function&lt;? <span class="hljs-built_in">super</span> T,? extends U&gt; fn)</span> &#123;<br>    <span class="hljs-keyword">return</span> uniApplyStage(asyncPool, fn);<br>&#125;<br><br><span class="hljs-keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="hljs-title function_">thenApplyAsync</span><span class="hljs-params">(</span><br><span class="hljs-params">    Function&lt;? <span class="hljs-built_in">super</span> T,? extends U&gt; fn, Executor executor)</span> &#123;<br>    <span class="hljs-keyword">return</span> uniApplyStage(screenExecutor(executor), fn);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥æ”¶ä¸€ä¸ªå…¥å‚ä¸º <code>Function&lt;? super T,? extends U&gt;</code> çš„å‡½æ•°å¼æ¥å£å‚æ•°ï¼Œä¹Ÿå°±æ˜¯å°†ä¸Šä¸€ä¸ª <code>Future</code> çš„è¿”å›å€¼å½“ä½œä¸‹ä¸€ä¸ªæ–¹æ³•çš„å…¥å‚ä¼ å…¥ï¼Œå¹¶ä¸”å›è°ƒæ–¹æ³•å†…å¯ä»¥<strong>è‡ªå®šä¹‰</strong>è¿”å›å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">3</span>);<br><br>CompletableFuture&lt;String&gt; future1 = CompletableFuture.supplyAsync(() -&gt; <span class="hljs-string">&quot;Hello&quot;</span>, executorService);<br><br>CompletableFuture&lt;Boolean&gt; future2 = future1.thenApply((str) -&gt; &#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> str + <span class="hljs-string">&quot; World&quot;</span>;<br>    <span class="hljs-keyword">return</span> s.equals(<span class="hljs-string">&quot;Hello World&quot;</span>);<br>&#125;);<br><br>System.out.println(future2.get()); <span class="hljs-comment">// ture</span><br><br>executorService.shutdown();<br></code></pre></td></tr></table></figure><h5 id="whenComplete-whenCompleteAsync"><a href="#whenComplete-whenCompleteAsync" class="headerlink" title="whenComplete()&#x2F;whenCompleteAsync()"></a>whenComplete()&#x2F;whenCompleteAsync()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> CompletableFuture&lt;T&gt; <span class="hljs-title function_">whenComplete</span><span class="hljs-params">(</span><br><span class="hljs-params">    BiConsumer&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-built_in">super</span> Throwable&gt; action)</span> &#123;<br>    <span class="hljs-keyword">return</span> uniWhenCompleteStage(<span class="hljs-literal">null</span>, action);<br>&#125;<br><br><span class="hljs-keyword">public</span> CompletableFuture&lt;T&gt; <span class="hljs-title function_">whenCompleteAsync</span><span class="hljs-params">(</span><br><span class="hljs-params">    BiConsumer&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-built_in">super</span> Throwable&gt; action)</span> &#123;<br>    <span class="hljs-keyword">return</span> uniWhenCompleteStage(asyncPool, action);<br>&#125;<br><br><span class="hljs-keyword">public</span> CompletableFuture&lt;T&gt; <span class="hljs-title function_">whenCompleteAsync</span><span class="hljs-params">(</span><br><span class="hljs-params">    BiConsumer&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-built_in">super</span> Throwable&gt; action, Executor executor)</span> &#123;<br>    <span class="hljs-keyword">return</span> uniWhenCompleteStage(screenExecutor(executor), action);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•æ¥æ”¶çš„å‚æ•°ä¸º <code>BiConsumer&lt;? super T, ? super Throwable&gt;</code> ï¼Œå®ƒæ¥å— <code>T</code> ç±»å‹æˆ– <code>T</code> çš„è¶…ç±»å‹çš„å‚æ•°ï¼Œä»¥åŠä¸Šä¸ªæ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•å¹¶<strong>æ²¡æœ‰è¿”å›</strong>å€¼ï¼Œ<code>whenComplete</code> æ–¹æ³•è¿”å›çš„ <code>CompletableFuture</code> çš„<strong>resultæ˜¯ä¸Šä¸ªä»»åŠ¡çš„ç»“æœ</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">3</span>);<br><br>CompletableFuture&lt;String&gt; future1 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    <span class="hljs-comment">// æ‰‹åŠ¨æŠ›å‡ºå¼‚å¸¸</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello world&quot;</span>;<br>&#125;, executorService);<br><br>CompletableFuture&lt;String&gt; future2 = future1.whenComplete((res, ex) -&gt; &#123;<br>   <span class="hljs-keyword">if</span> (ex != <span class="hljs-literal">null</span>) &#123;<br>       System.out.println(ex.getMessage());<br>       <span class="hljs-comment">// java.lang.ArithmeticException: / by zero</span><br>   &#125;<br>&#125;);<br><br><span class="hljs-comment">// å¦‚æœæˆ‘ä»¬æŠŠæ‰‹åŠ¨æŠ›å‡ºçš„å¼‚å¸¸æ³¨é‡Šæ‰ï¼Œè¿™é‡Œçš„è¾“å‡ºå°†æ˜¯ï¼šfuture2çš„ç»“æœhello world</span><br>System.out.println(<span class="hljs-string">&quot;future2çš„ç»“æœ&quot;</span> + future2.get());<br><br>executorService.shutdown();<br></code></pre></td></tr></table></figure><h5 id="handle-handleAsync"><a href="#handle-handleAsync" class="headerlink" title="handle()&#x2F;handleAsync()"></a>handle()&#x2F;handleAsync()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="hljs-title function_">handle</span><span class="hljs-params">(</span><br><span class="hljs-params">    BiFunction&lt;? <span class="hljs-built_in">super</span> T, Throwable, ? extends U&gt; fn)</span> &#123;<br>    <span class="hljs-keyword">return</span> uniHandleStage(<span class="hljs-literal">null</span>, fn);<br>&#125;<br><br><span class="hljs-keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="hljs-title function_">handleAsync</span><span class="hljs-params">(</span><br><span class="hljs-params">    BiFunction&lt;? <span class="hljs-built_in">super</span> T, Throwable, ? extends U&gt; fn)</span> &#123;<br>    <span class="hljs-keyword">return</span> uniHandleStage(asyncPool, fn);<br>&#125;<br><br><span class="hljs-keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="hljs-title function_">handleAsync</span><span class="hljs-params">(</span><br><span class="hljs-params">    BiFunction&lt;? <span class="hljs-built_in">super</span> T, Throwable, ? extends U&gt; fn, Executor executor)</span> &#123;<br>    <span class="hljs-keyword">return</span> uniHandleStage(screenExecutor(executor), fn);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>handle()</code> æ–¹æ³•å’Œ <code>whenComplete()</code> æ–¹æ³•çš„æ¥æ”¶å…¥å‚æ²¡æœ‰åŒºåˆ«ï¼Œä½†ä¸åŒçš„åœ°æ–¹åœ¨äº <code>handle()</code> æ–¹æ³•æ˜¯<strong>æœ‰è¿”å›å€¼</strong>çš„ï¼Œå¹¶ä¸”æ˜¯å¯ä»¥è‡ªå®šä¹‰è¿”å›å€¼çš„ã€‚</p><p><code>handle(</code>) æ–¹æ³•è¿”å›çš„ <code>CompletableFuture</code> çš„ <code>result</code> æ˜¯<strong>å›è°ƒæ–¹æ³•</strong>æ‰§è¡Œçš„ç»“æœã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">3</span>);<br><br>CompletableFuture&lt;String&gt; future1 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;future1 result&quot;</span>;<br>&#125;, executorService);<br><br>CompletableFuture&lt;String&gt; future2 = future1.handle((res, ex) -&gt; &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;future2 result&quot;</span>;<br>&#125;);<br><br>System.out.println(<span class="hljs-string">&quot;future2çš„ç»“æœ&quot;</span> + future2.get()); <span class="hljs-comment">// future2çš„ç»“æœfuture2 result</span><br><br>executorService.shutdown();<br></code></pre></td></tr></table></figure><h5 id="exceptionally"><a href="#exceptionally" class="headerlink" title="exceptionally()"></a>exceptionally()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> CompletableFuture&lt;T&gt; <span class="hljs-title function_">exceptionally</span><span class="hljs-params">(</span><br><span class="hljs-params">    Function&lt;Throwable, ? extends T&gt; fn)</span> &#123;<br>    <span class="hljs-keyword">return</span> uniExceptionallyStage(fn);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¤„ç†ä»»åŠ¡å¼‚å¸¸æ—¶æ‰§è¡Œçš„å›è°ƒæ–¹æ³•ï¼Œç”±æŠ›å‡ºçš„å¼‚å¸¸ä½œä¸ºæ–¹æ³•å…¥å‚ï¼Œæœ‰è¿”å›å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">3</span>);<br><br>CompletableFuture&lt;String&gt; future1 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>/<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;future1 result&quot;</span>;<br>&#125;, executorService);<br><br> CompletableFuture&lt;String&gt; exceptionally = future1.exceptionally((ex) -&gt; &#123;<br>    <span class="hljs-keyword">if</span> (ex != <span class="hljs-literal">null</span>) &#123;<br>        System.out.println(ex.getMessage());<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ç¨‹åºå‡ºç°å¼‚å¸¸&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ç¨‹åºæ­£å¸¸è¿è¡Œ&quot;</span>;<br>&#125;);<br><br>System.out.println(exceptionally.get());<span class="hljs-comment">// ç¨‹åºå‡ºç°å¼‚å¸¸</span><br><br>executorService.shutdown();<br></code></pre></td></tr></table></figure><h4 id="å¼‚æ­¥ä»»åŠ¡ç»„åˆ"><a href="#å¼‚æ­¥ä»»åŠ¡ç»„åˆ" class="headerlink" title="å¼‚æ­¥ä»»åŠ¡ç»„åˆ"></a>å¼‚æ­¥ä»»åŠ¡ç»„åˆ</h4><h5 id="æ€»è§ˆ"><a href="#æ€»è§ˆ" class="headerlink" title="æ€»è§ˆ"></a>æ€»è§ˆ</h5><p><img src="https://image.seeyourface.cn/migrate/Completable%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E7%BB%84%E5%90%88.png" alt="Completableå¼‚æ­¥ä»»åŠ¡ç»„åˆ"></p><h5 id="ANDç»„åˆå…³ç³»"><a href="#ANDç»„åˆå…³ç³»" class="headerlink" title="ANDç»„åˆå…³ç³»"></a>ANDç»„åˆå…³ç³»</h5><p><code>thenCombine</code> &#x2F; <code>thenAcceptBoth</code> &#x2F; <code>runAfterBoth</code>éƒ½è¡¨ç¤ºï¼š<strong>å°†ä¸¤ä¸ª <code>CompletableFuture</code> ç»„åˆèµ·æ¥ï¼Œåªæœ‰è¿™ä¸¤ä¸ªéƒ½æ­£å¸¸æ‰§è¡Œå®Œäº†ï¼Œæ‰ä¼šæ‰§è¡ŒæŸä¸ªä»»åŠ¡</strong>ã€‚</p><p>å®ƒä»¬ä¹‹é—´çš„åŒºåˆ«åœ¨äºï¼š</p><ul><li><code>thenCombine</code>ï¼šä¼šå°†ä¸¤ä¸ªä»»åŠ¡çš„æ‰§è¡Œç»“æœä½œä¸ºæ–¹æ³•å…¥å‚ï¼Œä¼ é€’åˆ°æŒ‡å®šæ–¹æ³•ä¸­ï¼Œä¸”<strong>æœ‰è¿”å›å€¼</strong>ã€‚</li><li><code>thenAcceptBoth</code>: ä¼šå°†ä¸¤ä¸ªä»»åŠ¡çš„æ‰§è¡Œç»“æœä½œä¸ºæ–¹æ³•å…¥å‚ï¼Œä¼ é€’åˆ°æŒ‡å®šæ–¹æ³•ä¸­ï¼Œä¸”<strong>æ— è¿”å›å€¼</strong>ã€‚</li><li><code>runAfterBoth</code> ä¸ä¼šæŠŠæ‰§è¡Œç»“æœå½“åšæ–¹æ³•å…¥å‚ï¼Œä¸”æ²¡æœ‰è¿”å›å€¼ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">CompletableFuture&lt;Integer&gt; future1 = CompletableFuture.supplyAsync(() -&gt; <span class="hljs-number">5</span>);<br>CompletableFuture&lt;Integer&gt; future2 = CompletableFuture.supplyAsync(() -&gt; <span class="hljs-number">7</span>);<br><br><span class="hljs-comment">// result1 æ˜¯ future1 çš„ç»“æœï¼Œresult2 æ˜¯ future2 çš„ç»“æœ</span><br>CompletableFuture&lt;Integer&gt; combinedFuture = future1.thenCombine(future2, Integer::sum);<br><br>combinedFuture.thenAccept(result -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;Combined Result: &quot;</span> + result);<br>&#125;);<br><br><span class="hljs-comment">// é˜»å¡ç­‰å¾…ç»“æœ</span><br>combinedFuture.join(); <span class="hljs-comment">// Combined Result: 12</span><br></code></pre></td></tr></table></figure><h5 id="ORç»„åˆå…³ç³»"><a href="#ORç»„åˆå…³ç³»" class="headerlink" title="ORç»„åˆå…³ç³»"></a>ORç»„åˆå…³ç³»</h5><p><code>applyToEither</code> &#x2F; <code>acceptEither</code> &#x2F; <code>runAfterEither</code> éƒ½è¡¨ç¤ºï¼š<strong>å°†ä¸¤ä¸ª <code>CompletableFuture</code> ç»„åˆèµ·æ¥ï¼Œåªè¦å…¶ä¸­ä¸€ä¸ªæ‰§è¡Œå®Œäº†ï¼Œå°±ä¼šæ‰§è¡ŒæŸä¸ªä»»åŠ¡</strong>ã€‚</p><p>å®ƒä»¬ä¹‹é—´çš„åŒºåˆ«åœ¨äºï¼š</p><ul><li><p><code>applyToEither</code>ï¼šä¼šå°†å·²ç»æ‰§è¡Œå®Œæˆçš„ä»»åŠ¡ï¼Œä½œä¸ºæ–¹æ³•å…¥å‚ï¼Œä¼ é€’åˆ°æŒ‡å®šæ–¹æ³•ä¸­ï¼Œä¸”<strong>æœ‰è¿”å›å€¼</strong></p></li><li><p><code>acceptEither</code>ï¼šä¼šå°†å·²ç»æ‰§è¡Œå®Œæˆçš„ä»»åŠ¡ï¼Œä½œä¸ºæ–¹æ³•å…¥å‚ï¼Œä¼ é€’åˆ°æŒ‡å®šæ–¹æ³•ä¸­ï¼Œä¸”<strong>æ— è¿”å›å€¼</strong></p></li><li><p><code>runAfterEither</code>ï¼šä¸ä¼šæŠŠæ‰§è¡Œç»“æœå½“åšæ–¹æ³•å…¥å‚ï¼Œä¸”æ²¡æœ‰è¿”å›å€¼ã€‚</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java">CompletableFuture&lt;Integer&gt; future1 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        TimeUnit.SECONDS.sleep(<span class="hljs-number">3</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>&#125;);<br><br>CompletableFuture&lt;Integer&gt; future2 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>;<br>&#125;);<br><br>CompletableFuture&lt;Integer&gt; resultFuture = future1.applyToEither(future2, result -&gt; &#123;<br>    <span class="hljs-comment">// result æ˜¯é¦–ä¸ªå®Œæˆçš„ CompletableFuture çš„ç»“æœ</span><br>    <span class="hljs-keyword">return</span> result * <span class="hljs-number">2</span>;<br>&#125;);<br><br>resultFuture.thenAccept(result -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;Result of the first completed future: &quot;</span> + result);<br>&#125;);<br><br><span class="hljs-comment">// é˜»å¡ç­‰å¾…ç»“æœ</span><br>resultFuture.join(); <span class="hljs-comment">// 8</span><br></code></pre></td></tr></table></figure><h5 id="allOf"><a href="#allOf" class="headerlink" title="allOf()"></a>allOf()</h5><p><code>allOf</code> æ–¹æ³•ç”¨äºç­‰å¾…å¤šä¸ª <code>CompletableFuture</code> éƒ½å®Œæˆåæ‰§è¡Œæ“ä½œã€‚å®ƒä¸è¿”å›ä¸€ä¸ªåˆå¹¶çš„ç»“æœï¼Œè€Œåªæ˜¯åœ¨æ‰€æœ‰çš„ <code>CompletableFuture</code> éƒ½å®Œæˆåè§¦å‘ä¸€ä¸ªæ“ä½œã€‚è¿™ä¸ªæ–¹æ³•é€šå¸¸ç”¨äºç­‰å¾…å¤šä¸ªä»»åŠ¡éƒ½å®Œæˆåæ‰ç»§ç»­æ‰§è¡Œå…¶ä»–æ“ä½œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java">CompletableFuture&lt;Integer&gt; future1 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        TimeUnit.SECONDS.sleep(<span class="hljs-number">2</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>    System.out.println(<span class="hljs-string">&quot;future1 is done&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>;<br>&#125;);<br><br>CompletableFuture&lt;Integer&gt; future2 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        TimeUnit.SECONDS.sleep(<span class="hljs-number">3</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>    System.out.println(<span class="hljs-string">&quot;future2 is done&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">7</span>;<br>&#125;);<br><br>CompletableFuture&lt;Integer&gt; future3 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>    System.out.println(<span class="hljs-string">&quot;future3 is done&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<br>&#125;);<br><br>CompletableFuture&lt;Void&gt; allOfFuture = CompletableFuture.allOf(future1, future2, future3);<br><br>allOfFuture.thenRun(() -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;All futures have completed.&quot;</span>);<br>&#125;);<br><br><span class="hljs-comment">// é˜»å¡ç­‰å¾…æ‰€æœ‰çš„ CompletableFuture å®Œæˆ</span><br>allOfFuture.join();<br><br><span class="hljs-comment">// è¾“å‡º</span><br><span class="hljs-comment">// future3 is done</span><br><span class="hljs-comment">// future1 is done</span><br><span class="hljs-comment">// future2 is done</span><br><span class="hljs-comment">// All futures have completed.</span><br></code></pre></td></tr></table></figure><h5 id="anyOf"><a href="#anyOf" class="headerlink" title="anyOf()"></a>anyOf()</h5><p><code>anyOf</code> æ–¹æ³•ç”¨äºç­‰å¾…å¤šä¸ª <code>CompletableFuture</code> ä¸­çš„ä»»ä½•ä¸€ä¸ªå®Œæˆåæ‰§è¡Œæ“ä½œã€‚å®ƒä¸ç­‰å¾…æ‰€æœ‰ <code>CompletableFuture</code> éƒ½å®Œæˆï¼Œåªéœ€ç­‰å¾…ä»»ä½•ä¸€ä¸ªå®Œæˆå³å¯è§¦å‘æ“ä½œã€‚è¿™å¯¹äºåœ¨å¤šä¸ªä»»åŠ¡ä¸­è·å–æœ€å¿«å®Œæˆçš„ç»“æœéå¸¸æœ‰ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java">CompletableFuture&lt;Integer&gt; future1 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        TimeUnit.SECONDS.sleep(<span class="hljs-number">2</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>;<br>&#125;);<br><br>CompletableFuture&lt;Integer&gt; future2 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        TimeUnit.SECONDS.sleep(<span class="hljs-number">3</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">7</span>;<br>&#125;);<br><br>CompletableFuture&lt;Integer&gt; future3 = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<br>&#125;);<br><br>CompletableFuture&lt;Object&gt; anyOfFuture = CompletableFuture.anyOf(future1, future2, future3);<br>anyOfFuture.thenAccept(result -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;Result of the first completed future: &quot;</span> + result);<br>&#125;);<br><br><span class="hljs-comment">// é˜»å¡ç­‰å¾…ç»“æœ</span><br>anyOfFuture.join(); <span class="hljs-comment">// Result of the first completed future: 3</span><br></code></pre></td></tr></table></figure><h5 id="thenCombine"><a href="#thenCombine" class="headerlink" title="thenCombine()"></a>thenCombine()</h5><p><code>thenCombine</code> æ–¹æ³•æ˜¯ç”¨äºç»„åˆä¸¤ä¸ªç‹¬ç«‹çš„ <code>CompletableFuture</code> çš„ç»“æœï¼Œç„¶ååœ¨ä¸¤è€…éƒ½å®Œæˆæ—¶æ‰§è¡Œä¸€ä¸ªæ“ä½œã€‚</p><p>è¿™ä¸ªæ“ä½œæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ä¸¤ä¸ª <code>CompletableFuture</code> çš„ç»“æœï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ç»“æœã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">CompletableFuture&lt;Integer&gt; future1 = CompletableFuture.supplyAsync(() -&gt; <span class="hljs-number">5</span>);<br>CompletableFuture&lt;Integer&gt; future2 = CompletableFuture.supplyAsync(() -&gt; <span class="hljs-number">7</span>);<br><br><span class="hljs-comment">// result1 æ˜¯ future1 çš„ç»“æœï¼Œresult2 æ˜¯ future2 çš„ç»“æœ</span><br>CompletableFuture&lt;Integer&gt; combinedFuture = future1.thenCombine(future2, Integer::sum);<br><br>combinedFuture.thenAccept(result -&gt; &#123;<br>System.out.println(<span class="hljs-string">&quot;Combined Result: &quot;</span> + result);<br>&#125;);<br><br><span class="hljs-comment">// é˜»å¡ç­‰å¾…ç»“æœ</span><br>combinedFuture.join(); <span class="hljs-comment">//Combined Result: 12</span><br></code></pre></td></tr></table></figure><h3 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><h4 id="Futureéœ€è¦è·å–è¿”å›å€¼ï¼Œæ‰èƒ½è·å–å¼‚å¸¸ä¿¡æ¯ã€‚"><a href="#Futureéœ€è¦è·å–è¿”å›å€¼ï¼Œæ‰èƒ½è·å–å¼‚å¸¸ä¿¡æ¯ã€‚" class="headerlink" title="Futureéœ€è¦è·å–è¿”å›å€¼ï¼Œæ‰èƒ½è·å–å¼‚å¸¸ä¿¡æ¯ã€‚"></a>Futureéœ€è¦è·å–è¿”å›å€¼ï¼Œæ‰èƒ½è·å–å¼‚å¸¸ä¿¡æ¯ã€‚</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">5L</span>,<br>    TimeUnit.SECONDS, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">10</span>));<br>CompletableFuture&lt;Void&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;<br>      <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>      <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">666</span>;<br>      <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> b / a;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>   &#125;,executorService).thenAccept(System.out::println);<br>   <br> <span class="hljs-comment">//å¦‚æœä¸åŠ  get()æ–¹æ³•è¿™ä¸€è¡Œï¼Œçœ‹ä¸åˆ°å¼‚å¸¸ä¿¡æ¯</span><br> <span class="hljs-comment">//future.get();</span><br></code></pre></td></tr></table></figure><h4 id="å°½é‡é¿å…ä½¿ç”¨-get"><a href="#å°½é‡é¿å…ä½¿ç”¨-get" class="headerlink" title="å°½é‡é¿å…ä½¿ç”¨ get()"></a>å°½é‡é¿å…ä½¿ç”¨ get()</h4><p><code>CompletableFuture</code>çš„<code>get()</code>æ–¹æ³•æ˜¯é˜»å¡çš„ï¼Œå°½é‡é¿å…ä½¿ç”¨ã€‚å¦‚æœå¿…é¡»è¦ä½¿ç”¨çš„è¯ï¼Œéœ€è¦æ·»åŠ è¶…æ—¶æ—¶é—´ï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´ä¸»çº¿ç¨‹ä¸€ç›´ç­‰å¾…ï¼Œæ— æ³•æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java">CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        Thread.sleep(<span class="hljs-number">10_000</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello, world!&quot;</span>;<br>&#125;);<br><br><span class="hljs-comment">// è·å–å¼‚æ­¥ä»»åŠ¡çš„è¿”å›å€¼ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´ä¸º 5 ç§’</span><br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.get(<span class="hljs-number">5</span>, TimeUnit.SECONDS);<br>    System.out.println(result);<br>&#125; <span class="hljs-keyword">catch</span> (InterruptedException | ExecutionException | TimeoutException e) &#123;<br>    <span class="hljs-comment">// å¤„ç†å¼‚å¸¸</span><br>    e.printStackTrace();<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢è¿™æ®µä»£ç åœ¨è°ƒç”¨ <code>get()</code> æ—¶æŠ›å‡ºäº† <code>TimeoutException</code> å¼‚å¸¸ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨å¼‚å¸¸å¤„ç†ä¸­è¿›è¡Œç›¸åº”çš„æ“ä½œï¼Œæ¯”å¦‚å–æ¶ˆä»»åŠ¡ã€é‡è¯•ä»»åŠ¡ã€è®°å½•æ—¥å¿—ç­‰ã€‚</p><h4 id="ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± "><a href="#ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± " class="headerlink" title="ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± "></a>ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± </h4><p><code>CompletableFuture</code> é»˜è®¤ä½¿ç”¨<code>ForkJoinPool.commonPool()</code> ä½œä¸ºæ‰§è¡Œå™¨ï¼Œè¿™ä¸ªçº¿ç¨‹æ± æ˜¯å…¨å±€å…±äº«çš„ï¼Œå¯èƒ½ä¼šè¢«å…¶ä»–ä»»åŠ¡å ç”¨ï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™æˆ–è€…é¥¥é¥¿ã€‚å› æ­¤ï¼Œå»ºè®®ä½¿ç”¨è‡ªå®šä¹‰çš„çº¿ç¨‹æ± æ¥æ‰§è¡Œ <code>CompletableFuture</code> çš„å¼‚æ­¥ä»»åŠ¡ï¼Œå¯ä»¥æé«˜å¹¶å‘åº¦å’Œçµæ´»æ€§ã€‚</p><h4 id="æ­£ç¡®è¿›è¡Œå¼‚å¸¸å¤„ç†"><a href="#æ­£ç¡®è¿›è¡Œå¼‚å¸¸å¤„ç†" class="headerlink" title="æ­£ç¡®è¿›è¡Œå¼‚å¸¸å¤„ç†"></a>æ­£ç¡®è¿›è¡Œå¼‚å¸¸å¤„ç†</h4><p>ä½¿ç”¨ <code>CompletableFuture</code>çš„æ—¶å€™ä¸€å®šè¦ä»¥æ­£ç¡®çš„æ–¹å¼è¿›è¡Œå¼‚å¸¸å¤„ç†ï¼Œé¿å…å¼‚å¸¸ä¸¢å¤±æˆ–è€…å‡ºç°ä¸å¯æ§é—®é¢˜ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€äº›å»ºè®®ï¼š</p><ul><li>ä½¿ç”¨ <code>whenComplete</code> æ–¹æ³•å¯ä»¥åœ¨ä»»åŠ¡å®Œæˆæ—¶è§¦å‘å›è°ƒå‡½æ•°ï¼Œå¹¶æ­£ç¡®åœ°å¤„ç†å¼‚å¸¸ï¼Œè€Œä¸æ˜¯è®©å¼‚å¸¸è¢«åå™¬æˆ–ä¸¢å¤±ã€‚</li><li>ä½¿ç”¨ <code>exceptionally</code> æ–¹æ³•å¯ä»¥å¤„ç†å¼‚å¸¸å¹¶é‡æ–°æŠ›å‡ºï¼Œä»¥ä¾¿å¼‚å¸¸èƒ½å¤Ÿä¼ æ’­åˆ°åç»­é˜¶æ®µï¼Œè€Œä¸æ˜¯è®©å¼‚å¸¸è¢«å¿½ç•¥æˆ–ç»ˆæ­¢ã€‚</li><li>ä½¿ç”¨ <code>handle</code> æ–¹æ³•å¯ä»¥å¤„ç†æ­£å¸¸çš„è¿”å›ç»“æœå’Œå¼‚å¸¸ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ç»“æœï¼Œè€Œä¸æ˜¯è®©å¼‚å¸¸å½±å“æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘ã€‚</li><li>ä½¿ç”¨ <code>CompletableFuture.allOf</code> æ–¹æ³•å¯ä»¥ç»„åˆå¤šä¸ª <code>CompletableFuture</code>ï¼Œå¹¶ç»Ÿä¸€å¤„ç†æ‰€æœ‰ä»»åŠ¡çš„å¼‚å¸¸ï¼Œè€Œä¸æ˜¯è®©å¼‚å¸¸å¤„ç†è¿‡äºå†—é•¿æˆ–é‡å¤ã€‚</li></ul><h4 id="åˆç†ç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡"><a href="#åˆç†ç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡" class="headerlink" title="åˆç†ç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡"></a>åˆç†ç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡</h4><p>æ­£ç¡®ä½¿ç”¨ <code>thenCompose()</code> ã€ <code>thenCombine()</code> ã€<code>acceptEither()</code>ã€<code>allOf()</code>ã€<code>anyOf() </code>ç­‰æ–¹æ³•æ¥ç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œä»¥æ»¡è¶³å®é™…ä¸šåŠ¡çš„éœ€æ±‚ï¼Œæé«˜ç¨‹åºæ‰§è¡Œæ•ˆç‡ã€‚</p><p>å®é™…ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åˆ©ç”¨æˆ–è€…å‚è€ƒç°æˆçš„å¼‚æ­¥ä»»åŠ¡ç¼–æ’æ¡†æ¶ï¼Œæ¯”å¦‚äº¬ä¸œçš„ <a href="https://gitee.com/jd-platform-opensource/asyncTool">asyncTool</a> ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>JAVA</category>
      
      <category>å¤šçº¿ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Thread</tag>
      
      <tag>å¤šçº¿ç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ThreadLocal</title>
    <link href="/2023/10/09/ThreadLocal/"/>
    <url>/2023/10/09/ThreadLocal/</url>
    
    <content type="html"><![CDATA[<h3 id="ThreadLocalæ˜¯ä»€ä¹ˆ"><a href="#ThreadLocalæ˜¯ä»€ä¹ˆ" class="headerlink" title="ThreadLocalæ˜¯ä»€ä¹ˆ"></a>ThreadLocalæ˜¯ä»€ä¹ˆ</h3><p>åœ¨å¤„ç†å¤šçº¿ç¨‹å¹¶å‘å®‰å…¨çš„é—®é¢˜ä¸­ï¼Œæˆ‘ä»¬æœ€å¸¸ä½¿ç”¨çš„æ–¹æ³•å°±æ˜¯é€šè¿‡é”æ¥æ§åˆ¶å¤šä¸ªä¸åŒçº¿ç¨‹å¯¹ä¸´ç•ŒåŒºçš„è®¿é—®ã€‚</p><p>ä½†æ— è®ºæ˜¯ä»€ä¹ˆæ ·çš„é”ï¼Œä¹è§‚é”æˆ–è€…æ‚²è§‚é”ï¼Œå°½ç®¡<code>JDK</code> åœ¨å‡çº§è¿‡ç¨‹ä¸­å¯¹å®ƒä»¬éƒ½æœ‰ä¸åŒç¨‹åº¦çš„ä¼˜åŒ–ï¼Œä½†åœ¨å¹¶å‘å†²çªçš„æ—¶å€™æ€»æ˜¯ä¼šå¯¹æ€§èƒ½äº§ç”Ÿä¸€å®šçš„å½±å“ã€‚</p><p>è€Œæˆ‘ä»¬ä»Šå¤©çš„ä¸»è§’ <code>ThreadLocal</code> è§£å†³çš„æ­£æ˜¯<strong>å½»åº•é¿å…</strong>å¤šçº¿ç¨‹ä¹‹é—´äº§ç”Ÿçš„ç«äº‰é—®é¢˜ã€‚</p><p>ä»å­—é¢æ„æ€ä¸Šçœ‹ï¼Œ<code>ThreadLocal</code> å¯ä»¥è§£é‡Šä¸ºçº¿ç¨‹çš„å±€éƒ¨å˜é‡ï¼Œä¹Ÿå°±æ˜¯è¯´å¯¹äºåŒä¸€ä¸ª <code>ThreadLocal</code> å˜é‡ï¼Œæ¯ä¸ªçº¿ç¨‹è®¿é—®çš„éƒ½æ˜¯è‡ªå·±æœ¬åœ°å˜é‡å€¼ï¼Œæ—¢ç„¶åªæœ‰è‡ªå·±èƒ½å¤Ÿè®¿é—®ï¼Œé‚£è‡ªç„¶å°±é¿å…äº†å†²çªã€‚</p><p>æ‰€ä»¥è¯´ï¼Œ<code>ThreadLocal</code> ç›¸è¾ƒäºé”æä¾›äº†ä¸€ç§ä¸ä¼—ä¸åŒçš„ä¿è¯çº¿ç¨‹å®‰å…¨çš„æ–¹å¼ï¼Œå®ƒä¸æ˜¯åœ¨çº¿ç¨‹å‘ç”Ÿå†²çªæ—¶æƒ³åŠæ³•è§£å†³å†²çªï¼Œè€Œæ˜¯å½»åº•çš„é¿å…äº†å†²çªçš„å‘ç”Ÿã€‚</p><p>ä¸¾ä¸€ä¸ªç°å®ç”Ÿæ´»å½“ä¸­çš„ä¾‹å­ï¼š</p><p>å»å•†åœºè´­ç‰©æ—¶æˆ‘ä»¬æ€»ä¼šå°†è´­ä¹°çš„å•†å“æ”¾åˆ°è´­ç‰©è½¦ä¸­ï¼Œå¹¶ä¸”å•†åœºä¼šä¸ºæ¯ä¸ªäººå‡†å¤‡å•ç‹¬çš„è´­ç‰©è½¦ï¼Œå¦‚æœæ‰€æœ‰äººè´­ä¹°çš„ä¸œè¥¿éƒ½æ”¾åˆ°ä¸€ä¸ªè´­ç‰©è½¦ï¼Œå¤§å®¶å°±ä¼šæ··æ·†å„è‡ªè´­ä¹°çš„å•†å“ï¼Œæœ€ç»ˆç»“è´¦ä¹Ÿä¼šå‡ºå¤§é—®é¢˜ã€‚æ‰€ä»¥æ¯ä¸ªäººéƒ½æœ‰å±äºè‡ªå·±çš„è´­ç‰©è½¦ï¼Œè¿™æ ·æ‰ä¸ä¼šå„è‡ªæ··æ·†ï¼Œ<code>ThreadLocal</code> çš„å®ç°æ–¹å¼ä¹Ÿå’Œè¿™ä¸ªä¾‹å­ç±»ä¼¼ã€‚</p><h3 id="ThreadLocalä½¿ç”¨"><a href="#ThreadLocalä½¿ç”¨" class="headerlink" title="ThreadLocalä½¿ç”¨"></a>ThreadLocalä½¿ç”¨</h3><p><code>ThreadLocal </code> æä¾›äº†ä¸€ä¸ª <code>withInitial()</code> æ–¹æ³•ç»Ÿä¸€åˆå§‹åŒ–æ‰€æœ‰çº¿ç¨‹çš„ <code>ThreadLocal</code> çš„å€¼ï¼Œè¿™é‡Œæˆ‘ä»¬å°† <code>thread1</code> ã€<code>thread2</code> å’Œä¸»çº¿ç¨‹çš„å€¼éƒ½åˆå§‹åŒ–ä¸º0ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ª ThreadLocal å˜é‡</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;Integer&gt; THREAD_LOCAL = ThreadLocal.withInitial(() -&gt; <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-comment">// åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹å¹¶å¯åŠ¨</span><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-comment">// åœ¨çº¿ç¨‹1ä¸­è®¾ç½® ThreadLocal å˜é‡çš„å€¼</span><br>            THREAD_LOCAL.set(<span class="hljs-number">1</span>);<br><br>            <span class="hljs-comment">// åœ¨çº¿ç¨‹1ä¸­è·å– ThreadLocal å˜é‡çš„å€¼å¹¶æ‰“å°</span><br>            System.out.println(<span class="hljs-string">&quot;Thread 1 - ThreadLocal Value: &quot;</span> + THREAD_LOCAL.get());<br>        &#125;);<br><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-comment">// åœ¨çº¿ç¨‹2ä¸­è®¾ç½® ThreadLocal å˜é‡çš„å€¼</span><br>            THREAD_LOCAL.set(<span class="hljs-number">2</span>);<br><br>            <span class="hljs-comment">// åœ¨çº¿ç¨‹2ä¸­è·å– ThreadLocal å˜é‡çš„å€¼å¹¶æ‰“å°</span><br>            System.out.println(<span class="hljs-string">&quot;Thread 2 - ThreadLocal Value: &quot;</span> + THREAD_LOCAL.get());<br>        &#125;);<br><br>        <span class="hljs-comment">// å¯åŠ¨çº¿ç¨‹1å’Œçº¿ç¨‹2</span><br>        thread1.start();<br>        thread2.start();<br><br>        <span class="hljs-comment">// ç­‰å¾…çº¿ç¨‹1å’Œçº¿ç¨‹2å®Œæˆ</span><br>        thread1.join();<br>        thread2.join();<br><br>        <span class="hljs-comment">// åœ¨ä¸»çº¿ç¨‹ä¸­è·å– ThreadLocal å˜é‡çš„å€¼å¹¶æ‰“å°</span><br>        System.out.println(<span class="hljs-string">&quot;Main Thread - ThreadLocal Value: &quot;</span> + THREAD_LOCAL.get());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tex">Thread 1 - ThreadLocal Value: 1<br>Thread 2 - ThreadLocal Value: 2<br>Main Thread - ThreadLocal Value: 0<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>thread1</code> å’Œ <code>thread2</code> è®¾ç½®çš„å€¼äº’ä¸å½±å“ï¼Œç”±äºä¸»çº¿ç¨‹æ²¡æœ‰é‡æ–°è®¾ç½®å€¼ï¼Œæ‰€ä»¥å–å¾—åˆå§‹åŒ–çš„å€¼0ã€‚</p><h3 id="ThreadLocalçš„å®ç°åŸç†"><a href="#ThreadLocalçš„å®ç°åŸç†" class="headerlink" title="ThreadLocalçš„å®ç°åŸç†"></a>ThreadLocalçš„å®ç°åŸç†</h3><p><code>ThreadLocal</code> å˜é‡æ˜¯å¦‚ä½•åšåˆ°åªå¯¹å½“å‰çº¿ç¨‹å¯è§çš„å‘¢ï¼Ÿæˆ‘ä»¬å…ˆä» <code>ThreadLocal</code> ç±»å½“ä¸­æœ€åŸºæœ¬çš„ <code>get()</code> æ–¹æ³•è¯´èµ·ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> T <span class="hljs-title function_">get</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// è·å¾—å½“å‰çº¿ç¨‹</span><br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>    <span class="hljs-comment">// ThreadLocalMapé‡Œä¿å­˜ç€æ‰€æœ‰ThreadLocalå˜é‡</span><br>    <span class="hljs-comment">// é€šè¿‡getMap(Thread t)æ–¹æ³•å¯ä»¥å‘ç° æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„ThreadLocalMap</span><br>    <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);<br>    <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// ThreadLocalMapçš„keyå°±æ˜¯å½“å‰ThreadLocalçš„å¯¹è±¡å®ä¾‹</span><br>        <span class="hljs-comment">// å¤šä¸ªThreadLocalå˜é‡éƒ½æ˜¯æ”¾åœ¨è¿™ä¸ªmapä¸­çš„</span><br>        ThreadLocalMap.<span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> map.getEntry(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>            <span class="hljs-comment">// è¿™é‡Œå–å‡ºæ¥çš„å€¼å°±æ˜¯å½“å‰çº¿ç¨‹å¯¹è¿™ä¸ªThreadLocalå˜é‡è®¾ç½®çš„å€¼</span><br>            <span class="hljs-type">T</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> (T)e.value;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// å¦‚æœmapæ²¡æœ‰åˆå§‹åŒ–ï¼Œè¿™é‡Œæ‰§è¡Œåˆå§‹åŒ–çš„æ“ä½œ</span><br>    <span class="hljs-keyword">return</span> setInitialValue();<br>&#125;<br><br>ThreadLocalMap <span class="hljs-title function_">getMap</span><span class="hljs-params">(Thread t)</span> &#123;<br>    <span class="hljs-comment">// è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMap</span><br>    <span class="hljs-keyword">return</span> t.threadLocals;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæ‰€è°“çš„ <code>ThreadLocal</code> å˜é‡å°±æ˜¯ä¿å­˜åœ¨æ¯ä¸ªçº¿ç¨‹çš„ <code>ThreadLocalMap</code> ä¸­çš„ã€‚è¿™ä¸ª <code>map</code> å°±æ˜¯ <code>Thread</code> å¯¹è±¡ä¸­çš„ <code>threadLocals</code> å­—æ®µã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ä¸æ­¤çº¿ç¨‹æœ‰å…³çš„ThreadLocalå€¼ã€‚ç”±ThreadLocalç±»ç»´æŠ¤</span><br>ThreadLocal.<span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">threadLocals</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼Œ<strong>æœ€ç»ˆçš„å˜é‡æ˜¯æ”¾åœ¨äº†å½“å‰çº¿ç¨‹çš„ <code>ThreadLocalMap</code> ä¸­ï¼Œå¹¶ä¸æ˜¯å­˜åœ¨ <code>ThreadLocal</code> ä¸Šï¼Œ<code>ThreadLocal</code> å¯ä»¥ç†è§£ä¸ºåªæ˜¯ <code>ThreadLocalMap</code> çš„å°è£…ï¼Œä¼ é€’äº†å˜é‡å€¼ã€‚</strong><code>ThrealLocal</code> ç±»ä¸­å¯ä»¥é€šè¿‡ <code>Thread.currentThread()</code> è·å–åˆ°å½“å‰çº¿ç¨‹å¯¹è±¡åï¼Œç›´æ¥é€šè¿‡<code>getMap(Thread t)</code>å¯ä»¥è®¿é—®åˆ°è¯¥çº¿ç¨‹çš„<code>ThreadLocalMap</code>å¯¹è±¡ã€‚</p><p><strong>æ¯ä¸ª <code>Thread</code> ä¸­éƒ½å…·å¤‡ä¸€ä¸ª <code>ThreadLocalMap</code>ï¼Œè€Œ <code>ThreadLocalMap</code> å¯ä»¥å­˜å‚¨ä»¥ <code>ThreadLocal</code> ä¸º key ï¼ŒObject å¯¹è±¡ä¸º value çš„é”®å€¼å¯¹ã€‚</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123;<br>    <span class="hljs-comment">//......</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ¯”å¦‚æˆ‘ä»¬åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å£°æ˜äº†ä¸¤ä¸ª <code>ThreadLocal</code> å¯¹è±¡çš„è¯ï¼Œ <code>Thread</code> å†…éƒ¨éƒ½æ˜¯ä½¿ç”¨ä»…æœ‰çš„é‚£ä¸ª<code>ThreadLocalMap</code> å­˜æ”¾æ•°æ®çš„ï¼Œ<code>ThreadLocalMap</code>çš„ key å°±æ˜¯ <code>ThreadLocal</code>å¯¹è±¡ï¼Œvalue å°±æ˜¯ <code>ThreadLocal</code> å¯¹è±¡è°ƒç”¨<code>set</code>æ–¹æ³•è®¾ç½®çš„å€¼ã€‚</p><p><code>ThreadLocal</code> ç»“æ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="https://image.seeyourface.cn/migrate/image-20231009141659619.png" alt="image-20231009141659619"></p><h3 id="ThreadLocalå†…å­˜æ³„æ¼"><a href="#ThreadLocalå†…å­˜æ³„æ¼" class="headerlink" title="ThreadLocalå†…å­˜æ³„æ¼"></a>ThreadLocalå†…å­˜æ³„æ¼</h3><p><code>ThreadLocal.ThreadLocalMap</code> æ˜¯ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„ <code>Map</code> ï¼Œå®ƒçš„æ¯ä¸ª <code>Entry</code> çš„ <code>key</code> éƒ½æ˜¯ä¸€ä¸ªå¼±å¼•ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Entry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WeakReference</span>&lt;ThreadLocal&lt;?&gt;&gt; &#123;<br>    <span class="hljs-comment">/** The value associated with this ThreadLocal. */</span><br>    Object value;<br>    <span class="hljs-comment">// keyæ˜¯ä¸€ä¸ªå¼±å¼•ç”¨</span><br>    Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;<br>        <span class="hljs-built_in">super</span>(k);<br>        value = v;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>ThreadLocalMap</code> ä¸­ä½¿ç”¨çš„ key ä¸º <code>ThreadLocal</code> çš„å¼±å¼•ç”¨ï¼Œè€Œ <code>value</code> æ˜¯å¼ºå¼•ç”¨ã€‚æ‰€ä»¥ï¼Œå¦‚æœ <code>ThreadLocal</code> æ²¡æœ‰è¢«å¤–éƒ¨å¼ºå¼•ç”¨çš„æƒ…å†µä¸‹ï¼Œåœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™ï¼Œ<code>key</code> ä¼šè¢«æ¸…ç†æ‰ï¼Œè€Œ <code>value</code> ä¸ä¼šè¢«æ¸…ç†ã€‚</p><p>è¿™ä¸ª <code>value</code> çš„å¼•ç”¨é“¾æ¡å¦‚ä¸‹ï¼š</p><p><img src="https://image.seeyourface.cn/migrate/ThreadLocalMap%E4%B8%ADvalue%E5%BC%95%E7%94%A8%E9%93%BE.jpg" alt="ThreadLocalMapä¸­valueå¼•ç”¨é“¾"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œåªæœ‰å½“ <code>Thread</code> è¢«å›æ”¶æ—¶ï¼Œè¿™ä¸ª <code>value</code> æ‰æœ‰è¢«å›æ”¶çš„æœºä¼šï¼Œå¦åˆ™ï¼Œåªè¦çº¿ç¨‹ä¸é€€å‡ºï¼Œ<code>value</code> æ€»æ˜¯ä¼šå­˜åœ¨ä¸€ä¸ªå¼ºå¼•ç”¨ã€‚ä½†æ˜¯ï¼Œè¦æ±‚æ¯ä¸ª <code>Thread</code> éƒ½ä¼šé€€å‡ºï¼Œæ˜¯ä¸€ä¸ªæå…¶è‹›åˆ»çš„è¦æ±‚ï¼Œå¯¹äºçº¿ç¨‹æ± æ¥è¯´ï¼Œå¤§éƒ¨åˆ†çº¿ç¨‹ä¼šä¸€ç›´å­˜åœ¨åœ¨ç³»ç»Ÿçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…ï¼Œé‚£æ ·çš„è¯ï¼Œå°±ä¼šé€ æˆ <code>value</code> å¯¹è±¡å‡ºç°æ³„æ¼çš„å¯èƒ½ã€‚</p><p>å¦‚æ­¤ä¸€æ¥ï¼Œ<code>ThreadLocalMap</code> ä¸­å°±ä¼šå‡ºç° <code>key</code> ä¸º <code>null</code> çš„ <code>Entry</code>ã€‚å‡å¦‚æˆ‘ä»¬ä¸åšä»»ä½•æªæ–½çš„è¯ï¼Œ<code>value</code> æ°¸è¿œæ— æ³•è¢« <code>GC</code> å›æ”¶ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯èƒ½ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ã€‚<code>ThreadLocalMap</code> å®ç°ä¸­å·²ç»è€ƒè™‘äº†è¿™ç§æƒ…å†µï¼Œåœ¨è°ƒç”¨ <code>set()</code>ã€<code>get()</code>ã€<code>remove()</code> æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæ¸…ç†æ‰ <code>key</code> ä¸º <code>null</code> çš„è®°å½•ã€‚ä½¿ç”¨å®Œ <code>ThreadLocal</code>æ–¹æ³•åæœ€å¥½æ‰‹åŠ¨è°ƒç”¨ <code>remove()</code> æ–¹æ³•ã€‚</p><p>ä»¥ <code>getEntry()</code> æ–¹æ³•ä¸ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Entry <span class="hljs-title function_">getEntry</span><span class="hljs-params">(ThreadLocal&lt;?&gt; key)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> key.threadLocalHashCode &amp; (table.length - <span class="hljs-number">1</span>);<br>    <span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> table[i];<br>    <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span> &amp;&amp; e.get() == key)<br>        <span class="hljs-comment">// å¦‚æœè¿™ä¸ªkeyå­˜åœ¨ï¼Œç›´æ¥è¿”å›ç»“æœ</span><br>        <span class="hljs-keyword">return</span> e;<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-comment">// å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°±ä¼šå°è¯•æ¸…ç†ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœä½ æ€»æ˜¯è®¿é—®å­˜åœ¨çš„keyï¼Œæ¸…ç†æµç¨‹æ°¸è¿œè¿›ä¸æ¥</span><br>        <span class="hljs-keyword">return</span> getEntryAfterMiss(key, i, e);<br>&#125;<br><br><span class="hljs-keyword">private</span> Entry <span class="hljs-title function_">getEntryAfterMiss</span><span class="hljs-params">(ThreadLocal&lt;?&gt; key, <span class="hljs-type">int</span> i, Entry e)</span> &#123;<br>    Entry[] tab = table;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> tab.length;<br>    <span class="hljs-keyword">while</span> (e != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// æ•´ä¸ªeæ˜¯entry ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå¼±å¼•ç”¨</span><br>        ThreadLocal&lt;?&gt; k = e.get();<br>        <span class="hljs-comment">// å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±è¿”å›</span><br>        <span class="hljs-keyword">if</span> (k == key)<br>            <span class="hljs-keyword">return</span> e;<br>        <span class="hljs-comment">// å¦‚æœkeyä¸ºnullï¼Œè¯´æ˜å¼±å¼•ç”¨å·²ç»è¢«å›æ”¶äº†</span><br>        <span class="hljs-comment">// é‚£ä¹ˆå°±è¦åœ¨è¿™é‡Œå›æ”¶é‡Œé¢çš„valueäº†</span><br>        <span class="hljs-keyword">if</span> (k == <span class="hljs-literal">null</span>)<br>            expungeStaleEntry(i);<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-comment">// å¦‚æœkeyä¸æ˜¯è¦æ‰¾çš„é‚£ä¸ªï¼Œé‚£è¯´æ˜æœ‰hashå†²çªï¼Œè¿™é‡Œæ˜¯å¤„ç†å†²çªï¼Œæ‰¾ä¸‹ä¸€ä¸ªentry</span><br>            i = nextIndex(i, len);<br>        e = tab[i];<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>çœŸæ­£ç”¨æ¥å›æ”¶valueçš„æ˜¯ <code>expungeStaleEntry()</code> æ–¹æ³•ï¼Œåœ¨ <code>remove()</code> å’Œ <code>set()</code> æ–¹æ³•ä¸­ï¼Œéƒ½ä¼šç›´æ¥æˆ–è€…é—´æ¥è°ƒç”¨åˆ°è¿™ä¸ªæ–¹æ³•è¿›è¡Œ <code>value</code> çš„æ¸…ç†ï¼š</p><p>ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œ<code>ThreadLocal</code> ä¸ºäº†é¿å…å†…å­˜æ³„éœ²ï¼Œä¹Ÿç®—æ˜¯èŠ±äº†ä¸€ç•ªå¤§å¿ƒæ€ã€‚ä¸ä»…ä½¿ç”¨äº†å¼±å¼•ç”¨ç»´æŠ¤ <code>key</code>ï¼Œè¿˜ä¼šåœ¨æ¯ä¸ªæ“ä½œä¸Šæ£€æŸ¥ <code>key</code> æ˜¯å¦è¢«å›æ”¶ï¼Œè¿›è€Œå†å›æ”¶ <code>value</code> ã€‚</p><p>ä½†æ˜¯ä»ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œ<code>ThreadLocal</code> å¹¶ä¸èƒ½100%ä¿è¯ä¸å‘ç”Ÿå†…å­˜æ³„æ¼ã€‚</p><p>æ¯”å¦‚ï¼Œå¾ˆä¸å¹¸çš„ï¼Œä½ çš„ <code>get()</code> æ–¹æ³•æ€»æ˜¯è®¿é—®å›ºå®šå‡ ä¸ªä¸€ç›´å­˜åœ¨çš„ <code>ThreadLocal</code> ï¼Œé‚£ä¹ˆæ¸…ç†åŠ¨ä½œå°±ä¸ä¼šæ‰§è¡Œï¼Œå¦‚æœä½ æ²¡æœ‰æœºä¼šè°ƒç”¨ <code>set()</code> å’Œ <code>remove()</code> ï¼Œé‚£ä¹ˆè¿™ä¸ªå†…å­˜æ³„æ¼ä¾ç„¶ä¼šå‘ç”Ÿã€‚</p><p>å› æ­¤ï¼Œä¸€ä¸ªè‰¯å¥½çš„ä¹ æƒ¯ä¾ç„¶æ˜¯ï¼š<strong>å½“ä½ ä¸éœ€è¦è¿™ä¸ª <code>ThreadLocal</code> å˜é‡æ—¶ï¼Œä¸»åŠ¨è°ƒç”¨ <code>remove()</code>ï¼Œè¿™æ ·å¯¹æ•´ä¸ªç³»ç»Ÿæ˜¯æœ‰å¥½å¤„çš„</strong>ã€‚</p><h3 id="ThreadLocalMapä¸­çš„Hashå†²çªå¤„ç†"><a href="#ThreadLocalMapä¸­çš„Hashå†²çªå¤„ç†" class="headerlink" title="ThreadLocalMapä¸­çš„Hashå†²çªå¤„ç†"></a>ThreadLocalMapä¸­çš„Hashå†²çªå¤„ç†</h3><p><code>ThreadLocalMap</code> ä½œä¸ºä¸€ä¸ª <code>HashMap</code> å’Œ <code>java.util.HashMap</code> çš„å®ç°æ˜¯ä¸åŒçš„ã€‚å¯¹äº<code>java.util.HashMap</code> ä½¿ç”¨çš„æ˜¯æ‹‰é“¾æ³•æ¥å¤„ç†å†²çªï¼š</p><p><img src="https://image.seeyourface.cn/migrate/%E6%8B%89%E9%93%BE%E6%B3%95.jpg" alt="æ‹‰é“¾æ³•"></p><p>ä½†æ˜¯ï¼Œå¯¹äº <code>ThreadLocalMap</code>ï¼Œå®ƒä½¿ç”¨çš„æ˜¯ç®€å•çš„çº¿æ€§æ¢æµ‹æ³•ï¼Œå¦‚æœå‘ç”Ÿäº†å…ƒç´ å†²çªï¼Œé‚£ä¹ˆå°±ä½¿ç”¨ä¸‹ä¸€ä¸ªæ§½ä½å­˜æ”¾ï¼š</p><p><img src="https://image.seeyourface.cn/migrate/%E7%BA%BF%E6%80%A7%E6%8E%A2%E6%B5%8B%E6%B3%95.jpg" alt="çº¿æ€§æ¢æµ‹æ³•"></p><p>æ•´ä¸ª <code>set()</code> æ–¹æ³•è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(ThreadLocal&lt;?&gt; key, Object value)</span> &#123;<br>    Entry[] tab = table;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> tab.length;<br>    <span class="hljs-comment">// æ ¹æ®keyçš„å“ˆå¸Œå€¼å¯¹æ•°ç»„é•¿åº¦å–æ¨¡æ‰¾åˆ°ä¸€ä¸ªä½ç½®</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> key.threadLocalHashCode &amp; (len-<span class="hljs-number">1</span>);<br>    <span class="hljs-comment">// å¦‚æœè¿™ä¸ªä½ç½®æ²¡æœ‰è¢«å ç”¨ï¼Œè¯´æ˜æ²¡æœ‰å†²çªï¼Œé‚£å°±ä¸éœ€è¦å¾ªç¯ï¼Œç›´æ¥ä½¿ç”¨è¿™ä¸ªä½ç½®</span><br>    <span class="hljs-comment">// å¦‚æœå‘ç”Ÿå†²çªï¼Œé‚£å°±ä¸€ç›´å¾ªç¯å¾€ä¸‹æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„ä½ç½®</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> tab[i];<br>         e != <span class="hljs-literal">null</span>;<br>         e = tab[i = nextIndex(i, len)]) &#123;<br>        <span class="hljs-comment">// å¾ªç¯ä½“å†…ï¼Œè¯´æ˜å·²ç»å‘ç”Ÿäº†å†²çª</span><br>        ThreadLocal&lt;?&gt; k = e.get();<br>        <span class="hljs-comment">// å¦‚æœæ˜¯å¯¹å€¼è¿›è¡Œé‡ç½®ï¼Œé‚£ä¹ˆç›´æ¥è¦†ç›–å°±å¥½</span><br>        <span class="hljs-keyword">if</span> (k == key) &#123;<br>            e.value = value;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// å¦‚æœkeyä¸ºnullï¼Œè¯´æ˜åŸæ¥çš„keyè¢«å›æ”¶äº†ï¼Œå¯åŠ¨æ¸…ç†</span><br>        <span class="hljs-keyword">if</span> (k == <span class="hljs-literal">null</span>) &#123;<br>            replaceStaleEntry(key, value, i);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// ä¸€æ—¦æ‰¾åˆ°åˆé€‚ä½ç½®ï¼Œå°±æ”¾å…¥æ–°çš„Entry</span><br>    tab[i] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(key, value);<br>    <span class="hljs-type">int</span> <span class="hljs-variable">sz</span> <span class="hljs-operator">=</span> ++size;<br>    <span class="hljs-keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)<br>        rehash();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="InheritableThreadLocal"><a href="#InheritableThreadLocal" class="headerlink" title="InheritableThreadLocal"></a>InheritableThreadLocal</h3><p>åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡åˆ°è¿™ä¹ˆä¸€ç§åœºæ™¯ã€‚ä¸»çº¿ç¨‹å¼€äº†ä¸€ä¸ªå­çº¿ç¨‹ï¼Œä½†æ˜¯æˆ‘ä»¬å¸Œæœ›åœ¨å­çº¿ç¨‹ä¸­å¯ä»¥è®¿é—®ä¸»çº¿ç¨‹ä¸­çš„ <code>ThreadLocal</code> å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰äº›æ•°æ®éœ€è¦è¿›è¡Œçˆ¶å­çº¿ç¨‹é—´çš„ä¼ é€’ã€‚æ¯”å¦‚åƒè¿™æ ·ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InheritableThreadLocalExample</span> &#123;<br><br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªInheritableThreadLocalå˜é‡</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> InheritableThreadLocal&lt;String&gt; inheritableThreadLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InheritableThreadLocal</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// åœ¨ä¸»çº¿ç¨‹ä¸­è®¾ç½®å€¼</span><br>        inheritableThreadLocal.set(<span class="hljs-string">&quot;Main Thread Value&quot;</span>);<br><br>        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå­çº¿ç¨‹</span><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">childThread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-comment">// å­çº¿ç¨‹å¯ä»¥è®¿é—®çˆ¶çº¿ç¨‹è®¾ç½®çš„å€¼</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> inheritableThreadLocal.get();<br>            System.out.println(<span class="hljs-string">&quot;Child Thread Value: &quot;</span> + value);<br>        &#125;);<br><br>        <span class="hljs-comment">// å¯åŠ¨å­çº¿ç¨‹</span><br>        childThread.start();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// ç­‰å¾…å­çº¿ç¨‹å®Œæˆ</span><br>            childThread.join();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-comment">// ä¸»çº¿ç¨‹ä»ç„¶å¯ä»¥è®¿é—®ç›¸åŒçš„å€¼</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">mainThreadValue</span> <span class="hljs-operator">=</span> inheritableThreadLocal.get();<br>        System.out.println(<span class="hljs-string">&quot;Main Thread Value: &quot;</span> + mainThreadValue);<br><br>        <span class="hljs-comment">// æ¸…é™¤InheritableThreadLocalå˜é‡</span><br>        inheritableThreadLocal.remove();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä¸Šè¿°ä»£ç ï¼Œå¯ä»¥å¾—åˆ°ç»“æœï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs tex">Child Thread Value: Main Thread Value<br>Main Thread Value: Main Thread Value<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå­çº¿ç¨‹å¯ä»¥è®¿é—®åˆ°ä»çˆ¶è¿›ç¨‹ä¼ é€’è¿‡æ¥çš„ä¸€ä¸ªæ•°æ®ã€‚è™½ç„¶ <code>InheritableThreadLocal</code> çœ‹èµ·æ¥æŒºæ–¹ä¾¿çš„ï¼Œä½†æ˜¯ä¾ç„¶è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ol><li>å˜é‡çš„ä¼ é€’æ˜¯å‘ç”Ÿåœ¨çº¿ç¨‹åˆ›å»ºçš„æ—¶å€™ï¼Œå¦‚æœä¸æ˜¯æ–°å»ºçº¿ç¨‹ï¼Œè€Œæ˜¯ç”¨äº†çº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹ï¼Œå°±ä¸çµäº†ã€‚</li><li>å˜é‡çš„èµ‹å€¼å°±æ˜¯ä»ä¸»çº¿ç¨‹çš„ <code>map</code> å¤åˆ¶åˆ°å­çº¿ç¨‹ï¼Œå®ƒä»¬çš„ <code>value</code> æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœè¿™ä¸ªå¯¹è±¡æœ¬èº«ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</li></ol><h3 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h3><ol><li>æ¯ä¸ªçº¿ç¨‹éœ€è¦ä¸€ä¸ªç‹¬äº«çš„å¯¹è±¡ï¼ˆé€šå¸¸æ˜¯å·¥å…·ç±»ï¼Œå…¸å‹éœ€è¦ä½¿ç”¨çš„ç±»æœ‰ <code>SimpleDateFormat</code> å’Œ<code>Random</code> ï¼‰ã€‚</li><li>æ¯ä¸ªçº¿ç¨‹å†…éœ€è¦ä¿å­˜å…¨å±€å˜é‡ï¼ˆä¾‹å¦‚åœ¨æ‹¦æˆªå™¨ä¸­è·å–ç”¨æˆ·ä¿¡æ¯ï¼‰ï¼Œå¯ä»¥è®©ä¸åŒæ–¹æ³•ç›´æ¥ä½¿ç”¨ï¼Œé¿å…å‚æ•°ä¼ é€’çš„éº»çƒ¦ã€‚</li></ol>]]></content>
    
    
    <categories>
      
      <category>JAVA</category>
      
      <category>å¤šçº¿ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Thread</tag>
      
      <tag>å¤šçº¿ç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JDKæºç ç³»åˆ—-HashMap</title>
    <link href="/2023/09/27/JDK%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-HashMap/"/>
    <url>/2023/09/27/JDK%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-HashMap/</url>
    
    <content type="html"><![CDATA[<h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p><code>HashMap</code>æ˜¯Javaç¨‹åºå‘˜ä½¿ç”¨é¢‘ç‡æœ€é«˜çš„ç”¨äºæ˜ å°„(key-valueé”®å€¼å¯¹)å¤„ç†çš„æ•°æ®ç±»å‹ã€‚</p><p>JDK1.8 ä¹‹å‰ <code>HashMap</code> æ˜¯ç”± æ•°ç»„+é“¾è¡¨ ç»„æˆçš„ï¼Œæ•°ç»„æ˜¯ <code>HashMap</code> çš„ä¸»ä½“ï¼Œé“¾è¡¨åˆ™æ˜¯ä¸»è¦ä¸ºäº†è§£å†³<strong>å“ˆå¸Œå†²çª</strong>è€Œå­˜åœ¨çš„ï¼ˆâ€œæ‹‰é“¾æ³•â€è§£å†³å†²çªï¼‰ã€‚ </p><p>JDK1.8 ä»¥åçš„ <code>HashMap</code> åœ¨è§£å†³å“ˆå¸Œå†²çªæ—¶æœ‰äº†è¾ƒå¤§çš„å˜åŒ–ï¼Œå½“é“¾è¡¨é•¿åº¦<strong>å¤§äºç­‰äºé˜ˆå€¼</strong>ï¼ˆé»˜è®¤ä¸º 8ï¼‰ï¼ˆå°†é“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘å‰ä¼šåˆ¤æ–­ï¼Œå¦‚æœå½“å‰<strong>æ•°ç»„çš„é•¿åº¦å°äº 64</strong>ï¼Œé‚£ä¹ˆä¼šé€‰æ‹©<strong>å…ˆè¿›è¡Œæ•°ç»„æ‰©å®¹</strong>ï¼Œè€Œä¸æ˜¯è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼‰æ—¶ï¼Œå°†é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘ï¼Œä»¥å‡å°‘æœç´¢æ—¶é—´ã€‚</p><p><code>HashMap</code>çš„ä¼˜ç‚¹æ˜¯<strong>è®¿é—®é€Ÿåº¦å¿«</strong>ï¼Œæ’å…¥å’Œåˆ é™¤æ“ä½œä¹Ÿæ–¹ä¾¿ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœ<code>HashMap</code>ä¸­çš„å…ƒç´ æ˜¯å‡åŒ€åˆ†å¸ƒåœ¨æ•°ç»„ä¸­çš„ï¼Œé‚£ä¹ˆæŸ¥è¯¢æ—¶é—´å¤æ‚åº¦æ¥è¿‘äºO(1)ï¼›ç›¸åï¼Œé‚£ä¹ˆæŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦å¯èƒ½ä¼šå¢åŠ ï¼Œå› ä¸ºå¯èƒ½éœ€è¦éå†æ•°ç»„ä¸­çš„é“¾è¡¨æˆ–çº¢é»‘æ ‘æ¥æ‰¾åˆ°å¯¹åº”çš„å€¼ã€‚é“¾è¡¨çš„æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦æ˜¯O(n)ï¼Œçº¢é»‘æ ‘çš„æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦æ˜¯O(logn)ï¼Œå…¶ä¸­næ˜¯é“¾è¡¨æˆ–çº¢é»‘æ ‘ä¸­çš„å…ƒç´ ä¸ªæ•°ã€‚å› æ­¤ï¼Œ<code>HashMap</code>çš„æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦æœ€å¥½æ˜¯O(1)ï¼Œæœ€åæ˜¯O(n)ã€‚</p><p><code>HashMap</code>çš„ç¼ºç‚¹æ˜¯ä¸ä¿è¯å…ƒç´ çš„é¡ºåºï¼Œä¸æ”¯æŒçº¿ç¨‹åŒæ­¥ï¼Œä¹Ÿä¸èƒ½å­˜å‚¨é‡å¤çš„é”®ï¼ˆkeyï¼‰ã€‚</p><p><code>HashMap</code>å¯ä»¥å­˜å‚¨ null çš„ key å’Œ valueï¼Œä½† null ä½œä¸ºé”®åªèƒ½æœ‰ä¸€ä¸ªï¼Œnull ä½œä¸ºå€¼å¯ä»¥æœ‰å¤šä¸ªã€‚</p><p><code>HashMap</code> é»˜è®¤çš„åˆå§‹åŒ–å¤§å°ä¸º 16ã€‚ä¹‹åæ¯æ¬¡æ‰©å……ï¼Œå®¹é‡å˜ä¸ºåŸæ¥çš„ 2 å€ã€‚å¹¶ä¸”ï¼Œ<code>HashMap</code>æ€»æ˜¯ä½¿ç”¨ 2 çš„å¹‚ä½œä¸ºå“ˆå¸Œè¡¨çš„å¤§å°ã€‚</p><h3 id="ç¤ºæ„å›¾"><a href="#ç¤ºæ„å›¾" class="headerlink" title="ç¤ºæ„å›¾"></a>ç¤ºæ„å›¾</h3><p>ä¸‹å›¾æ˜¯<code>HashMap</code>çš„ç±»ç»“æ„å…³ç³»å›¾ï¼š</p><p>å®ƒç»§æ‰¿äº†<code>AbstractMap</code>ï¼Œ<code>AbstractMap</code>å®ç°äº†é¡¶å±‚æ¥å£Mapä¸­çš„å¤§éƒ¨åˆ†æ–¹æ³•ï¼Œåªæœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•<code>entrySet()</code>éœ€è¦è‡ªå·±å®ç°ã€‚</p><p>å®ç°äº†ä»¥ä¸‹æ¥å£ï¼š</p><ul><li>Mapï¼šå“ˆå¸Œè¡¨çš„é¡¶çº§æ¥å£ï¼Œå®šä¹‰äº†å“ˆå¸Œè¡¨çš„åŸºç¡€æ“ä½œæ–¹æ³•ï¼Œäº¤ç»™å­ç±»å®ç°ã€‚</li><li>Cloneableï¼šè¡¨æ˜å®ƒå…·æœ‰æ‹·è´èƒ½åŠ›ï¼Œå¯ä»¥è¿›è¡Œæ·±æ‹·è´æˆ–æµ…æ‹·è´æ“ä½œã€‚</li><li>Serializableï¼šè¡¨æ˜å®ƒå¯ä»¥è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œï¼Œä¹Ÿå°±æ˜¯å³å¯ä»¥å°†<strong>å¯¹è±¡åºåˆ—åŒ–ä¸ºå­—èŠ‚æµ</strong>è¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨æˆ–ç½‘ç»œä¼ è¾“ï¼Œä¹Ÿå¯ä»¥ä»<strong>å­—èŠ‚æµååºåˆ—åŒ–ä¸ºå¯¹è±¡</strong>ï¼Œéå¸¸æ–¹ä¾¿ã€‚</li></ul><p><img src="https://image.seeyourface.cn/migrate/image-20230927152729707.png" alt="image-20230927152729707"></p><h3 id="åº•å±‚æ•°æ®ç»“æ„"><a href="#åº•å±‚æ•°æ®ç»“æ„" class="headerlink" title="åº•å±‚æ•°æ®ç»“æ„"></a>åº•å±‚æ•°æ®ç»“æ„</h3><p>ä»åº•å±‚æ•°æ®å­˜å‚¨ç»“æ„å®ç°æ¥è®²ï¼Œ<code>HashMap</code>æ˜¯æ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘ï¼ˆJDK1.8å¢åŠ äº†çº¢é»‘æ ‘éƒ¨åˆ†ï¼‰å®ç°çš„ï¼Œå¦‚ä¸‹å¦‚æ‰€ç¤ºã€‚</p><p><img src="https://image.seeyourface.cn/migrate/hashMap.png" alt="hashMap"></p><p>å¤§å®¶æœ‰æ²¡æœ‰æƒ³è¿‡ï¼š<code>HashMap</code>æ•°æ®åº•å±‚å…·ä½“å­˜å‚¨çš„æ˜¯ä»€ä¹ˆï¼Ÿè¿™æ ·çš„å­˜å‚¨æ–¹å¼æœ‰ä»€ä¹ˆä¼˜ç‚¹å‘¢ï¼Ÿ</p><p>é—®é¢˜1ï¼šé€šè¿‡æºç æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œ<code>HashMap</code>çš„æ•°æ®æœ€ç»ˆéƒ½ä¿å­˜åœ¨ä¸€ä¸ªå«<code>Node&lt;K,V&gt;</code>çš„ç»“æ„ä¸­ã€‚</p><p>ä»€ä¹ˆï¼è¿˜æœ‰é«˜æ‰‹ï¼Ÿï¼Ÿï¼Ÿ</p><p><img src="https://image.seeyourface.cn/migrate/image-20230927170909332.png" alt="image-20230927170909332"></p><p><code>Node</code>æ˜¯<code>HashMap</code>çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œå®ç°äº†<code>Map.Entry</code>æ¥å£ï¼Œæœ¬è´¨æ˜¯å°±æ˜¯ä¸€ä¸ªæ˜ å°„(é”®å€¼å¯¹)ã€‚ä¹Ÿå°±æ˜¯ä¸Šå›¾ä¸­çš„é•¿æ–¹å½¢ä»£è¡¨çš„ç»“æ„ã€‚</p><p>é—®é¢˜2ï¼šå“ˆå¸Œè¡¨ä¸ºäº†è§£å†³å†²çªï¼Œå¯ä»¥é‡‡ç”¨çš„è§£å†³æ–¹æ³•æœ‰å¼€æ”¾åœ°å€æ³•å’Œé“¾åœ°å€æ³•ï¼Œä¸”<code>Java</code>ä¸­<code>HashMap</code>é‡‡ç”¨çš„å°±æ˜¯é“¾åœ°å€æ³•ã€‚ç®€å•æ¥è¯´å°±æ˜¯æ•°ç»„åŠ é“¾è¡¨çš„ç»“åˆã€‚åœ¨æ¯ä¸ªæ•°ç»„å…ƒç´ ä¸Šéƒ½ä¸€ä¸ªé“¾è¡¨ç»“æ„ï¼Œå½“æ•°æ®è¢«<code>Hash</code>åï¼Œå¾—åˆ°æ•°ç»„ä¸‹æ ‡ï¼ŒæŠŠæ•°æ®æ”¾åœ¨å¯¹åº”ä¸‹æ ‡å…ƒç´ çš„é“¾è¡¨ä¸Šã€‚</p><h3 id="HashMapæ˜¯å¦‚ä½•ä¿è¯é«˜æ€§èƒ½çš„ï¼Ÿ"><a href="#HashMapæ˜¯å¦‚ä½•ä¿è¯é«˜æ€§èƒ½çš„ï¼Ÿ" class="headerlink" title="HashMapæ˜¯å¦‚ä½•ä¿è¯é«˜æ€§èƒ½çš„ï¼Ÿ"></a>HashMapæ˜¯å¦‚ä½•ä¿è¯é«˜æ€§èƒ½çš„ï¼Ÿ</h3><p>å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œç†æƒ³æƒ…å†µä¸‹<code>HashMap</code>çš„æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦æ˜¯O(1)ï¼Œä½†æ˜¯éšç€åŠ å…¥çš„å¯¹è±¡è¶Šæ¥è¶Šå¤šï¼Œæ•°ç»„ä¸­çš„é“¾è¡¨å°†è¶Šæ¥è¶Šé•¿ï¼Œå°†ä¸¥é‡å½±å“HashMapçš„æ€§èƒ½ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•é™ä½å“ˆå¸Œå†²çªçš„æ¦‚ç‡å‘¢ï¼Œå¯ä»¥é€šè¿‡æ§åˆ¶å˜é‡æ³•è¿›è¡Œåˆ†æï¼šæˆ‘ä»¬çŸ¥é“ä¸€ä¸ªå¯¹è±¡å­˜æ”¾çš„ä½ç½®å–å†³äº<strong>æ•£åˆ—å‡½æ•°</strong>å’Œ<strong>æ•°ç»„å®¹é‡</strong>ã€‚</p><ul><li>æˆ‘ä»¬å°†å“ˆå¸Œæ¡¶çš„å®¹é‡å›ºå®šï¼ŒHashç®—æ³•è¶Šå¥½ï¼Œå¯¹è±¡åœ¨å“ˆå¸Œæ¡¶ä¸­çš„ä½ç½®åˆ†å¸ƒå°±è¶Šå‡åŒ€ï¼Œä¹Ÿå°±æ˜¯å“ˆå¸Œå†²çªçš„æ¦‚ç‡è¶Šä½ã€‚</li><li>å¯¹äºåŒä¸€ä¸ªHashç®—æ³•ï¼Œå“ˆå¸Œæ¡¶è¶Šå¤§ï¼Œå¯¹è±¡åœ¨å“ˆå¸Œæ¡¶ä¸­å†²çªçš„æ¦‚ç‡ä¹Ÿè¶Šä½ã€‚</li></ul><p>å¦‚æœå“ˆå¸Œæ¡¶æ•°ç»„å¾ˆå¤§ï¼Œå³ä½¿è¾ƒå·®çš„Hashç®—æ³•ä¹Ÿä¼šæ¯”è¾ƒåˆ†æ•£ï¼Œå¦‚æœå“ˆå¸Œæ¡¶æ•°ç»„æ•°ç»„å¾ˆå°ï¼Œå³ä½¿å¥½çš„Hashç®—æ³•ä¹Ÿä¼šå‡ºç°è¾ƒå¤šç¢°æ’ï¼Œæ‰€ä»¥å°±éœ€è¦åœ¨ç©ºé—´æˆæœ¬å’Œæ—¶é—´æˆæœ¬ä¹‹é—´æƒè¡¡ï¼Œå…¶å®å°±æ˜¯åœ¨æ ¹æ®å®é™…æƒ…å†µç¡®å®šå“ˆå¸Œæ¡¶æ•°ç»„çš„å¤§å°ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šè®¾è®¡å¥½çš„Hashç®—æ³•å‡å°‘Hashç¢°æ’ã€‚</p><p>è€Œ<code>HashMap</code>æ­£æ˜¯é€šè¿‡å¥½çš„Hashç®—æ³•å’Œå“ˆå¸Œæ¡¶çš„æ‰©å®¹æœºåˆ¶æ¥å¹³è¡¡ç©ºé—´ä¸æ—¶é—´ä¹‹é—´çš„å…³ç³»ã€‚</p><h3 id="ä»€ä¹ˆæ—¶å€™è§¦å‘æ‰©å®¹æœºåˆ¶"><a href="#ä»€ä¹ˆæ—¶å€™è§¦å‘æ‰©å®¹æœºåˆ¶" class="headerlink" title="ä»€ä¹ˆæ—¶å€™è§¦å‘æ‰©å®¹æœºåˆ¶"></a>ä»€ä¹ˆæ—¶å€™è§¦å‘æ‰©å®¹æœºåˆ¶</h3><p>åœ¨ä»‹ç»Hashç®—æ³•å’Œæ‰©å®¹æµç¨‹ä¹‹å‰ï¼Œæˆ‘æƒ³å…ˆæä¸€ä¸‹ <code>HashMap</code> åœ¨ä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘æ‰©å®¹æœºåˆ¶ã€‚</p><p>é€šè¿‡æŸ¥çœ‹<code>HashMap</code>æºç å¯çŸ¥ï¼Œæ‰©å®¹æœºåˆ¶æ˜¯é€šè¿‡ <code>resize()</code> æ–¹æ³•å®ç°çš„ï¼Œè€Œæˆ‘ä»¬åœ¨å¾€ <code>HashMap</code> ä¸­æ”¾å…¥å¯¹è±¡æ—¶ï¼Œæ»¡è¶³æ¡ä»¶ <code>(++size &gt; threshold)</code> æ—¶ä¼šè°ƒç”¨ <code>resize()</code> æ–¹æ³•è¿›è¡Œæ‰©å®¹ï¼Œ<code>threshold</code> åœ¨æºç ä¸­ç»™å‡ºçš„è§£é‡Šæ˜¯ï¼šåœ¨ç»™å®š <code>Load factor</code> å’Œ <code>capacity</code> (æ•°ç»„å®¹é‡)ä¸‹æ‰€å…è®¸çš„æœ€å¤§å…ƒç´ æ•°ç›®ï¼Œå³ <code>threshold = capacity * load factor </code> ï¼Œé»˜è®¤çš„è´Ÿè½½å› å­(<code>load factor</code>)æ˜¯0.75ã€‚</p><p>å¦‚æœä½¿ç”¨æ— å‚æ„é€ å™¨åˆ›å»º <code>HashMap</code> é»˜è®¤å®¹é‡ä¸º <code>1 &gt;&gt; 4</code> å³16ï¼Œæ‰€ä»¥å½“æ·»åŠ ç¬¬13ä¸ªå¯¹è±¡æ—¶å°±ä¼šè§¦å‘<code>HashMap</code>çš„æ‰©å®¹æœºåˆ¶ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230928134857618.png" alt="image-20230928134857618"></p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ•°ç»„å®šä¹‰å¥½é•¿åº¦ä¹‹åï¼Œè´Ÿè½½å› å­è¶Šå¤§ï¼Œæ‰€èƒ½å®¹çº³çš„é”®å€¼å¯¹ä¸ªæ•°è¶Šå¤šï¼Œè¶…è¿‡è¿™ä¸ªæ•°ç›®å°±é‡æ–°resize(æ‰©å®¹)ã€‚</p><p>é»˜è®¤çš„è´Ÿè½½å› å­0.75æ˜¯å¯¹ç©ºé—´å’Œæ—¶é—´æ•ˆç‡çš„ä¸€ä¸ªå¹³è¡¡é€‰æ‹©ï¼Œå»ºè®®å¤§å®¶ä¸è¦ä¿®æ”¹ï¼Œé™¤éåœ¨æ—¶é—´å’Œç©ºé—´æ¯”è¾ƒç‰¹æ®Šçš„æƒ…å†µä¸‹ï¼Œå¦‚æœå†…å­˜ç©ºé—´å¾ˆå¤šè€Œåˆå¯¹æ—¶é—´æ•ˆç‡è¦æ±‚å¾ˆé«˜ï¼Œå¯ä»¥é€‚å½“é™ä½è´Ÿè½½å› å­ <code>loadFactor</code> çš„å€¼ï¼›ç›¸åï¼Œå¦‚æœå†…å­˜ç©ºé—´ç´§å¼ è€Œå¯¹æ—¶é—´æ•ˆç‡è¦æ±‚ä¸é«˜ï¼Œå¯ä»¥å¢åŠ è´Ÿè½½å› å­ <code>loadFactor</code> çš„å€¼ï¼Œè¿™ä¸ªå€¼<strong>å¯ä»¥å¤§äº</strong>1ã€‚</p><h3 id="ä¸ºä»€ä¹ˆHashMapçš„å®¹é‡å§‹ç»ˆä¸º2çš„Næ¬¡å¹‚"><a href="#ä¸ºä»€ä¹ˆHashMapçš„å®¹é‡å§‹ç»ˆä¸º2çš„Næ¬¡å¹‚" class="headerlink" title="ä¸ºä»€ä¹ˆHashMapçš„å®¹é‡å§‹ç»ˆä¸º2çš„Næ¬¡å¹‚"></a>ä¸ºä»€ä¹ˆHashMapçš„å®¹é‡å§‹ç»ˆä¸º2çš„Næ¬¡å¹‚</h3><p><code>HashMap</code>æ‰©å®¹åçš„å®¹é‡æ˜¯ä¹‹å‰å®¹é‡çš„ä¸¤å€ã€‚å¹¶ä¸”åœ¨ <code>HashMap</code> ä¸­ï¼Œå“ˆå¸Œæ¡¶æ•°ç»„tableçš„å®¹é‡å¤§å°å§‹ç»ˆä¸º2çš„næ¬¡æ–¹(ä¸€å®šæ˜¯åˆæ•°)ã€‚è¿™æ˜¯ä¸€ç§éå¸¸è§„çš„è®¾è®¡ï¼Œå¸¸è§„çš„è®¾è®¡æ˜¯æŠŠæ¡¶çš„å¤§å°è®¾è®¡ä¸ºç´ æ•°ã€‚ç›¸å¯¹æ¥è¯´ç´ æ•°å¯¼è‡´å†²çªçš„æ¦‚ç‡è¦å°äºåˆæ•°ï¼Œä¾‹å¦‚ <code>Hashtable</code> åˆå§‹åŒ–æ¡¶å¤§å°ä¸º11ï¼Œå°±æ˜¯æ¡¶å¤§å°è®¾è®¡ä¸ºç´ æ•°çš„åº”ç”¨ï¼ˆ<code>Hashtable</code>æ‰©å®¹åä¸èƒ½ä¿è¯è¿˜æ˜¯ç´ æ•°ï¼‰ã€‚</p><p><code>HashMap</code> é‡‡ç”¨è¿™ç§éå¸¸è§„è®¾è®¡ï¼Œä¸»è¦æ˜¯ä¸ºäº†åœ¨<strong>å–æ¨¡å’Œæ‰©å®¹</strong>æ—¶åšä¼˜åŒ–ã€‚</p><p>å¦‚ä¸‹å›¾åœ¨å®¹é‡Nä¸º <code>2 ^ 3 = 8</code> çš„ <code>HashMap</code> ä¸­ï¼Œæˆ‘ä»¬ä¸¾ä¸ªä¾‹å­æ¥è¯æ˜ç´ æ•°çš„å†²çªæ¦‚ç‡è¦å°äºåˆæ•°ï¼š</p><p><img src="https://image.seeyourface.cn/migrate/image-20230928145903047.png" alt="image-20230928145903047"></p><p>é¦–å…ˆï¼ŒäºŒè¿›åˆ¶ä¸­ç”¨ä½è¿ç®—æ¥æ‰§è¡Œå–æ¨¡æ“ä½œï¼Œåªé€‚ç”¨äºæ¨¡æ•°ä¸º<strong>2çš„å€æ•°</strong>çš„æƒ…å†µï¼Œè¿™é‡Œè§£é‡Šäº†<code>HashMap</code>ç”¨2çš„Næ¬¡å¹‚åšå®¹é‡çš„ç¬¬ä¸€ä¸ªåŸå› ã€‚</p><p>K &#x3D; 28 å¯¹ N å–æ¨¡çš„è¿ç®— 28 % N å¯ä»¥è½¬åŒ–ä¸ºä½è¿ç®—çš„ <code>1 1100 &amp; (N - 1)</code> ï¼Œä¸Šé¢çš„ä¾‹å­ç»“æœå°±æ˜¯4ï¼›å†å¯¹å¦ä¸€ä¸ªå…ƒç´  K &#x3D; 20 åšåŒæ ·è¿ç®—ï¼Œæˆ‘ä»¬èƒ½å¾—åˆ°è¯¥å…ƒç´ æœ€ç»ˆå­˜å‚¨çš„ç´¢å¼•ä¹Ÿæ˜¯4ã€‚</p><p>é€šè¿‡ä¸Šå›¾æˆ‘ä»¬å‘ç°ï¼Œå³ä½¿ 28 å’Œ 20 è½¬åŒ–ä¸ºäºŒè¿›åˆ¶åçš„ç¬¬å››ä½ï¼ˆä»å³å¾€å·¦æ•°ï¼‰ä¸ç›¸åŒï¼Œä½†ä»ç„¶å“ˆå¸Œåˆ°äº†åŒä¸€ä¸ªä½ç½®ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™æ—¶å€™å…ƒç´ Kç¬¬å››ä½å°±æ ¹æœ¬ä¸å‚ä¸å“ˆå¸Œè¿ç®—ï¼Œè¿™å°±æ— æ³•å®Œæ•´åœ°åæ˜ å…ƒç´  K çš„ç‰¹æ€§ï¼Œå¢å¤§äº†å¯¼è‡´å†²çªçš„å‡ ç‡ã€‚</p><p>å–å…¶ä»–åˆæ•°æ—¶ï¼Œéƒ½ä¼šä¸åŒç¨‹åº¦çš„å¯¼è‡´cçš„æŸäº›ä½â€å¤±æ•ˆâ€ï¼Œä»è€Œåœ¨ä¸€äº›å¸¸è§åº”ç”¨ä¸­å¯¼è‡´å†²çªã€‚</p><p>ä½†æ˜¯å–è´¨æ•°ï¼ŒåŸºæœ¬å¯ä»¥ä¿è¯Kçš„æ¯ä¸€ä½éƒ½å‚ä¸å“ˆå¸Œè¿ç®—ï¼Œä»è€Œåœ¨å¸¸è§åº”ç”¨ä¸­å‡å°å†²çªå‡ ç‡ï¼ˆå¹¶ä¸èƒ½å®Œå…¨é¿å…ï¼‰ã€‚</p><p>æ‰€ä»¥ä¸ºäº†å‡å°‘å†²çªï¼Œ<code>HashMap</code> å®šä½å“ˆå¸Œæ¡¶ç´¢å¼•ä½ç½®æ—¶ï¼Œä¹ŸåŠ å…¥äº†<strong>é«˜ä½å‚ä¸è¿ç®—</strong>çš„è¿‡ç¨‹ã€‚</p><h3 id="é“¾è¡¨å’Œçº¢é»‘æ ‘çš„ç›¸äº’è½¬åŒ–"><a href="#é“¾è¡¨å’Œçº¢é»‘æ ‘çš„ç›¸äº’è½¬åŒ–" class="headerlink" title="é“¾è¡¨å’Œçº¢é»‘æ ‘çš„ç›¸äº’è½¬åŒ–"></a>é“¾è¡¨å’Œçº¢é»‘æ ‘çš„ç›¸äº’è½¬åŒ–</h3><p>å³ä½¿è´Ÿè½½å› å­å’Œ <code>Hash</code> ç®—æ³•è®¾è®¡çš„å†åˆç†ï¼Œä¹Ÿæ— æ³•é¿å…ä¼šå‡ºç°æ‹‰é“¾è¿‡é•¿çš„æƒ…å†µï¼Œä¸€æ—¦å‡ºç°æ‹‰é“¾è¿‡é•¿ï¼Œåˆ™ä¼šä¸¥é‡å½±å“ <code>HashMap</code> çš„æ€§èƒ½ã€‚</p><p>äºæ˜¯ï¼Œåœ¨ <code>JDK1.8</code> ç‰ˆæœ¬ä¸­ï¼Œå¯¹æ•°æ®ç»“æ„åšäº†è¿›ä¸€æ­¥çš„ä¼˜åŒ–ï¼Œå¼•å…¥äº†çº¢é»‘æ ‘ã€‚è€Œå½“é“¾è¡¨é•¿åº¦å¤ªé•¿è¶…è¿‡ <code>TREEIFY_THRESHOLD</code>ï¼ˆé»˜è®¤ä¸º8ï¼‰æ—¶ï¼Œä¼šè¿›ä¸€æ­¥åˆ¤æ–­æ•°ç»„å®¹é‡ï¼Œ<strong>å¦‚æœæ•°ç»„å®¹é‡å°äº <code>MIN_TREEIFY_CAPACITY</code> (é»˜è®¤ä¸º64)ï¼Œä¼šä¼˜å…ˆå¯¹æ•°ç»„è¿›è¡Œæ‰©å®¹</strong>ï¼Œç„¶åå°†æ•°æ®é‡æ–°æ•£åˆ—åˆ°æ–°çš„å“ˆå¸Œæ¡¶ä¸­ï¼›å¦‚æœæ•°ç»„å®¹é‡å¤§äºç­‰äº64ï¼Œå°±ä¼šå°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œåˆ©ç”¨çº¢é»‘æ ‘å¿«é€Ÿå¢åˆ æ”¹æŸ¥çš„ç‰¹ç‚¹æé«˜ <code>HashMap</code> çš„æ€§èƒ½ã€‚</p><p>åœ¨æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œå¦‚æœåŸæ¥æ•°ç»„ä¸­çº¢é»‘æ ‘çš„èŠ‚ç‚¹ç»é‡æ–°æ•£åˆ—å<strong>å°äºç­‰äº</strong> <code>UNTREEIFY_THRESHOLD</code> (é»˜è®¤ä¸º6)æ—¶ï¼Œçº¢é»‘æ ‘ä¼šé‡æ–°é€€åŒ–ä¸ºé“¾è¡¨ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/img-20230928153456.png" alt="img-20230928153456"></p><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><h4 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// é»˜è®¤æ„é€ å‡½æ•°ã€‚</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">HashMap</span><span class="hljs-params">()</span> &#123;<br>   <span class="hljs-built_in">this</span>.loadFactor = DEFAULT_LOAD_FACTOR; <span class="hljs-comment">// all   other fields defaulted</span><br>&#125;<br><br><span class="hljs-comment">// åŒ…å«å¦ä¸€ä¸ªâ€œMapâ€çš„æ„é€ å‡½æ•°</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">HashMap</span><span class="hljs-params">(Map&lt;? extends K, ? extends V&gt; m)</span> &#123;<br>   <span class="hljs-built_in">this</span>.loadFactor = DEFAULT_LOAD_FACTOR;<br>   putMapEntries(m, <span class="hljs-literal">false</span>);<span class="hljs-comment">//ä¸‹é¢ä¼šåˆ†æåˆ°è¿™ä¸ªæ–¹æ³•</span><br>&#125;<br><br><span class="hljs-comment">// æŒ‡å®šâ€œå®¹é‡å¤§å°â€çš„æ„é€ å‡½æ•°</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">HashMap</span><span class="hljs-params">(<span class="hljs-type">int</span> initialCapacity)</span> &#123;<br>   <span class="hljs-built_in">this</span>(initialCapacity, DEFAULT_LOAD_FACTOR);<br>&#125;<br><br><span class="hljs-comment">// æŒ‡å®šâ€œå®¹é‡å¤§å°â€å’Œâ€œè´Ÿè½½å› å­â€çš„æ„é€ å‡½æ•°</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">HashMap</span><span class="hljs-params">(<span class="hljs-type">int</span> initialCapacity, <span class="hljs-type">float</span> loadFactor)</span> &#123;<br>   <span class="hljs-keyword">if</span> (initialCapacity &lt; <span class="hljs-number">0</span>)<br>       <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Illegal initial capacity: &quot;</span> + initialCapacity);<br>   <span class="hljs-keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)<br>       initialCapacity = MAXIMUM_CAPACITY;<br>   <span class="hljs-keyword">if</span> (loadFactor &lt;= <span class="hljs-number">0</span> || Float.isNaN(loadFactor))<br>       <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Illegal load factor: &quot;</span> + loadFactor);<br>   <span class="hljs-built_in">this</span>.loadFactor = loadFactor;<br>   <span class="hljs-comment">// åˆå§‹å®¹é‡æš‚æ—¶å­˜æ”¾åˆ° threshold ï¼Œåœ¨resizeä¸­å†èµ‹å€¼ç»™ newCap è¿›è¡Œtableåˆå§‹åŒ–</span><br>   <span class="hljs-built_in">this</span>.threshold = tableSizeFor(initialCapacity);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šä¸Šè¿°å››ä¸ªæ„é€ æ–¹æ³•ä¸­ï¼Œéƒ½åˆå§‹åŒ–äº†è´Ÿè½½å› å­ <code>loadFactor</code>ï¼Œç”±äº<code>HashMap</code>ä¸­æ²¡æœ‰ <code>capacity</code> è¿™æ ·çš„å­—æ®µï¼Œå³ä½¿æŒ‡å®šäº†åˆå§‹åŒ–å®¹é‡ <code>initialCapacity</code> ï¼Œä¹Ÿåªæ˜¯é€šè¿‡ <code>tableSizeFor</code> å°†å…¶æ‰©å®¹åˆ°ä¸ <code>initialCapacity</code> <strong>æœ€æ¥è¿‘çš„2çš„å¹‚æ¬¡æ–¹å¤§å°</strong>ï¼Œç„¶åæš‚æ—¶èµ‹å€¼ç»™ <code>threshold</code> ï¼Œåç»­é€šè¿‡ <code>resize</code> æ–¹æ³•å°† <code>threshold</code> èµ‹å€¼ç»™ <code>newCap</code> è¿›è¡Œ <code>table</code> çš„åˆå§‹åŒ–ã€‚</p></blockquote><h4 id="tableSizeFor"><a href="#tableSizeFor" class="headerlink" title="tableSizeFor()"></a>tableSizeFor()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Returns a power of two size for the given target capacity.</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tableSizeFor</span><span class="hljs-params">(<span class="hljs-type">int</span> cap)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> cap - <span class="hljs-number">1</span>;<br>    n |= n &gt;&gt;&gt; <span class="hljs-number">1</span>;<br>    n |= n &gt;&gt;&gt; <span class="hljs-number">2</span>;<br>    n |= n &gt;&gt;&gt; <span class="hljs-number">4</span>;<br>    n |= n &gt;&gt;&gt; <span class="hljs-number">8</span>;<br>    n |= n &gt;&gt;&gt; <span class="hljs-number">16</span>;<br><span class="hljs-keyword">return</span> (n &lt; <span class="hljs-number">0</span>) ? <span class="hljs-number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹ä»»æ„åè¿›åˆ¶æ•°è½¬æ¢ä¸º2çš„æ•´æ•°å¹‚ï¼Œç»“æœæ˜¯è¿™ä¸ªæ•°æœ¬èº«çš„<strong>æœ€é«˜æœ‰æ•ˆä½çš„å‰ä¸€ä½å˜æˆ1ï¼Œæœ€é«˜æœ‰æ•ˆä½ä»¥åŠå…¶åçš„ä½éƒ½å˜ä¸º0</strong>ã€‚</p><p>æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå…ˆ<strong>å°†æœ€é«˜æœ‰æ•ˆä½ä»¥åŠå…¶åçš„ä½éƒ½å˜ä¸º1</strong>ï¼Œæœ€åå†+1ï¼Œå°±è¿›ä½åˆ°å‰ä¸€ä½å˜æˆ1ï¼Œå…¶åæ‰€æœ‰çš„æ»¡2å˜0ã€‚æ‰€ä»¥å…³é”®æ˜¯<strong>å¦‚ä½•å°†æœ€é«˜æœ‰æ•ˆä½åé¢éƒ½å˜ä¸º1</strong>ã€‚</p><ul><li>å³ç§»ä¸€ä½ï¼Œå†æˆ–è¿ç®—ï¼Œæœ€é«˜æœ‰æ•ˆä½å°±æœ‰ä¸¤ä½å˜ä¸º1</li><li>å³ç§»ä¸¤ä½ï¼Œå†æˆ–è¿ç®—ï¼Œæœ€é«˜æœ‰æ•ˆä½å°±æœ‰å››ä½å˜ä¸º1</li><li>å³ç§»16ä½å†æˆ–è¿ç®—ï¼Œä¿è¯32ä½çš„intç±»å‹æ•´æ•°æœ€é«˜æœ‰æ•ˆä½ä¹‹åçš„ä½éƒ½èƒ½å˜ä¸º1ã€‚</li><li>æœ€ååŠ 1å°±èƒ½è¾¾åˆ°æƒ³è¦çš„æ•ˆæœã€‚</li></ul><p>å¼€å§‹ç§»ä½å‰å…ˆå°†å®¹é‡å…ˆå‡1ï¼Œæ˜¯ä¸ºäº†é¿å…ç»™å®šå®¹é‡å·²ç»æ˜¯8, 16è¿™æ ·å·²ç»æ˜¯2çš„å¹‚æ•°æ—¶ï¼Œä¸å‡ä¸€ç›´æ¥ç§»ä½ä¼šå¯¼è‡´å¾—åˆ°çš„ç»“æœæ¯”é¢„æœŸå¤§ã€‚æ¯”å¦‚é¢„æœŸ16å¾—åˆ°åº”è¯¥æ˜¯16ï¼Œç›´æ¥ç§»ä½çš„è¯ä¼šå¾—åˆ°32ã€‚</p><h4 id="putMapEntries"><a href="#putMapEntries" class="headerlink" title="putMapEntries()"></a>putMapEntries()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putMapEntries</span><span class="hljs-params">(Map&lt;? extends K, ? extends V&gt; m, <span class="hljs-type">boolean</span> evict)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> m.size();<br>    <span class="hljs-keyword">if</span> (s &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// åˆ¤æ–­tableæ˜¯å¦å·²ç»åˆå§‹åŒ–</span><br>        <span class="hljs-keyword">if</span> (table == <span class="hljs-literal">null</span>) &#123; <span class="hljs-comment">// pre-size</span><br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">             * æœªåˆå§‹åŒ–ï¼Œsä¸ºmçš„å®é™…å…ƒç´ ä¸ªæ•°ï¼Œft = s/loadFactor =&gt; s=ft*loadFactor, è·Ÿæˆ‘ä»¬å‰é¢æåˆ°çš„</span><br><span class="hljs-comment">             * é˜ˆå€¼=å®¹é‡*è´Ÿè½½å› å­ æ˜¯ä¸æ˜¯å¾ˆåƒï¼ŒftæŒ‡çš„æ˜¯è¦æ·»åŠ sä¸ªå…ƒç´ æ‰€éœ€çš„æœ€å°çš„å®¹é‡ã€‚</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-type">float</span> <span class="hljs-variable">ft</span> <span class="hljs-operator">=</span> ((<span class="hljs-type">float</span>)s / loadFactor) + <span class="hljs-number">1.0F</span>;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> ((ft &lt; (<span class="hljs-type">float</span>)MAXIMUM_CAPACITY) ?<br>                    (<span class="hljs-type">int</span>)ft : MAXIMUM_CAPACITY);<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">             * æ ¹æ®æ„é€ å‡½æ•°å¯çŸ¥ï¼Œtableæœªåˆå§‹åŒ–ï¼Œthresholdå®é™…ä¸Šæ˜¯å­˜æ”¾çš„åˆå§‹åŒ–å®¹é‡ï¼Œå¦‚æœæ·»åŠ sä¸ªå…ƒç´ æ‰€</span><br><span class="hljs-comment">             * éœ€çš„æœ€å°å®¹é‡å¤§äºåˆå§‹åŒ–å®¹é‡ï¼Œåˆ™å°†æœ€å°å®¹é‡æ‰©å®¹ä¸ºæœ€æ¥è¿‘çš„2çš„å¹‚æ¬¡æ–¹å¤§å°ä½œä¸ºåˆå§‹åŒ–ã€‚</span><br><span class="hljs-comment">             * æ³¨æ„è¿™é‡Œä¸æ˜¯åˆå§‹åŒ–é˜ˆå€¼</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-keyword">if</span> (t &gt; threshold)<br>                threshold = tableSizeFor(t);<br>        &#125;<br>        <span class="hljs-comment">// å·²åˆå§‹åŒ–ï¼Œå¹¶ä¸”må…ƒç´ ä¸ªæ•°å¤§äºé˜ˆå€¼ï¼Œè¿›è¡Œæ‰©å®¹å¤„ç†</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (s &gt; threshold)<br>            resize();<br>        <span class="hljs-comment">// å°†mä¸­çš„æ‰€æœ‰å…ƒç´ æ·»åŠ è‡³HashMapä¸­ï¼Œå¦‚æœtableæœªåˆå§‹åŒ–ï¼ŒputValä¸­ä¼šè°ƒç”¨resizeåˆå§‹åŒ–æˆ–æ‰©å®¹</span><br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">K</span>, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">V</span>&gt; e : m.entrySet()) &#123;<br>            <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> e.getKey();<br>            <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> e.getValue();<br>            putVal(hash(key), key, value, <span class="hljs-literal">false</span>, evict);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Hashç®—æ³•"><a href="#Hashç®—æ³•" class="headerlink" title="Hashç®—æ³•"></a>Hashç®—æ³•</h4><p>æ— è®ºæ˜¯å¢åŠ ã€åˆ é™¤è¿˜æ˜¯æŸ¥æ‰¾é”®å€¼å¯¹ï¼Œå®šä½åˆ°å“ˆå¸Œæ¡¶æ•°ç»„çš„ä½ç½®éƒ½æ˜¯å¾ˆå…³é”®çš„ç¬¬ä¸€æ­¥ã€‚å‰é¢è¯´è¿‡ <code>HashMap</code> çš„æ•°æ®ç»“æ„æ˜¯æ•°ç»„å’Œé“¾è¡¨çš„ç»“åˆï¼Œæ‰€ä»¥æˆ‘ä»¬å½“ç„¶å¸Œæœ›è¿™ä¸ª <code>HashMap</code> é‡Œé¢çš„å…ƒç´ ä½ç½®å°½é‡åˆ†å¸ƒå‡åŒ€äº›ï¼Œå°½é‡ä½¿å¾—æ¯ä¸ªä½ç½®ä¸Šçš„å…ƒç´ æ•°é‡åªæœ‰ä¸€ä¸ªï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬ç”¨hashç®—æ³•æ±‚å¾—è¿™ä¸ªä½ç½®çš„æ—¶å€™ï¼Œé©¬ä¸Šå°±å¯ä»¥çŸ¥é“å¯¹åº”ä½ç½®çš„å…ƒç´ å°±æ˜¯æˆ‘ä»¬è¦çš„ï¼Œä¸ç”¨éå†é“¾è¡¨ï¼Œå¤§å¤§ä¼˜åŒ–äº†æŸ¥è¯¢çš„æ•ˆç‡ã€‚</p><p>hashæ–¹æ³•çš„ç¦»æ•£æ€§èƒ½ç›´æ¥å†³å®šäº† <code>HashMap</code> å®šä½æ•°ç»„ç´¢å¼•ä½ç½®æ•ˆç‡ï¼Œæˆ‘ä»¬çœ‹çœ‹æºç æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// JDK1.8</span><br><span class="hljs-comment">// é¦–å…ˆå–å¾—hashCodeçš„å€¼ h</span><br><span class="hljs-comment">// h ä¸ h æ— ç¬¦å·å‘å³ä½ç§»16ä½åšå¼‚æˆ–è¿ç®—ï¼Œç›®çš„æ˜¯è®©é«˜ä½å‚ä¸è¿ç®—ï¼Œè€Œå¼‚æˆ–è¿ç®—ä¿è¯0 1å‡ºç°çš„æ¦‚ç‡ç›¸ç­‰</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hash</span><span class="hljs-params">(Object key)</span> &#123;<br><span class="hljs-type">int</span> h;<br>    <span class="hljs-keyword">return</span> (key == <span class="hljs-literal">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>&#125;<br><br><span class="hljs-comment">// JDK 1.7</span><br><span class="hljs-comment">// ç›¸æ¯”äº JDK1.8 çš„ hash æ–¹æ³• ï¼ŒJDK 1.7 çš„ hash æ–¹æ³•çš„æ€§èƒ½ä¼šç¨å·®ä¸€ç‚¹ç‚¹ï¼Œå› ä¸ºæ¯•ç«Ÿæ‰°åŠ¨äº† 4 æ¬¡ã€‚</span><br><span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hash</span><span class="hljs-params">(<span class="hljs-type">int</span> h)</span> &#123;<br>    <span class="hljs-comment">// This function ensures that hashCodes that differ only by</span><br>    <span class="hljs-comment">// constant multiples at each bit position have a bounded</span><br>    <span class="hljs-comment">// number of collisions (approximately 8 at default load factor).</span><br><br>    h ^= (h &gt;&gt;&gt; <span class="hljs-number">20</span>) ^ (h &gt;&gt;&gt; <span class="hljs-number">12</span>);<br>    <span class="hljs-keyword">return</span> h ^ (h &gt;&gt;&gt; <span class="hljs-number">7</span>) ^ (h &gt;&gt;&gt; <span class="hljs-number">4</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ç¡®å®šå…ƒç´ åœ¨å“ˆå¸Œæ¡¶ä¸­çš„ä½ç½®"><a href="#ç¡®å®šå…ƒç´ åœ¨å“ˆå¸Œæ¡¶ä¸­çš„ä½ç½®" class="headerlink" title="ç¡®å®šå…ƒç´ åœ¨å“ˆå¸Œæ¡¶ä¸­çš„ä½ç½®"></a>ç¡®å®šå…ƒç´ åœ¨å“ˆå¸Œæ¡¶ä¸­çš„ä½ç½®</h4><p>å¯¹äºä»»æ„ç»™å®šçš„å¯¹è±¡ï¼Œåªè¦å®ƒçš„ <code>hashCode()</code> è¿”å›å€¼ç›¸åŒï¼Œé‚£ä¹ˆç¨‹åºè°ƒç”¨æ–¹æ³•ä¸€æ‰€è®¡ç®—å¾—åˆ°çš„Hashç å€¼æ€»æ˜¯ç›¸åŒçš„ã€‚</p><p>æˆ‘ä»¬é¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯æŠŠhashå€¼å¯¹æ•°ç»„é•¿åº¦å–æ¨¡è¿ç®—ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå…ƒç´ çš„åˆ†å¸ƒç›¸å¯¹æ¥è¯´æ˜¯æ¯”è¾ƒå‡åŒ€çš„ã€‚</p><p>ä½†æ˜¯ï¼Œæ¨¡è¿ç®—çš„æ¶ˆè€—è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œåœ¨ <code>HashMap</code> ä¸­æ˜¯è¿™æ ·åšçš„ï¼š<code>HashMap</code> åº•å±‚æ•°ç»„çš„é•¿åº¦æ€»æ˜¯2çš„næ¬¡æ–¹ï¼Œè¿™æ˜¯ <code>HashMap</code> åœ¨é€Ÿåº¦ä¸Šçš„ä¼˜åŒ–ã€‚<strong>å½“lengthæ€»æ˜¯2çš„næ¬¡æ–¹æ—¶</strong>ï¼Œ<code>h &amp; (length-1)</code> è¿ç®—<strong>ç­‰ä»·äº</strong>å¯¹ <code>length</code> å–æ¨¡ï¼Œä¹Ÿå°±æ˜¯ <code>h % length</code>ï¼Œä½†æ˜¯**&amp;æ¯”%å…·æœ‰æ›´é«˜çš„æ•ˆç‡**ã€‚</p><h4 id="put-æ–¹æ³•"><a href="#put-æ–¹æ³•" class="headerlink" title="put()æ–¹æ³•"></a>put()æ–¹æ³•</h4><p><code>HashMap</code> åªæä¾›äº† put ç”¨äºæ·»åŠ å…ƒç´ ï¼ŒputVal æ–¹æ³•åªæ˜¯ç»™ put æ–¹æ³•è°ƒç”¨çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå¹¶æ²¡æœ‰æä¾›ç»™ç”¨æˆ·ä½¿ç”¨ã€‚</p><p><strong>å¯¹ putVal æ–¹æ³•æ·»åŠ å…ƒç´ çš„åˆ†æå¦‚ä¸‹ï¼š</strong></p><ol><li>å¦‚æœå®šä½åˆ°çš„æ•°ç»„ä½ç½®æ²¡æœ‰å…ƒç´  å°±ç›´æ¥æ’å…¥ã€‚</li><li>å¦‚æœå®šä½åˆ°çš„æ•°ç»„ä½ç½®æœ‰å…ƒç´ å°±å’Œè¦æ’å…¥çš„ key æ¯”è¾ƒï¼Œå¦‚æœ key ç›¸åŒå°±ç›´æ¥è¦†ç›–ï¼Œå¦‚æœ key ä¸ç›¸åŒï¼Œå°±åˆ¤æ–­ p æ˜¯å¦æ˜¯ä¸€ä¸ªæ ‘èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯å°±è°ƒç”¨<code>e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(this, tab, hash, key, value)</code>å°†å…ƒç´ æ·»åŠ è¿›å…¥ã€‚å¦‚æœä¸æ˜¯å°±éå†é“¾è¡¨æ’å…¥(æ’å…¥çš„æ˜¯é“¾è¡¨å°¾éƒ¨)ã€‚</li></ol><p><img src="https://image.seeyourface.cn/migrate/image-20230928175621083.png" alt="image-20230928175621083"></p><p>ç”»çš„æœ‰ç‚¹ä¹±ï¼Œå¤§å®¶å°†å°±çœ‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> &#123;<br>    <span class="hljs-keyword">return</span> putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>&#125;<br><br><span class="hljs-keyword">final</span> V <span class="hljs-title function_">putVal</span><span class="hljs-params">(<span class="hljs-type">int</span> hash, K key, V value, <span class="hljs-type">boolean</span> onlyIfAbsent,</span><br><span class="hljs-params">                   <span class="hljs-type">boolean</span> evict)</span> &#123;<br>    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="hljs-type">int</span> n, i;<br>    <span class="hljs-comment">// tableæœªåˆå§‹åŒ–æˆ–è€…é•¿åº¦ä¸º0ï¼Œè¿›è¡Œæ‰©å®¹</span><br>    <span class="hljs-keyword">if</span> ((tab = table) == <span class="hljs-literal">null</span> || (n = tab.length) == <span class="hljs-number">0</span>)<br>        n = (tab = resize()).length;<br>    <span class="hljs-comment">// (n - 1) &amp; hash ç¡®å®šå…ƒç´ å­˜æ”¾åœ¨å“ªä¸ªæ¡¶ä¸­ï¼Œæ¡¶ä¸ºç©ºï¼Œæ–°ç”Ÿæˆç»“ç‚¹æ”¾å…¥æ¡¶ä¸­(æ­¤æ—¶ï¼Œè¿™ä¸ªç»“ç‚¹æ˜¯æ”¾åœ¨æ•°ç»„ä¸­)</span><br>    <span class="hljs-keyword">if</span> ((p = tab[i = (n - <span class="hljs-number">1</span>) &amp; hash]) == <span class="hljs-literal">null</span>)<br>        tab[i] = newNode(hash, key, value, <span class="hljs-literal">null</span>);<br>    <span class="hljs-comment">// æ¡¶ä¸­å·²ç»å­˜åœ¨å…ƒç´ ï¼ˆå¤„ç†hashå†²çªï¼‰</span><br>    <span class="hljs-keyword">else</span> &#123;<br>        Node&lt;K,V&gt; e; K k;<br>        <span class="hljs-comment">//å¿«é€Ÿåˆ¤æ–­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹table[i]çš„keyæ˜¯å¦ä¸æ’å…¥çš„keyä¸€æ ·ï¼Œè‹¥ç›¸åŒå°±ç›´æ¥ä½¿ç”¨æ’å…¥çš„å€¼pæ›¿æ¢æ‰æ—§çš„å€¼eã€‚</span><br>        <span class="hljs-keyword">if</span> (p.hash == hash &amp;&amp;<br>            ((k = p.key) == key || (key != <span class="hljs-literal">null</span> &amp;&amp; key.equals(k))))<br>                e = p;<br>        <span class="hljs-comment">// åˆ¤æ–­æ’å…¥çš„æ˜¯å¦æ˜¯çº¢é»‘æ ‘èŠ‚ç‚¹</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (p <span class="hljs-keyword">instanceof</span> TreeNode)<br>            <span class="hljs-comment">// æ”¾å…¥æ ‘ä¸­</span><br>            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="hljs-built_in">this</span>, tab, hash, key, value);<br>        <span class="hljs-comment">// ä¸æ˜¯çº¢é»‘æ ‘èŠ‚ç‚¹åˆ™è¯´æ˜ä¸ºé“¾è¡¨ç»“ç‚¹</span><br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// åœ¨é“¾è¡¨æœ€æœ«æ’å…¥ç»“ç‚¹</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">binCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; ; ++binCount) &#123;<br>                <span class="hljs-comment">// åˆ°è¾¾é“¾è¡¨çš„å°¾éƒ¨</span><br>                <span class="hljs-keyword">if</span> ((e = p.next) == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-comment">// åœ¨å°¾éƒ¨æ’å…¥æ–°ç»“ç‚¹</span><br>                    p.next = newNode(hash, key, value, <span class="hljs-literal">null</span>);<br>                    <span class="hljs-comment">// ç»“ç‚¹æ•°é‡è¾¾åˆ°é˜ˆå€¼(é»˜è®¤ä¸º 8 )ï¼Œæ‰§è¡Œ treeifyBin æ–¹æ³•</span><br>                    <span class="hljs-comment">// è¿™ä¸ªæ–¹æ³•ä¼šæ ¹æ® HashMap æ•°ç»„æ¥å†³å®šæ˜¯å¦è½¬æ¢ä¸ºçº¢é»‘æ ‘ã€‚</span><br>                    <span class="hljs-comment">// åªæœ‰å½“æ•°ç»„é•¿åº¦å¤§äºæˆ–è€…ç­‰äº 64 çš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šæ‰§è¡Œè½¬æ¢çº¢é»‘æ ‘æ“ä½œï¼Œä»¥å‡å°‘æœç´¢æ—¶é—´ã€‚å¦åˆ™ï¼Œå°±æ˜¯åªæ˜¯å¯¹æ•°ç»„æ‰©å®¹ã€‚</span><br>                    <span class="hljs-keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="hljs-number">1</span>) <span class="hljs-comment">// -1 for 1st</span><br>                        treeifyBin(tab, hash);<br>                    <span class="hljs-comment">// è·³å‡ºå¾ªç¯</span><br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                <span class="hljs-comment">// åˆ¤æ–­é“¾è¡¨ä¸­ç»“ç‚¹çš„keyå€¼ä¸æ’å…¥çš„å…ƒç´ çš„keyå€¼æ˜¯å¦ç›¸ç­‰</span><br>                <span class="hljs-keyword">if</span> (e.hash == hash &amp;&amp;<br>                    ((k = e.key) == key || (key != <span class="hljs-literal">null</span> &amp;&amp; key.equals(k))))<br>                    <span class="hljs-comment">// ç›¸ç­‰ï¼Œè·³å‡ºå¾ªç¯</span><br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-comment">// ç”¨äºéå†æ¡¶ä¸­çš„é“¾è¡¨ï¼Œä¸å‰é¢çš„e = p.nextç»„åˆï¼Œå¯ä»¥éå†é“¾è¡¨</span><br>                p = e;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// è¡¨ç¤ºåœ¨æ¡¶ä¸­æ‰¾åˆ°keyå€¼ã€hashå€¼ä¸æ’å…¥å…ƒç´ ç›¸ç­‰çš„ç»“ç‚¹</span><br>        <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// è®°å½•eçš„value</span><br>            <span class="hljs-type">V</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> e.value;<br>            <span class="hljs-comment">// onlyIfAbsentä¸ºfalseæˆ–è€…æ—§å€¼ä¸ºnull</span><br>            <span class="hljs-keyword">if</span> (!onlyIfAbsent || oldValue == <span class="hljs-literal">null</span>)<br>                <span class="hljs-comment">//ç”¨æ–°å€¼æ›¿æ¢æ—§å€¼</span><br>                e.value = value;<br>            <span class="hljs-comment">// è®¿é—®åå›è°ƒ</span><br>            afterNodeAccess(e);<br>            <span class="hljs-comment">// è¿”å›æ—§å€¼</span><br>            <span class="hljs-keyword">return</span> oldValue;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// ç»“æ„æ€§ä¿®æ”¹</span><br>    ++modCount;<br>    <span class="hljs-comment">// å®é™…å¤§å°å¤§äºé˜ˆå€¼åˆ™æ‰©å®¹</span><br>    <span class="hljs-keyword">if</span> (++size &gt; threshold)<br>        resize();<br>    <span class="hljs-comment">// æ’å…¥åå›è°ƒ</span><br>    afterNodeInsertion(evict);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="get-æ–¹æ³•"><a href="#get-æ–¹æ³•" class="headerlink" title="get()æ–¹æ³•"></a>get()æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br>    Node&lt;K,V&gt; e;<br>    <span class="hljs-keyword">return</span> (e = getNode(hash(key), key)) == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : e.value;<br>&#125;<br><br><span class="hljs-keyword">final</span> Node&lt;K,V&gt; <span class="hljs-title function_">getNode</span><span class="hljs-params">(<span class="hljs-type">int</span> hash, Object key)</span> &#123;<br>    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; <span class="hljs-type">int</span> n; K k;<br>    <span class="hljs-keyword">if</span> ((tab = table) != <span class="hljs-literal">null</span> &amp;&amp; (n = tab.length) &gt; <span class="hljs-number">0</span> &amp;&amp;<br>        (first = tab[(n - <span class="hljs-number">1</span>) &amp; hash]) != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// æ•°ç»„å…ƒç´ ç›¸ç­‰</span><br>        <span class="hljs-keyword">if</span> (first.hash == hash &amp;&amp; <span class="hljs-comment">// always check first node</span><br>            ((k = first.key) == key || (key != <span class="hljs-literal">null</span> &amp;&amp; key.equals(k))))<br>            <span class="hljs-keyword">return</span> first;<br>        <span class="hljs-comment">// æ¡¶ä¸­ä¸æ­¢ä¸€ä¸ªèŠ‚ç‚¹</span><br>        <span class="hljs-keyword">if</span> ((e = first.next) != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// åœ¨æ ‘ä¸­get</span><br>            <span class="hljs-keyword">if</span> (first <span class="hljs-keyword">instanceof</span> TreeNode)<br>                <span class="hljs-keyword">return</span> ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);<br>            <span class="hljs-comment">// åœ¨é“¾è¡¨ä¸­get</span><br>            <span class="hljs-keyword">do</span> &#123;<br>                <span class="hljs-keyword">if</span> (e.hash == hash &amp;&amp;<br>                    ((k = e.key) == key || (key != <span class="hljs-literal">null</span> &amp;&amp; key.equals(k))))<br>                    <span class="hljs-keyword">return</span> e;<br>            &#125; <span class="hljs-keyword">while</span> ((e = e.next) != <span class="hljs-literal">null</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="resize-æ–¹æ³•"><a href="#resize-æ–¹æ³•" class="headerlink" title="resize()æ–¹æ³•"></a>resize()æ–¹æ³•</h4><p>è¿›è¡Œæ‰©å®¹ï¼Œä¼šä¼´éšç€ä¸€æ¬¡é‡æ–° hash åˆ†é…ï¼Œå¹¶ä¸”ä¼šéå† hash è¡¨ä¸­æ‰€æœ‰çš„å…ƒç´ ï¼Œæ˜¯éå¸¸è€—æ—¶çš„ã€‚åœ¨ç¼–å†™ç¨‹åºä¸­ï¼Œè¦å°½é‡é¿å… resizeã€‚resizeæ–¹æ³•å®é™…ä¸Šæ˜¯å°† table åˆå§‹åŒ–å’Œ table æ‰©å®¹ è¿›è¡Œäº†æ•´åˆï¼Œåº•å±‚çš„è¡Œä¸ºéƒ½æ˜¯ç»™ table èµ‹å€¼ä¸€ä¸ªæ–°çš„æ•°ç»„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;<br>    Node&lt;K,V&gt;[] oldTab = table;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">oldCap</span> <span class="hljs-operator">=</span> (oldTab == <span class="hljs-literal">null</span>) ? <span class="hljs-number">0</span> : oldTab.length;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">oldThr</span> <span class="hljs-operator">=</span> threshold;<br>    <span class="hljs-type">int</span> newCap, newThr = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (oldCap &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// è¶…è¿‡æœ€å¤§å€¼å°±ä¸å†æ‰©å……äº†ï¼Œå°±åªå¥½éšä½ ç¢°æ’å»å§</span><br>        <span class="hljs-keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;<br>            threshold = Integer.MAX_VALUE;<br>            <span class="hljs-keyword">return</span> oldTab;<br>        &#125;<br>        <span class="hljs-comment">// æ²¡è¶…è¿‡æœ€å¤§å€¼ï¼Œå°±æ‰©å……ä¸ºåŸæ¥çš„2å€</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="hljs-number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp; oldCap &gt;= DEFAULT_INITIAL_CAPACITY)<br>            newThr = oldThr &lt;&lt; <span class="hljs-number">1</span>; <span class="hljs-comment">// double threshold</span><br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oldThr &gt; <span class="hljs-number">0</span>) <span class="hljs-comment">// initial capacity was placed in threshold</span><br>        <span class="hljs-comment">// åˆ›å»ºå¯¹è±¡æ—¶åˆå§‹åŒ–å®¹é‡å¤§å°æ”¾åœ¨thresholdä¸­ï¼Œæ­¤æ—¶åªéœ€è¦å°†å…¶ä½œä¸ºæ–°çš„æ•°ç»„å®¹é‡</span><br>        newCap = oldThr;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// signifies using defaults æ— å‚æ„é€ å‡½æ•°åˆ›å»ºçš„å¯¹è±¡åœ¨è¿™é‡Œè®¡ç®—å®¹é‡å’Œé˜ˆå€¼</span><br>        newCap = DEFAULT_INITIAL_CAPACITY;<br>        newThr = (<span class="hljs-type">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (newThr == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// åˆ›å»ºæ—¶æŒ‡å®šäº†åˆå§‹åŒ–å®¹é‡æˆ–è€…è´Ÿè½½å› å­ï¼Œåœ¨è¿™é‡Œè¿›è¡Œé˜ˆå€¼åˆå§‹åŒ–ï¼Œ</span><br>    <span class="hljs-comment">// æˆ–è€…æ‰©å®¹å‰çš„æ—§å®¹é‡å°äº16ï¼Œåœ¨è¿™é‡Œè®¡ç®—æ–°çš„resizeä¸Šé™</span><br>        <span class="hljs-type">float</span> <span class="hljs-variable">ft</span> <span class="hljs-operator">=</span> (<span class="hljs-type">float</span>)newCap * loadFactor;<br>        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="hljs-type">float</span>)MAXIMUM_CAPACITY ? (<span class="hljs-type">int</span>)ft : Integer.MAX_VALUE);<br>    &#125;<br>    threshold = newThr;<br>    <span class="hljs-meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span><br>        Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>[newCap];<br>    table = newTab;<br>    <span class="hljs-keyword">if</span> (oldTab != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// æŠŠæ—§å“ˆå¸Œè¡¨ä¸­çš„æ¯ä¸ªbucketéƒ½ç§»åŠ¨åˆ°æ–°çš„bucketsä¸­</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; oldCap; ++j) &#123;<br>            Node&lt;K,V&gt; e;<br>            <span class="hljs-keyword">if</span> ((e = oldTab[j]) != <span class="hljs-literal">null</span>) &#123;<br>                oldTab[j] = <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">if</span> (e.next == <span class="hljs-literal">null</span>)<br>                    <span class="hljs-comment">// åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç›´æ¥è®¡ç®—å…ƒç´ æ–°çš„ä½ç½®å³å¯</span><br>                    newTab[e.hash &amp; (newCap - <span class="hljs-number">1</span>)] = e;<br>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> TreeNode)<br>                    <span class="hljs-comment">// å°†çº¢é»‘æ ‘æ‹†åˆ†æˆ2æ£µå­æ ‘ï¼Œæ‹†åˆ†åçš„å­æ ‘èŠ‚ç‚¹æ•°å°äºç­‰äº6ï¼Œåˆ™å°†æ ‘è½¬åŒ–æˆé“¾è¡¨</span><br>                    ((TreeNode&lt;K,V&gt;)e).split(<span class="hljs-built_in">this</span>, newTab, j, oldCap);<br>                <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">// å®šä¹‰ä½ä½é“¾è¡¨çš„å¤´èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹</span><br>                    Node&lt;K,V&gt; loHead = <span class="hljs-literal">null</span>, loTail = <span class="hljs-literal">null</span>;<br>                    <span class="hljs-comment">// å®šä¹‰é«˜ä½é“¾è¡¨çš„å¤´èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹</span><br>                    Node&lt;K,V&gt; hiHead = <span class="hljs-literal">null</span>, hiTail = <span class="hljs-literal">null</span>;<br>                    Node&lt;K,V&gt; next;<br>                    <span class="hljs-keyword">do</span> &#123;<br>                        next = e.next;<br>                        <span class="hljs-comment">// åˆ¤æ–­åŸhashå€¼æœ‰æ•ˆä½çš„é«˜ä¸€ä½æ˜¯0ï¼Œè¿æ¥åˆ°ä½ä½é“¾è¡¨ï¼Œå¹¶ä¿æŒå…ƒç´ çš„ç›¸å¯¹é¡ºåºä¸å˜ï¼ŒèŠ‚çœå¯¹æ–°æ•°ç»„é•¿åº¦é‡æ–°å–æ¨¡çš„æ—¶é—´</span><br>                        <span class="hljs-keyword">if</span> ((e.hash &amp; oldCap) == <span class="hljs-number">0</span>) &#123;<br>                            <span class="hljs-keyword">if</span> (loTail == <span class="hljs-literal">null</span>)<br>                                loHead = e;<br>                            <span class="hljs-keyword">else</span><br>                                loTail.next = e;<br>                            loTail = e;<br>                        &#125;<br>                        <span class="hljs-comment">// åˆ¤æ–­åŸhashå€¼æœ‰æ•ˆä½çš„é«˜ä¸€ä½æ˜¯0ï¼Œè¿æ¥åˆ°é«˜ä½é“¾è¡¨ï¼Œå¹¶ä¿æŒå…ƒç´ çš„ç›¸å¯¹é¡ºåºä¸å˜ï¼ŒèŠ‚çœå¯¹æ–°æ•°ç»„é•¿åº¦é‡æ–°å–æ¨¡çš„æ—¶é—´  </span><br>                        <span class="hljs-keyword">else</span> &#123;<br>                            <span class="hljs-keyword">if</span> (hiTail == <span class="hljs-literal">null</span>)<br>                                hiHead = e;<br>                            <span class="hljs-keyword">else</span><br>                                hiTail.next = e;<br>                            hiTail = e;<br>                        &#125;<br>                    &#125; <span class="hljs-keyword">while</span> ((e = next) != <span class="hljs-literal">null</span>);<br>                    <span class="hljs-comment">// ä½ä½é“¾è¡¨çš„å¤´èŠ‚ç‚¹è¿æ¥åˆ°åŸç´¢å¼•ä½ç½®çš„bucketé‡Œ</span><br>                    <span class="hljs-keyword">if</span> (loTail != <span class="hljs-literal">null</span>) &#123;<br>                        loTail.next = <span class="hljs-literal">null</span>;<br>                        newTab[j] = loHead;<br>                    &#125;<br>                    <span class="hljs-comment">// é«˜ä½é“¾è¡¨çš„å¤´èŠ‚ç‚¹è¿æ¥åˆ°åŸç´¢å¼•ä½ç½® + oldCapçš„bucketé‡Œ</span><br>                    <span class="hljs-keyword">if</span> (hiTail != <span class="hljs-literal">null</span>) &#123;<br>                        hiTail.next = <span class="hljs-literal">null</span>;<br>                        newTab[j + oldCap] = hiHead;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> newTab;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æºç </category>
      
      <category>JDK</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HashMap</tag>
      
      <tag>å“ˆå¸Œè¡¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MySQLçš„è‡ªå¢ä¸»é”®ä¸€å®šæ˜¯è¿ç»­çš„å—ï¼Ÿ</title>
    <link href="/2023/09/26/MySQL%E7%9A%84%E8%87%AA%E5%A2%9E%E4%B8%BB%E9%94%AE%E4%B8%80%E5%AE%9A%E6%98%AF%E8%BF%9E%E7%BB%AD%E7%9A%84%E5%90%97%EF%BC%9F/"/>
    <url>/2023/09/26/MySQL%E7%9A%84%E8%87%AA%E5%A2%9E%E4%B8%BB%E9%94%AE%E4%B8%80%E5%AE%9A%E6%98%AF%E8%BF%9E%E7%BB%AD%E7%9A%84%E5%90%97%EF%BC%9F/</url>
    
    <content type="html"><![CDATA[<h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>MySQLè‡ªå¢ä¸»é”®çš„ä½œç”¨æ˜¯åœ¨è‡ªå¢åˆ—ä¸Šå®šä¹‰ä¸€ä¸ªä¸»é”®ï¼Œè®©ä¸»é”®çš„å€¼ç”±æ•°æ®åº“ç³»ç»Ÿè‡ªåŠ¨åˆ†é…ï¼Œè€Œä¸éœ€è¦ç”¨æˆ·è¾“å…¥ã€‚è¿™æ ·å¯ä»¥é¿å…ä¸»é”®é‡å¤æˆ–ç¼ºå¤±ï¼Œæé«˜æ’å…¥æ•°æ®çš„æ•ˆç‡ï¼Œä¿æŒä¸»é”®ç´¢å¼•çš„é€’å¢é¡ºåºï¼Œå‡å°‘<em>ç´¢å¼•çš„ç¢ç‰‡åŒ–</em>ã€‚</p><blockquote><p>ç´¢å¼•çš„ç¢ç‰‡åŒ–æ˜¯æŒ‡ç´¢å¼•ä¸­çš„æ•°æ®åœ¨ç‰©ç†å­˜å‚¨ä¸Šä¸è¿ç»­ï¼Œè€Œæ˜¯åˆ†æ•£åœ¨ç£ç›˜ä¸Šçš„ä¸åŒä½ç½®ã€‚è¿™æ ·ä¼šå¯¼è‡´æŸ¥è¯¢éœ€è¦æ›´å¤šçš„ç£ç›˜I&#x2F;Oæ“ä½œï¼Œé™ä½æŸ¥è¯¢æ€§èƒ½å’Œèµ„æºåˆ©ç”¨ç‡ã€‚</p></blockquote><p>ä½†å®é™…ä¸Šï¼ŒMySQLçš„è‡ªå¢ä¸»é”®å¹¶ä¸èƒ½ä¿è¯ä¸€å®šæ˜¯è¿ç»­è‡ªå¢çš„ã€‚</p><p>å…ˆåˆ›å»ºä¸€å¼ è¡¨ï¼Œå…¶ä¸­idä¸ºä¸»é”®ä¸”è‡ªå¢ï¼Œå­—æ®µaåˆ›å»ºäº†ä¸€ä¸ªå”¯ä¸€ç´¢å¼•ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230926112247507.png" alt="image-20230926112247507"></p><h3 id="è‡ªå¢å€¼ä¿å­˜åœ¨å“ªï¼Ÿ"><a href="#è‡ªå¢å€¼ä¿å­˜åœ¨å“ªï¼Ÿ" class="headerlink" title="è‡ªå¢å€¼ä¿å­˜åœ¨å“ªï¼Ÿ"></a>è‡ªå¢å€¼ä¿å­˜åœ¨å“ªï¼Ÿ</h3><p>æ‰§è¡Œ<code>insert test_incr(a, b) values(1,1);</code>æ’å…¥ä¸€æ¡æ•°æ®ï¼›å†æ‰§è¡Œ<code>show create table test_incr;</code>å‘½ä»¤æŸ¥çœ‹è¡¨çš„ç»“æ„ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230926113445991.png" alt="image-20230926113445991"></p><p>ä¸Šè¿°è¡¨çš„ç»“æ„å®šä¹‰å­˜æ”¾åœ¨åç¼€åä¸º <code>.frm</code> çš„æœ¬åœ°æ–‡ä»¶ä¸­ï¼Œåœ¨ MySQL å®‰è£…ç›®å½•ä¸‹çš„ data æ–‡ä»¶å¤¹ä¸‹å¯ä»¥æ‰¾åˆ°è¿™ä¸ª <code>.frm</code> æ–‡ä»¶ï¼š</p><p><img src="https://image.seeyourface.cn/migrate/img-20230926113940.png" alt="img-20230926113940"></p><p>ä»ä¸Šè¿°è¡¨ç»“æ„å¯ä»¥çœ‹åˆ°ï¼Œè¡¨å®šä¹‰é‡Œé¢å‡ºç°äº†ä¸€ä¸ª <code>AUTO_INCREMENT=2</code>ï¼Œè¡¨ç¤ºä¸‹ä¸€æ¬¡æ’å…¥æ•°æ®æ—¶ï¼Œå¦‚æœéœ€è¦è‡ªåŠ¨ç”Ÿæˆè‡ªå¢å€¼ï¼Œä¼šç”Ÿæˆ id &#x3D; 2ã€‚</p><p>ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè‡ªå¢å€¼å¹¶ä¸ä¼šä¿å­˜åœ¨è¿™ä¸ªè¡¨ç»“æ„ä¹Ÿå°±æ˜¯ <code>.frm</code> æ–‡ä»¶ä¸­ï¼Œä¸åŒçš„å¼•æ“å¯¹äºè‡ªå¢å€¼çš„ä¿å­˜ç­–ç•¥ä¸åŒï¼š</p><ol><li>MyISAM å¼•æ“çš„è‡ªå¢å€¼ä¿å­˜åœ¨æ•°æ®æ–‡ä»¶ä¸­</li><li>InnoDB å¼•æ“çš„è‡ªå¢å€¼ï¼Œå…¶å®æ˜¯ä¿å­˜åœ¨äº†å†…å­˜é‡Œï¼Œå¹¶æ²¡æœ‰æŒä¹…åŒ–ã€‚ç¬¬ä¸€æ¬¡æ‰“å¼€è¡¨çš„æ—¶å€™ï¼Œéƒ½ä¼šå»æ‰¾è‡ªå¢å€¼çš„æœ€å¤§å€¼ <code>max(id)</code>ï¼Œç„¶åå°† <code>max(id)+1</code> ä½œä¸ºè¿™ä¸ªè¡¨å½“å‰çš„è‡ªå¢å€¼ã€‚</li></ol><p>ä¸¾ä¸ªä¾‹å­ï¼šç°åœ¨è¡¨é‡Œå½“å‰æ•°æ®è¡Œé‡Œæœ€å¤§çš„ id æ˜¯ 1ï¼ŒAUTO_INCREMENT&#x3D;2å¯¹å§ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬åˆ é™¤ id&#x3D;1 çš„è¡Œï¼ŒAUTO_INCREMENT è¿˜æ˜¯ 2ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230926114409154.png" alt="image-20230926114409154"></p><p>ä½†å¦‚æœé©¬ä¸Šé‡å¯ MySQL å®ä¾‹ï¼Œé‡å¯åè¿™ä¸ªè¡¨çš„ AUTO_INCREMENT å°±ä¼šå˜æˆ 1ã€‚ï»¿ä¹Ÿå°±æ˜¯è¯´ï¼ŒMySQL é‡å¯å¯èƒ½ä¼šä¿®æ”¹ä¸€ä¸ªè¡¨çš„ <strong>AUTO_INCREMENT</strong> çš„å€¼ã€‚</p><p>æˆ‘ä»¬è¶MySQLä¸æ³¨æ„ï¼Œä½¿ç”¨<code>kill -9 pid</code>æ€æ‰MySQLæœåŠ¡ï¼ˆä¸»æ‰“çš„å°±æ˜¯ä¸€ä¸ªä¸è®²æ­¦å¾·ï¼‰ï¼Œç„¶åé‡å¯æœåŠ¡ï¼Œå†æ¬¡æ‰§è¡Œ<code>show create table test_incr;</code></p><p><img src="https://image.seeyourface.cn/migrate/image-20230926140109271.png" alt="image-20230926140109271"></p><p>æ­¤æ—¶æˆ‘ä»¬å‘ç°<strong>AUTO_INCREMENT</strong>æ²¡æœ‰æ˜¾ç¤ºï¼Œæ˜¯å› ä¸ºé»˜è®¤ç­‰äº1ä¸ä¼šå±•ç¤ºã€‚</p><p>ä»¥ä¸Šæµ‹è¯•åŸºäºMySQLæ•°æ®åº“çš„<strong>5.7.36</strong>ç‰ˆæœ¬ï¼Œå­˜å‚¨å¼•æ“ä¸º<strong>INNODB</strong>ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230926140417057.png" alt="image-20230926140417057"></p><p>å®é™…ä¸Šï¼Œåˆ°äº† MySQL 8.0 ç‰ˆæœ¬åï¼Œè‡ªå¢å€¼çš„å˜æ›´è®°å½•è¢«æ”¾åœ¨äº† <strong>redo log</strong> ä¸­ï¼Œæä¾›äº†è‡ªå¢å€¼æŒä¹…åŒ–çš„èƒ½åŠ›ï¼Œä¹Ÿå°±æ˜¯å®ç°äº†â€œå¦‚æœå‘ç”Ÿé‡å¯ï¼Œè¡¨çš„è‡ªå¢å€¼å¯ä»¥æ ¹æ® redo  log æ¢å¤ä¸º MySQL é‡å¯å‰çš„å€¼â€ã€‚</p><p>ä¹Ÿå°±æ˜¯å¯¹äºä¸Šé¢è¿™ä¸ªä¾‹å­æ¥è¯´ï¼Œé‡å¯å®ä¾‹åè¿™ä¸ªè¡¨çš„ AUTO_INCREMENT ä»ç„¶æ˜¯ 2ã€‚</p><p>ç†è§£äº† MySQL è‡ªå¢å€¼åˆ°åº•ä¿å­˜åœ¨å“ªé‡Œä»¥åï¼Œå†æ¥çœ‹çœ‹è‡ªå¢å€¼çš„ä¿®æ”¹æœºåˆ¶ï¼Œå¹¶ä¸ºå¤§å®¶ä»‹ç»ä¸€äº›è‡ªå¢å€¼ä¸è¿ç»­çš„åœºæ™¯ï¼Œä»¥ä¸‹ç»“è®ºåŸºäºMySQL8ï¼Œå­˜å‚¨å¼•æ“INNODBã€‚</p><h3 id="è‡ªå¢åˆ—æŒ‡å®šå€¼"><a href="#è‡ªå¢åˆ—æŒ‡å®šå€¼" class="headerlink" title="è‡ªå¢åˆ—æŒ‡å®šå€¼"></a>è‡ªå¢åˆ—æŒ‡å®šå€¼</h3><p>åœ¨ MySQL é‡Œé¢ï¼Œå¦‚æœå­—æ®µ id è¢«å®šä¹‰ä¸º AUTO_INCREMENTï¼Œåœ¨æ’å…¥ä¸€è¡Œæ•°æ®çš„æ—¶å€™ï¼Œè‡ªå¢å€¼çš„è¡Œä¸ºå¦‚ä¸‹ï¼š</p><ul><li>å¦‚æœæ’å…¥æ•°æ®æ—¶ id å­—æ®µæŒ‡å®šä¸º 0ã€null æˆ–æœªæŒ‡å®šå€¼ï¼Œé‚£ä¹ˆå°±æŠŠè¿™ä¸ªè¡¨å½“å‰çš„ AUTO_INCREMENT å€¼å¡«åˆ°è‡ªå¢å­—æ®µï¼›</li><li>å¦‚æœæ’å…¥æ•°æ®æ—¶ id å­—æ®µæŒ‡å®šäº†å…·ä½“çš„å€¼ï¼Œå°±ç›´æ¥ä½¿ç”¨è¯­å¥é‡ŒæŒ‡å®šçš„å€¼ã€‚</li></ul><p>æ ¹æ®è¦æ’å…¥çš„å€¼å’Œå½“å‰è‡ªå¢å€¼çš„å¤§å°å…³ç³»ï¼Œè‡ªå¢å€¼çš„å˜æ›´ç»“æœä¹Ÿä¼šæœ‰æ‰€ä¸åŒã€‚å‡è®¾æŸæ¬¡è¦æ’å…¥çš„å€¼æ˜¯ <code>insert_num</code>ï¼Œå½“å‰çš„è‡ªå¢å€¼æ˜¯ <code>autoIncrement_num</code>ï¼š</p><ul><li>å¦‚æœ <code>insert_num &lt; autoIncrement_num</code>ï¼Œé‚£ä¹ˆè¿™ä¸ªè¡¨çš„è‡ªå¢å€¼ä¸å˜</li><li>å¦‚æœ <code>insert_num &gt;= autoIncrement_num</code>ï¼Œå°±éœ€è¦æŠŠå½“å‰è‡ªå¢å€¼ä¿®æ”¹ä¸ºæ–°çš„è‡ªå¢å€¼</li></ul><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæ’å…¥çš„ id æ˜¯ 100ï¼Œå½“å‰çš„è‡ªå¢å€¼æ˜¯ 90ï¼Œ<code>insert_num &gt;= autoIncrement_num</code>ï¼Œé‚£ä¹ˆè‡ªå¢å€¼å°±ä¼šè¢«ä¿®æ”¹ä¸ºæ–°çš„è‡ªå¢å€¼å³ 101â€¦</p><p>ä¸€å®šå¦‚æ­¤å—ï¼Ÿ</p><p>å‡¡æ˜¯æ²¡æœ‰ç»å¯¹~~~</p><p>MySQLä¸­æ˜¯é€šè¿‡<code>auto_increment_offset</code> å’Œ <code>auto_increment_increment</code> è¿™ä¸¤ä¸ªå‚æ•°æ¥å®ç°ä¸»é”®è‡ªå¢çš„ï¼Œè¿™ä¿©åˆ†åˆ«ç”¨æ¥è¡¨ç¤ºè‡ªå¢çš„åˆå§‹å€¼å’Œæ­¥é•¿ï¼Œé»˜è®¤å€¼éƒ½æ˜¯ 1ã€‚</p><p>æ‰€ä»¥ï¼Œä¸Šé¢çš„ä¾‹å­ä¸­ç”Ÿæˆæ–°çš„è‡ªå¢å€¼çš„æ­¥éª¤å®é™…æ˜¯è¿™æ ·çš„ï¼šä» <code>auto_increment_offset</code> å¼€å§‹ï¼Œä»¥ <code>auto_increment_increment</code> ä¸ºæ­¥é•¿ï¼ŒæŒç»­å åŠ ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äº 100  çš„å€¼ï¼Œä½œä¸ºæ–°çš„è‡ªå¢å€¼ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå½“æ­¥é•¿ä¸ç­‰äº1æ—¶ï¼Œè‡ªå¢å€¼å¯èƒ½ä¼šæ˜¯ 102ï¼Œ103 ç­‰ç­‰ä¹‹ç±»çš„ï¼Œå°±ä¼šå¯¼è‡´ä¸è¿ç»­çš„ä¸»é”® idã€‚</p><p>æ›´é—æ†¾çš„æ˜¯ï¼Œå³ä½¿åœ¨è‡ªå¢åˆå§‹å€¼å’Œæ­¥é•¿è¿™ä¸¤ä¸ªå‚æ•°éƒ½è®¾ç½®ä¸º 1 çš„æ—¶å€™ï¼Œè‡ªå¢ä¸»é”® id ä¹Ÿä¸ä¸€å®šèƒ½ä¿è¯ä¸»é”®æ˜¯è¿ç»­çš„ã€‚</p><h3 id="å”¯ä¸€é”®å†²çª"><a href="#å”¯ä¸€é”®å†²çª" class="headerlink" title="å”¯ä¸€é”®å†²çª"></a>å”¯ä¸€é”®å†²çª</h3><p>æˆ‘ä»¬ä¹‹å‰å¾€è¡¨é‡Œæ’å…¥ä¸€æ¡ (null,1,1) çš„è®°å½•ï¼Œç”Ÿæˆçš„ä¸»é”®æ˜¯ 1ï¼ŒAUTO_INCREMENT&#x3D; 2ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230926152320949.png" alt="image-20230926152320949"></p><p>è¿™æ—¶æˆ‘å†æ‰§è¡Œä¸€æ¡æ’å…¥ <code>(null,1,1)</code> çš„å‘½ä»¤ï¼Œå¾ˆæ˜¾ç„¶ä¼šæŠ¥é”™ <code>Duplicate entry</code>ï¼Œå› ä¸ºæˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ªå”¯ä¸€ç´¢å¼•å­—æ®µ <code>a</code>ï¼š</p><p><img src="https://image.seeyourface.cn/migrate/image-20230926152525247.png" alt="image-20230926152525247"></p><p>ä½†æ˜¯æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œè™½ç„¶æ’å…¥å¤±è´¥äº†ï¼ŒAUTO_INCREMENTçš„å€¼ä»2å˜ä¸ºäº†3ï¼</p><p>å…·ä½“åŸå› æ¥åˆ†æä¸‹è¿™ä¸ª insert è¯­å¥çš„æ‰§è¡Œæµç¨‹ï¼š</p><ol><li>æ‰§è¡Œå™¨è°ƒç”¨ InnoDB å¼•æ“æ¥å£å‡†å¤‡æ’å…¥ä¸€è¡Œè®°å½• (null,1,1);</li><li>InnoDB å‘ç°ç”¨æˆ·æ²¡æœ‰æŒ‡å®šè‡ªå¢ id çš„å€¼ï¼Œåˆ™è·å–è¡¨ <code>test_pk</code> å½“å‰çš„è‡ªå¢å€¼ 2ï¼›</li><li>å°†ä¼ å…¥çš„è®°å½•æ”¹æˆ (2,1,1);</li><li>å°†è¡¨çš„è‡ªå¢å€¼æ”¹æˆ 3ï¼›</li><li>ç»§ç»­æ‰§è¡Œæ’å…¥æ•°æ®æ“ä½œï¼Œç”±äºå·²ç»å­˜åœ¨ a&#x3D;1 çš„è®°å½•ï¼Œæ‰€ä»¥æŠ¥ Duplicate key errorï¼Œè¯­å¥è¿”å›ã€‚</li></ol><p>å¯ä»¥çœ‹åˆ°ï¼Œè‡ªå¢å€¼ä¿®æ”¹çš„è¿™ä¸ªæ“ä½œï¼Œæ˜¯åœ¨çœŸæ­£æ‰§è¡Œæ’å…¥æ•°æ®çš„æ“ä½œä¹‹å‰ã€‚</p><p>è¿™ä¸ªè¯­å¥çœŸæ­£æ‰§è¡Œçš„æ—¶å€™ï¼Œå› ä¸ºç¢°åˆ°å”¯ä¸€é”® a å†²çªï¼Œæ‰€ä»¥ id &#x3D; 2 è¿™ä¸€è¡Œå¹¶æ²¡æœ‰æ’å…¥æˆåŠŸï¼Œä½†ä¹Ÿæ²¡æœ‰å°†è‡ªå¢å€¼å†æ”¹å›å»ã€‚æ‰€ä»¥ï¼Œåœ¨è¿™ä¹‹åï¼Œå†æ’å…¥æ–°çš„æ•°æ®è¡Œæ—¶ï¼Œæ‹¿åˆ°çš„è‡ªå¢ id å°±æ˜¯ 3ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå‡ºç°äº†è‡ªå¢ä¸»é”®ä¸è¿ç»­çš„æƒ…å†µã€‚</p><h3 id="äº‹åŠ¡å›æ»š"><a href="#äº‹åŠ¡å›æ»š" class="headerlink" title="äº‹åŠ¡å›æ»š"></a>äº‹åŠ¡å›æ»š</h3><p>ç°åœ¨æˆ‘ä»¬è¡¨é‡Œæœ‰ä¸€è¡Œ <code>(1,1,1)</code> çš„è®°å½•ï¼Œå¹¶ä¸”AUTO_INCREMENT &#x3D; 3ï¼š</p><p><img src="https://image.seeyourface.cn/migrate/image-20230926153207589.png" alt="image-20230926153207589"></p><p>ç„¶åæˆ‘ä»¬æ‰‹åŠ¨å¼€å¯äº‹åŠ¡ï¼Œæ’å…¥ä¸€æ¡(null,2,2)çš„æ•°æ®ï¼Œå†å›æ»šã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230926153412078.png" alt="image-20230926153412078"></p><p>æ˜¾ç„¶ï¼Œæˆ‘ä»¬æ‰§è¡Œäº†æ’å…¥è¯­å¥ï¼Œä½†æ˜¯å›æ»šäº†äº‹åŠ¡ï¼Œæ‰€ä»¥æ•°æ®åº“ä¸­å¹¶æ²¡æœ‰åˆšæ‰çš„(null,2,2)æ•°æ®ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230926153917766.png" alt="image-20230926153917766"></p><p>ä½†æ˜¯æˆ‘ä»¬å¯ä»¥å‘ç°è‡ªå¢å€¼å¹¶æ²¡æœ‰åŒæ ·å‘ç”Ÿå›æ»šï¼å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè‡ªå¢å€¼ä»ç„¶å›ºæ‰§åœ°ä» 3 å¢åŠ åˆ°äº† 4ã€‚</p><p>å¦‚æœè¿™æ—¶å€™æˆ‘ä»¬å†å»æ’å…¥ä¸€æ¡æ•°æ®ï¼ˆnull, 2, 2ï¼‰çš„æ—¶å€™ï¼Œä¸»é”® id å°±ä¼šè¢«è‡ªåŠ¨èµ‹ä¸º 4 äº†ï¼š</p><p><img src="https://image.seeyourface.cn/migrate/image-20230926154213388.png" alt="image-20230926154213388"></p><p>æ‰€ä»¥ï¼Œå½“å‡ºç°å”¯ä¸€é”®å†²çªæˆ–è€…å›æ»šçš„æ—¶å€™ï¼ŒMySQL æ²¡æœ‰æŠŠè¡¨çš„è‡ªå¢å€¼æ”¹å›å»ï¼Œå›é€€å›å»çš„è¯ä¸å°±ä¸ä¼šå‘ç”Ÿè‡ªå¢ id ä¸è¿ç»­äº†å—ï¼Ÿè¿™åˆæ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>å…¶å®ï¼Œè¿™ä¹ˆåšçš„ä¸»è¦åŸå› æ˜¯ä¸ºäº†æé«˜æ€§èƒ½ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å‡è®¾ MySQL åœ¨äº‹åŠ¡å›æ»šçš„æ—¶å€™ä¼šæŠŠè‡ªå¢å€¼æ”¹å›å»ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p><p>ç°åœ¨æœ‰ä¸¤ä¸ªå¹¶è¡Œæ‰§è¡Œçš„äº‹åŠ¡ A å’Œ Bï¼Œåœ¨ç”³è¯·è‡ªå¢å€¼çš„æ—¶å€™ï¼Œä¸ºäº†é¿å…ä¸¤ä¸ªäº‹åŠ¡ç”³è¯·åˆ°ç›¸åŒçš„è‡ªå¢ idï¼Œè‚¯å®šè¦åŠ é”ï¼Œç„¶åæŒ‰è¯·æ±‚é¡ºåºç”³è¯·ï¼Œå¯¹å§ã€‚</p><ol><li>å‡è®¾äº‹åŠ¡ A ç”³è¯·åˆ°äº† id &#x3D; 1ï¼Œ äº‹åŠ¡ B ç”³è¯·åˆ° id&#x3D;2ï¼Œé‚£ä¹ˆè¿™æ—¶å€™è¡¨ t çš„è‡ªå¢å€¼æ˜¯3ï¼Œä¹‹åç»§ç»­æ‰§è¡Œã€‚</li><li>äº‹åŠ¡ B æ­£ç¡®æäº¤äº†ï¼Œä½†äº‹åŠ¡ A å‡ºç°äº†å”¯ä¸€é”®å†²çªï¼Œä¹Ÿå°±æ˜¯ id &#x3D; 1 çš„é‚£è¡Œè®°å½•æ’å…¥å¤±è´¥äº†ï¼Œé‚£å¦‚æœå…è®¸äº‹åŠ¡ A æŠŠè‡ªå¢ id å›é€€ï¼Œä¹Ÿå°±æ˜¯æŠŠè¡¨çš„å½“å‰è‡ªå¢å€¼æ”¹å› 1ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°è¿™æ ·çš„æƒ…å†µï¼šè¡¨é‡Œé¢å·²ç»æœ‰ id &#x3D; 2 çš„è¡Œï¼Œè€Œå½“å‰çš„è‡ªå¢ id å€¼æ˜¯ 1ã€‚</li><li>æ¥ä¸‹æ¥ï¼Œç»§ç»­æ‰§è¡Œçš„å…¶ä»–äº‹åŠ¡å°±ä¼šç”³è¯·åˆ° id&#x3D;2ã€‚è¿™æ—¶ï¼Œå°±ä¼šå‡ºç°æ’å…¥è¯­å¥æŠ¥é”™â€œä¸»é”®å†²çªâ€ã€‚</li></ol><p><img src="https://image.seeyourface.cn/migrate/img_20230926155314.png" alt="img_20230926155314"></p><p>æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è§£å†³è¿™ä¸ªä¸»é”®å†²çªï¼š</p><ol><li>æ¯æ¬¡ç”³è¯· id ä¹‹å‰ï¼Œå…ˆåˆ¤æ–­è¡¨é‡Œé¢æ˜¯å¦å·²ç»å­˜åœ¨è¿™ä¸ª idï¼Œå¦‚æœå­˜åœ¨ï¼Œå°±è·³è¿‡è¿™ä¸ª id</li><li>æŠŠè‡ªå¢ id çš„é”èŒƒå›´æ‰©å¤§ï¼Œå¿…é¡»ç­‰åˆ°ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œå®Œæˆå¹¶æäº¤ï¼Œä¸‹ä¸€ä¸ªäº‹åŠ¡æ‰èƒ½å†ç”³è¯·è‡ªå¢ id</li></ol><p>å¾ˆæ˜¾ç„¶ï¼Œä¸Šè¿°ä¸¤ä¸ªæ–¹æ³•çš„æˆæœ¬éƒ½æ¯”è¾ƒé«˜ï¼Œä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚è€ŒåŸå› å°±æ˜¯æˆ‘ä»¬å‡è®¾çš„è¿™ä¸ª â€œå…è®¸è‡ªå¢ id å›é€€â€ã€‚</p><p>å› æ­¤ï¼ŒInnoDB æ”¾å¼ƒäº†è¿™ä¸ªè®¾è®¡ï¼Œè¯­å¥æ‰§è¡Œå¤±è´¥ä¹Ÿä¸å›é€€è‡ªå¢ idã€‚ä¹Ÿæ­£æ˜¯å› ä¸ºè¿™æ ·ï¼Œæ‰€ä»¥æ‰åªä¿è¯äº†è‡ªå¢ id æ˜¯é€’å¢çš„ï¼Œä½†<strong>ä¸ä¿è¯æ˜¯è¿ç»­çš„</strong>ã€‚</p><h3 id="æ‰¹é‡æ’å…¥æ•°æ®"><a href="#æ‰¹é‡æ’å…¥æ•°æ®" class="headerlink" title="æ‰¹é‡æ’å…¥æ•°æ®"></a>æ‰¹é‡æ’å…¥æ•°æ®</h3><p>å¯¹äºæ‰¹é‡æ’å…¥æ•°æ®çš„è¯­å¥ï¼ŒMySQL æœ‰ä¸€ä¸ªæ‰¹é‡ç”³è¯·è‡ªå¢ id çš„ç­–ç•¥ï¼š</p><ol><li>è¯­å¥æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç¬¬ä¸€æ¬¡ç”³è¯·è‡ªå¢ idï¼Œä¼šåˆ†é… 1 ä¸ªï¼›</li><li>1 ä¸ªç”¨å®Œä»¥åï¼Œè¿™ä¸ªè¯­å¥ç¬¬äºŒæ¬¡ç”³è¯·è‡ªå¢ idï¼Œä¼šåˆ†é… 2 ä¸ªï¼›</li><li>2 ä¸ªç”¨å®Œä»¥åï¼Œè¿˜æ˜¯è¿™ä¸ªè¯­å¥ï¼Œç¬¬ä¸‰æ¬¡ç”³è¯·è‡ªå¢ idï¼Œä¼šåˆ†é… 4 ä¸ªï¼›</li><li>ä¾æ­¤ç±»æ¨ï¼ŒåŒä¸€ä¸ªè¯­å¥å»ç”³è¯·è‡ªå¢ idï¼Œæ¯æ¬¡ç”³è¯·åˆ°çš„è‡ªå¢ id ä¸ªæ•°éƒ½æ˜¯ä¸Šä¸€æ¬¡çš„ä¸¤å€ã€‚</li></ol><p>æ³¨æ„ï¼Œè¿™é‡Œè¯´çš„æ‰¹é‡æ’å…¥æ•°æ®ï¼Œä¸æ˜¯åœ¨æ™®é€šçš„ insert è¯­å¥é‡Œé¢åŒ…å«å¤šä¸ª value å€¼ï¼ï¼ï¼å› ä¸ºè¿™ç±»è¯­å¥åœ¨ç”³è¯·è‡ªå¢ id çš„æ—¶å€™ï¼Œæ ¹æ®valueçš„æ•°é‡æ˜¯å¯ä»¥ç²¾ç¡®è®¡ç®—å‡ºéœ€è¦å¤šå°‘ä¸ª id çš„ï¼Œç„¶åä¸€æ¬¡æ€§ç”³è¯·ï¼Œç”³è¯·å®Œæˆåé”å°±å¯ä»¥é‡Šæ”¾äº†ã€‚</p><p>è€Œå¯¹äº <code>insert â€¦ select</code>ã€<code>replace â€¦ select</code> å’Œ <code>load data</code> è¿™ç§ç±»å‹çš„è¯­å¥æ¥è¯´ï¼ŒMySQL å¹¶ä¸çŸ¥é“åˆ°åº•éœ€è¦ç”³è¯·å¤šå°‘ idï¼Œæ‰€ä»¥å°±é‡‡ç”¨äº†è¿™ç§<strong>æ‰¹é‡ç”³è¯·</strong>çš„ç­–ç•¥ï¼Œæ¯•ç«Ÿä¸€ä¸ªä¸€ä¸ªç”³è¯·çš„è¯å®åœ¨å¤ªæ…¢äº†ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬ç°åœ¨è¿™ä¸ªè¡¨æœ‰ä¸‹é¢è¿™äº›æ•°æ®ï¼š</p><p><img src="https://image.seeyourface.cn/migrate/image-20230926162829910.png" alt="image-20230926162829910"></p><p>åˆ›å»ºä¸€å¼ å’Œå½“å‰è¡¨ <code>test_incr</code> æœ‰ç›¸åŒç»“æ„å®šä¹‰çš„è¡¨ <code>test_incr2</code>ï¼š</p><p><img src="https://image.seeyourface.cn/migrate/image-20230926163210736.png" alt="image-20230926163210736"></p><p>ç„¶åä½¿ç”¨ <code>insert...select</code> å¾€ <code>teset_incr2</code> è¡¨ä¸­æ‰¹é‡æ’å…¥æ•°æ®ï¼š</p><p><img src="https://image.seeyourface.cn/migrate/image-20230926163423686.png" alt="image-20230926163423686"></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒæˆåŠŸå¯¼å…¥äº†æ•°æ®ã€‚</p><p>å†æ¥çœ‹ä¸‹ <code>test_pk2</code> çš„è‡ªå¢å€¼æ˜¯å¤šå°‘ï¼š</p><p><img src="https://image.seeyourface.cn/migrate/image-20230926163515786.png" alt="image-20230926163515786"></p><p>å¦‚ä¸Šåˆ†æä¸€è‡´ï¼Œæ˜¯ 8 è€Œä¸æ˜¯ 6ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œ<code>insertâ€¦select</code> å®é™…ä¸Šå¾€è¡¨ä¸­æ’å…¥äº† 5 è¡Œæ•°æ® ï¼ˆ1,1ï¼‰ï¼ˆ2,2ï¼‰ï¼ˆ3,3ï¼‰ï¼ˆ4,4ï¼‰ï¼ˆ5,5ï¼‰ã€‚ä½†æ˜¯ï¼Œè¿™äº”è¡Œæ•°æ®æ˜¯åˆ†ä¸‰æ¬¡ç”³è¯·çš„è‡ªå¢ idï¼Œç»“åˆæ‰¹é‡ç”³è¯·ç­–ç•¥ï¼Œæ¯æ¬¡ç”³è¯·åˆ°çš„è‡ªå¢ id ä¸ªæ•°éƒ½æ˜¯ä¸Šä¸€æ¬¡çš„ä¸¤å€ï¼Œæ‰€ä»¥ï¼š</p><ul><li>ç¬¬ä¸€æ¬¡ç”³è¯·åˆ°äº†ä¸€ä¸ª idï¼šid&#x3D;1</li><li>ç¬¬äºŒæ¬¡è¢«åˆ†é…äº†ä¸¤ä¸ª idï¼šid&#x3D;2 å’Œ id&#x3D;3</li><li>ç¬¬ä¸‰æ¬¡è¢«åˆ†é…åˆ°äº† 4 ä¸ª idï¼šid&#x3D;4ã€id &#x3D; 5ã€id &#x3D; 6ã€id&#x3D;7</li></ul><p>ç”±äºè¿™æ¡è¯­å¥å®é™…åªç”¨ä¸Šäº† 5 ä¸ª idï¼Œæ‰€ä»¥ id&#x3D;6 å’Œ id&#x3D;7 å°±è¢«æµªè´¹æ‰äº†ã€‚ä¹‹åï¼Œå†æ‰§è¡Œ <code>insert into test_incr2 values(null,6,6)</code>ï¼Œå®é™…ä¸Šæ’å…¥çš„æ•°æ®å°±æ˜¯ï¼ˆ8,6,6)ï¼š</p><p><img src="https://image.seeyourface.cn/migrate/image-20230926163809960.png" alt="image-20230926163809960"></p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æ€»ç»“ä¸‹è‡ªå¢å€¼ä¸è¿ç»­çš„å››ä¸ªåœºæ™¯ï¼š</p><ol><li>è‡ªå¢åˆå§‹å€¼å’Œè‡ªå¢æ­¥é•¿è®¾ç½®ä¸ä¸º 1ã€‚</li><li>å”¯ä¸€é”®å†²çªã€‚</li><li>äº‹åŠ¡å›æ»šã€‚</li><li>æ‰¹é‡æ’å…¥ï¼ˆå¦‚ <code>insert...select</code> è¯­å¥ï¼‰ã€‚</li></ol>]]></content>
    
    
    <categories>
      
      <category>æ•°æ®åº“</category>
      
      <category>MySQL</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ•°æ®åº“</tag>
      
      <tag>MySQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HTTPç¼“å­˜</title>
    <link href="/2023/09/25/HTTP%E7%BC%93%E5%AD%98/"/>
    <url>/2023/09/25/HTTP%E7%BC%93%E5%AD%98/</url>
    
    <content type="html"><![CDATA[<h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><h4 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç¼“å­˜ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç¼“å­˜ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç¼“å­˜ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç¼“å­˜ï¼Ÿ</h4><p>HTTP(è¶…æ–‡æœ¬ä¼ è¾“åè®®)æ˜¯ä¸€ç§æ— çŠ¶æ€çš„åº”ç”¨ç¨‹åºçº§è¯·æ±‚&#x2F;å“åº”åè®®ï¼Œä½¿ç”¨å¯æ‰©å±•è¯­ä¹‰å’Œè‡ªæè¿°æ¶ˆæ¯ä¸åŸºäºç½‘ç»œçš„è¶…æ–‡æœ¬ä¿¡æ¯ç³»ç»Ÿè¿›è¡Œçµæ´»çš„äº¤äº’ã€‚å¯¹äºç°ä»£äº’è”ç½‘æ¥è¯´å­˜åœ¨ç€å¤§é‡çš„é™æ€æ–‡ä»¶ä¾‹å¦‚HTMLã€CSSå’Œå›¾ç‰‡ç­‰èµ„æºï¼Œè¿™äº›èµ„æºåœ¨åç»­çš„è¯·æ±‚ä¸­ä¸ä¼šå‘ç”Ÿå˜æ›´ã€‚æˆ‘ä»¬å¯ä»¥ç¼“å­˜å­˜å‚¨å¯ç¼“å­˜çš„å“åº”ï¼Œä»¥å‡å°‘æœªæ¥ç­‰æ•ˆè¯·æ±‚çš„å“åº”æ—¶é—´å’Œç½‘ç»œå¸¦å®½æ¶ˆè€—ã€‚</p><p>HTTP <strong>ç¼“å­˜çš„ç›®æ ‡</strong>æ˜¯é€šè¿‡é‡ç”¨å…ˆå‰çš„å“åº”æ¶ˆæ¯æ¥æ»¡è¶³å½“å‰è¯·æ±‚ï¼Œæ¯æ¬¡ç¼“å­˜é‡ç”¨æ–°å“åº”æ—¶ï¼Œæ–°å“åº”éƒ½å¯ä»¥å‡å°‘å»¶è¿Ÿå’Œç½‘ç»œå¼€é”€ï¼Œä»è€Œæ˜¾ç€æé«˜æ€§èƒ½ã€‚</p><h3 id="ç¼“å­˜æ“ä½œæ¦‚è¿°"><a href="#ç¼“å­˜æ“ä½œæ¦‚è¿°" class="headerlink" title="ç¼“å­˜æ“ä½œæ¦‚è¿°"></a>ç¼“å­˜æ“ä½œæ¦‚è¿°</h3><h4 id="ç¼“å­˜éœ€è¦è§£å†³çš„ä¸»è¦é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#ç¼“å­˜éœ€è¦è§£å†³çš„ä¸»è¦é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="ç¼“å­˜éœ€è¦è§£å†³çš„ä¸»è¦é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ"></a>ç¼“å­˜éœ€è¦è§£å†³çš„ä¸»è¦é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ</h4><p>è™½ç„¶ç¼“å­˜æ˜¯HTTPçš„å¯é€‰åŠŸèƒ½ï¼Œä½†æˆ‘ä»¬å¯ä»¥å‡è®¾é‡ç”¨ç¼“å­˜çš„å“åº”æ˜¯æœ‰æ•ˆçš„ï¼Œå¹¶ä¸”å½“æ²¡æœ‰è¦æ±‚æˆ–æœ¬åœ°é…ç½®é˜»æ­¢å¯¹å“åº”è¿›è¡Œç¼“å­˜æ—¶ï¼Œè¿™ç§é‡ç”¨æ˜¯<strong>é»˜è®¤è¡Œä¸º</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´HTTPçš„ç¼“å­˜é»˜è®¤æ˜¯å¼€å¯çš„ã€‚å› æ­¤ï¼Œ<strong>HTTP ç¼“å­˜å®ç°çš„é‡ç‚¹æ˜¯é˜²æ­¢ç¼“å­˜å­˜å‚¨ä¸å¯é‡ç”¨çš„å“åº”æˆ–ä¸é€‚å½“åœ°é‡ç”¨å·²å­˜å‚¨çš„å“åº”</strong>ï¼Œè€Œä¸æ˜¯å¼ºåˆ¶ç¼“å­˜å­˜å‚¨å’Œé‡ç”¨ç‰¹å®šå“åº”ã€‚</p><h4 id="æœ¬åœ°ç¼“å­˜å­˜å‚¨æ ¼å¼"><a href="#æœ¬åœ°ç¼“å­˜å­˜å‚¨æ ¼å¼" class="headerlink" title="æœ¬åœ°ç¼“å­˜å­˜å‚¨æ ¼å¼"></a>æœ¬åœ°ç¼“å­˜å­˜å‚¨æ ¼å¼</h4><p>ç¼“å­˜åœ¨æœ¬åœ°æ˜¯ä»¥ ã€è¯·æ±‚-å“åº”ã€‘ çš„key&#x2F;valueé”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨çš„ã€‚</p><p>ç¼“å­˜é”®ï¼ˆkeyï¼‰æ˜¯ç¼“å­˜ç”¨æ¥é€‰æ‹©å“åº”çš„ä¿¡æ¯ï¼Œè‡³å°‘ç”±è¯·æ±‚æ–¹æ³•å’Œç”¨äºæ£€ç´¢å­˜å‚¨çš„å“åº”çš„ç›®æ ‡ URL ç»„æˆï¼Œè¯¥æ–¹æ³•ç¡®å®šåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ï¼ˆGET&#x2F;POSTç­‰ï¼‰å¯ä»¥ä½¿ç”¨è¯¥å“åº”æ¥æ»¡è¶³åç»­è¯·æ±‚ã€‚ç„¶è€Œï¼Œç›®å‰è®¸å¤šå¸¸ç”¨çš„ HTTP ç¼“å­˜<strong>ä»…ç¼“å­˜ GET</strong> å“åº”ï¼Œå› æ­¤ä»…ä½¿ç”¨ URL ä½œä¸ºç¼“å­˜é”®ã€‚</p><h5 id="ä½¿ç”¨Varyæ ‡å¤´å­—æ®µè®¡ç®—ç¼“å­˜é”®"><a href="#ä½¿ç”¨Varyæ ‡å¤´å­—æ®µè®¡ç®—ç¼“å­˜é”®" class="headerlink" title="ä½¿ç”¨Varyæ ‡å¤´å­—æ®µè®¡ç®—ç¼“å­˜é”®"></a>ä½¿ç”¨Varyæ ‡å¤´å­—æ®µè®¡ç®—ç¼“å­˜é”®</h5><p><strong>æ³¨æ„ï¼ï¼ï¼</strong></p><p>è™½ç„¶åŒºåˆ†å“åº”çš„æ–¹å¼æœ¬è´¨ä¸Šæ˜¯åŸºäºå®ƒä»¬çš„ URLã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230925230408064.png" alt="image-20230925230408064"></p><p>ä½†æ˜¯å“åº”çš„å†…å®¹å¹¶ä¸æ€»æ˜¯ç›¸åŒçš„ï¼Œå³ä½¿å®ƒä»¬å…·æœ‰ç›¸åŒçš„ URLã€‚ä¾‹å¦‚åœ¨æ‰§è¡Œå†…å®¹åå•†æ—¶ï¼Œæ¥è‡ªæœåŠ¡å™¨çš„å“åº”å¯èƒ½å–å†³äº <code>Accept</code>ã€<code>Accept-Language</code> å’Œ <code>Accept-Encoding</code> è¯·æ±‚æ ‡å¤´çš„å€¼ã€‚</p><p>æ‰“ä¸ªæ¯”æ–¹ï¼šå¯¹äºå¸¦æœ‰ <code>Accept-Language: en</code> æ ‡å¤´å¹¶å·²ç¼“å­˜çš„è‹±è¯­å†…å®¹ï¼Œä¸å¸Œæœ›å†å¯¹å…·æœ‰ <code>Accept-Language: ja è¯·æ±‚æ ‡å¤´çš„è¯·æ±‚é‡ç”¨è¯¥ç¼“å­˜å“åº”ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡åœ¨ </code>Vary<code> æ ‡å¤´çš„å€¼ä¸­æ·»åŠ â€œ</code>Accept-Language&#96;â€ï¼Œæ ¹æ®è¯­è¨€å•ç‹¬ç¼“å­˜å“åº”ã€‚</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-attribute">Vary</span><span class="hljs-punctuation">: </span>Accept-Language<br></code></pre></td></tr></table></figure><p>å½“ç¼“å­˜æ”¶åˆ°å¯ç”±å­˜å‚¨å“åº”æ»¡è¶³çš„è¯·æ±‚å¹¶ä¸”è¯¥æœ¬åœ°å­˜å‚¨çš„å“åº”åŒ…å« Vary æ ‡å¤´å­—æ®µæ—¶ï¼Œç¼“å­˜<strong>ä¸å…è®¸</strong>åœ¨æ²¡æœ‰é‡æ–°éªŒè¯çš„æƒ…å†µä¸‹ä½¿ç”¨è¯¥å­˜å‚¨çš„å“åº”ï¼Œé™¤éè¯¥ Vary å­—æ®µå€¼æŒ‡å®šçš„æ‰€æœ‰å‘ˆç°çš„è¯·æ±‚æ ‡å¤´å­—æ®µéƒ½ä¸åŸå§‹è¯·æ±‚ä¸­çš„å­—æ®µåŒ¹é…ã€‚è¿™ä¼šå¯¼è‡´ç¼“å­˜åŸºäºå“åº” URL å’Œ <code>Accept-Language</code>è¯·æ±‚æ ‡å¤´çš„ç»„åˆè¿›è¡Œé”®æ§â€”â€”è€Œä¸æ˜¯ä»…ä»…åŸºäºå“åº” URLã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230925230553189.png" alt="image-20230925230553189"></p><p>åŒæ—¶ï¼ŒVaryæ ‡å¤´å­—æ®µå€¼åŒ…å« â€œ*â€ çš„å­˜å‚¨å“åº”å°†<strong>å§‹ç»ˆæ— æ³•åŒ¹é…</strong>ã€‚</p><h4 id="å“ªäº›å“åº”èƒ½è¢«ç¼“å­˜ï¼Ÿ"><a href="#å“ªäº›å“åº”èƒ½è¢«ç¼“å­˜ï¼Ÿ" class="headerlink" title="å“ªäº›å“åº”èƒ½è¢«ç¼“å­˜ï¼Ÿ"></a>å“ªäº›å“åº”èƒ½è¢«ç¼“å­˜ï¼Ÿ</h4><p>å¹¶ä¸æ˜¯æ‰€æœ‰å“åº”éƒ½èƒ½è¢«ç¼“å­˜å­˜å‚¨ï¼Œå“åº”ä¸­å­˜åœ¨ no-store ç¼“å­˜æŒ‡ä»¤å°†ä¸ä¼šè¢«ç¼“å­˜ã€‚</p><p>æœ€å¸¸è§çš„æ˜¯ç¼“å­˜è¯·æ±‚æˆåŠŸçš„ç»“æœï¼šå³å¯¹ GET è¯·æ±‚200ï¼ˆOKï¼‰çš„å“åº”ï¼Œå…¶ä¸­åŒ…å«ç›®æ ‡èµ„æºçš„è¡¨ç¤ºã€‚</p><p>ç„¶è€Œï¼Œä¹Ÿå¯ä»¥å­˜å‚¨é‡å®šå‘ã€å¦å®šç»“æœï¼ˆ404 æœªæ‰¾åˆ°ï¼‰ã€ä¸å®Œæ•´çš„ç»“æœï¼ˆ206 éƒ¨åˆ†å†…å®¹ï¼‰ã€ä»¥åŠå¯¹ GET ä»¥å¤–çš„æ–¹æ³•çš„å“åº”å¦‚æœè¯¥æ–¹æ³•çš„å®šä¹‰å…è®¸æ­¤ç±»ç¼“å­˜å¹¶å®šä¹‰äº†é€‚åˆç”¨ä½œç¼“å­˜é”®çš„å†…å®¹ã€‚</p><h3 id="ç¼“å­˜ç±»å‹"><a href="#ç¼“å­˜ç±»å‹" class="headerlink" title="ç¼“å­˜ç±»å‹"></a>ç¼“å­˜ç±»å‹</h3><p><a href="https://httpwg.org/specs/rfc9111.html#calculating.freshness.lifetime">RFC 9111 HTTP Caching</a> æ ‡å‡†å®šä¹‰äº†ä¸¤ç§ä¸åŒçš„ç¼“å­˜ï¼š<strong>ç§æœ‰ç¼“å­˜å’Œå…±äº«ç¼“å­˜</strong>ã€‚</p><h4 id="ç§æœ‰ç¼“å­˜"><a href="#ç§æœ‰ç¼“å­˜" class="headerlink" title="ç§æœ‰ç¼“å­˜"></a>ç§æœ‰ç¼“å­˜</h4><p>ç§æœ‰ç¼“å­˜æ˜¯ä¸ç‰¹å®šå®¢æˆ·ç«¯ç›¸ç»‘å®šçš„ç¼“å­˜â€”â€”é€šå¸¸æ˜¯æŒ‡æµè§ˆå™¨ç¼“å­˜ã€‚ç”±äºå­˜å‚¨çš„å“åº”ä¸ä¸å…¶ä»–å®¢æˆ·ç«¯å…±äº«ï¼Œå› æ­¤ç§æœ‰ç¼“å­˜å¯ä»¥å­˜å‚¨è¯¥ç”¨æˆ·çš„ä¸ªæ€§åŒ–å“åº”ã€‚</p><p>å¦‚æœå“åº”åŒ…å«ä¸ªæ€§åŒ–å†…å®¹å¹¶ä¸”ä½ åªæƒ³å°†å“åº”å­˜å‚¨åœ¨ç§æœ‰ç¼“å­˜ä¸­ï¼Œåˆ™å¿…é¡»æŒ‡å®š <code>private</code> æŒ‡ä»¤ã€‚</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>private<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯å¦‚æœå“åº”å…·æœ‰ <code>Authorization</code> æ ‡å¤´ï¼Œåˆ™ä¸èƒ½å°†å…¶å­˜å‚¨åœ¨ç§æœ‰ç¼“å­˜ï¼ˆæˆ–å…±äº«ç¼“å­˜ï¼Œé™¤é Cache-Control æŒ‡å®šçš„æ˜¯ <code>public</code>ï¼‰ä¸­ã€‚</p><blockquote><p>A cache <em>MUST NOT</em> store a response to a request unless if the cache is shared: the Authorization header field is not present in the request or a response directive is present that explicitly allows shared caching;</p></blockquote><h4 id="å…±äº«ç¼“å­˜"><a href="#å…±äº«ç¼“å­˜" class="headerlink" title="å…±äº«ç¼“å­˜"></a>å…±äº«ç¼“å­˜</h4><p>å…±äº«ç¼“å­˜ä½äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ï¼Œå¯ä»¥å­˜å‚¨èƒ½åœ¨ç”¨æˆ·ä¹‹é—´<strong>å…±äº«</strong>çš„å“åº”ã€‚å…±äº«ç¼“å­˜å¯ä»¥è¿›ä¸€æ­¥ç»†åˆ†ä¸ºä»£ç†ç¼“å­˜å’Œæ‰˜ç®¡ç¼“å­˜ã€‚</p><h3 id="å¯å‘å¼ç¼“å­˜"><a href="#å¯å‘å¼ç¼“å­˜" class="headerlink" title="å¯å‘å¼ç¼“å­˜"></a>å¯å‘å¼ç¼“å­˜</h3><p><a href="https://httpwg.org/specs/rfc9111.html#calculating.freshness.lifetime">RFC 9111 HTTP Caching</a> è§„èŒƒä¸­æåˆ°ï¼Œç”±äºæºæœåŠ¡å™¨å¹¶ä¸æ€»æ˜¯æä¾›æ˜¾å¼è¿‡æœŸæ—¶é—´ï¼Œå› æ­¤å½“æœªæŒ‡å®šæ˜¾å¼æ—¶é—´æ—¶ï¼Œç¼“å­˜<em>å¯ä»¥</em>åˆ†é…å¯å‘å¼è¿‡æœŸæ—¶é—´ï¼Œå¹¶é‡‡ç”¨ä½¿ç”¨å…¶ä»–å­—æ®µå€¼ï¼ˆä¾‹å¦‚ä¸Šæ¬¡ä¿®æ”¹æ—¶é—´ï¼‰çš„ç®—æ³•æ¥ä¼°è®¡åˆç†çš„è¿‡æœŸæ—¶é—´ã€‚è¯¥è§„èŒƒæ²¡æœ‰æä¾›å…·ä½“çš„ç®—æ³•ï¼Œä½†å®ƒç¡®å®å¯¹å…¶ç»“æœæ–½åŠ äº†æœ€åæƒ…å†µçš„é™åˆ¶ã€‚</p><p>å½“å­˜å‚¨çš„å“åº”ä¸­å­˜åœ¨æ˜¾å¼è¿‡æœŸæ—¶é—´(ä¾‹å¦‚<code>Cache-Control</code>)æ—¶ï¼Œç¼“å­˜<strong>ä¸å¾—</strong>ä½¿ç”¨å¯å‘å¼æ–¹æ³•æ¥ç¡®å®šæ–°é²œåº¦ã€‚ä¹Ÿå°±æ˜¯è¯´<strong>å¯å‘å¼ç¼“å­˜åªé€‚ç”¨äºå­˜å‚¨å“åº”ä¸­æ²¡æœ‰æ˜¾å¼ç»™å‡ºè¿‡æœŸæ—¶é—´çš„æƒ…å†µ</strong>ã€‚</p><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬é€šè¿‡è¯·æ±‚è·å–åˆ°ä»¥ä¸‹å“åº”ï¼Œå†…å®¹æœ€åä¸€æ¬¡æ›´æ–°æ˜¯åœ¨ 1 å¹´å‰ã€‚</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-meta">HTTP/1.1</span> <span class="hljs-number">200</span> OK<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>text/html<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>1024<br><span class="hljs-attribute">Date</span><span class="hljs-punctuation">: </span>Tue, 26 Sep 2022 22:22:22 GMT<br><span class="hljs-attribute">Last-Modified</span><span class="hljs-punctuation">: </span>Tue, 26 Sep 2021 22:22:22 GMT<br><br><span class="language-xml"><span class="hljs-meta">&lt;!doctype <span class="hljs-keyword">html</span>&gt;</span></span><br><span class="language-xml">â€¦</span><br></code></pre></td></tr></table></figure><p>é€šè¿‡å“åº”æˆ‘ä»¬å¯ä»¥æ¨æµ‹æ•´æ•´ä¸€å¹´æ²¡æœ‰æ›´æ–°çš„å†…å®¹åœ¨é‚£ä¹‹åçš„ä¸€æ®µæ—¶é—´å†…ä¹Ÿå°†ä¸ä¼šæ›´æ–°ã€‚å› æ­¤ï¼Œå®¢æˆ·ç«¯å†³å®šå­˜å‚¨æ­¤å“åº”ï¼ˆå°½ç®¡ç¼ºå°‘ <code>max-age</code>ï¼‰å¹¶é‡ç”¨å®ƒä¸€æ®µæ—¶é—´ã€‚å¤ç”¨å¤šé•¿æ—¶é—´å–å†³äºå®ç°ï¼Œä½†è§„èŒƒå»ºè®®å­˜å‚¨<strong>ä¸è¶…è¿‡è‡ªè¯¥ä¿®æ”¹æ—¶é—´ä»¥æ¥è‡³ä»Šçš„ä¸€éƒ¨åˆ†</strong>ã€‚è¿™ä¸ªå€¼åœ¨è§„èŒƒä¸­æ¨èä¸º10%ï¼Œæ‰€ä»¥ä¸Šé¢çš„ä¾‹å­ä¸­é‡ç”¨çš„æ—¶é—´ä¸è¶…è¿‡0.1å¹´ã€‚</p><p>å› æ­¤ï¼Œå¦‚æœæºæœåŠ¡å™¨å¸Œæœ›é˜»æ­¢ç¼“å­˜ï¼Œåˆ™é¼“åŠ±å®ƒä»¬å‘é€æ˜¾å¼æŒ‡ä»¤ï¼ˆä¾‹å¦‚ï¼Œ<code>Cache-Controlï¼šno-cache</code>ï¼‰</p><blockquote><p>Since origin servers do not always provide explicit expiration times, a cache <em>MAY</em> assign a heuristic expiration time when an explicit time is not specified, employing algorithms that use other field values (such as the Last-Modified time) to estimate a plausible expiration time. This specification does not provide specific algorithms, but it does impose worst-case constraints on their results.</p><p>A cache <em>MUST NOT</em> use heuristics to determine freshness when an explicit expiration time is present in the stored response. Because of the requirements in Section 3), heuristics can only be used on responses without explicit freshness whose status codes are defined as heuristically cacheable (e.g., see Section 15.1 of HTTP) and on responses without explicit freshness that have been marked as explicitly cacheable (e.g., with a public response directive).</p><p>Note that in previous specifications, heuristically cacheable response status codes were called â€œcacheable by defaultâ€.</p><p>If the response has a Last-Modified header field of HTTP, caches are encouraged to use a heuristic expiration value that is no more than some fraction of the interval since that time. A typical setting of this fraction might be 10%.</p></blockquote><h3 id="å¼ºåˆ¶ç¼“å­˜"><a href="#å¼ºåˆ¶ç¼“å­˜" class="headerlink" title="å¼ºåˆ¶ç¼“å­˜"></a>å¼ºåˆ¶ç¼“å­˜</h3><p>å‘½ä¸­å¼ºåˆ¶ç¼“å­˜æ—¶ï¼Œå®¢æˆ·ç«¯ä¸ä¼šå†è¯·æ±‚æœåŠ¡å™¨ï¼Œç›´æ¥ä»é‡ç”¨ç¼“å­˜çš„å“åº”ï¼Œå¹¶è¿”å›HTTPçŠ¶æ€ç ä¸º200ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230927225454971.png" alt="image-20230927225454971"></p><p>å¼ºåˆ¶ç¼“å­˜ç”±å“åº”æ ‡å¤´ä¸­çš„<code>Expries</code>ã€<code>Cache-Control</code> å’Œ <code>Pragma</code>æ¥æ§åˆ¶ï¼š</p><ul><li>Expiresï¼šåœ¨ HTTP&#x2F;1.0 ä¸­ï¼Œç¼“å­˜çš„æœ‰æ•ˆæœŸæ˜¯é€šè¿‡ <code>Expires</code> æ ‡å¤´æ¥æŒ‡å®šçš„ã€‚<code>Expires</code> æ ‡å¤´ä½¿ç”¨æ˜ç¡®çš„æ—¶é—´è€Œä¸æ˜¯é€šè¿‡æŒ‡å®šç»è¿‡çš„æ—¶é—´æ¥æŒ‡å®šç¼“å­˜çš„ç”Ÿå‘½å‘¨æœŸã€‚</li></ul><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-attribute">Expires</span><span class="hljs-punctuation">: </span>Tue, 28 Feb 2022 22:22:22 GMT<br></code></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œä¾‹å¦‚æ—¶é—´æ ¼å¼éš¾ä»¥è§£æï¼Œå¹¶ä¸”å®¢æˆ·ç«¯å¯èƒ½é€šè¿‡æ•…æ„åç§»ç³»ç»Ÿæ—¶é’Ÿæ¥è¯±å‘é—®é¢˜ã€‚</p><ul><li>Cache-Controlï¼šç”±äºExpireså¯èƒ½å¯¼è‡´çš„é—®é¢˜ï¼Œåœ¨ HTTP&#x2F;1.1 ä¸­å¼•å…¥äº†<code>Cache-Control</code> æ ‡å¤´ï¼Œå®ƒé‡‡ç”¨äº† <code>max-age</code>â€”â€”å³ç”¨äºæŒ‡å®šç»è¿‡çš„æ—¶é—´ï¼Œè¿™æ˜¯ä¸€ä¸ªç›¸å¯¹æ—¶é—´ï¼Œæ˜¯è‡ªå“åº”ç”Ÿæˆä»¥æ¥ç»è¿‡çš„æ—¶é—´ã€‚å¦‚æœ <code>Expires</code> å’Œ <code>Cache-Control: max-age</code> éƒ½å¯ç”¨ï¼Œåˆ™å°† <code>max-age</code> å®šä¹‰ä¸ºé¦–é€‰ã€‚å› æ­¤ï¼Œç”±äº HTTP&#x2F;1.1 å·²è¢«å¹¿æ³›ä½¿ç”¨ï¼Œæ— éœ€ç‰¹åœ°æä¾› <code>Expires</code>ã€‚<ul><li>no-storeï¼š ç¦ç”¨ç¼“å­˜ï¼Œè¡¨æ˜æœåŠ¡å™¨å¸Œæœ›<strong>æ°¸è¿œéƒ½ä¸è¦åœ¨å®¢æˆ·ç«¯å­˜å‚¨èµ„æº</strong>ï¼Œæ€»æ˜¯å»åŸå§‹æœåŠ¡å™¨å»è·å–æœ€æ–°èµ„æºã€‚</li><li>no-cacheï¼šå¯ä»¥åœ¨å®¢æˆ·ç«¯å­˜å‚¨èµ„æºï¼Œä½†<strong>æ¯æ¬¡éƒ½å¿…é¡»å»æœåŠ¡ç«¯åšæ–°é²œåº¦æ ¡éªŒ</strong>ã€‚</li><li>private&#x2F;publicï¼šprivateæŒ‡çš„å•ä¸ªç”¨æˆ·ï¼Œpublicå¯ä»¥è¢«ä»»ä½•ä¸­é—´äººã€CDNç­‰ç¼“å­˜</li><li>max-age&#x3D;ï¼šmax-ageæ˜¯è·ç¦»è¯·æ±‚å‘èµ·çš„æ—¶é—´çš„ç§’æ•°</li><li>must-revalidateï¼šåœ¨ç¼“å­˜è¿‡æœŸå‰å¯ä»¥ä½¿ç”¨ï¼Œè¿‡æœŸåå¿…é¡»å‘æœåŠ¡å™¨éªŒè¯</li></ul></li><li>Pragmaï¼š<code>Pragma</code>è¯·æ±‚æ ‡å¤´å­—æ®µæ˜¯ä¸º HTTP&#x2F;1.0 ç¼“å­˜å®šä¹‰çš„ï¼Œä»¥ä¾¿å®¢æˆ·ç«¯å¯ä»¥æŒ‡å®šâ€œæ— ç¼“å­˜â€çš„è¯·æ±‚ï¼ˆå› ä¸ºCache-Controlç›´åˆ°HTTP&#x2F;1.1æ‰è¢«å®šä¹‰ï¼‰ã€‚ç„¶è€Œï¼Œå¯¹ <code>Cache-Control</code> çš„æ”¯æŒç°åœ¨å·²ç»å¾ˆå¹¿æ³›äº†ï¼Œå› æ­¤ï¼Œ<em>RFC 9111 - HTTP Caching</em>è§„èŒƒä¸èµæˆä½¿ç”¨ Pragmaã€‚</li></ul><h4 id="å¼ºåˆ¶ç¼“å­˜å­˜å‚¨çš„ä½ç½®"><a href="#å¼ºåˆ¶ç¼“å­˜å­˜å‚¨çš„ä½ç½®" class="headerlink" title="å¼ºåˆ¶ç¼“å­˜å­˜å‚¨çš„ä½ç½®"></a>å¼ºåˆ¶ç¼“å­˜å­˜å‚¨çš„ä½ç½®</h4><table><thead><tr><th>çŠ¶æ€</th><th>Network - Size</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>200</td><td>from memory cache</td><td>ä¸è¯·æ±‚ç½‘ç»œèµ„æºï¼Œèµ„æºåœ¨å†…å­˜ï¼Œä¸€èˆ¬æ˜¯è„šæœ¬ã€å­—ä½“ã€å›¾ç‰‡ï¼Œæµè§ˆå™¨å…³é—­ï¼Œæ•°æ®å°†è¢«é‡Šæ”¾</td></tr><tr><td>200</td><td>from disk cache</td><td>è¯·æ±‚ç½‘ç»œèµ„æºï¼Œèµ„æºåœ¨ç£ç›˜ï¼Œä¸€èˆ¬æ˜¯CSSç­‰ï¼Œå…³é—­æ•°æ®è¿˜åœ¨</td></tr><tr><td>200</td><td>èµ„æºå¤§å°</td><td>ä»æœåŠ¡å™¨ä¸‹è½½æœ€æ–°èµ„æº</td></tr><tr><td>304</td><td>æŠ¥æ–‡å¤§å°</td><td>è¯·æ±‚æœåŠ¡ç«¯å‘ç°èµ„æºæœªæ›´æ–°ï¼Œä½¿ç”¨æœ¬åœ°èµ„æºï¼Œä¸ä»æœåŠ¡å™¨æºå¸¦å®Œæ•´å“åº”</td></tr></tbody></table><p>æ¯”å¦‚ä¸‹å›¾è¿”å›çš„å“åº”Sizeå­—æ®µä¸­çš„å†…å®¹ï¼š</p><p><img src="https://image.seeyourface.cn/migrate/image-20230927233159423.png" alt="image-20230927233159423"></p><h3 id="åå•†ç¼“å­˜"><a href="#åå•†ç¼“å­˜" class="headerlink" title="åå•†ç¼“å­˜"></a>åå•†ç¼“å­˜</h3><p>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨ä¼šæ ¹æ®è¿™ä¸ªè¯·æ±‚çš„è¯·æ±‚å¤´çš„ä¸€äº›å‚æ•°æ¥åˆ¤æ–­æ˜¯å¦å‘½ä¸­åå•†ç¼“å­˜ï¼Œå¦‚æœå‘½ä¸­ï¼Œåˆ™è¿”å›304çŠ¶æ€ç å¹¶å¸¦ä¸Šæ–°çš„å“åº”å¤´é€šçŸ¥æµè§ˆå™¨ä»ç¼“å­˜ä¸­è¯»å–èµ„æºï¼Œç”±äºæ­¤å“åº”ä»…è¡¨ç¤ºâ€œæ²¡æœ‰å˜åŒ–â€ï¼Œå› æ­¤æ²¡æœ‰å“åº”ä¸»ä½“â€”â€”åªæœ‰ä¸€ä¸ªçŠ¶æ€ç â€”â€”å› æ­¤ä¼ è¾“å¤§å°éå¸¸å°ã€‚</p><p>åå•†ç¼“å­˜ï¼Œå“åº”å¤´ä¸­æœ‰ä¸¤å¯¹å­—æ®µé…åˆä½¿ç”¨æ ‡è®°è§„åˆ™ã€‚</p><h4 id="Last-Modified-If-Modified-Since"><a href="#Last-Modified-If-Modified-Since" class="headerlink" title="Last-Modified &#x2F; If-Modified-Since"></a>Last-Modified &#x2F; If-Modified-Since</h4><p>ä»¥ä¸‹å“åº”åœ¨ 22:22:22 ç”Ÿæˆï¼Œ<code>max-age</code> ä¸º 1 å°æ—¶ï¼Œå› æ­¤ä½ çŸ¥é“å®ƒåœ¨ 23:22:22 ä¹‹å‰æ˜¯æœ‰æ•ˆçš„ã€‚</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-meta">HTTP/1.1</span> <span class="hljs-number">200</span> OK<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>text/html<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>1024<br><span class="hljs-attribute">Date</span><span class="hljs-punctuation">: </span>Tue, 22 Feb 2022 22:22:22 GMT<br><span class="hljs-attribute">Last-Modified</span><span class="hljs-punctuation">: </span>Tue, 22 Feb 2022 22:00:00 GMT<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>max-age=3600<br><br><span class="language-xml"><span class="hljs-meta">&lt;!doctype <span class="hljs-keyword">html</span>&gt;</span></span><br><span class="language-xml">â€¦</span><br></code></pre></td></tr></table></figure><p>åˆ° 23:22:22 æ—¶ï¼Œå“åº”ä¼šè¿‡æ—¶å¹¶ä¸”ä¸èƒ½é‡ç”¨ç¼“å­˜ã€‚å› æ­¤ï¼Œä¸‹é¢çš„è¯·æ±‚æ˜¾ç¤ºå®¢æˆ·ç«¯å‘é€å¸¦æœ‰ <code>If-Modified-Since</code> è¯·æ±‚æ ‡å¤´çš„è¯·æ±‚ï¼Œä»¥è¯¢é—®æœåŠ¡å™¨è‡ªæŒ‡å®šæ—¶é—´ä»¥æ¥æ˜¯å¦æœ‰ä»»ä½•çš„æ”¹å˜ã€‚</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">GET</span> <span class="hljs-string">/index.html</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>example.com<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html<br><span class="hljs-attribute">If-Modified-Since</span><span class="hljs-punctuation">: </span>Tue, 22 Feb 2022 22:00:00 GMT<br></code></pre></td></tr></table></figure><p>å¦‚æœå†…å®¹è‡ªæŒ‡å®šæ—¶é—´ä»¥æ¥æ²¡æœ‰æ›´æ”¹ï¼ŒæœåŠ¡å™¨å°†å“åº” <code>304 Not Modified</code>ã€‚</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-meta">HTTP/1.1</span> <span class="hljs-number">304</span> Not Modified<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>text/html<br><span class="hljs-attribute">Date</span><span class="hljs-punctuation">: </span>Tue, 22 Feb 2022 23:22:22 GMT<br><span class="hljs-attribute">Last-Modified</span><span class="hljs-punctuation">: </span>Tue, 22 Feb 2022 22:00:00 GMT<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>max-age=3600<br></code></pre></td></tr></table></figure><p>æ”¶åˆ°è¯¥å“åº”åï¼Œå®¢æˆ·ç«¯å°†å­˜å‚¨çš„è¿‡æœŸå“åº”æ¢å¤ä¸ºæœ‰æ•ˆçš„ï¼Œå¹¶å¯ä»¥åœ¨å‰©ä½™çš„ 1 å°æ—¶å†…é‡å¤ä½¿ç”¨å®ƒã€‚</p><p>è¿™ç§æ–¹æ³•åŒæ ·å­˜åœ¨ä¸€äº›é—®é¢˜ï¼šä¾‹å¦‚ï¼Œæ—¶é—´æ ¼å¼å¤æ‚ä¸”éš¾ä»¥è§£æï¼Œåˆ†å¸ƒå¼æœåŠ¡å™¨éš¾ä»¥åŒæ­¥æ–‡ä»¶æ›´æ–°æ—¶é—´ã€‚</p><p>æ‰€ä»¥ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œ<code>ETag</code> å“åº”æ ‡å¤´è¢«æ ‡å‡†åŒ–ä½œä¸ºæ›¿ä»£æ–¹æ¡ˆã€‚</p><h4 id="ETag-If-None-Match"><a href="#ETag-If-None-Match" class="headerlink" title="ETag&#x2F;If-None-Match"></a>ETag&#x2F;If-None-Match</h4><p><code>ETag</code> å“åº”æ ‡å¤´çš„å€¼æ˜¯æœåŠ¡å™¨ç”Ÿæˆçš„ä»»æ„å€¼ã€‚æœåŠ¡å™¨å¯¹äºç”Ÿæˆå€¼æ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œå› æ­¤æœåŠ¡å™¨å¯ä»¥æ ¹æ®ä»–ä»¬é€‰æ‹©çš„ä»»ä½•æ–¹å¼è‡ªç”±è®¾ç½®å€¼â€”â€”ä¾‹å¦‚ä¸»ä½“å†…å®¹çš„å“ˆå¸Œæˆ–ç‰ˆæœ¬å·ï¼Œåªéœ€è¦èƒ½å”¯ä¸€æ ‡è¯†è¿™ä¸ªèµ„æºå³å¯ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœ <code>ETag</code> æ ‡å¤´ä½¿ç”¨äº† hash å€¼ï¼Œ<code>index.html</code> èµ„æºçš„ hash å€¼æ˜¯ <code>deadbeef</code>ï¼Œå“åº”å¦‚ä¸‹ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-meta">HTTP/1.1</span> <span class="hljs-number">200</span> OK<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>text/html<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>1024<br><span class="hljs-attribute">Date</span><span class="hljs-punctuation">: </span>Tue, 22 Feb 2022 22:22:22 GMT<br><span class="hljs-attribute">ETag</span><span class="hljs-punctuation">: </span>&quot;deadbeef&quot;<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>max-age=3600<br><br><span class="language-xml"><span class="hljs-meta">&lt;!doctype <span class="hljs-keyword">html</span>&gt;</span></span><br><span class="language-xml">â€¦</span><br></code></pre></td></tr></table></figure><p>å¦‚æœè¯¥å“åº”æ˜¯é™ˆæ—§çš„ï¼Œåˆ™å®¢æˆ·ç«¯è·å–ç¼“å­˜å“åº”çš„ <code>ETag</code> å“åº”æ ‡å¤´çš„å€¼ï¼Œå¹¶å°†å…¶æ”¾å…¥ <code>If-None-Match</code> è¯·æ±‚æ ‡å¤´ä¸­ï¼Œä»¥è¯¢é—®æœåŠ¡å™¨èµ„æºæ˜¯å¦å·²è¢«ä¿®æ”¹ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">GET</span> <span class="hljs-string">/index.html</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>example.com<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html<br><span class="hljs-attribute">If-None-Match</span><span class="hljs-punctuation">: </span>&quot;deadbeef&quot;<br></code></pre></td></tr></table></figure><p>å¦‚æœæœåŠ¡å™¨ä¸ºè¯·æ±‚çš„èµ„æºç¡®å®šçš„ <code>ETag</code> æ ‡å¤´çš„å€¼ä¸è¯·æ±‚ä¸­çš„ <code>If-None-Match</code> å€¼ç›¸åŒï¼Œåˆ™æœåŠ¡å™¨å°†è¿”å› <code>304 Not Modified</code>ã€‚</p><p>ä½†æ˜¯ï¼Œå¦‚æœæœåŠ¡å™¨ç¡®å®šè¯·æ±‚çš„èµ„æºç°åœ¨åº”è¯¥å…·æœ‰ä¸åŒçš„ <code>ETag</code> å€¼ï¼Œåˆ™æœåŠ¡å™¨å°†å…¶æ”¹ä¸º <code>200 OK</code> å’Œèµ„æºçš„æœ€æ–°ç‰ˆæœ¬è¿›è¡Œå“åº”ã€‚</p><p>é‚£æ˜¯ä¸æ˜¯æœ‰äº†<code>ETag</code>ä¹‹åå°±æ²¡å¿…è¦ä½¿ç”¨<code>Last-Modified</code>å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚</p><p>å¼•ç”¨MDNå¼€å‘è§„èŒƒä¸­çš„å†…å®¹ï¼š</p><blockquote><p><strong>å¤‡æ³¨ï¼š</strong> åœ¨è¯„ä¼°å¦‚ä½•ä½¿ç”¨ <code>ETag</code> å’Œ <code>Last-Modified</code> æ—¶ï¼Œè¯·è€ƒè™‘ä»¥ä¸‹å‡ ç‚¹ï¼šåœ¨ç¼“å­˜é‡æ–°éªŒè¯æœŸé—´ï¼Œå¦‚æœ <code>ETag</code> å’Œ <code>Last-Modified</code> éƒ½å­˜åœ¨ï¼Œåˆ™ <code>ETag</code> ä¼˜å…ˆã€‚å› æ­¤ï¼Œå¦‚æœä½ åªè€ƒè™‘ç¼“å­˜ï¼Œä½ å¯èƒ½ä¼šè®¤ä¸º <code>Last-Modified</code> æ˜¯ä¸å¿…è¦çš„ã€‚ç„¶è€Œï¼Œ<code>Last-Modified</code> ä¸ä»…ä»…å¯¹ç¼“å­˜æœ‰ç”¨ï¼›ç›¸åï¼Œå®ƒæ˜¯ä¸€ä¸ªæ ‡å‡†çš„ HTTP æ ‡å¤´ï¼Œå†…å®¹ç®¡ç† (CMS) ç³»ç»Ÿä¹Ÿä½¿ç”¨å®ƒæ¥æ˜¾ç¤ºä¸Šæ¬¡ä¿®æ”¹æ—¶é—´ï¼Œç”±çˆ¬è™«è°ƒæ•´çˆ¬å–é¢‘ç‡ï¼Œä»¥åŠç”¨äºå…¶ä»–å„ç§ç›®çš„ã€‚æ‰€ä»¥è€ƒè™‘åˆ°æ•´ä¸ª HTTP ç”Ÿæ€ç³»ç»Ÿï¼Œæœ€å¥½åŒæ—¶æä¾› <code>ETag</code> å’Œ <code>Last-Modified</code>ã€‚</p></blockquote><h3 id="å¼ºåˆ¶é‡æ–°éªŒè¯"><a href="#å¼ºåˆ¶é‡æ–°éªŒè¯" class="headerlink" title="å¼ºåˆ¶é‡æ–°éªŒè¯"></a>å¼ºåˆ¶é‡æ–°éªŒè¯</h3><p>å¦‚æœä½ æ˜¯ä¸ªå–œæ–°åŒæ—§çš„äººï¼Œä¸å¸Œæœ›é‡å¤ä½¿ç”¨å“åº”ï¼Œè€Œæ˜¯å¸Œæœ›å§‹ç»ˆä»æœåŠ¡å™¨è·å–æœ€æ–°å†…å®¹ï¼ŒHTTPæä¾›äº†<code>no-cache</code>æŒ‡ä»¤å¼ºåˆ¶éªŒè¯ã€‚</p><p>é€šè¿‡åœ¨å“åº”ä¸­æ·»åŠ  <code>Cache-Control: no-cache</code> ä»¥åŠ <code>Last-Modified</code> å’Œ <code>ETag</code>â€”â€”å¦‚ä¸‹æ‰€ç¤ºâ€”â€”å¦‚æœè¯·æ±‚çš„èµ„æºå·²æ›´æ–°ï¼Œå®¢æˆ·ç«¯å°†æ”¶åˆ° <code>200 OK</code> å“åº”ï¼Œå¦åˆ™ï¼Œå¦‚æœè¯·æ±‚çš„èµ„æºå°šæœªæ›´æ–°ï¼Œåˆ™ä¼šæ”¶åˆ° <code>304 Not Modified</code> å“åº”ã€‚</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-meta">HTTP/1.1</span> <span class="hljs-number">200</span> OK<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>text/html<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>1024<br><span class="hljs-attribute">Date</span><span class="hljs-punctuation">: </span>Tue, 22 Feb 2022 22:22:22 GMT<br><span class="hljs-attribute">Last-Modified</span><span class="hljs-punctuation">: </span>Tue, 22 Feb 2022 22:00:00 GMT<br><span class="hljs-attribute">ETag</span><span class="hljs-punctuation">: </span>deadbeef<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>no-cache<br><br><span class="language-xml"><span class="hljs-meta">&lt;!doctype <span class="hljs-keyword">html</span>&gt;</span></span><br><span class="language-xml">â€¦</span><br></code></pre></td></tr></table></figure><p><code>max-age=0</code> å’Œ <code>must-revalidate</code> çš„ç»„åˆä¸ <code>no-cache</code> å…·æœ‰ç›¸åŒçš„å«ä¹‰ã€‚</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>max-age=0, must-revalidate<br></code></pre></td></tr></table></figure><p><code>max-age=0</code> æ„å‘³ç€å“åº”ç«‹å³è¿‡æ—¶ï¼Œè€Œ <code>must-revalidate</code> æ„å‘³ç€ä¸€æ—¦è¿‡æ—¶å°±ä¸å¾—åœ¨æ²¡æœ‰é‡æ–°éªŒè¯çš„æƒ…å†µä¸‹é‡ç”¨å®ƒâ€”â€”å› æ­¤ï¼Œç»“åˆèµ·æ¥ï¼Œè¯­ä¹‰ä¼¼ä¹ä¸ <code>no-cache</code> ç›¸åŒã€‚</p><p>ç„¶è€Œï¼Œ<code>max-age=0</code> çš„ä½¿ç”¨æ˜¯è§£å†³ HTTP&#x2F;1.1 ä¹‹å‰çš„è®¸å¤šå®ç°æ— æ³•å¤„ç† <code>no-cache</code> è¿™ä¸€æŒ‡ä»¤â€”â€”å› æ­¤ä¸ºäº†è§£å†³è¿™ä¸ªé™åˆ¶ï¼Œ<code>max-age=0</code> è¢«ç”¨ä½œè§£å†³æ–¹æ³•ã€‚</p><p>ä½†æ˜¯ç°åœ¨ç¬¦åˆ HTTP&#x2F;1.1 çš„æœåŠ¡å™¨å·²ç»å¹¿æ³›éƒ¨ç½²ï¼Œæ²¡æœ‰ç†ç”±ä½¿ç”¨ <code>max-age=0</code> å’Œ <code>must-revalidate</code> ç»„åˆâ€”â€”ä½ åº”è¯¥åªä½¿ç”¨ <code>no-cache</code>ã€‚</p><h3 id="ä¸ä½¿ç”¨ç¼“å­˜"><a href="#ä¸ä½¿ç”¨ç¼“å­˜" class="headerlink" title="ä¸ä½¿ç”¨ç¼“å­˜"></a>ä¸ä½¿ç”¨ç¼“å­˜</h3><p><code>no-cache</code> æŒ‡ä»¤ä¸ä¼šé˜»æ­¢å“åº”çš„å­˜å‚¨ï¼Œè€Œæ˜¯é˜»æ­¢åœ¨æ²¡æœ‰é‡æ–°éªŒè¯çš„æƒ…å†µä¸‹é‡ç”¨å“åº”ã€‚</p><p>å¦‚æœä½ ä¸å¸Œæœ›å°†å“åº”å­˜å‚¨åœ¨ä»»ä½•ç¼“å­˜ä¸­ï¼Œåº”ä½¿ç”¨ <code>no-store</code>ã€‚</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>no-store<br></code></pre></td></tr></table></figure><h3 id="é‡æ–°åŠ è½½"><a href="#é‡æ–°åŠ è½½" class="headerlink" title="é‡æ–°åŠ è½½"></a>é‡æ–°åŠ è½½</h3><p>ä¸ºäº†ä»é¡µé¢é”™è¯¯ä¸­æ¢å¤æˆ–æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬çš„èµ„æºï¼Œæµè§ˆå™¨ä¸ºç”¨æˆ·æä¾›äº†é‡æ–°åŠ è½½åŠŸèƒ½ã€‚</p><p>åœ¨æµè§ˆå™¨é‡æ–°åŠ è½½æœŸé—´å‘é€çš„ HTTP è¯·æ±‚çš„ç®€åŒ–è§†å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">GET</span> <span class="hljs-string">/</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>example.com<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>max-age=0<br><span class="hljs-attribute">If-None-Match</span><span class="hljs-punctuation">: </span>&quot;deadbeef&quot;<br><span class="hljs-attribute">If-Modified-Since</span><span class="hljs-punctuation">: </span>Tue, 22 Feb 2022 20:20:20 GMT<br></code></pre></td></tr></table></figure><p>è¯·æ±‚ä¸­çš„ <code>max-age=0</code> æŒ‡ä»¤æŒ‡å®šâ€œé‡ç”¨ age ä¸º 0 æˆ–æ›´å°‘çš„å“åº”â€â€”â€”å› æ­¤ï¼Œä¸­é—´å­˜å‚¨çš„å“åº”ä¸ä¼šè¢«é‡ç”¨ã€‚</p><p>è¯·æ±‚é€šè¿‡ <code>If-None-Match</code> å’Œ <code>If-Modified-Since</code> è¿›è¡ŒéªŒè¯ã€‚</p><h3 id="å¼ºåˆ¶é‡æ–°åŠ è½½"><a href="#å¼ºåˆ¶é‡æ–°åŠ è½½" class="headerlink" title="å¼ºåˆ¶é‡æ–°åŠ è½½"></a>å¼ºåˆ¶é‡æ–°åŠ è½½</h3><p>å‡ºäºå‘åå…¼å®¹çš„åŸå› ï¼Œæµè§ˆå™¨åœ¨é‡æ–°åŠ è½½æœŸé—´ä½¿ç”¨ <code>max-age=0</code>â€”â€”å› ä¸ºåœ¨ HTTP&#x2F;1.1 ä¹‹å‰çš„è®¸å¤šè¿‡æ—¶çš„å®ç°ä¸­ä¸ç†è§£ <code>no-cache</code>ã€‚ä½†æ˜¯åœ¨è¿™ä¸ªç”¨ä¾‹ä¸­ï¼Œ<code>no-cache</code> å·²è¢«æ”¯æŒï¼Œå¹¶ä¸”<strong>å¼ºåˆ¶é‡æ–°åŠ è½½</strong>æ˜¯ç»•è¿‡ç¼“å­˜å“åº”çš„å¦ä¸€ç§æ–¹æ³•ã€‚</p><p>æµè§ˆå™¨<strong>å¼ºåˆ¶é‡æ–°åŠ è½½</strong>æœŸé—´çš„ HTTP è¯·æ±‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">GET</span> <span class="hljs-string">/</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>example.com<br><span class="hljs-attribute">Pragma</span><span class="hljs-punctuation">: </span>no-cache<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>no-cache<br></code></pre></td></tr></table></figure><h3 id="é¿å…é‡æ–°éªŒè¯"><a href="#é¿å…é‡æ–°éªŒè¯" class="headerlink" title="é¿å…é‡æ–°éªŒè¯"></a>é¿å…é‡æ–°éªŒè¯</h3><p>æ°¸è¿œä¸ä¼šæ”¹å˜çš„å†…å®¹åº”è¯¥è¢«èµ‹äºˆä¸€ä¸ªè¾ƒé•¿çš„ <code>max-age</code>ï¼Œæ–¹æ³•æ˜¯ä½¿ç”¨ç¼“å­˜ç ´åâ€”â€”ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è¯·æ±‚ URL ä¸­åŒ…å«ç‰ˆæœ¬å·ã€å“ˆå¸Œå€¼ç­‰ã€‚</p><p>ä½†æ˜¯ï¼Œå½“ç”¨æˆ·é‡æ–°åŠ è½½æ—¶ï¼Œå³ä½¿æœåŠ¡å™¨çŸ¥é“å†…å®¹æ˜¯ä¸å¯å˜çš„ï¼Œä¹Ÿä¼šå‘é€é‡æ–°éªŒè¯è¯·æ±‚ã€‚</p><p>ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µï¼Œ<code>immutable</code> æŒ‡ä»¤å¯ç”¨äºæ˜ç¡®æŒ‡ç¤ºä¸éœ€è¦é‡æ–°éªŒè¯ï¼Œå› ä¸ºå†…å®¹æ°¸è¿œä¸ä¼šæ”¹å˜ã€‚</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>max-age=31536000, immutable<br></code></pre></td></tr></table></figure><p>è¿™å¯ä»¥é˜²æ­¢åœ¨é‡æ–°åŠ è½½æœŸé—´è¿›è¡Œä¸å¿…è¦çš„é‡æ–°éªŒè¯ã€‚</p><h3 id="ä¸¾ä¸ªæ —å­"><a href="#ä¸¾ä¸ªæ —å­" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h3><p>å¦‚ä¸‹å›¾è¯·æ±‚ç½‘ç«™<a href="https://seeyourface.cnï¼Œç¬¬ä¸€æ¬¡è¯·æ±‚æˆ‘ä»¬æ³¨æ„æœåŠ¡å™¨è¿”å›çš„å“åº”å†…å®¹ï¼š">https://seeyourface.cnï¼Œç¬¬ä¸€æ¬¡è¯·æ±‚æˆ‘ä»¬æ³¨æ„æœåŠ¡å™¨è¿”å›çš„å“åº”å†…å®¹ï¼š</a></p><p>HTTP Code : 200 â€”â€” æ²¡æœ‰ä½¿ç”¨å¼ºåˆ¶ç¼“å­˜ï¼ŒåŒæ—¶ä¹Ÿæ²¡æœ‰è¿›è¡Œåå•†ç¼“å­˜ã€‚</p><p>Etag â€”â€” åå•†ç¼“å­˜ç”¨åˆ°çš„æ ‡å¤´ï¼Œç¼“å­˜å¤±æ•ˆæ—¶ä¸‹ä¸€ä¸ªè¯·æ±‚åœ¨<code>If-None-Match</code>ä¸­æºå¸¦ç¼“å­˜ä¸­Etagå†…å®¹ï¼ŒæœåŠ¡å™¨ç»è¿‡éªŒè¯åï¼Œå¦‚æœæ²¡æœ‰å¯¹èµ„æºè¿›è¡Œä¿®æ”¹ï¼Œè¿”å›304 Not Modifiedã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230928000111033.png" alt="image-20230928000111033"></p><p>æˆ‘ä»¬åˆ·æ–°æµè§ˆå™¨å†æ¬¡è¯·æ±‚ï¼ŒçŠ¶æ€ç ç¡®å®æ˜¯304ï¼Œæˆ‘è¿™ä¸ªè¯·æ±‚æ˜¯åœ¨600ç§’ä¹‹å†…åˆ·æ–°çš„ï¼Œé‚£ä¸ºä»€ä¹ˆç¬¬ä¸€æ¬¡çš„è¯·æ±‚æ ‡å¤´ä¸­çš„ <code>Cache-Control : max-age=600</code> å­—æ®µæ²¡æœ‰ç”Ÿæ•ˆå‘¢ï¼Œä¸åº”è¯¥æ˜¯é€šè¿‡å¼ºåˆ¶ç¼“å­˜ç›´æ¥é‡ç”¨å“åº”å—ï¼Ÿ</p><p>è¿™æ˜¯å› ä¸ºè¯·æ±‚ä¸­æºå¸¦äº† <code>Cache-Control : max-age=0</code> ï¼Œè¯·æ±‚ä¸­çš„ <code>max-age=0</code> æŒ‡ä»¤æŒ‡å®šâ€œé‡ç”¨ age ä¸º 0 æˆ–æ›´å°‘çš„å“åº”â€â€”â€”å› æ­¤ï¼Œæˆ‘ä»¬å­˜å‚¨çš„å“åº”ä¸ä¼šè¢«é‡ç”¨ã€‚è€Œæ˜¯é€šè¿‡ <code>If-None-Match</code> å’Œ <code>If-Modified-Since</code> è¿›è¡ŒéªŒè¯ã€‚æ‰€ä»¥è¯·æ±‚æ ‡å¤´<code>If-None-Match</code>ä¸­æºå¸¦äº†ä¸Šä¸€æ¬¡å“åº”çš„<code>Etag</code>å­—æ®µå†…å®¹ï¼ŒæœåŠ¡å™¨ç»è¿‡éªŒè¯ï¼Œè®¤ä¸ºè¯¥èµ„æºè‡ªä¸Šæ¬¡è¯·æ±‚ä»¥æ¥æ²¡æœ‰è¢«ä¿®æ”¹ï¼Œæ‰€ä»¥è¿”å›304çŠ¶æ€ç ï¼Œå®¢æˆ·ç«¯å¯é‡ç”¨å·²å­˜å‚¨çš„å“åº”ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230928000248303.png" alt="image-20230928000248303"></p>]]></content>
    
    
    <categories>
      
      <category>ç½‘ç»œ</category>
      
      <category>HTTP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HTTP</tag>
      
      <tag>ç¼“å­˜</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JDKæºç ç³»åˆ—-LinkedList</title>
    <link href="/2023/09/24/JDK%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-LinkedList/"/>
    <url>/2023/09/24/JDK%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-LinkedList/</url>
    
    <content type="html"><![CDATA[<h3 id="LinkedList"><a href="#LinkedList" class="headerlink" title="LinkedList"></a>LinkedList</h3><h4 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h4><p>æœ¬æ–‡å†…å®¹å‡ä»¥JDK8ä¸ºä¾‹ã€‚</p><p><code>LinkedList</code> æ˜¯ä¸€ä¸ªåŸºäºåŒå‘é“¾è¡¨å®ç°çš„é›†åˆç±»ï¼Œç»å¸¸è¢«æ‹¿æ¥å’Œ <code>ArrayList</code> åšæ¯”è¾ƒã€‚</p><p><img src="https://image.seeyourface.cn/migrate/linkedList%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png" alt="linkedListæ•°æ®ç»“æ„"></p><p>ä¸è¿‡ï¼Œæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä¸€èˆ¬æ˜¯ä¸ä¼šä½¿ç”¨åˆ° <code>LinkedList</code> çš„ï¼Œéœ€è¦ç”¨åˆ° <code>LinkedList</code> çš„åœºæ™¯å‡ ä¹éƒ½å¯ä»¥ä½¿ç”¨ <code>ArrayList</code> æ¥ä»£æ›¿ï¼Œå¹¶ä¸”ï¼Œæ€§èƒ½é€šå¸¸ä¼šæ›´å¥½ï¼å°±è¿ <code>LinkedList</code> çš„ä½œè€…çº¦ä¹¦äºš Â· å¸ƒæ´›å…‹ï¼ˆJosh Blochï¼‰è‡ªå·±éƒ½è¯´ä»æ¥ä¸ä¼šä½¿ç”¨ <code>LinkedList</code> ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/336a2145-32ef-497e.png" alt="336a2145-32ef-497e"></p><p>å¦å¤–ï¼Œ<strong>ä¸è¦</strong>ä¸‹æ„è¯†åœ°è®¤ä¸º <code>LinkedList</code> ä½œä¸ºé“¾è¡¨å°±æœ€é€‚åˆå…ƒç´ å¢åˆ çš„åœºæ™¯ã€‚<code>LinkedList</code> ä»…ä»…åœ¨å¤´å°¾æ’å…¥æˆ–è€…åˆ é™¤å…ƒç´ çš„æ—¶å€™æ—¶é—´å¤æ‚åº¦è¿‘ä¼¼ O(1)ï¼Œå…¶ä»–æƒ…å†µå¢åˆ å…ƒç´ çš„å¹³å‡æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ O(n) ï¼Œå› ä¸ºéƒ½éœ€è¦å…ˆéå†åˆ°å¯¹åº”èŠ‚ç‚¹å†è¿›è¡Œå¢åˆ æ“ä½œã€‚</p><h4 id="LinkedList-æ’å…¥å’Œåˆ é™¤å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦ï¼Ÿ"><a href="#LinkedList-æ’å…¥å’Œåˆ é™¤å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦ï¼Ÿ" class="headerlink" title="LinkedList æ’å…¥å’Œåˆ é™¤å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦ï¼Ÿ"></a>LinkedList æ’å…¥å’Œåˆ é™¤å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦ï¼Ÿ</h4><ul><li>å¤´éƒ¨æ’å…¥&#x2F;åˆ é™¤ï¼šåªéœ€è¦ä¿®æ”¹å¤´ç»“ç‚¹çš„æŒ‡é’ˆå³å¯å®Œæˆæ’å…¥&#x2F;åˆ é™¤æ“ä½œï¼Œå› æ­¤æ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚</li><li>å°¾éƒ¨æ’å…¥&#x2F;åˆ é™¤ï¼šåªéœ€è¦ä¿®æ”¹å°¾ç»“ç‚¹çš„æŒ‡é’ˆå³å¯å®Œæˆæ’å…¥&#x2F;åˆ é™¤æ“ä½œï¼Œå› æ­¤æ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚</li><li>æŒ‡å®šä½ç½®æ’å…¥&#x2F;åˆ é™¤ï¼šéœ€è¦å…ˆç§»åŠ¨åˆ°æŒ‡å®šä½ç½®ï¼Œå†ä¿®æ”¹æŒ‡å®šèŠ‚ç‚¹çš„æŒ‡é’ˆå®Œæˆæ’å…¥&#x2F;åˆ é™¤ï¼Œå› æ­¤éœ€è¦ç§»åŠ¨å¹³å‡ n&#x2F;2 ä¸ªå…ƒç´ ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n)ã€‚</li></ul><h4 id="LinkedList-ä¸ºä»€ä¹ˆä¸èƒ½å®ç°-RandomAccess-æ¥å£ï¼Ÿ"><a href="#LinkedList-ä¸ºä»€ä¹ˆä¸èƒ½å®ç°-RandomAccess-æ¥å£ï¼Ÿ" class="headerlink" title="LinkedList ä¸ºä»€ä¹ˆä¸èƒ½å®ç° RandomAccess æ¥å£ï¼Ÿ"></a>LinkedList ä¸ºä»€ä¹ˆä¸èƒ½å®ç° RandomAccess æ¥å£ï¼Ÿ</h4><p><code>RandomAccess</code> æ˜¯ä¸€ä¸ªæ ‡è®°æ¥å£ï¼Œç”¨æ¥è¡¨æ˜å®ç°è¯¥æ¥å£çš„ç±»æ”¯æŒ<strong>éšæœºè®¿é—®</strong>ï¼ˆå³å¯ä»¥é€šè¿‡ç´¢å¼•å¿«é€Ÿè®¿é—®å…ƒç´ ï¼‰ã€‚ç”±äº <code>LinkedList</code> åº•å±‚æ•°æ®ç»“æ„æ˜¯é“¾è¡¨ï¼Œå†…å­˜åœ°å€ä¸è¿ç»­ï¼Œåªèƒ½é€šè¿‡æŒ‡é’ˆæ¥å®šä½ï¼Œä¸æ”¯æŒéšæœºå¿«é€Ÿè®¿é—®ï¼Œæ‰€ä»¥ä¸èƒ½å®ç° <code>RandomAccess</code> æ¥å£ã€‚</p><h4 id="LinkedListæºç åˆ†æ"><a href="#LinkedListæºç åˆ†æ" class="headerlink" title="LinkedListæºç åˆ†æ"></a>LinkedListæºç åˆ†æ</h4><p><code>LinkedList</code> ç»§æ‰¿äº† <code>AbstractSequentialList</code> ï¼Œè€Œ <code>AbstractSequentialList</code> åˆç»§æ‰¿äº <code>AbstractList</code> ã€‚</p><p>é˜…è¯»è¿‡ <code>ArrayList</code> çš„æºç æˆ‘ä»¬å°±çŸ¥é“ï¼Œ<code>ArrayList</code> åŒæ ·ç»§æ‰¿äº† <code>AbstractList</code> ï¼Œ æ‰€ä»¥ <code>LinkedList</code> ä¼šæœ‰å¤§éƒ¨åˆ†æ–¹æ³•å’Œ <code>ArrayList</code> ç›¸ä¼¼ã€‚</p><p><code>LinkedList</code> å®ç°äº†ä»¥ä¸‹æ¥å£ï¼š</p><ul><li><code>List</code> : è¡¨æ˜å®ƒæ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œæ”¯æŒæ·»åŠ ã€åˆ é™¤ã€æŸ¥æ‰¾ç­‰æ“ä½œï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ä¸‹æ ‡è¿›è¡Œè®¿é—®ã€‚</li><li><code>Deque</code> ï¼šç»§æ‰¿è‡ª <code>Queue</code> æ¥å£ï¼Œå…·æœ‰åŒç«¯é˜Ÿåˆ—çš„ç‰¹æ€§ï¼Œæ”¯æŒä»ä¸¤ç«¯æ’å…¥å’Œåˆ é™¤å…ƒç´ ï¼Œæ–¹ä¾¿å®ç°æ ˆå’Œé˜Ÿåˆ—ç­‰æ•°æ®ç»“æ„ã€‚éœ€è¦æ³¨æ„ï¼Œ<code>Deque</code> çš„å‘éŸ³ä¸º â€œdeckâ€ [dÉ›k]ï¼Œè¿™ä¸ªå¤§éƒ¨åˆ†äººéƒ½ä¼šè¯»é”™ã€‚</li><li><code>Cloneable</code> ï¼šè¡¨æ˜å®ƒå…·æœ‰æ‹·è´èƒ½åŠ›ï¼Œå¯ä»¥è¿›è¡Œæ·±æ‹·è´æˆ–æµ…æ‹·è´æ“ä½œã€‚</li><li><code>Serializable</code> : è¡¨æ˜å®ƒå¯ä»¥è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œï¼Œä¹Ÿå°±æ˜¯å³å¯ä»¥å°†<strong>å¯¹è±¡åºåˆ—åŒ–ä¸ºå­—èŠ‚æµ</strong>è¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨æˆ–ç½‘ç»œä¼ è¾“ï¼Œä¹Ÿå¯ä»¥ä»<strong>å­—èŠ‚æµååºåˆ—åŒ–ä¸ºå¯¹è±¡</strong>ï¼Œéå¸¸æ–¹ä¾¿ã€‚</li></ul><p><img src="https://image.seeyourface.cn/migrate/image-20230924171241953.png" alt="image-20230924171241953"></p><p>ä¸ArrayListä¸åŒçš„æ˜¯ï¼Œ<code>LinkedList</code> ä¸­çš„å…ƒç´ æ˜¯é€šè¿‡ <code>Node</code> å®šä¹‰çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>&lt;E&gt; &#123;<br>       <span class="hljs-comment">// å®é™…å­˜å‚¨æ•°æ®</span><br>       E item;<br>       <span class="hljs-comment">// åç»§èŠ‚ç‚¹</span><br>       Node&lt;E&gt; next;<br>       <span class="hljs-comment">// å‰é©±èŠ‚ç‚¹</span><br>       Node&lt;E&gt; prev;<br><span class="hljs-comment">// åˆå§‹åŒ–å‚æ•°é¡ºåºåˆ†åˆ«æ˜¯ï¼šå‰é©±ç»“ç‚¹ã€æœ¬èº«èŠ‚ç‚¹å€¼ã€åç»§èŠ‚ç‚¹</span><br>       Node(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next) &#123;<br>           <span class="hljs-built_in">this</span>.item = element;<br>           <span class="hljs-built_in">this</span>.next = next;<br>           <span class="hljs-built_in">this</span>.prev = prev;<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h4><p><code>LinkedList</code> ä¸­æœ‰ä¸€ä¸ªæ— å‚æ„é€ å‡½æ•°å’Œä¸€ä¸ªæœ‰å‚æ„é€ å‡½æ•°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªç©ºçš„é“¾è¡¨å¯¹è±¡</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">LinkedList</span><span class="hljs-params">()</span> &#123;<br>   &#125;<br><br><span class="hljs-comment">// æ¥æ”¶ä¸€ä¸ªé›†åˆç±»å‹ä½œä¸ºå‚æ•°ï¼Œä¼šåˆ›å»ºä¸€ä¸ªä¸ä¼ å…¥é›†åˆç›¸åŒå…ƒç´ çš„é“¾è¡¨å¯¹è±¡</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">LinkedList</span><span class="hljs-params">(Collection&lt;? extends E&gt; c)</span> &#123;<br>       <span class="hljs-built_in">this</span>();<br>       addAll(c);<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="æ·»åŠ å…ƒç´ "><a href="#æ·»åŠ å…ƒç´ " class="headerlink" title="æ·»åŠ å…ƒç´ "></a>æ·»åŠ å…ƒç´ </h4><p><code>LinkedList</code> é™¤äº†å®ç°äº† <code>List</code> æ¥å£ç›¸å…³æ–¹æ³•ï¼Œè¿˜å®ç°äº† <code>Deque</code> æ¥å£çš„å¾ˆå¤šæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰å¾ˆå¤šç§æ–¹å¼æ’å…¥å…ƒç´ ã€‚</p><p>è¿™é‡Œä»¥ <code>List</code> æ¥å£ä¸­ç›¸å…³çš„æ’å…¥æ–¹æ³•ä¸ºä¾‹è¿›è¡Œæºç è®²è§£ï¼Œå¯¹åº”çš„æ˜¯<code>add()</code> æ–¹æ³•ã€‚</p><p><code>add()</code> æ–¹æ³•æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼š</p><ul><li><code>add(E e)</code>ï¼šç”¨äºåœ¨ <code>LinkedList</code> çš„å°¾éƒ¨æ’å…¥å…ƒç´ ï¼Œå³å°†æ–°å…ƒç´ ä½œä¸ºé“¾è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚</li><li><code>add(int index, E element)</code>:ç”¨äºåœ¨æŒ‡å®šä½ç½®æ’å…¥å…ƒç´ ã€‚è¿™ç§æ’å…¥æ–¹å¼éœ€è¦å…ˆç§»åŠ¨åˆ°æŒ‡å®šä½ç½®ï¼Œå†ä¿®æ”¹æŒ‡å®šèŠ‚ç‚¹çš„æŒ‡é’ˆå®Œæˆæ’å…¥&#x2F;åˆ é™¤ï¼Œå› æ­¤éœ€è¦ç§»åŠ¨å¹³å‡ n &#x2F; 2 ä¸ªå…ƒç´ ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n)ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åœ¨é“¾è¡¨å°¾éƒ¨æ’å…¥å…ƒç´ </span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">add</span><span class="hljs-params">(E e)</span> &#123;<br>    linkLast(e);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-comment">// åœ¨é“¾è¡¨æŒ‡å®šä½ç½®æ’å…¥å…ƒç´ </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> index, E element)</span> &#123;<br>    <span class="hljs-comment">// ä¸‹æ ‡è¶Šç•Œæ£€æŸ¥</span><br>    checkPositionIndex(index);<br><br>    <span class="hljs-comment">// åˆ¤æ–­ index æ˜¯ä¸æ˜¯é“¾è¡¨å°¾éƒ¨ä½ç½®</span><br>    <span class="hljs-keyword">if</span> (index == size)<br>        <span class="hljs-comment">// å¦‚æœæ˜¯å°±ç›´æ¥è°ƒç”¨ linkLast æ–¹æ³•å°†å…ƒç´ èŠ‚ç‚¹æ’å…¥é“¾è¡¨å°¾éƒ¨å³å¯</span><br>        linkLast(element);<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-comment">// å¦‚æœä¸æ˜¯åˆ™è°ƒç”¨ linkBefore æ–¹æ³•å°†å…¶æ’å…¥æŒ‡å®šå…ƒç´ ä¹‹å‰</span><br>        linkBefore(element, node(index));<br>&#125;<br><br><span class="hljs-comment">// å°†å…ƒç´ èŠ‚ç‚¹æ’å…¥åˆ°é“¾è¡¨å°¾éƒ¨</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">linkLast</span><span class="hljs-params">(E e)</span> &#123;<br>    <span class="hljs-comment">// å°†æœ€åä¸€ä¸ªå…ƒç´ èµ‹å€¼ï¼ˆå¼•ç”¨ä¼ é€’ï¼‰ç»™èŠ‚ç‚¹ l</span><br>    <span class="hljs-keyword">final</span> Node&lt;E&gt; l = last;<br>    <span class="hljs-comment">// åˆ›å»ºèŠ‚ç‚¹ï¼Œå¹¶æŒ‡å®šèŠ‚ç‚¹å‰é©±ä¸ºé“¾è¡¨å°¾èŠ‚ç‚¹ lastï¼Œåç»§å¼•ç”¨ä¸ºç©º</span><br>    <span class="hljs-keyword">final</span> Node&lt;E&gt; newNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;&gt;(l, e, <span class="hljs-literal">null</span>);<br>    <span class="hljs-comment">// å°† last å¼•ç”¨æŒ‡å‘æ–°èŠ‚ç‚¹</span><br>    last = newNode;<br>    <span class="hljs-comment">// åˆ¤æ–­å°¾èŠ‚ç‚¹æ˜¯å¦ä¸ºç©º</span><br>    <span class="hljs-comment">// å¦‚æœ l æ˜¯null æ„å‘³ç€è¿™æ˜¯ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ </span><br>    <span class="hljs-keyword">if</span> (l == <span class="hljs-literal">null</span>)<br>        <span class="hljs-comment">// å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ·»åŠ ï¼Œå°†firstèµ‹å€¼ä¸ºæ–°èŠ‚ç‚¹ï¼Œæ­¤æ—¶é“¾è¡¨åªæœ‰ä¸€ä¸ªå…ƒç´ </span><br>        first = newNode;<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-comment">// å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡æ·»åŠ ï¼Œå°†æ–°èŠ‚ç‚¹èµ‹å€¼ç»™lï¼ˆæ·»åŠ å‰çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼‰çš„next</span><br>        l.next = newNode;<br>    size++;<br>    modCount++;<br>&#125;<br><br><span class="hljs-comment">// åœ¨æŒ‡å®šå…ƒç´ ä¹‹å‰æ’å…¥å…ƒç´ </span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">linkBefore</span><span class="hljs-params">(E e, Node&lt;E&gt; succ)</span> &#123;<br>    <span class="hljs-comment">// assert succ != null;æ–­è¨€ succä¸ä¸º null</span><br>    <span class="hljs-comment">// å®šä¹‰ä¸€ä¸ªèŠ‚ç‚¹å…ƒç´ ä¿å­˜ succ çš„ prev å¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯å®ƒçš„å‰ä¸€èŠ‚ç‚¹ä¿¡æ¯</span><br>    <span class="hljs-keyword">final</span> Node&lt;E&gt; pred = succ.prev;<br>    <span class="hljs-comment">// åˆå§‹åŒ–èŠ‚ç‚¹ï¼Œå¹¶æŒ‡æ˜å‰é©±å’Œåç»§èŠ‚ç‚¹</span><br>    <span class="hljs-keyword">final</span> Node&lt;E&gt; newNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;&gt;(pred, e, succ);<br>    <span class="hljs-comment">// å°† succ èŠ‚ç‚¹å‰é©±å¼•ç”¨ prev æŒ‡å‘æ–°èŠ‚ç‚¹</span><br>    succ.prev = newNode;<br>    <span class="hljs-comment">// åˆ¤æ–­å°¾èŠ‚ç‚¹æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºè¡¨ç¤ºå½“å‰é“¾è¡¨è¿˜æ²¡æœ‰èŠ‚ç‚¹</span><br>    <span class="hljs-keyword">if</span> (pred == <span class="hljs-literal">null</span>)<br>        first = newNode;<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-comment">// succ èŠ‚ç‚¹å‰é©±çš„åç»§å¼•ç”¨æŒ‡å‘æ–°èŠ‚ç‚¹</span><br>        pred.next = newNode;<br>    size++;<br>    modCount++;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="è·å–å…ƒç´ "><a href="#è·å–å…ƒç´ " class="headerlink" title="è·å–å…ƒç´ "></a>è·å–å…ƒç´ </h4><p><code>LinkedList</code>è·å–å…ƒç´ ç›¸å…³çš„æ–¹æ³•ä¸€å…±æœ‰ 3 ä¸ªï¼š</p><ol><li><code>getFirst()</code>ï¼šè·å–é“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚</li><li><code>getLast()</code>ï¼šè·å–é“¾è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚</li><li><code>get(int index)</code>ï¼šè·å–é“¾è¡¨æŒ‡å®šä½ç½®çš„å…ƒç´ ã€‚</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è·å–é“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ </span><br><span class="hljs-keyword">public</span> E <span class="hljs-title function_">getFirst</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">final</span> Node&lt;E&gt; f = first;<br>    <span class="hljs-keyword">if</span> (f == <span class="hljs-literal">null</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchElementException</span>();<br>    <span class="hljs-keyword">return</span> f.item;<br>&#125;<br><br><span class="hljs-comment">// è·å–é“¾è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ </span><br><span class="hljs-keyword">public</span> E <span class="hljs-title function_">getLast</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">final</span> Node&lt;E&gt; l = last;<br>    <span class="hljs-keyword">if</span> (l == <span class="hljs-literal">null</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchElementException</span>();<br>    <span class="hljs-keyword">return</span> l.item;<br>&#125;<br><br><span class="hljs-comment">// è·å–é“¾è¡¨æŒ‡å®šä½ç½®çš„å…ƒç´ </span><br><span class="hljs-keyword">public</span> E <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> &#123;<br>  <span class="hljs-comment">// ä¸‹æ ‡è¶Šç•Œæ£€æŸ¥ï¼Œå¦‚æœè¶Šç•Œå°±æŠ›å¼‚å¸¸</span><br>  checkElementIndex(index);<br>  <span class="hljs-comment">// è¿”å›é“¾è¡¨ä¸­å¯¹åº”ä¸‹æ ‡çš„å…ƒç´ </span><br>  <span class="hljs-keyword">return</span> node(index).item;<br>&#125;<br></code></pre></td></tr></table></figure><p>get(index)æ–¹æ³•çš„æ ¸å¿ƒåœ¨äº <code>node(int index)</code> è¿™ä¸ªæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è¿”å›æŒ‡å®šä¸‹æ ‡çš„éç©ºèŠ‚ç‚¹</span><br>Node&lt;E&gt; <span class="hljs-title function_">node</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> &#123;<br>    <span class="hljs-comment">// æ–­è¨€ä¸‹æ ‡æœªè¶Šç•Œ</span><br>    <span class="hljs-comment">// assert isElementIndex(index);</span><br>    <span class="hljs-comment">// å¦‚æœindexå°äºsizeçš„äºŒåˆ†ä¹‹ä¸€  ä»å‰å¼€å§‹æŸ¥æ‰¾ï¼ˆå‘åæŸ¥æ‰¾ï¼‰  åä¹‹å‘å‰æŸ¥æ‰¾</span><br>    <span class="hljs-keyword">if</span> (index &lt; (size &gt;&gt; <span class="hljs-number">1</span>)) &#123;<br>        Node&lt;E&gt; x = first;<br>        <span class="hljs-comment">// éå†ï¼Œå¾ªç¯å‘åæŸ¥æ‰¾ï¼Œç›´è‡³ i == index</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; index; i++)<br>            x = x.next;<br>        <span class="hljs-keyword">return</span> x;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        Node&lt;E&gt; x = last;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> size - <span class="hljs-number">1</span>; i &gt; index; i--)<br>            x = x.prev;<br>        <span class="hljs-keyword">return</span> x;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>get(int index)</code> æˆ– <code>remove(int index)</code> ç­‰æ–¹æ³•å†…éƒ¨éƒ½è°ƒç”¨äº†è¯¥æ–¹æ³•æ¥è·å–å¯¹åº”çš„èŠ‚ç‚¹ã€‚</p><p>ä»è¿™ä¸ªæ–¹æ³•çš„æºç å¯ä»¥çœ‹å‡ºï¼Œè¯¥æ–¹æ³•é€šè¿‡æ¯”è¾ƒç´¢å¼•å€¼ä¸é“¾è¡¨ size çš„ä¸€åŠå¤§å°æ¥ç¡®å®šä»é“¾è¡¨å¤´è¿˜æ˜¯å°¾å¼€å§‹éå†ã€‚å¦‚æœç´¢å¼•å€¼å°äº size çš„ä¸€åŠï¼Œå°±ä»é“¾è¡¨å¤´å¼€å§‹éå†ï¼Œåä¹‹ä»é“¾è¡¨å°¾å¼€å§‹éå†ã€‚è¿™æ ·å¯ä»¥åœ¨è¾ƒçŸ­çš„æ—¶é—´å†…æ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œå……åˆ†åˆ©ç”¨äº†åŒå‘é“¾è¡¨çš„ç‰¹æ€§æ¥æé«˜æ•ˆç‡ã€‚</p><h4 id="åˆ é™¤å…ƒç´ "><a href="#åˆ é™¤å…ƒç´ " class="headerlink" title="åˆ é™¤å…ƒç´ "></a>åˆ é™¤å…ƒç´ </h4><p><code>LinkedList</code>åˆ é™¤å…ƒç´ ç›¸å…³çš„æ–¹æ³•ä¸€å…±æœ‰ 5 ä¸ªï¼š</p><ol><li><code>removeFirst()</code>ï¼šåˆ é™¤å¹¶è¿”å›é“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚</li><li><code>removeLast()</code>ï¼šåˆ é™¤å¹¶è¿”å›é“¾è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚</li><li><code>remove(E e)</code>ï¼šåˆ é™¤é“¾è¡¨ä¸­é¦–æ¬¡å‡ºç°çš„æŒ‡å®šå…ƒç´ ï¼Œå¦‚æœä¸å­˜åœ¨è¯¥å…ƒç´ åˆ™è¿”å› falseã€‚</li><li><code>remove(int index)</code>ï¼šåˆ é™¤æŒ‡å®šç´¢å¼•å¤„çš„å…ƒç´ ï¼Œå¹¶è¿”å›è¯¥å…ƒç´ çš„å€¼ã€‚</li><li><code>void clear()</code>ï¼šç§»é™¤æ­¤é“¾è¡¨ä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åˆ é™¤å¹¶è¿”å›é“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ </span><br><span class="hljs-keyword">public</span> E <span class="hljs-title function_">removeFirst</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">final</span> Node&lt;E&gt; f = first;<br>    <span class="hljs-keyword">if</span> (f == <span class="hljs-literal">null</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchElementException</span>();<br>    <span class="hljs-keyword">return</span> unlinkFirst(f);<br>&#125;<br><br><span class="hljs-comment">// åˆ é™¤å¹¶è¿”å›é“¾è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ </span><br><span class="hljs-keyword">public</span> E <span class="hljs-title function_">removeLast</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">final</span> Node&lt;E&gt; l = last;<br>    <span class="hljs-keyword">if</span> (l == <span class="hljs-literal">null</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchElementException</span>();<br>    <span class="hljs-keyword">return</span> unlinkLast(l);<br>&#125;<br><br><span class="hljs-comment">// åˆ é™¤é“¾è¡¨ä¸­é¦–æ¬¡å‡ºç°çš„æŒ‡å®šå…ƒç´ ï¼Œå¦‚æœä¸å­˜åœ¨è¯¥å…ƒç´ åˆ™è¿”å› fals</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">remove</span><span class="hljs-params">(Object o)</span> &#123;<br>    <span class="hljs-comment">// å¦‚æœæŒ‡å®šå…ƒç´ ä¸º nullï¼Œéå†é“¾è¡¨æ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸º null çš„å…ƒç´ è¿›è¡Œåˆ é™¤</span><br>    <span class="hljs-keyword">if</span> (o == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">for</span> (Node&lt;E&gt; x = first; x != <span class="hljs-literal">null</span>; x = x.next) &#123;<br>            <span class="hljs-keyword">if</span> (x.item == <span class="hljs-literal">null</span>) &#123;<br>                unlink(x);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// å¦‚æœä¸ä¸º null ,éå†é“¾è¡¨æ‰¾åˆ°è¦åˆ é™¤çš„èŠ‚ç‚¹</span><br>        <span class="hljs-keyword">for</span> (Node&lt;E&gt; x = first; x != <span class="hljs-literal">null</span>; x = x.next) &#123;<br>            <span class="hljs-keyword">if</span> (o.equals(x.item)) &#123;<br>                unlink(x);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-comment">// åˆ é™¤é“¾è¡¨æŒ‡å®šä½ç½®çš„å…ƒç´ </span><br><span class="hljs-keyword">public</span> E <span class="hljs-title function_">remove</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> &#123;<br>    <span class="hljs-comment">// ä¸‹æ ‡è¶Šç•Œæ£€æŸ¥ï¼Œå¦‚æœè¶Šç•Œå°±æŠ›å¼‚å¸¸</span><br>    checkElementIndex(index);<br>    <span class="hljs-keyword">return</span> unlink(node(index));<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„æ ¸å¿ƒåœ¨äº <code>unlink(Node&lt;E&gt; x)</code> è¿™ä¸ªæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java">E <span class="hljs-title function_">unlink</span><span class="hljs-params">(Node&lt;E&gt; x)</span> &#123;<br>    <span class="hljs-comment">// æ–­è¨€ x ä¸ä¸º null</span><br>    <span class="hljs-comment">// assert x != null;</span><br>    <span class="hljs-comment">// è·å–å½“å‰èŠ‚ç‚¹ï¼ˆä¹Ÿå°±æ˜¯å¾…åˆ é™¤èŠ‚ç‚¹ï¼‰çš„å…ƒç´ </span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">E</span> <span class="hljs-variable">element</span> <span class="hljs-operator">=</span> x.item;<br>    <span class="hljs-comment">// è·å–å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span><br>    <span class="hljs-keyword">final</span> Node&lt;E&gt; next = x.next;<br>    <span class="hljs-comment">// è·å–å½“å‰èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹</span><br>    <span class="hljs-keyword">final</span> Node&lt;E&gt; prev = x.prev;<br><br>    <span class="hljs-comment">// å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™è¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹</span><br>    <span class="hljs-keyword">if</span> (prev == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// ç»´æŠ¤é“¾è¡¨å¤´æŒ‡å‘å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span><br>        first = next;<br>    <span class="hljs-comment">// å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹ä¸ä¸ºç©º    </span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// å°†å‰ä¸€ä¸ªèŠ‚ç‚¹çš„ next æŒ‡é’ˆæŒ‡å‘å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span><br>        prev.next = next;<br>        <span class="hljs-comment">// å°†å½“å‰èŠ‚ç‚¹çš„ prev æŒ‡é’ˆç½®ä¸º nullï¼Œï¼Œæ–¹ä¾¿ GC å›æ”¶</span><br>        x.prev = <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// å¦‚æœä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™è¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯å°¾èŠ‚ç‚¹</span><br>    <span class="hljs-keyword">if</span> (next == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// ç»´æŠ¤é“¾è¡¨å°¾æŒ‡å‘å½“å‰èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹</span><br>        last = prev;<br>    <span class="hljs-comment">// å¦‚æœä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ä¸ºç©º    </span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// å°†ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ prev æŒ‡é’ˆæŒ‡å‘å½“å‰èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹</span><br>        next.prev = prev;<br>        <span class="hljs-comment">// å°†å½“å‰èŠ‚ç‚¹çš„ next æŒ‡é’ˆç½®ä¸º nullï¼Œæ–¹ä¾¿ GC å›æ”¶</span><br>        x.next = <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// å°†å½“å‰èŠ‚ç‚¹å…ƒç´ ç½®ä¸º nullï¼Œæ–¹ä¾¿ GC å›æ”¶</span><br>    x.item = <span class="hljs-literal">null</span>;<br>    size--;<br>    modCount++;<br>    <span class="hljs-keyword">return</span> element;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>unlink()</code> æ–¹æ³•çš„é€»è¾‘å¦‚ä¸‹ï¼š</p><ol><li><p>é¦–å…ˆè·å–å¾…åˆ é™¤èŠ‚ç‚¹ x çš„å‰é©±å’Œåç»§èŠ‚ç‚¹ï¼›</p></li><li><p>åˆ¤æ–­å¾…åˆ é™¤èŠ‚ç‚¹æ˜¯å¦ä¸ºå¤´èŠ‚ç‚¹æˆ–å°¾èŠ‚ç‚¹ï¼š </p><ul><li><p>å¦‚æœ x æ˜¯å¤´èŠ‚ç‚¹ï¼Œåˆ™å°† first æŒ‡å‘ x çš„åç»§èŠ‚ç‚¹ next</p></li><li><p>å¦‚æœ x æ˜¯å°¾èŠ‚ç‚¹ï¼Œåˆ™å°† last æŒ‡å‘ x çš„å‰é©±èŠ‚ç‚¹ prev</p></li><li><p>å¦‚æœ x ä¸æ˜¯å¤´èŠ‚ç‚¹ä¹Ÿä¸æ˜¯å°¾èŠ‚ç‚¹ï¼Œæ‰§è¡Œä¸‹ä¸€æ­¥æ“ä½œ</p></li></ul></li><li><p>å°†å¾…åˆ é™¤èŠ‚ç‚¹ x çš„å‰é©±çš„åç»§æŒ‡å‘å¾…åˆ é™¤èŠ‚ç‚¹çš„åç»§ nextï¼Œæ–­å¼€ x å’Œ x.prev ä¹‹é—´çš„é“¾æ¥ï¼›</p></li><li><p>å°†å¾…åˆ é™¤èŠ‚ç‚¹ x çš„åç»§çš„å‰é©±æŒ‡å‘å¾…åˆ é™¤èŠ‚ç‚¹çš„å‰é©± prevï¼Œæ–­å¼€ x å’Œ x.next ä¹‹é—´çš„é“¾æ¥ï¼›</p></li><li><p>å°†å¾…åˆ é™¤èŠ‚ç‚¹ x çš„å…ƒç´ ç½®ç©ºï¼Œä¿®æ”¹é“¾è¡¨é•¿åº¦ã€‚</p></li></ol><p>å‚è€ƒä¸‹å›¾ç†è§£ï¼š</p><p><img src="https://image.seeyourface.cn/migrate/LinkedList%E5%88%A0%E9%99%A4%E8%8A%82%E7%82%B9%E9%80%BB%E8%BE%91.jpg" alt="LinkedListåˆ é™¤èŠ‚ç‚¹é€»è¾‘"></p><h4 id="éå†é“¾è¡¨"><a href="#éå†é“¾è¡¨" class="headerlink" title="éå†é“¾è¡¨"></a>éå†é“¾è¡¨</h4><p>æ¨èä½¿ç”¨<code>for-each</code> å¾ªç¯æ¥éå† <code>LinkedList</code> ä¸­çš„å…ƒç´ ï¼Œ <code>for-each</code> å¾ªç¯æœ€ç»ˆä¼šè½¬æ¢æˆè¿­ä»£å™¨å½¢å¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">LinkedList&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br>list.add(<span class="hljs-string">&quot;apple&quot;</span>);<br>list.add(<span class="hljs-string">&quot;banana&quot;</span>);<br>list.add(<span class="hljs-string">&quot;pear&quot;</span>);<br><br><span class="hljs-keyword">for</span> (String fruit : list) &#123;<br>    System.out.println(fruit);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>LinkedList</code> çš„éå†çš„æ ¸å¿ƒå°±æ˜¯å®ƒçš„è¿­ä»£å™¨çš„å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åŒå‘è¿­ä»£å™¨</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ListItr</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ListIterator</span>&lt;E&gt; &#123;<br>    <span class="hljs-comment">// è¡¨ç¤ºä¸Šä¸€æ¬¡è°ƒç”¨ next() æˆ– previous() æ–¹æ³•æ—¶ç»è¿‡çš„èŠ‚ç‚¹ï¼›</span><br>    <span class="hljs-keyword">private</span> Node&lt;E&gt; lastReturned;<br>    <span class="hljs-comment">// è¡¨ç¤ºä¸‹ä¸€ä¸ªè¦éå†çš„èŠ‚ç‚¹ï¼›</span><br>    <span class="hljs-keyword">private</span> Node&lt;E&gt; next;<br>    <span class="hljs-comment">// è¡¨ç¤ºä¸‹ä¸€ä¸ªè¦éå†çš„èŠ‚ç‚¹çš„ä¸‹æ ‡ï¼Œä¹Ÿå°±æ˜¯å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹çš„ä¸‹æ ‡ï¼›</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> nextIndex;<br>    <span class="hljs-comment">// è¡¨ç¤ºå½“å‰éå†æœŸæœ›çš„ä¿®æ”¹è®¡æ•°å€¼ï¼Œç”¨äºå’Œ LinkedList çš„ modCount æ¯”è¾ƒï¼Œåˆ¤æ–­é“¾è¡¨æ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡ã€‚</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">expectedModCount</span> <span class="hljs-operator">=</span> modCount;<br>    â€¦â€¦â€¦â€¦<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢å¯¹è¿­ä»£å™¨ <code>ListItr</code> ä¸­çš„æ ¸å¿ƒæ–¹æ³•è¿›è¡Œè¯¦ç»†ä»‹ç»ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ä»å¤´åˆ°å°¾æ–¹å‘çš„è¿­ä»£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åˆ¤æ–­è¿˜æœ‰æ²¡æœ‰ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasNext</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// åˆ¤æ–­ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ä¸‹æ ‡æ˜¯å¦å°äºé“¾è¡¨çš„å¤§å°ï¼Œå¦‚æœæ˜¯åˆ™è¡¨ç¤ºè¿˜æœ‰ä¸‹ä¸€ä¸ªå…ƒç´ å¯ä»¥éå†</span><br>    <span class="hljs-keyword">return</span> nextIndex &lt; size;<br>&#125;<br><br><span class="hljs-comment">// è·å–ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span><br><span class="hljs-keyword">public</span> E <span class="hljs-title function_">next</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// æ£€æŸ¥åœ¨è¿­ä»£è¿‡ç¨‹ä¸­é“¾è¡¨æ˜¯å¦è¢«ä¿®æ”¹è¿‡</span><br>    checkForComodification();<br>    <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥éå†ï¼Œå¦‚æœæ²¡æœ‰åˆ™æŠ›å‡º NoSuchElementException å¼‚å¸¸</span><br>    <span class="hljs-keyword">if</span> (!hasNext())<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchElementException</span>();<br>    <span class="hljs-comment">// å°† lastReturned æŒ‡å‘å½“å‰èŠ‚ç‚¹</span><br>    lastReturned = next;<br>    <span class="hljs-comment">// å°† next æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span><br>    next = next.next;<br>    nextIndex++;<br>    <span class="hljs-keyword">return</span> lastReturned.item;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†æ¥çœ‹ä¸€ä¸‹ä»å°¾åˆ°å¤´æ–¹å‘çš„è¿­ä»£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦è¿˜æœ‰å‰ä¸€ä¸ªèŠ‚ç‚¹</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasPrevious</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> nextIndex &gt; <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// è·å–å‰ä¸€ä¸ªèŠ‚ç‚¹</span><br><span class="hljs-keyword">public</span> E <span class="hljs-title function_">previous</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦åœ¨è¿­ä»£è¿‡ç¨‹ä¸­é“¾è¡¨è¢«ä¿®æ”¹</span><br>    checkForComodification();<br>    <span class="hljs-comment">// å¦‚æœæ²¡æœ‰å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span><br>    <span class="hljs-keyword">if</span> (!hasPrevious())<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchElementException</span>();<br>    <span class="hljs-comment">// å°† lastReturned å’Œ next æŒ‡é’ˆæŒ‡å‘ä¸Šä¸€ä¸ªèŠ‚ç‚¹</span><br>    lastReturned = next = (next == <span class="hljs-literal">null</span>) ? last : next.prev;<br>    nextIndex--;<br>    <span class="hljs-keyword">return</span> lastReturned.item;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœéœ€è¦åˆ é™¤æˆ–æ’å…¥å…ƒç´ ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è¿­ä»£å™¨è¿›è¡Œæ“ä½œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">LinkedList&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br>list.add(<span class="hljs-string">&quot;apple&quot;</span>);<br>list.add(<span class="hljs-literal">null</span>);<br>list.add(<span class="hljs-string">&quot;banana&quot;</span>);<br><br><span class="hljs-comment">// Collection æ¥å£çš„ removeIf æ–¹æ³•åº•å±‚ä¾ç„¶æ˜¯åŸºäºè¿­ä»£å™¨</span><br>list.removeIf(Objects::isNull);<br><br><span class="hljs-keyword">for</span> (String fruit : list) &#123;<br>    System.out.println(fruit);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿­ä»£å™¨å¯¹åº”çš„ç§»é™¤å…ƒç´ çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ä»åˆ—è¡¨ä¸­åˆ é™¤ä¸Šæ¬¡è¢«è¿”å›çš„å…ƒç´ </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦åœ¨è¿­ä»£è¿‡ç¨‹ä¸­é“¾è¡¨è¢«ä¿®æ”¹</span><br>    checkForComodification();<br>    <span class="hljs-comment">// å¦‚æœä¸Šæ¬¡è¿”å›çš„èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span><br>    <span class="hljs-keyword">if</span> (lastReturned == <span class="hljs-literal">null</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>();<br><br>    <span class="hljs-comment">// è·å–å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span><br>    Node&lt;E&gt; lastNext = lastReturned.next;<br>    <span class="hljs-comment">// ä»é“¾è¡¨ä¸­åˆ é™¤ä¸Šæ¬¡è¿”å›çš„èŠ‚ç‚¹</span><br>    unlink(lastReturned);<br>    <span class="hljs-comment">// ä¿®æ”¹æŒ‡é’ˆ</span><br>    <span class="hljs-keyword">if</span> (next == lastReturned)<br>        next = lastNext;<br>    <span class="hljs-keyword">else</span><br>        nextIndex--;<br>    <span class="hljs-comment">// å°†ä¸Šæ¬¡è¿”å›çš„èŠ‚ç‚¹å¼•ç”¨ç½®ä¸º nullï¼Œæ–¹ä¾¿ GC å›æ”¶</span><br>    lastReturned = <span class="hljs-literal">null</span>;<br>    expectedModCount++;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æºç </category>
      
      <category>JDK</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é›†åˆ</tag>
      
      <tag>LinkedList</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JDKæºç ç³»åˆ—-ArrayList</title>
    <link href="/2023/09/24/JDK%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-ArrayList/"/>
    <url>/2023/09/24/JDK%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-ArrayList/</url>
    
    <content type="html"><![CDATA[<h3 id="ArrayList"><a href="#ArrayList" class="headerlink" title="ArrayList"></a>ArrayList</h3><h4 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h4><p>æœ¬æ–‡å†…å®¹å‡ä»¥JDK8ä¸ºä¾‹ã€‚</p><p><code>ArrayList</code> ç»§æ‰¿äº <code>AbstractList</code> ï¼Œå®ç°äº† <code>List</code>, <code>RandomAccess</code>, <code>Cloneable</code>, <code>java.io.Serializable</code> è¿™äº›æ¥å£ã€‚</p><ul><li><code>List</code> : è¡¨æ˜å®ƒæ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œæ”¯æŒæ·»åŠ ã€åˆ é™¤ã€æŸ¥æ‰¾ç­‰æ“ä½œï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ä¸‹æ ‡è¿›è¡Œè®¿é—®ã€‚</li><li><code>RandomAccess</code> : è¿™æ˜¯ä¸€ä¸ªæ ‡å¿—æ¥å£ï¼Œè¡¨æ˜å®ç°è¿™ä¸ªæ¥å£çš„ <code>List</code> é›†åˆæ˜¯æ”¯æŒ <strong>å¿«é€Ÿéšæœºè®¿é—®</strong> çš„ã€‚åœ¨ <code>ArrayList</code> ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å…ƒç´ çš„åºå·å¿«é€Ÿè·å–å…ƒç´ å¯¹è±¡ï¼Œè¿™å°±æ˜¯å¿«é€Ÿéšæœºè®¿é—®ã€‚</li><li><code>Cloneable</code> ï¼šè¡¨æ˜å®ƒå…·æœ‰æ‹·è´èƒ½åŠ›ï¼Œå¯ä»¥è¿›è¡Œæ·±æ‹·è´æˆ–æµ…æ‹·è´æ“ä½œã€‚</li><li><code>Serializable</code> : è¡¨æ˜å®ƒå¯ä»¥è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œï¼Œä¹Ÿå°±æ˜¯å³å¯ä»¥å°†<strong>å¯¹è±¡åºåˆ—åŒ–ä¸ºå­—èŠ‚æµ</strong>è¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨æˆ–ç½‘ç»œä¼ è¾“ï¼Œä¹Ÿå¯ä»¥ä»<strong>å­—èŠ‚æµååºåˆ—åŒ–ä¸ºå¯¹è±¡</strong>ï¼Œéå¸¸æ–¹ä¾¿ã€‚</li></ul><p><img src="https://image.seeyourface.cn/migrate/image-20230924112821522.png" alt="image-20230924112821522"></p><p><code>ArrayList</code> çš„åº•å±‚æ˜¯æ•°ç»„é˜Ÿåˆ—ï¼Œç›¸å½“äº<strong>åŠ¨æ€æ•°ç»„</strong>ã€‚ä¸ Java ä¸­çš„æ•°ç»„ç›¸æ¯”ï¼Œå®ƒçš„ä¼˜ç‚¹æ˜¯å®¹é‡èƒ½åŠ¨æ€å¢é•¿ã€‚åœ¨æ·»åŠ å¤§é‡å…ƒç´ å‰ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨<code>ensureCapacity</code>æ“ä½œæ¥å¢åŠ  <code>ArrayList</code> å®ä¾‹çš„å®¹é‡ã€‚è¿™æ ·å¯ä»¥å‡å°‘é€’å¢å¼å†åˆ†é…çš„æ•°é‡ï¼Œæé«˜ç¨‹åºæ‰§è¡Œçš„æ•ˆç‡ã€‚</p><h4 id="ArrayListå’ŒVectorçš„åŒºåˆ«ï¼Ÿ"><a href="#ArrayListå’ŒVectorçš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="ArrayListå’ŒVectorçš„åŒºåˆ«ï¼Ÿ"></a>ArrayListå’ŒVectorçš„åŒºåˆ«ï¼Ÿ</h4><ul><li><code>ArrayList</code> æ˜¯ <code>List</code> çš„ä¸»è¦å®ç°ç±»ï¼Œåº•å±‚ä½¿ç”¨ <code>Object[]</code>å­˜å‚¨ï¼Œé€‚ç”¨äºé¢‘ç¹çš„æŸ¥æ‰¾å·¥ä½œï¼Œçº¿ç¨‹ä¸å®‰å…¨ã€‚</li><li><code>Vector</code> æ˜¯ <code>List</code> çš„å¤è€å®ç°ç±»ï¼Œåº•å±‚ä½¿ç”¨<code>Object[]</code> å­˜å‚¨ï¼Œé€šè¿‡<em>synchronized</em>å…³é”®å­—ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</li></ul><h4 id="ArrayListå¯ä»¥æ·»åŠ nullå€¼å—ï¼Ÿ"><a href="#ArrayListå¯ä»¥æ·»åŠ nullå€¼å—ï¼Ÿ" class="headerlink" title="ArrayListå¯ä»¥æ·»åŠ nullå€¼å—ï¼Ÿ"></a>ArrayListå¯ä»¥æ·»åŠ nullå€¼å—ï¼Ÿ</h4><p><code>ArrayList</code> ä¸­å¯ä»¥å­˜å‚¨ä»»ä½•ç±»å‹çš„å¯¹è±¡ï¼ŒåŒ…æ‹¬ <code>null</code> å€¼ã€‚ä½†æ˜¯ä¸å»ºè®®å‘<code>ArrayList</code> ä¸­æ·»åŠ  <code>null</code> å€¼ï¼Œ å› ä¸º<code>null</code> å€¼æ— æ„ä¹‰ï¼Œä¼šè®©ä»£ç éš¾ä»¥ç»´æŠ¤ä¾‹å¦‚å¿˜è®°åšåˆ¤ç©ºå¤„ç†å°±ä¼šå¯¼è‡´<strong>ç©ºæŒ‡é’ˆ</strong>å¼‚å¸¸ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230924114702452.png" alt="image-20230924114702452"></p><h4 id="Arraylist-ä¸-LinkedList-åŒºåˆ«"><a href="#Arraylist-ä¸-LinkedList-åŒºåˆ«" class="headerlink" title="Arraylist ä¸ LinkedList åŒºåˆ«?"></a>Arraylist ä¸ LinkedList åŒºåˆ«?</h4><ul><li><strong>æ˜¯å¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼š</strong> <code>ArrayList</code> å’Œ <code>LinkedList</code> éƒ½ä¸æ˜¯åŒæ­¥çš„ï¼Œä¹Ÿå°±æ˜¯ä¸ä¿è¯çº¿ç¨‹å®‰å…¨ï¼›</li><li><strong>åº•å±‚æ•°æ®ç»“æ„ï¼š</strong> <code>ArrayList</code> åº•å±‚ä½¿ç”¨çš„æ˜¯ <strong>Object æ•°ç»„</strong>ï¼›<code>LinkedList</code> åº•å±‚ä½¿ç”¨çš„æ˜¯ <strong>åŒå‘é“¾è¡¨</strong> æ•°æ®ç»“æ„ï¼ˆJDK1.6 ä¹‹å‰ä¸ºåŒå‘å¾ªç¯é“¾è¡¨ï¼ŒJDK1.7 å–æ¶ˆäº†å¾ªç¯ã€‚æ³¨æ„åŒå‘é“¾è¡¨å’ŒåŒå‘å¾ªç¯é“¾è¡¨çš„åŒºåˆ«ï¼Œä¸‹é¢æœ‰ä»‹ç»åˆ°ï¼ï¼‰</li><li><strong>æ’å…¥å’Œåˆ é™¤æ˜¯å¦å—å…ƒç´ ä½ç½®çš„å½±å“ï¼š</strong><ul><li><code>ArrayList</code> é‡‡ç”¨æ•°ç»„å­˜å‚¨ï¼Œæ‰€ä»¥æ’å…¥å’Œåˆ é™¤å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦å—å…ƒç´ ä½ç½®çš„å½±å“ã€‚ æ¯”å¦‚ï¼šæ‰§è¡Œ<code>add(E e)</code>æ–¹æ³•çš„æ—¶å€™ï¼Œ <code>ArrayList</code> ä¼šé»˜è®¤åœ¨å°†æŒ‡å®šçš„å…ƒç´ è¿½åŠ åˆ°æ­¤åˆ—è¡¨çš„æœ«å°¾ï¼Œè¿™ç§æƒ…å†µæ—¶é—´å¤æ‚åº¦å°±æ˜¯ O(1)ã€‚ä½†æ˜¯å¦‚æœè¦åœ¨æŒ‡å®šä½ç½® i æ’å…¥å’Œåˆ é™¤å…ƒç´ çš„è¯ï¼ˆ<code>add(int index, E element)</code>ï¼‰ï¼Œæ—¶é—´å¤æ‚åº¦å°±ä¸º O(n)ã€‚å› ä¸ºåœ¨è¿›è¡Œä¸Šè¿°æ“ä½œçš„æ—¶å€™é›†åˆä¸­ç¬¬ i å’Œç¬¬ i ä¸ªå…ƒç´ ä¹‹åçš„(n-i)ä¸ªå…ƒç´ éƒ½è¦æ‰§è¡Œ<strong>å‘åä½&#x2F;å‘å‰</strong>ç§»ä¸€ä½çš„æ“ä½œã€‚</li><li><code>LinkedList</code> é‡‡ç”¨é“¾è¡¨å­˜å‚¨ï¼Œæ‰€ä»¥åœ¨å¤´å°¾æ’å…¥æˆ–è€…åˆ é™¤å…ƒç´ ä¸å—å…ƒç´ ä½ç½®çš„å½±å“ï¼ˆ<code>add(E e)</code>ã€<code>addFirst(E e)</code>ã€<code>addLast(E e)</code>ã€<code>removeFirst()</code>ã€ <code>removeLast()</code>ï¼‰ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼Œå¦‚æœæ˜¯è¦åœ¨æŒ‡å®šä½ç½® <code>i</code> æ’å…¥å’Œåˆ é™¤å…ƒç´ çš„è¯ï¼ˆ<code>add(int index, E element)</code>ï¼Œ<code>remove(Object o)</code>,<code>remove(int index)</code>ï¼‰ï¼Œ æ—¶é—´å¤æ‚åº¦ä¸º O(n) ï¼Œå› ä¸ºéœ€è¦å…ˆ<strong>ç§»åŠ¨åˆ°æŒ‡å®šä½ç½®</strong>å†æ’å…¥å’Œåˆ é™¤ã€‚</li></ul></li><li><strong>æ˜¯å¦æ”¯æŒå¿«é€Ÿéšæœºè®¿é—®ï¼š</strong> <code>LinkedList</code> ä¸æ”¯æŒé«˜æ•ˆçš„éšæœºå…ƒç´ è®¿é—®ï¼Œè€Œ <code>ArrayList</code>ï¼ˆå®ç°äº† <code>RandomAccess</code> æ¥å£ï¼‰ æ”¯æŒã€‚å¿«é€Ÿéšæœºè®¿é—®å°±æ˜¯é€šè¿‡å…ƒç´ çš„åºå·å¿«é€Ÿè·å–å…ƒç´ å¯¹è±¡(å¯¹åº”äº<code>get(int index)</code>æ–¹æ³•)ã€‚æœ¬è´¨æ˜¯å› ä¸º<code>LinkedList</code>å…ƒç´ çš„å­˜å‚¨ä¸æ˜¯è¿ç»­çš„ã€‚</li><li><strong>å†…å­˜ç©ºé—´å ç”¨ï¼š</strong> <code>ArrayList</code> çš„ç©ºé—´æµªè´¹ä¸»è¦ä½“ç°åœ¨åœ¨ list åˆ—è¡¨çš„ç»“å°¾ä¼šé¢„ç•™ä¸€å®šçš„å®¹é‡ç©ºé—´ï¼Œè€Œ <code>LinkedList</code> çš„ç©ºé—´èŠ±è´¹åˆ™ä½“ç°åœ¨å®ƒçš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½éœ€è¦æ¶ˆè€—æ¯” <code>ArrayList</code> æ›´å¤šçš„ç©ºé—´ï¼ˆå› ä¸ºè¦å­˜æ”¾ç›´æ¥åç»§å’Œç›´æ¥å‰é©±ä»¥åŠæ•°æ®ï¼‰ã€‚</li></ul><h4 id="ArrayListæ ¸å¿ƒæºç "><a href="#ArrayListæ ¸å¿ƒæºç " class="headerlink" title="ArrayListæ ¸å¿ƒæºç "></a>ArrayListæ ¸å¿ƒæºç </h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> java.util;<br><br><span class="hljs-keyword">import</span> java.util.function.Consumer;<br><span class="hljs-keyword">import</span> java.util.function.Predicate;<br><span class="hljs-keyword">import</span> java.util.function.UnaryOperator;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArrayList</span>&lt;E&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractList</span>&lt;E&gt;<br>        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">List</span>&lt;E&gt;, RandomAccess, Cloneable, java.io.Serializable<br>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">8683452581122892189L</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * é»˜è®¤åˆå§‹å®¹é‡å¤§å°</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">DEFAULT_CAPACITY</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ç©ºæ•°ç»„ï¼ˆç”¨äºç©ºå®ä¾‹ï¼‰ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Object[] EMPTY_ELEMENTDATA = &#123;&#125;;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * ç”¨äºé»˜è®¤å¤§å°ç©ºå®ä¾‹çš„å…±äº«ç©ºæ•°ç»„å®ä¾‹ã€‚</span><br><span class="hljs-comment">     * ç›®çš„æ˜¯æŠŠå®ƒä»EMPTY_ELEMENTDATAæ•°ç»„ä¸­åŒºåˆ†å‡ºæ¥ï¼Œä»¥çŸ¥é“åœ¨æ·»åŠ ç¬¬ä¸€ä¸ªå…ƒç´ æ—¶å®¹é‡éœ€è¦å¢åŠ å¤šå°‘ã€‚</span><br><span class="hljs-comment">     */</span> <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = &#123;&#125;;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ä¿å­˜ArrayListæ•°æ®çš„æ•°ç»„</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">transient</span> Object[] elementData; <span class="hljs-comment">// non-private to simplify nested class access</span><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ArrayList æ‰€åŒ…å«çš„å…ƒç´ ä¸ªæ•°</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> size;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å¸¦åˆå§‹å®¹é‡å‚æ•°çš„æ„é€ å‡½æ•°ï¼ˆç”¨æˆ·å¯ä»¥åœ¨åˆ›å»ºArrayListå¯¹è±¡æ—¶è‡ªå·±æŒ‡å®šé›†åˆçš„åˆå§‹å¤§å°ï¼‰</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ArrayList</span><span class="hljs-params">(<span class="hljs-type">int</span> initialCapacity)</span> &#123;<br>        <span class="hljs-keyword">if</span> (initialCapacity &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">//å¦‚æœä¼ å…¥çš„å‚æ•°å¤§äº0ï¼Œåˆ›å»ºinitialCapacityå¤§å°çš„æ•°ç»„</span><br>            <span class="hljs-built_in">this</span>.elementData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[initialCapacity];<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (initialCapacity == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">//å¦‚æœä¼ å…¥çš„å‚æ•°ç­‰äº0ï¼Œåˆ›å»ºç©ºæ•°ç»„</span><br>            <span class="hljs-built_in">this</span>.elementData = EMPTY_ELEMENTDATA;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//å…¶ä»–æƒ…å†µï¼ŒæŠ›å‡ºå¼‚å¸¸</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Illegal Capacity: &quot;</span>+<br>                                               initialCapacity);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * é»˜è®¤æ— å‚æ„é€ å‡½æ•°</span><br><span class="hljs-comment">     * DEFAULTCAPACITY_EMPTY_ELEMENTDATA ä¸º0.åˆå§‹åŒ–ä¸º10ï¼Œä¹Ÿå°±æ˜¯è¯´åˆå§‹å…¶å®æ˜¯ç©ºæ•°ç»„ å½“æ·»åŠ ç¬¬ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™æ•°ç»„å®¹é‡æ‰å˜æˆ10</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ArrayList</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ„é€ ä¸€ä¸ªåŒ…å«æŒ‡å®šé›†åˆçš„å…ƒç´ çš„åˆ—è¡¨ï¼ŒæŒ‰ç…§å®ƒä»¬ç”±é›†åˆçš„è¿­ä»£å™¨è¿”å›çš„é¡ºåºã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ArrayList</span><span class="hljs-params">(Collection&lt;? extends E&gt; c)</span> &#123;<br>        <span class="hljs-comment">//å°†æŒ‡å®šé›†åˆè½¬æ¢ä¸ºæ•°ç»„</span><br>        elementData = c.toArray();<br>        <span class="hljs-comment">//å¦‚æœelementDataæ•°ç»„çš„é•¿åº¦ä¸ä¸º0</span><br>        <span class="hljs-keyword">if</span> ((size = elementData.length) != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// å¦‚æœelementDataä¸æ˜¯Objectç±»å‹æ•°æ®ï¼ˆc.toArrayå¯èƒ½è¿”å›çš„ä¸æ˜¯Objectç±»å‹çš„æ•°ç»„æ‰€ä»¥åŠ ä¸Šä¸‹é¢çš„è¯­å¥ç”¨äºåˆ¤æ–­ï¼‰</span><br>            <span class="hljs-keyword">if</span> (elementData.getClass() != Object[].class)<br>                <span class="hljs-comment">//å°†åŸæ¥ä¸æ˜¯Objectç±»å‹çš„elementDataæ•°ç»„çš„å†…å®¹ï¼Œèµ‹å€¼ç»™æ–°çš„Objectç±»å‹çš„elementDataæ•°ç»„</span><br>                elementData = Arrays.copyOf(elementData, size, Object[].class);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// elementDataæ•°ç»„é•¿åº¦ä¸º0ï¼Œç”¨ç©ºæ•°ç»„ä»£æ›¿</span><br>            <span class="hljs-built_in">this</span>.elementData = EMPTY_ELEMENTDATA;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ä¿®æ”¹è¿™ä¸ªArrayListå®ä¾‹çš„å®¹é‡æ˜¯åˆ—è¡¨çš„å½“å‰å¤§å°ã€‚ åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨æ­¤æ“ä½œæ¥æœ€å°åŒ–ArrayListå®ä¾‹çš„å­˜å‚¨ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">trimToSize</span><span class="hljs-params">()</span> &#123;<br>        modCount++;<br>        <span class="hljs-keyword">if</span> (size &lt; elementData.length) &#123;<br>            elementData = (size == <span class="hljs-number">0</span>)<br>              ? EMPTY_ELEMENTDATA<br>              : Arrays.copyOf(elementData, size);<br>        &#125;<br>    &#125;<br>    <br><span class="hljs-comment">//ä¸‹é¢æ˜¯ArrayListçš„æ‰©å®¹æœºåˆ¶</span><br><span class="hljs-comment">//ArrayListçš„æ‰©å®¹æœºåˆ¶æé«˜äº†æ€§èƒ½ï¼Œå¦‚æœæ¯æ¬¡åªæ‰©å……ä¸€ä¸ªï¼Œ</span><br><span class="hljs-comment">//é‚£ä¹ˆé¢‘ç¹çš„æ’å…¥ä¼šå¯¼è‡´é¢‘ç¹çš„æ‹·è´ï¼Œé™ä½æ€§èƒ½ï¼Œè€ŒArrayListçš„æ‰©å®¹æœºåˆ¶é¿å…äº†è¿™ç§æƒ…å†µã€‚</span><br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å¦‚æœ‰å¿…è¦ï¼Œå¢åŠ æ­¤ArrayListå®ä¾‹çš„å®¹é‡ï¼Œä»¥ç¡®ä¿å®ƒè‡³å°‘èƒ½å®¹çº³å…ƒç´ çš„æ•°é‡</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span>   minCapacity   æ‰€éœ€çš„æœ€å°å®¹é‡</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ensureCapacity</span><span class="hljs-params">(<span class="hljs-type">int</span> minCapacity)</span> &#123;<br>        <span class="hljs-comment">//å¦‚æœæ˜¯trueï¼ŒminExpandçš„å€¼ä¸º0ï¼Œå¦‚æœæ˜¯false,minExpandçš„å€¼ä¸º10</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">minExpand</span> <span class="hljs-operator">=</span> (elementData != DEFAULTCAPACITY_EMPTY_ELEMENTDATA)<br>            <span class="hljs-comment">// any size if not default element table</span><br>            ? <span class="hljs-number">0</span><br>            <span class="hljs-comment">// larger than default for default empty table. It&#x27;s already</span><br>            <span class="hljs-comment">// supposed to be at default size.</span><br>            : DEFAULT_CAPACITY;<br>        <span class="hljs-comment">//å¦‚æœæœ€å°å®¹é‡å¤§äºå·²æœ‰çš„æœ€å¤§å®¹é‡</span><br>        <span class="hljs-keyword">if</span> (minCapacity &gt; minExpand) &#123;<br>            ensureExplicitCapacity(minCapacity);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">//1.å¾—åˆ°æœ€å°æ‰©å®¹é‡</span><br>    <span class="hljs-comment">//2.é€šè¿‡æœ€å°å®¹é‡æ‰©å®¹</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ensureCapacityInternal</span><span class="hljs-params">(<span class="hljs-type">int</span> minCapacity)</span> &#123;<br>        <span class="hljs-keyword">if</span> (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) &#123;<br>              <span class="hljs-comment">// è·å–â€œé»˜è®¤çš„å®¹é‡â€å’Œâ€œä¼ å…¥å‚æ•°â€ä¸¤è€…ä¹‹é—´çš„æœ€å¤§å€¼</span><br>            minCapacity = Math.max(DEFAULT_CAPACITY, minCapacity);<br>        &#125;<br><br>        ensureExplicitCapacity(minCapacity);<br>    &#125;<br>    <br>    <span class="hljs-comment">//åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ensureExplicitCapacity</span><span class="hljs-params">(<span class="hljs-type">int</span> minCapacity)</span> &#123;<br>        modCount++;<br><br>        <span class="hljs-comment">// overflow-conscious code</span><br>        <span class="hljs-keyword">if</span> (minCapacity - elementData.length &gt; <span class="hljs-number">0</span>)<br>            <span class="hljs-comment">//è°ƒç”¨growæ–¹æ³•è¿›è¡Œæ‰©å®¹ï¼Œè°ƒç”¨æ­¤æ–¹æ³•ä»£è¡¨å·²ç»å¼€å§‹æ‰©å®¹äº†</span><br>            grow(minCapacity);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è¦åˆ†é…çš„æœ€å¤§æ•°ç»„å¤§å°</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_ARRAY_SIZE</span> <span class="hljs-operator">=</span> Integer.MAX_VALUE - <span class="hljs-number">8</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ArrayListæ‰©å®¹çš„æ ¸å¿ƒæ–¹æ³•ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">grow</span><span class="hljs-params">(<span class="hljs-type">int</span> minCapacity)</span> &#123;<br>        <span class="hljs-comment">// oldCapacityä¸ºæ—§å®¹é‡ï¼ŒnewCapacityä¸ºæ–°å®¹é‡</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">oldCapacity</span> <span class="hljs-operator">=</span> elementData.length;<br>        <span class="hljs-comment">//å°†oldCapacity å³ç§»ä¸€ä½ï¼Œå…¶æ•ˆæœç›¸å½“äºoldCapacity / 2ï¼Œ</span><br>        <span class="hljs-comment">//æˆ‘ä»¬çŸ¥é“ä½è¿ç®—çš„é€Ÿåº¦è¿œè¿œå¿«äºæ•´é™¤è¿ç®—ï¼Œæ•´å¥è¿ç®—å¼çš„ç»“æœå°±æ˜¯å°†æ–°å®¹é‡æ›´æ–°ä¸ºæ—§å®¹é‡çš„1.5å€ï¼Œ</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">newCapacity</span> <span class="hljs-operator">=</span> oldCapacity + (oldCapacity &gt;&gt; <span class="hljs-number">1</span>);<br>        <span class="hljs-comment">//ç„¶åæ£€æŸ¥æ–°å®¹é‡æ˜¯å¦å¤§äºæœ€å°éœ€è¦å®¹é‡ï¼Œè‹¥è¿˜æ˜¯å°äºæœ€å°éœ€è¦å®¹é‡ï¼Œé‚£ä¹ˆå°±æŠŠæœ€å°éœ€è¦å®¹é‡å½“ä½œæ•°ç»„çš„æ–°å®¹é‡ï¼Œ</span><br>        <span class="hljs-keyword">if</span> (newCapacity - minCapacity &lt; <span class="hljs-number">0</span>)<br>            newCapacity = minCapacity;<br>        <span class="hljs-comment">//å†æ£€æŸ¥æ–°å®¹é‡æ˜¯å¦è¶…å‡ºäº†ArrayListæ‰€å®šä¹‰çš„æœ€å¤§å®¹é‡ï¼Œ</span><br>        <span class="hljs-comment">//è‹¥è¶…å‡ºäº†ï¼Œåˆ™è°ƒç”¨hugeCapacity()æ¥æ¯”è¾ƒminCapacityå’Œ MAX_ARRAY_SIZEï¼Œ</span><br>        <span class="hljs-comment">//å¦‚æœminCapacityå¤§äºMAX_ARRAY_SIZEï¼Œåˆ™æ–°å®¹é‡åˆ™ä¸ºInterger.MAX_VALUEï¼Œå¦åˆ™ï¼Œæ–°å®¹é‡å¤§å°åˆ™ä¸º MAX_ARRAY_SIZEã€‚</span><br>        <span class="hljs-keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="hljs-number">0</span>)<br>            newCapacity = hugeCapacity(minCapacity);<br>        <span class="hljs-comment">// minCapacity is usually close to size, so this is a win:</span><br>        elementData = Arrays.copyOf(elementData, newCapacity);<br>    &#125;<br>    <br>    <span class="hljs-comment">//æ¯”è¾ƒminCapacityå’Œ MAX_ARRAY_SIZE</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hugeCapacity</span><span class="hljs-params">(<span class="hljs-type">int</span> minCapacity)</span> &#123;<br>        <span class="hljs-keyword">if</span> (minCapacity &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">// overflow</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OutOfMemoryError</span>();<br>        <span class="hljs-keyword">return</span> (minCapacity &gt; MAX_ARRAY_SIZE) ?<br>            Integer.MAX_VALUE :<br>            MAX_ARRAY_SIZE;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *è¿”å›æ­¤åˆ—è¡¨ä¸­çš„å…ƒç´ æ•°ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> size;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å¦‚æœæ­¤åˆ—è¡¨ä¸åŒ…å«å…ƒç´ ï¼Œåˆ™è¿”å› true ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEmpty</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//æ³¨æ„=å’Œ==çš„åŒºåˆ«</span><br>        <span class="hljs-keyword">return</span> size == <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å¦‚æœæ­¤åˆ—è¡¨åŒ…å«æŒ‡å®šçš„å…ƒç´ ï¼Œåˆ™è¿”å›true ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">contains</span><span class="hljs-params">(Object o)</span> &#123;<br>        <span class="hljs-comment">//indexOf()æ–¹æ³•ï¼šè¿”å›æ­¤åˆ—è¡¨ä¸­æŒ‡å®šå…ƒç´ çš„é¦–æ¬¡å‡ºç°çš„ç´¢å¼•ï¼Œå¦‚æœæ­¤åˆ—è¡¨ä¸åŒ…å«æ­¤å…ƒç´ ï¼Œåˆ™ä¸º-1</span><br>        <span class="hljs-keyword">return</span> indexOf(o) &gt;= <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *è¿”å›æ­¤åˆ—è¡¨ä¸­æŒ‡å®šå…ƒç´ çš„é¦–æ¬¡å‡ºç°çš„ç´¢å¼•ï¼Œå¦‚æœæ­¤åˆ—è¡¨ä¸åŒ…å«æ­¤å…ƒç´ ï¼Œåˆ™ä¸º-1</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">indexOf</span><span class="hljs-params">(Object o)</span> &#123;<br>        <span class="hljs-keyword">if</span> (o == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; size; i++)<br>                <span class="hljs-keyword">if</span> (elementData[i]==<span class="hljs-literal">null</span>)<br>                    <span class="hljs-keyword">return</span> i;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; size; i++)<br>                <span class="hljs-comment">//equals()æ–¹æ³•æ¯”è¾ƒ</span><br>                <span class="hljs-keyword">if</span> (o.equals(elementData[i]))<br>                    <span class="hljs-keyword">return</span> i;<br>        &#125;<br>        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è¿”å›æ­¤åˆ—è¡¨ä¸­æŒ‡å®šå…ƒç´ çš„æœ€åä¸€æ¬¡å‡ºç°çš„ç´¢å¼•ï¼Œå¦‚æœæ­¤åˆ—è¡¨ä¸åŒ…å«å…ƒç´ ï¼Œåˆ™è¿”å›-1ã€‚.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">lastIndexOf</span><span class="hljs-params">(Object o)</span> &#123;<br>        <span class="hljs-keyword">if</span> (o == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> size-<span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--)<br>                <span class="hljs-keyword">if</span> (elementData[i]==<span class="hljs-literal">null</span>)<br>                    <span class="hljs-keyword">return</span> i;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> size-<span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--)<br>                <span class="hljs-keyword">if</span> (o.equals(elementData[i]))<br>                    <span class="hljs-keyword">return</span> i;<br>        &#125;<br>        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è¿”å›æ­¤ArrayListå®ä¾‹çš„æµ…æ‹·è´ã€‚ ï¼ˆå…ƒç´ æœ¬èº«ä¸è¢«å¤åˆ¶ã€‚ï¼‰</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">clone</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            ArrayList&lt;?&gt; v = (ArrayList&lt;?&gt;) <span class="hljs-built_in">super</span>.clone();<br>            <span class="hljs-comment">//Arrays.copyOfåŠŸèƒ½æ˜¯å®ç°æ•°ç»„çš„å¤åˆ¶ï¼Œè¿”å›å¤åˆ¶åçš„æ•°ç»„ã€‚å‚æ•°æ˜¯è¢«å¤åˆ¶çš„æ•°ç»„å’Œå¤åˆ¶çš„é•¿åº¦</span><br>            v.elementData = Arrays.copyOf(elementData, size);<br>            v.modCount = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">return</span> v;<br>        &#125; <span class="hljs-keyword">catch</span> (CloneNotSupportedException e) &#123;<br>            <span class="hljs-comment">// è¿™ä¸åº”è¯¥å‘ç”Ÿï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯å¯ä»¥å…‹éš†çš„</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InternalError</span>(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ä»¥æ­£ç¡®çš„é¡ºåºï¼ˆä»ç¬¬ä¸€ä¸ªåˆ°æœ€åä¸€ä¸ªå…ƒç´ ï¼‰è¿”å›ä¸€ä¸ªåŒ…å«æ­¤åˆ—è¡¨ä¸­æ‰€æœ‰å…ƒç´ çš„æ•°ç»„ã€‚</span><br><span class="hljs-comment">     * è¿”å›çš„æ•°ç»„å°†æ˜¯â€œå®‰å…¨çš„â€ï¼Œå› ä¸ºè¯¥åˆ—è¡¨ä¸ä¿ç•™å¯¹å®ƒçš„å¼•ç”¨ã€‚ ï¼ˆæ¢å¥è¯è¯´ï¼Œè¿™ä¸ªæ–¹æ³•å¿…é¡»åˆ†é…ä¸€ä¸ªæ–°çš„æ•°ç»„ï¼‰ã€‚</span><br><span class="hljs-comment">     * å› æ­¤ï¼Œè°ƒç”¨è€…å¯ä»¥è‡ªç”±åœ°ä¿®æ”¹è¿”å›çš„æ•°ç»„ã€‚ æ­¤æ–¹æ³•å……å½“åŸºäºé˜µåˆ—å’ŒåŸºäºé›†åˆçš„APIä¹‹é—´çš„æ¡¥æ¢ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> Object[] toArray() &#123;<br>        <span class="hljs-keyword">return</span> Arrays.copyOf(elementData, size);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ä»¥æ­£ç¡®çš„é¡ºåºè¿”å›ä¸€ä¸ªåŒ…å«æ­¤åˆ—è¡¨ä¸­æ‰€æœ‰å…ƒç´ çš„æ•°ç»„ï¼ˆä»ç¬¬ä¸€ä¸ªåˆ°æœ€åä¸€ä¸ªå…ƒç´ ï¼‰;</span><br><span class="hljs-comment">     * è¿”å›çš„æ•°ç»„çš„è¿è¡Œæ—¶ç±»å‹æ˜¯æŒ‡å®šæ•°ç»„çš„è¿è¡Œæ—¶ç±»å‹ã€‚ å¦‚æœåˆ—è¡¨é€‚åˆæŒ‡å®šçš„æ•°ç»„ï¼Œåˆ™è¿”å›å…¶ä¸­ã€‚</span><br><span class="hljs-comment">     * å¦åˆ™ï¼Œå°†ä¸ºæŒ‡å®šæ•°ç»„çš„è¿è¡Œæ—¶ç±»å‹å’Œæ­¤åˆ—è¡¨çš„å¤§å°åˆ†é…ä¸€ä¸ªæ–°æ•°ç»„ã€‚</span><br><span class="hljs-comment">     * å¦‚æœåˆ—è¡¨é€‚ç”¨äºæŒ‡å®šçš„æ•°ç»„ï¼Œå…¶ä½™ç©ºé—´ï¼ˆå³æ•°ç»„çš„åˆ—è¡¨æ•°é‡å¤šäºæ­¤å…ƒç´ ï¼‰ï¼Œåˆ™ç´§è·Ÿåœ¨é›†åˆç»“æŸåçš„æ•°ç»„ä¸­çš„å…ƒç´ è®¾ç½®ä¸ºnull ã€‚</span><br><span class="hljs-comment">     *ï¼ˆè¿™ä»…åœ¨è°ƒç”¨è€…çŸ¥é“åˆ—è¡¨ä¸åŒ…å«ä»»ä½•ç©ºå…ƒç´ çš„æƒ…å†µä¸‹æ‰èƒ½ç¡®å®šåˆ—è¡¨çš„é•¿åº¦ã€‚ï¼‰</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>    <span class="hljs-keyword">public</span> &lt;T&gt; T[] toArray(T[] a) &#123;<br>        <span class="hljs-keyword">if</span> (a.length &lt; size)<br>            <span class="hljs-comment">// æ–°å»ºä¸€ä¸ªè¿è¡Œæ—¶ç±»å‹çš„æ•°ç»„ï¼Œä½†æ˜¯ArrayListæ•°ç»„çš„å†…å®¹</span><br>            <span class="hljs-keyword">return</span> (T[]) Arrays.copyOf(elementData, size, a.getClass());<br>            <span class="hljs-comment">//è°ƒç”¨Systemæä¾›çš„arraycopy()æ–¹æ³•å®ç°æ•°ç»„ä¹‹é—´çš„å¤åˆ¶</span><br>        System.arraycopy(elementData, <span class="hljs-number">0</span>, a, <span class="hljs-number">0</span>, size);<br>        <span class="hljs-comment">// è¿™æ®µé€»è¾‘çš„ç›®çš„æ˜¯åœ¨å°†åˆ—è¡¨å…ƒç´ å¤åˆ¶åˆ°æ•°ç»„åï¼Œå¦‚æœæ•°ç»„çš„é•¿åº¦å¤§äºåˆ—è¡¨çš„å¤§å°ï¼ˆå³åˆ—è¡¨ä¸­çš„å…ƒç´ ä¸ªæ•°ï¼‰ï¼Œåˆ™å°†æ•°ç»„ä¸­å¤šä½™çš„å…ƒç´ ä½ç½®ç½®ä¸º nullã€‚</span><br>        <span class="hljs-comment">// è¿™æ ·åšæ˜¯ä¸ºäº†é¿å…åœ¨åç»­çš„ä»£ç ä¸­å¯èƒ½å¯¼è‡´æ··æ·†æˆ–é”™è¯¯çš„æƒ…å†µã€‚</span><br>        <span class="hljs-comment">// ä¾‹å¦‚ list = &#123;&quot;java&quot;, &quot;c&quot;&#125; a = &#123;&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;&#125; è¿”å›çš„æ•°ç»„ä¸º &#123;&quot;java&quot;, &quot;c&quot;, null, &quot;4&quot;, &quot;5&quot;&#125;</span><br>        <span class="hljs-comment">// è¿™æ ·å°±å¯ä»¥é¿å…æ··æ·†listä¸­çš„å…ƒç´ å’Œaæ•°ç»„ä¸­çš„æ—§å…ƒç´ </span><br>        <span class="hljs-keyword">if</span> (a.length &gt; size)<br>            a[size] = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">return</span> a;<br>    &#125;<br><br>    <span class="hljs-comment">// Positional Access Operations</span><br><br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>    E <span class="hljs-title function_">elementData</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> &#123;<br>        <span class="hljs-keyword">return</span> (E) elementData[index];<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è¿”å›æ­¤åˆ—è¡¨ä¸­æŒ‡å®šä½ç½®çš„å…ƒç´ ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> E <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> &#123;<br>        rangeCheck(index);<br><br>        <span class="hljs-keyword">return</span> elementData(index);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ç”¨æŒ‡å®šçš„å…ƒç´ æ›¿æ¢æ­¤åˆ—è¡¨ä¸­æŒ‡å®šä½ç½®çš„å…ƒç´ ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> E <span class="hljs-title function_">set</span><span class="hljs-params">(<span class="hljs-type">int</span> index, E element)</span> &#123;<br>        <span class="hljs-comment">//å¯¹indexè¿›è¡Œç•Œé™æ£€æŸ¥</span><br>        rangeCheck(index);<br><br>        <span class="hljs-type">E</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> elementData(index);<br>        elementData[index] = element;<br>        <span class="hljs-comment">//è¿”å›åŸæ¥åœ¨è¿™ä¸ªä½ç½®çš„å…ƒç´ </span><br>        <span class="hljs-keyword">return</span> oldValue;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å°†æŒ‡å®šçš„å…ƒç´ è¿½åŠ åˆ°æ­¤åˆ—è¡¨çš„æœ«å°¾ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">add</span><span class="hljs-params">(E e)</span> &#123;<br>        ensureCapacityInternal(size + <span class="hljs-number">1</span>);  <span class="hljs-comment">// Increments modCount!!</span><br>        <span class="hljs-comment">//è¿™é‡Œçœ‹åˆ°ArrayListæ·»åŠ å…ƒç´ çš„å®è´¨å°±ç›¸å½“äºä¸ºæ•°ç»„èµ‹å€¼</span><br>        elementData[size++] = e;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * åœ¨æ­¤åˆ—è¡¨ä¸­çš„æŒ‡å®šä½ç½®æ’å…¥æŒ‡å®šçš„å…ƒç´ ã€‚</span><br><span class="hljs-comment">     * å…ˆè°ƒç”¨ rangeCheckForAdd å¯¹indexè¿›è¡Œç•Œé™æ£€æŸ¥ï¼›ç„¶åè°ƒç”¨ ensureCapacityInternal æ–¹æ³•ä¿è¯capacityè¶³å¤Ÿå¤§ï¼›</span><br><span class="hljs-comment">     * å†å°†ä»indexå¼€å§‹ä¹‹åçš„æ‰€æœ‰æˆå‘˜åç§»ä¸€ä¸ªä½ç½®ï¼›å°†elementæ’å…¥indexä½ç½®ï¼›æœ€åsizeåŠ 1ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> index, E element)</span> &#123;<br>        rangeCheckForAdd(index);<br><br>        ensureCapacityInternal(size + <span class="hljs-number">1</span>);  <span class="hljs-comment">// Increments modCount!!</span><br>        <span class="hljs-comment">//arraycopy()è¿™ä¸ªå®ç°æ•°ç»„ä¹‹é—´å¤åˆ¶çš„æ–¹æ³•ä¸€å®šè¦çœ‹ä¸€ä¸‹ï¼Œä¸‹é¢å°±ç”¨åˆ°äº†arraycopy()æ–¹æ³•å®ç°æ•°ç»„è‡ªå·±å¤åˆ¶è‡ªå·±</span><br>        System.arraycopy(elementData, index, elementData, index + <span class="hljs-number">1</span>,<br>                         size - index);<br>        elementData[index] = element;<br>        size++;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * åˆ é™¤è¯¥åˆ—è¡¨ä¸­æŒ‡å®šä½ç½®çš„å…ƒç´ ã€‚ å°†ä»»ä½•åç»­å…ƒç´ ç§»åŠ¨åˆ°å·¦ä¾§ï¼ˆä»å…¶ç´¢å¼•ä¸­å‡å»ä¸€ä¸ªå…ƒç´ ï¼‰ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> E <span class="hljs-title function_">remove</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> &#123;<br>        rangeCheck(index);<br><br>        modCount++;<br>        <span class="hljs-type">E</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> elementData(index);<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">numMoved</span> <span class="hljs-operator">=</span> size - index - <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> (numMoved &gt; <span class="hljs-number">0</span>)<br>            System.arraycopy(elementData, index+<span class="hljs-number">1</span>, elementData, index,<br>                             numMoved);<br>        elementData[--size] = <span class="hljs-literal">null</span>; <span class="hljs-comment">// clear to let GC do its work</span><br>        <span class="hljs-comment">//ä»åˆ—è¡¨ä¸­åˆ é™¤çš„å…ƒç´ </span><br>        <span class="hljs-keyword">return</span> oldValue;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ä»åˆ—è¡¨ä¸­åˆ é™¤æŒ‡å®šå…ƒç´ çš„ç¬¬ä¸€ä¸ªå‡ºç°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚ å¦‚æœåˆ—è¡¨ä¸åŒ…å«è¯¥å…ƒç´ ï¼Œåˆ™å®ƒä¸ä¼šæ›´æ”¹ã€‚</span><br><span class="hljs-comment">     * è¿”å›trueï¼Œå¦‚æœæ­¤åˆ—è¡¨åŒ…å«æŒ‡å®šçš„å…ƒç´ </span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">remove</span><span class="hljs-params">(Object o)</span> &#123;<br>        <span class="hljs-keyword">if</span> (o == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; index &lt; size; index++)<br>                <span class="hljs-keyword">if</span> (elementData[index] == <span class="hljs-literal">null</span>) &#123;<br>                    fastRemove(index);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; index &lt; size; index++)<br>                <span class="hljs-keyword">if</span> (o.equals(elementData[index])) &#123;<br>                    fastRemove(index);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Private remove method that skips bounds checking and does not</span><br><span class="hljs-comment">     * return the value removed.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fastRemove</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> &#123;<br>        modCount++;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">numMoved</span> <span class="hljs-operator">=</span> size - index - <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> (numMoved &gt; <span class="hljs-number">0</span>)<br>            System.arraycopy(elementData, index+<span class="hljs-number">1</span>, elementData, index,<br>                             numMoved);<br>        elementData[--size] = <span class="hljs-literal">null</span>; <span class="hljs-comment">// clear to let GC do its work</span><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ä»åˆ—è¡¨ä¸­åˆ é™¤æ‰€æœ‰å…ƒç´ ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> &#123;<br>        modCount++;<br><br>        <span class="hljs-comment">// æŠŠæ•°ç»„ä¸­æ‰€æœ‰çš„å…ƒç´ çš„å€¼è®¾ä¸ºnull</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; size; i++)<br>            elementData[i] = <span class="hljs-literal">null</span>;<br><br>        size = <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æŒ‰æŒ‡å®šé›†åˆçš„Iteratorè¿”å›çš„é¡ºåºå°†æŒ‡å®šé›†åˆä¸­çš„æ‰€æœ‰å…ƒç´ è¿½åŠ åˆ°æ­¤åˆ—è¡¨çš„æœ«å°¾ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">addAll</span><span class="hljs-params">(Collection&lt;? extends E&gt; c)</span> &#123;<br>        Object[] a = c.toArray();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">numNew</span> <span class="hljs-operator">=</span> a.length;<br>        ensureCapacityInternal(size + numNew);  <span class="hljs-comment">// Increments modCount</span><br>        System.arraycopy(a, <span class="hljs-number">0</span>, elementData, size, numNew);<br>        size += numNew;<br>        <span class="hljs-keyword">return</span> numNew != <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å°†æŒ‡å®šé›†åˆä¸­çš„æ‰€æœ‰å…ƒç´ æ’å…¥åˆ°æ­¤åˆ—è¡¨ä¸­ï¼Œä»æŒ‡å®šçš„ä½ç½®å¼€å§‹ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">addAll</span><span class="hljs-params">(<span class="hljs-type">int</span> index, Collection&lt;? extends E&gt; c)</span> &#123;<br>        rangeCheckForAdd(index);<br><br>        Object[] a = c.toArray();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">numNew</span> <span class="hljs-operator">=</span> a.length;<br>        ensureCapacityInternal(size + numNew);  <span class="hljs-comment">// Increments modCount</span><br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">numMoved</span> <span class="hljs-operator">=</span> size - index;<br>        <span class="hljs-keyword">if</span> (numMoved &gt; <span class="hljs-number">0</span>)<br>            System.arraycopy(elementData, index, elementData, index + numNew,<br>                             numMoved);<br><br>        System.arraycopy(a, <span class="hljs-number">0</span>, elementData, index, numNew);<br>        size += numNew;<br>        <span class="hljs-keyword">return</span> numNew != <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ä»æ­¤åˆ—è¡¨ä¸­åˆ é™¤æ‰€æœ‰ç´¢å¼•ä¸ºfromIndex ï¼ˆå«ï¼‰å’ŒtoIndexä¹‹é—´çš„å…ƒç´ ã€‚</span><br><span class="hljs-comment">     * å°†ä»»ä½•åç»­å…ƒç´ ç§»åŠ¨åˆ°å·¦ä¾§ï¼ˆå‡å°‘å…¶ç´¢å¼•ï¼‰ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeRange</span><span class="hljs-params">(<span class="hljs-type">int</span> fromIndex, <span class="hljs-type">int</span> toIndex)</span> &#123;<br>        modCount++;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">numMoved</span> <span class="hljs-operator">=</span> size - toIndex;<br>        System.arraycopy(elementData, toIndex, elementData, fromIndex,<br>                         numMoved);<br><br>        <span class="hljs-comment">// clear to let GC do its work</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">newSize</span> <span class="hljs-operator">=</span> size - (toIndex-fromIndex);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> newSize; i &lt; size; i++) &#123;<br>            elementData[i] = <span class="hljs-literal">null</span>;<br>        &#125;<br>        size = newSize;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ£€æŸ¥ç»™å®šçš„ç´¢å¼•æ˜¯å¦åœ¨èŒƒå›´å†…ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rangeCheck</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> &#123;<br>        <span class="hljs-keyword">if</span> (index &gt;= size)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexOutOfBoundsException</span>(outOfBoundsMsg(index));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * addå’ŒaddAllä½¿ç”¨çš„rangeCheckçš„ä¸€ä¸ªç‰ˆæœ¬</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rangeCheckForAdd</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> &#123;<br>        <span class="hljs-keyword">if</span> (index &gt; size || index &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexOutOfBoundsException</span>(outOfBoundsMsg(index));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è¿”å›IndexOutOfBoundsExceptionç»†èŠ‚ä¿¡æ¯</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">outOfBoundsMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Index: &quot;</span>+index+<span class="hljs-string">&quot;, Size: &quot;</span>+size;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ä»æ­¤åˆ—è¡¨ä¸­åˆ é™¤æŒ‡å®šé›†åˆä¸­åŒ…å«çš„æ‰€æœ‰å…ƒç´ ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">removeAll</span><span class="hljs-params">(Collection&lt;?&gt; c)</span> &#123;<br>        Objects.requireNonNull(c);<br>        <span class="hljs-comment">//å¦‚æœæ­¤åˆ—è¡¨è¢«ä¿®æ”¹åˆ™è¿”å›true</span><br>        <span class="hljs-keyword">return</span> batchRemove(c, <span class="hljs-literal">false</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ä»…ä¿ç•™æ­¤åˆ—è¡¨ä¸­åŒ…å«åœ¨æŒ‡å®šé›†åˆä¸­çš„å…ƒç´ ã€‚</span><br><span class="hljs-comment">     * æ¢å¥è¯è¯´ï¼Œä»æ­¤åˆ—è¡¨ä¸­åˆ é™¤å…¶ä¸­ä¸åŒ…å«åœ¨æŒ‡å®šé›†åˆä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">retainAll</span><span class="hljs-params">(Collection&lt;?&gt; c)</span> &#123;<br>        Objects.requireNonNull(c);<br>        <span class="hljs-keyword">return</span> batchRemove(c, <span class="hljs-literal">true</span>);<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ä»åˆ—è¡¨ä¸­çš„æŒ‡å®šä½ç½®å¼€å§‹ï¼Œè¿”å›åˆ—è¡¨ä¸­çš„å…ƒç´ ï¼ˆæŒ‰æ­£ç¡®é¡ºåºï¼‰çš„åˆ—è¡¨è¿­ä»£å™¨ã€‚</span><br><span class="hljs-comment">     * æŒ‡å®šçš„ç´¢å¼•è¡¨ç¤ºåˆå§‹è°ƒç”¨å°†è¿”å›çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºnext ã€‚ åˆå§‹è°ƒç”¨previouså°†è¿”å›æŒ‡å®šç´¢å¼•å‡1çš„å…ƒç´ ã€‚</span><br><span class="hljs-comment">     * è¿”å›çš„åˆ—è¡¨è¿­ä»£å™¨æ˜¯fail-fastã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> ListIterator&lt;E&gt; <span class="hljs-title function_">listIterator</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> &#123;<br>        <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span> || index &gt; size)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexOutOfBoundsException</span>(<span class="hljs-string">&quot;Index: &quot;</span>+index);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListItr</span>(index);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è¿”å›åˆ—è¡¨ä¸­çš„åˆ—è¡¨è¿­ä»£å™¨ï¼ˆæŒ‰é€‚å½“çš„é¡ºåºï¼‰ã€‚</span><br><span class="hljs-comment">     * è¿”å›çš„åˆ—è¡¨è¿­ä»£å™¨æ˜¯fail-fast ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> ListIterator&lt;E&gt; <span class="hljs-title function_">listIterator</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListItr</span>(<span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *ä»¥æ­£ç¡®çš„é¡ºåºè¿”å›è¯¥åˆ—è¡¨ä¸­çš„å…ƒç´ çš„è¿­ä»£å™¨ã€‚</span><br><span class="hljs-comment">     *è¿”å›çš„è¿­ä»£å™¨æ˜¯fail-fast ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> Iterator&lt;E&gt; <span class="hljs-title function_">iterator</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Itr</span>();<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="ArrayListçš„æ‰©å®¹æœºåˆ¶"><a href="#ArrayListçš„æ‰©å®¹æœºåˆ¶" class="headerlink" title="ArrayListçš„æ‰©å®¹æœºåˆ¶"></a>ArrayListçš„æ‰©å®¹æœºåˆ¶</h4><p>å…ˆä» ArrayList çš„æ„é€ å‡½æ•°è¯´èµ·ï¼ŒArrayList æœ‰ä¸‰ç§æ–¹å¼æ¥åˆå§‹åŒ–ï¼Œæ„é€ æ–¹æ³•æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * é»˜è®¤åˆå§‹å®¹é‡å¤§å°</span><br><span class="hljs-comment">  */</span><br> <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">DEFAULT_CAPACITY</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br><br><br> <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = &#123;&#125;;<br><br> <span class="hljs-comment">/**</span><br><span class="hljs-comment">  * é»˜è®¤æ„é€ å‡½æ•°ï¼Œä½¿ç”¨åˆå§‹å®¹é‡10æ„é€ ä¸€ä¸ªç©ºåˆ—è¡¨(æ— å‚æ•°æ„é€ )</span><br><span class="hljs-comment">  */</span><br> <span class="hljs-keyword">public</span> <span class="hljs-title function_">ArrayList</span><span class="hljs-params">()</span> &#123;<br>     <span class="hljs-built_in">this</span>.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;<br> &#125;<br><br> <span class="hljs-comment">/**</span><br><span class="hljs-comment">  * å¸¦åˆå§‹å®¹é‡å‚æ•°çš„æ„é€ å‡½æ•°ã€‚ï¼ˆç”¨æˆ·è‡ªå·±æŒ‡å®šå®¹é‡ï¼‰</span><br><span class="hljs-comment">  */</span><br> <span class="hljs-keyword">public</span> <span class="hljs-title function_">ArrayList</span><span class="hljs-params">(<span class="hljs-type">int</span> initialCapacity)</span> &#123;<br>     <span class="hljs-comment">//åˆå§‹å®¹é‡å¤§äº0</span><br>     <span class="hljs-keyword">if</span> (initialCapacity &gt; <span class="hljs-number">0</span>) &#123;<br>         <span class="hljs-comment">// åˆ›å»ºinitialCapacityå¤§å°çš„æ•°ç»„</span><br>         <span class="hljs-built_in">this</span>.elementData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[initialCapacity];<br>     <span class="hljs-comment">//åˆå§‹å®¹é‡ç­‰äº0</span><br>     &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (initialCapacity == <span class="hljs-number">0</span>) &#123;<br>         <span class="hljs-comment">// åˆ›å»ºç©ºæ•°ç»„</span><br>         <span class="hljs-built_in">this</span>.elementData = EMPTY_ELEMENTDATA;<br>     <span class="hljs-comment">//åˆå§‹å®¹é‡å°äº0ï¼ŒæŠ›å‡ºå¼‚å¸¸    </span><br>     &#125; <span class="hljs-keyword">else</span> &#123;<br>         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Illegal Capacity: &quot;</span>+<br>                                            initialCapacity);<br>     &#125;<br> &#125;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * æ„é€ åŒ…å«æŒ‡å®šcollectionå…ƒç´ çš„åˆ—è¡¨ï¼Œè¿™äº›å…ƒç´ åˆ©ç”¨è¯¥é›†åˆçš„è¿­ä»£å™¨æŒ‰é¡ºåºè¿”å›</span><br><span class="hljs-comment"> * å¦‚æœæŒ‡å®šçš„é›†åˆä¸ºnullï¼Œthrows NullPointerExceptionã€‚</span><br><span class="hljs-comment"> */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">ArrayList</span><span class="hljs-params">(Collection&lt;? extends E&gt; c)</span> &#123;<br>     elementData = c.toArray();<br>     <span class="hljs-keyword">if</span> ((size = elementData.length) != <span class="hljs-number">0</span>) &#123;<br>         <span class="hljs-comment">// c.toArray might (incorrectly) not return Object[] (see 6260652)</span><br>         <span class="hljs-keyword">if</span> (elementData.getClass() != Object[].class)<br>             elementData = Arrays.copyOf(elementData, size, Object[].class);<br>     &#125; <span class="hljs-keyword">else</span> &#123;<br>         <span class="hljs-comment">// replace with empty array.</span><br>         <span class="hljs-built_in">this</span>.elementData = EMPTY_ELEMENTDATA;<br>     &#125;<br> &#125;<br></code></pre></td></tr></table></figure><p><strong>ä»¥æ— å‚æ•°æ„é€ æ–¹æ³•åˆ›å»º</strong> <code>ArrayList</code> <strong>æ—¶ï¼Œå®é™…ä¸Šåˆå§‹åŒ–èµ‹å€¼çš„æ˜¯ä¸€ä¸ªç©ºæ•°ç»„ã€‚</strong></p><p><strong>å½“çœŸæ­£å¯¹æ•°ç»„è¿›è¡Œæ·»åŠ å…ƒç´ æ“ä½œæ—¶ï¼Œæ‰çœŸæ­£åˆ†é…å®¹é‡ã€‚å³å‘æ•°ç»„ä¸­æ·»åŠ ç¬¬ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œæ•°ç»„å®¹é‡æ‰©ä¸º 10ã€‚</strong> </p><blockquote><p>è¡¥å……ï¼šJDK6 new æ— å‚æ„é€ çš„ <code>ArrayList</code> å¯¹è±¡æ—¶ï¼Œç›´æ¥åˆ›å»ºäº†é•¿åº¦æ˜¯ 10 çš„ <code>Object[]</code> æ•°ç»„ elementData </p></blockquote><h5 id="é€æ­¥åˆ†æ-ArrayList-æ‰©å®¹æœºåˆ¶"><a href="#é€æ­¥åˆ†æ-ArrayList-æ‰©å®¹æœºåˆ¶" class="headerlink" title="é€æ­¥åˆ†æ ArrayList æ‰©å®¹æœºåˆ¶"></a>é€æ­¥åˆ†æ ArrayList æ‰©å®¹æœºåˆ¶</h5><p>è¿™é‡Œä»¥æ— å‚æ„é€ å‡½æ•°åˆ›å»ºçš„ ArrayList ä¸ºä¾‹åˆ†æ</p><h6 id="å…ˆæ¥çœ‹-add-æ–¹æ³•"><a href="#å…ˆæ¥çœ‹-add-æ–¹æ³•" class="headerlink" title="å…ˆæ¥çœ‹ add æ–¹æ³•"></a>å…ˆæ¥çœ‹ <code>add</code> æ–¹æ³•</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * å°†æŒ‡å®šçš„å…ƒç´ è¿½åŠ åˆ°æ­¤åˆ—è¡¨çš„æœ«å°¾ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">add</span><span class="hljs-params">(E e)</span> &#123;<br><span class="hljs-comment">//æ·»åŠ å…ƒç´ ä¹‹å‰ï¼Œå…ˆè°ƒç”¨ensureCapacityInternalæ–¹æ³•</span><br>    ensureCapacityInternal(size + <span class="hljs-number">1</span>);  <span class="hljs-comment">// Increments modCount!!</span><br>    <span class="hljs-comment">//è¿™é‡Œçœ‹åˆ°ArrayListæ·»åŠ å…ƒç´ çš„å®è´¨å°±ç›¸å½“äºä¸ºæ•°ç»„èµ‹å€¼</span><br>    elementData[size++] = e;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p><strong>æ³¨æ„</strong>ï¼šJDK11 ç§»é™¤äº† <code>ensureCapacityInternal()</code> å’Œ <code>ensureExplicitCapacity()</code> æ–¹æ³•</p></blockquote><h6 id="å†æ¥çœ‹çœ‹-ensureCapacityInternal-æ–¹æ³•"><a href="#å†æ¥çœ‹çœ‹-ensureCapacityInternal-æ–¹æ³•" class="headerlink" title="å†æ¥çœ‹çœ‹ ensureCapacityInternal() æ–¹æ³•"></a>å†æ¥çœ‹çœ‹ <code>ensureCapacityInternal()</code> æ–¹æ³•</h6><p>å¯ä»¥çœ‹åˆ° <code>add</code> æ–¹æ³• é¦–å…ˆè°ƒç”¨äº†<code>ensureCapacityInternal(size + 1)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ensureCapacityInternal</span><span class="hljs-params">(<span class="hljs-type">int</span> minCapacity)</span> &#123;<br>    <span class="hljs-comment">// æ–¹æ³•é‡Œé¢è°ƒç”¨calculateCapacityè·å–æœ€å°å®¹é‡</span><br>    ensureExplicitCapacity(calculateCapacity(elementData, minCapacity));<br>&#125;<br></code></pre></td></tr></table></figure><h6 id="calculateCapacity-æ–¹æ³•"><a href="#calculateCapacity-æ–¹æ³•" class="headerlink" title="calculateCapacity()æ–¹æ³•"></a>calculateCapacity()æ–¹æ³•</h6><p><strong>å½“ è¦ add è¿›ç¬¬ 1 ä¸ªå…ƒç´ æ—¶ï¼ŒminCapacity ä¸º 1ï¼Œåœ¨ Math.max()æ–¹æ³•æ¯”è¾ƒåï¼ŒminCapacity ä¸º 10ã€‚</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è®¡ç®—æœ€å°å®¹é‡</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateCapacity</span><span class="hljs-params">(Object[] elementData, <span class="hljs-type">int</span> minCapacity)</span> &#123;<br>       <span class="hljs-comment">// å¦‚æœæ˜¯æ— å‚æ„é€ ï¼ŒelementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATAä¸ºtrue</span><br>       <span class="hljs-keyword">if</span> (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) &#123;<br>           <span class="hljs-comment">// è¿™é‡Œå–1å’ŒDEFAULT_CAPACITYçš„è¾ƒå¤§å€¼ï¼Œä¹Ÿå°±æ˜¯10</span><br>           <span class="hljs-keyword">return</span> Math.max(DEFAULT_CAPACITY, minCapacity);<br>       &#125;<br>       <span class="hljs-keyword">return</span> minCapacity;<br>   &#125;<br></code></pre></td></tr></table></figure><h6 id="ensureExplicitCapacity-æ–¹æ³•"><a href="#ensureExplicitCapacity-æ–¹æ³•" class="headerlink" title="ensureExplicitCapacity()æ–¹æ³•"></a>ensureExplicitCapacity()æ–¹æ³•</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ensureExplicitCapacity</span><span class="hljs-params">(<span class="hljs-type">int</span> minCapacity)</span> &#123;<br>       modCount++;<br><br>       <span class="hljs-comment">// overflow-conscious code</span><br>       <span class="hljs-keyword">if</span> (minCapacity - elementData.length &gt; <span class="hljs-number">0</span>)<br>           <span class="hljs-comment">// è°ƒç”¨growæ–¹æ³•è¿›è¡Œæ‰©å®¹ï¼Œè°ƒç”¨æ­¤æ–¹æ³•ä»£è¡¨å·²ç»å¼€å§‹æ‰©å®¹äº†</span><br>           grow(minCapacity);<br>   &#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥ä»”ç»†åˆ†æä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼š</p><ul><li><p>å½“æˆ‘ä»¬è¦ add è¿›ç¬¬ 1 ä¸ªå…ƒç´ åˆ° ArrayList æ—¶ï¼Œ<code>elementData.length</code> ä¸º 0 ï¼ˆå› ä¸ºè¿˜æ˜¯ä¸€ä¸ªç©ºçš„ listï¼‰ï¼Œå› ä¸ºæ‰§è¡Œäº† <code>ensureCapacityInternal()</code> æ–¹æ³• ï¼Œæ‰€ä»¥ minCapacity æ­¤æ—¶ä¸º 10ã€‚æ­¤æ—¶ï¼Œ<code>minCapacity - elementData.length &gt; 0</code>æˆç«‹ï¼Œæ‰€ä»¥ä¼šè¿›å…¥ <code>grow(minCapacity)</code> æ–¹æ³•ã€‚</p></li><li><p>å½“ add ç¬¬ 2 ä¸ªå…ƒç´ æ—¶ï¼ŒminCapacity ä¸º 2ï¼Œæ­¤æ—¶ elementData.length(å®¹é‡)åœ¨æ·»åŠ ç¬¬ä¸€ä¸ªå…ƒç´ åæ‰©å®¹æˆ 10 äº†ã€‚æ­¤æ—¶ï¼Œ<code>minCapacity - elementData.length &gt; 0</code> ä¸æˆç«‹ï¼Œæ‰€ä»¥ä¸ä¼šè¿›å…¥ ï¼ˆæ‰§è¡Œï¼‰<code>grow(minCapacity)</code> æ–¹æ³•ã€‚</p></li><li><p>æ·»åŠ ç¬¬ 3ã€4Â·Â·Â·åˆ°ç¬¬ 10 ä¸ªå…ƒç´ æ—¶ï¼Œä¾ç„¶ä¸ä¼šæ‰§è¡Œ grow æ–¹æ³•ï¼Œæ•°ç»„å®¹é‡éƒ½ä¸º 10ã€‚</p></li><li><p>ç›´åˆ°æ·»åŠ ç¬¬ 11 ä¸ªå…ƒç´ ï¼ŒminCapacity(ä¸º 11)æ¯” elementData.lengthï¼ˆä¸º 10ï¼‰è¦å¤§ã€‚è¿›å…¥ grow æ–¹æ³•è¿›è¡Œæ‰©å®¹ã€‚</p></li></ul><h6 id="grow-æ–¹æ³•"><a href="#grow-æ–¹æ³•" class="headerlink" title="grow() æ–¹æ³•"></a><code>grow()</code> æ–¹æ³•</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * è¦åˆ†é…çš„æœ€å¤§æ•°ç»„å¤§å°</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_ARRAY_SIZE</span> <span class="hljs-operator">=</span> Integer.MAX_VALUE - <span class="hljs-number">8</span>;<br><br><span class="hljs-comment">// ArrayListæ ¸å¿ƒæ‰©å®¹æ–¹æ³•</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">grow</span><span class="hljs-params">(<span class="hljs-type">int</span> minCapacity)</span> &#123;<br>       <span class="hljs-comment">// oldCapacityä¸ºæ—§å®¹é‡ï¼ŒnewCapacityä¸ºæ–°å®¹é‡</span><br>       <span class="hljs-type">int</span> <span class="hljs-variable">oldCapacity</span> <span class="hljs-operator">=</span> elementData.length;<br>       <span class="hljs-comment">// å°†oldCapacity å³ç§»ä¸€ä½ï¼Œå…¶æ•ˆæœç›¸å½“äºoldCapacity / 2ï¼Œ</span><br>       <span class="hljs-comment">// å› ä¸ºä½è¿ç®—çš„é€Ÿåº¦è¿œè¿œå¿«äºæ•´é™¤è¿ç®—ï¼Œæ•´å¥è¿ç®—å¼çš„ç»“æœå°±æ˜¯å°†æ–°å®¹é‡æ›´æ–°ä¸ºæ—§å®¹é‡çš„1.5å€ã€‚</span><br>       <span class="hljs-type">int</span> <span class="hljs-variable">newCapacity</span> <span class="hljs-operator">=</span> oldCapacity + (oldCapacity &gt;&gt; <span class="hljs-number">1</span>);<br>       <span class="hljs-comment">// ç„¶åæ£€æŸ¥æ–°å®¹é‡æ˜¯å¦å¤§äºæœ€å°éœ€è¦å®¹é‡ï¼Œè‹¥è¿˜æ˜¯å°äºæœ€å°éœ€è¦å®¹é‡ï¼Œé‚£ä¹ˆå°±æŠŠæœ€å°éœ€è¦å®¹é‡å½“ä½œæ•°ç»„çš„æ–°å®¹é‡</span><br>       <span class="hljs-keyword">if</span> (newCapacity - minCapacity &lt; <span class="hljs-number">0</span>)<br>           newCapacity = minCapacity;<br>       <span class="hljs-comment">// å¦‚æœæ–°å®¹é‡å¤§äº MAX_ARRAY_SIZE, è¿›å…¥`hugeCapacity()` æ–¹æ³•æ¥æ¯”è¾ƒ minCapacity å’Œ MAX_ARRAY_SIZE</span><br>       <span class="hljs-comment">// å¦‚æœminCapacityå¤§äºæœ€å¤§å®¹é‡ï¼Œåˆ™æ–°å®¹é‡åˆ™ä¸º`Integer.MAX_VALUE`ï¼Œå¦åˆ™ï¼Œæ–°å®¹é‡å¤§å°åˆ™ä¸º MAX_ARRAY_SIZE å³ä¸º `Integer.MAX_VALUE - 8`ã€‚</span><br>       <span class="hljs-keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="hljs-number">0</span>)<br>           newCapacity = hugeCapacity(minCapacity);<br>       <span class="hljs-comment">// minCapacity is usually close to size, so this is a win:</span><br>       elementData = Arrays.copyOf(elementData, newCapacity);<br>   &#125;<br></code></pre></td></tr></table></figure><p><strong>int newCapacity &#x3D; oldCapacity + (oldCapacity &gt;&gt; 1), æ‰€ä»¥ ArrayList æ¯æ¬¡æ‰©å®¹ä¹‹åå®¹é‡éƒ½ä¼šå˜ä¸ºåŸæ¥çš„ 1.5 å€å·¦å³ï¼ˆoldCapacity ä¸ºå¶æ•°å°±æ˜¯ 1.5 å€ï¼Œå¦åˆ™æ˜¯ 1.5 å€å·¦å³ï¼‰ï¼</strong> å¥‡å¶ä¸åŒï¼Œæ¯”å¦‚ï¼š10+10&#x2F;2 &#x3D; 15, 33+33&#x2F;2&#x3D;49ã€‚å¦‚æœæ˜¯å¥‡æ•°çš„è¯ä¼šä¸¢æ‰å°æ•°ã€‚</p><blockquote><p>â€œ&gt;&gt;â€ï¼ˆç§»ä½è¿ç®—ç¬¦ï¼‰ï¼š&gt;&gt; 1 å³ç§»ä¸€ä½ç›¸å½“äºé™¤ 2ï¼Œå³ç§» n ä½ç›¸å½“äºé™¤ä»¥ 2 çš„ n æ¬¡æ–¹ã€‚è¿™é‡Œ oldCapacity å³ç§»äº† 1 ä½æ‰€ä»¥ç›¸å½“äº oldCapacity &#x2F; 2ã€‚å¯¹äºå¤§æ•°æ®çš„ äºŒè¿›åˆ¶è¿ç®—, ä½ç§»è¿ç®—ç¬¦æ¯”é‚£äº›æ™®é€šè¿ç®—ç¬¦çš„è¿ç®—è¦å¿«å¾ˆå¤šï¼Œå› ä¸ºç¨‹åºåº•å±‚éƒ½æ˜¯åŸºäºäºŒè¿›åˆ¶æ‰€ä»¥ç¨‹åºä»…ä»…æ˜¯ç§»åŠ¨ä¸€ä¸‹è€Œå·²ï¼Œä¸ç”¨å»è®¡ç®—ï¼Œè¿™æ ·æé«˜äº†æ•ˆç‡ï¼ŒèŠ‚çœäº†èµ„æºã€‚</p></blockquote><p><strong>æˆ‘ä»¬å†æ¥é€šè¿‡ä¾‹å­æ¢ç©¶ä¸€ä¸‹</strong><code>grow()</code> <strong>æ–¹æ³•ï¼š</strong></p><ul><li>å½“ add ç¬¬ 1 ä¸ªå…ƒç´ æ—¶ï¼ŒoldCapacity ä¸º 0ï¼Œç»æ¯”è¾ƒåç¬¬ä¸€ä¸ª if åˆ¤æ–­æˆç«‹ï¼ŒnewCapacity &#x3D; minCapacity(ä¸º 10)ã€‚ä½†æ˜¯ç¬¬äºŒä¸ª if åˆ¤æ–­ä¸ä¼šæˆç«‹ï¼Œå³ newCapacity ä¸æ¯” MAX_ARRAY_SIZE å¤§ï¼Œåˆ™ä¸ä¼šè¿›å…¥ <code>hugeCapacity</code> æ–¹æ³•ã€‚æ•°ç»„å®¹é‡ä¸º 10ï¼Œadd æ–¹æ³•ä¸­ return trueï¼Œsize å¢ä¸º 1ã€‚</li><li>å½“ add ç¬¬ 11 ä¸ªå…ƒç´ è¿›å…¥ grow æ–¹æ³•æ—¶ï¼ŒnewCapacity ä¸º 15ï¼Œæ¯” minCapacityï¼ˆä¸º 11ï¼‰å¤§ï¼Œç¬¬ä¸€ä¸ª if åˆ¤æ–­ä¸æˆç«‹ã€‚æ–°å®¹é‡æ²¡æœ‰å¤§äºæ•°ç»„æœ€å¤§ sizeï¼Œä¸ä¼šè¿›å…¥ hugeCapacity æ–¹æ³•ã€‚æ•°ç»„å®¹é‡æ‰©ä¸º 15ï¼Œadd æ–¹æ³•ä¸­ return trueï¼Œsize å¢ä¸º 11ã€‚</li></ul><p><strong>è¿™é‡Œè¡¥å……ä¸€ç‚¹æ¯”è¾ƒé‡è¦ï¼Œä½†æ˜¯å®¹æ˜“è¢«å¿½è§†æ‰çš„çŸ¥è¯†ç‚¹ï¼š</strong></p><ul><li><p>java ä¸­çš„ <code>length</code>å±æ€§æ˜¯é’ˆå¯¹æ•°ç»„è¯´çš„ï¼Œæ¯”å¦‚è¯´ä½ å£°æ˜äº†ä¸€ä¸ªæ•°ç»„ï¼Œæƒ³çŸ¥é“è¿™ä¸ªæ•°ç»„çš„é•¿åº¦åˆ™ç”¨åˆ°äº† length è¿™ä¸ªå±æ€§ã€‚</p></li><li><p>java ä¸­çš„ <code>length()</code> æ–¹æ³•æ˜¯é’ˆå¯¹å­—ç¬¦ä¸²è¯´çš„ï¼Œå¦‚æœæƒ³çœ‹è¿™ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦åˆ™ç”¨åˆ° <code>length()</code> è¿™ä¸ªæ–¹æ³•ã€‚</p></li><li><p>java ä¸­çš„ <code>size()</code> æ–¹æ³•æ˜¯é’ˆå¯¹æ³›å‹é›†åˆè¯´çš„ï¼Œå¦‚æœæƒ³çœ‹è¿™ä¸ªæ³›å‹æœ‰å¤šå°‘ä¸ªå…ƒç´ ï¼Œå°±è°ƒç”¨æ­¤æ–¹æ³•æ¥æŸ¥çœ‹ï¼</p></li></ul><h6 id="hugeCapacity-æ–¹æ³•ã€‚"><a href="#hugeCapacity-æ–¹æ³•ã€‚" class="headerlink" title="hugeCapacity() æ–¹æ³•ã€‚"></a><code>hugeCapacity()</code> æ–¹æ³•ã€‚</h6><p>ä»ä¸Šé¢ <code>grow()</code> æ–¹æ³•æºç æˆ‘ä»¬çŸ¥é“ï¼šå¦‚æœæ–°å®¹é‡å¤§äº <code>MAX_ARRAY_SIZE</code>ï¼Œè¿›å…¥(æ‰§è¡Œ) hugeCapacity() æ–¹æ³•æ¥æ¯”è¾ƒ <code>minCapacity</code> å’Œ <code>MAX_ARRAY_SIZE</code>ï¼Œå¦‚æœ <code>minCapacity</code> å¤§äºæœ€å¤§å®¹é‡ï¼Œåˆ™æ–°å®¹é‡åˆ™ä¸º<code>Integer.MAX_VALUE</code>ï¼Œå¦åˆ™ï¼Œæ–°å®¹é‡å¤§å°åˆ™ä¸º <code>MAX_ARRAY_SIZE</code> å³ä¸º <code>Integer.MAX_VALUE - 8</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hugeCapacity</span><span class="hljs-params">(<span class="hljs-type">int</span> minCapacity)</span> &#123;<br>       <span class="hljs-keyword">if</span> (minCapacity &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">// overflow</span><br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OutOfMemoryError</span>();<br>       <span class="hljs-comment">// å¯¹minCapacityå’ŒMAX_ARRAY_SIZEè¿›è¡Œæ¯”è¾ƒ</span><br>       <span class="hljs-comment">// è‹¥minCapacityå¤§ï¼Œå°†Integer.MAX_VALUEä½œä¸ºæ–°æ•°ç»„çš„å¤§å°</span><br>       <span class="hljs-comment">// è‹¥MAX_ARRAY_SIZEå¤§ï¼Œå°†MAX_ARRAY_SIZEä½œä¸ºæ–°æ•°ç»„çš„å¤§å°</span><br>       <span class="hljs-comment">// MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;</span><br>       <span class="hljs-keyword">return</span> (minCapacity &gt; MAX_ARRAY_SIZE) ?<br>           Integer.MAX_VALUE :<br>           MAX_ARRAY_SIZE;<br>   &#125;<br></code></pre></td></tr></table></figure><h5 id="System-arraycopy-å’Œ-Arrays-copyOf-æ–¹æ³•"><a href="#System-arraycopy-å’Œ-Arrays-copyOf-æ–¹æ³•" class="headerlink" title="System.arraycopy() å’Œ Arrays.copyOf()æ–¹æ³•"></a><code>System.arraycopy()</code> å’Œ <code>Arrays.copyOf()</code>æ–¹æ³•</h5><p>é€šè¿‡ä¸Šé¢çš„æºç ï¼Œæˆ‘ä»¬ä¼šå‘ç° ArrayList ä¸­å¤§é‡è°ƒç”¨äº†è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚æ¯”å¦‚ï¼šæˆ‘ä»¬ä¸Šé¢è®²çš„æ‰©å®¹æ“ä½œä»¥åŠ<code>add(int index, E element)</code>ã€<code>toArray()</code> ç­‰æ–¹æ³•ä¸­éƒ½ç”¨åˆ°äº†è¯¥æ–¹æ³•ï¼</p><h6 id="System-arraycopy-æ–¹æ³•"><a href="#System-arraycopy-æ–¹æ³•" class="headerlink" title="System.arraycopy() æ–¹æ³•"></a><code>System.arraycopy()</code> æ–¹æ³•</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// æˆ‘ä»¬å‘ç° arraycopy æ˜¯ä¸€ä¸ª native æ–¹æ³•,æ¥ä¸‹æ¥æˆ‘ä»¬è§£é‡Šä¸€ä¸‹å„ä¸ªå‚æ•°çš„å…·ä½“æ„ä¹‰</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">*   å¤åˆ¶æ•°ç»„</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> src æºæ•°ç»„</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> srcPos æºæ•°ç»„ä¸­çš„èµ·å§‹ä½ç½®</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> dest ç›®æ ‡æ•°ç»„</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> destPos ç›®æ ‡æ•°ç»„ä¸­çš„èµ·å§‹ä½ç½®</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> length è¦å¤åˆ¶çš„æ•°ç»„å…ƒç´ çš„æ•°é‡</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">arraycopy</span><span class="hljs-params">(Object src,  <span class="hljs-type">int</span>  srcPos,</span><br><span class="hljs-params">                                    Object dest, <span class="hljs-type">int</span> destPos,</span><br><span class="hljs-params">                                    <span class="hljs-type">int</span> length)</span>;<br></code></pre></td></tr></table></figure><p>ä¸¾ä¸ªæ —å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * åœ¨æ­¤åˆ—è¡¨ä¸­çš„æŒ‡å®šä½ç½®æ’å…¥æŒ‡å®šçš„å…ƒç´ ã€‚</span><br><span class="hljs-comment"> * å…ˆè°ƒç”¨ rangeCheckForAdd å¯¹indexè¿›è¡Œç•Œé™æ£€æŸ¥ï¼›ç„¶åè°ƒç”¨ ensureCapacityInternal æ–¹æ³•ä¿è¯capacityè¶³å¤Ÿå¤§ï¼›</span><br><span class="hljs-comment"> * å†å°†ä»indexå¼€å§‹ä¹‹åçš„æ‰€æœ‰æˆå‘˜åç§»ä¸€ä¸ªä½ç½®ï¼›å°†elementæ’å…¥indexä½ç½®ï¼›æœ€åsizeåŠ 1ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> index, E element)</span> &#123;<br>    rangeCheckForAdd(index);<br><br>    ensureCapacityInternal(size + <span class="hljs-number">1</span>);  <span class="hljs-comment">// Increments modCount!!</span><br>    <span class="hljs-comment">// arraycopy()æ–¹æ³•å®ç°æ•°ç»„è‡ªå·±å¤åˆ¶è‡ªå·±</span><br>    <span class="hljs-comment">// elementData:æºæ•°ç»„;index:æºæ•°ç»„ä¸­çš„èµ·å§‹ä½ç½®;elementDataï¼šç›®æ ‡æ•°ç»„ï¼›index + 1ï¼šç›®æ ‡æ•°ç»„ä¸­çš„èµ·å§‹ä½ç½®ï¼› size - indexï¼šè¦å¤åˆ¶çš„æ•°ç»„å…ƒç´ çš„æ•°é‡ï¼›</span><br>    System.arraycopy(elementData, index, elementData, index + <span class="hljs-number">1</span>, size - index);<br>    elementData[index] = element;<br>    size++;<br>&#125;<br></code></pre></td></tr></table></figure><h6 id="Arrays-copyOf-æ–¹æ³•"><a href="#Arrays-copyOf-æ–¹æ³•" class="headerlink" title="Arrays.copyOf()æ–¹æ³•"></a><code>Arrays.copyOf()</code>æ–¹æ³•</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">   <span class="hljs-comment">/*</span><br><span class="hljs-comment">   * å¤åˆ¶æŒ‡å®šçš„æ•°ç»„ï¼Œæˆªæ–­æˆ–å¡«å…… nullï¼ˆå¦‚æœ‰å¿…è¦ï¼‰ï¼Œä»¥ä¾¿å‰¯æœ¬å…·æœ‰æŒ‡å®šçš„é•¿åº¦ã€‚å¯¹äºåœ¨åŸå§‹æ•°ç»„å’Œå‰¯æœ¬ä¸­éƒ½æœ‰æ•ˆçš„æ‰€æœ‰ç´¢å¼•ï¼Œè¿™ä¸¤ä¸ªæ•°ç»„å°†åŒ…å«ç›¸åŒçš„å€¼ã€‚</span><br><span class="hljs-comment">   * å¯¹äºåœ¨å‰¯æœ¬ä¸­æœ‰æ•ˆä½†å¯¹åŸå§‹å‰¯æœ¬æ— æ•ˆçš„ä»»ä½•ç´¢å¼•ï¼Œå‰¯æœ¬å°†åŒ…å« nullã€‚å½“ä¸”ä»…å½“æŒ‡å®šçš„é•¿åº¦å¤§äºåŸå§‹æ•°ç»„çš„é•¿åº¦æ—¶ï¼Œæ­¤ç±»ç´¢å¼•æ‰ä¼šå­˜åœ¨ã€‚</span><br><span class="hljs-comment">   * ç”Ÿæˆçš„æ•°ç»„ä¸åŸå§‹æ•°ç»„çš„ç±»å®Œå…¨ç›¸åŒã€‚ </span><br><span class="hljs-comment">  </span><br><span class="hljs-comment">* @param original æºå¯¹è±¡æ•°ç»„ï¼Œéœ€è¦è¢«å¤åˆ¶çš„æ•°ç»„</span><br><span class="hljs-comment">   * @param newLength è¦è¿”å›çš„å‰¯æœ¬çš„é•¿åº¦</span><br><span class="hljs-comment">   * @return åŸå§‹æ•°ç»„çš„å‰¯æœ¬ï¼Œæˆªæ–­æˆ–å¡«å……ç©ºå€¼è·å–æŒ‡å®šé•¿åº¦</span><br><span class="hljs-comment">   */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span>[] copyOf(<span class="hljs-type">int</span>[] original, <span class="hljs-type">int</span> newLength) &#123;<br>   <span class="hljs-comment">// ç”³è¯·ä¸€ä¸ªæ–°çš„æ•°ç»„</span><br>       <span class="hljs-type">int</span>[] copy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[newLength];<br><span class="hljs-comment">// è°ƒç”¨System.arraycopy,å°†æºæ•°ç»„ä¸­çš„æ•°æ®è¿›è¡Œæ‹·è´,å¹¶è¿”å›æ–°çš„æ•°ç»„</span><br>       System.arraycopy(original, <span class="hljs-number">0</span>, copy, <span class="hljs-number">0</span>,<br>                        Math.min(original.length, newLength));<br>       <span class="hljs-keyword">return</span> copy;<br>   &#125;<br></code></pre></td></tr></table></figure><p>å†ä¸¾ä¸ªæ —å­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä»¥æ­£ç¡®çš„é¡ºåºè¿”å›ä¸€ä¸ªåŒ…å«æ­¤åˆ—è¡¨ä¸­æ‰€æœ‰å…ƒç´ çš„æ•°ç»„ï¼ˆä»ç¬¬ä¸€ä¸ªåˆ°æœ€åä¸€ä¸ªå…ƒç´ ï¼‰; </span><br><span class="hljs-comment"> * è¿”å›çš„æ•°ç»„çš„è¿è¡Œæ—¶ç±»å‹æ˜¯æŒ‡å®šæ•°ç»„çš„è¿è¡Œæ—¶ç±»å‹ã€‚</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-keyword">public</span> Object[] toArray() &#123;<br> <span class="hljs-comment">//elementDataï¼šè¦å¤åˆ¶çš„æ•°ç»„ï¼›sizeï¼šè¦å¤åˆ¶çš„é•¿åº¦</span><br>     <span class="hljs-keyword">return</span> Arrays.copyOf(elementData, size);<br> &#125;<br></code></pre></td></tr></table></figure><h6 id="ä¸¤è€…è”ç³»å’ŒåŒºåˆ«"><a href="#ä¸¤è€…è”ç³»å’ŒåŒºåˆ«" class="headerlink" title="ä¸¤è€…è”ç³»å’ŒåŒºåˆ«"></a>ä¸¤è€…è”ç³»å’ŒåŒºåˆ«</h6><p><strong>è”ç³»ï¼š</strong>çœ‹ä¸¤è€…æºä»£ç å¯ä»¥å‘ç° <code>copyOf()</code>å†…éƒ¨å®é™…è°ƒç”¨äº† <code>System.arraycopy()</code> æ–¹æ³•</p><p><strong>åŒºåˆ«ï¼š</strong><code>arraycopy()</code> éœ€è¦ç›®æ ‡æ•°ç»„ï¼Œå°†åŸæ•°ç»„æ‹·è´åˆ°ä½ è‡ªå·±å®šä¹‰çš„æ•°ç»„é‡Œæˆ–è€…åŸæ•°ç»„ï¼Œè€Œä¸”å¯ä»¥é€‰æ‹©æ‹·è´çš„èµ·ç‚¹å’Œé•¿åº¦ä»¥åŠæ”¾å…¥æ–°æ•°ç»„ä¸­çš„ä½ç½® <code>copyOf()</code> æ˜¯ç³»ç»Ÿè‡ªåŠ¨åœ¨å†…éƒ¨æ–°å»ºä¸€ä¸ªæ•°ç»„ï¼Œå¹¶è¿”å›è¯¥æ•°ç»„ã€‚</p><h5 id="ensureCapacityæ–¹æ³•"><a href="#ensureCapacityæ–¹æ³•" class="headerlink" title="ensureCapacityæ–¹æ³•"></a><code>ensureCapacity</code>æ–¹æ³•</h5><p><code>ArrayList</code> æºç ä¸­æœ‰ä¸€ä¸ª <code>ensureCapacity</code> æ–¹æ³•ä¸çŸ¥é“å¤§å®¶æ³¨æ„åˆ°æ²¡æœ‰ï¼Œè¿™ä¸ªæ–¹æ³• <code>ArrayList</code> å†…éƒ¨æ²¡æœ‰è¢«è°ƒç”¨è¿‡ï¼Œæ‰€ä»¥å¾ˆæ˜¾ç„¶æ˜¯æä¾›ç»™ç”¨æˆ·è°ƒç”¨çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * å¦‚æœ‰å¿…è¦ï¼Œå¢åŠ æ­¤ ArrayList å®ä¾‹çš„å®¹é‡ï¼Œä»¥ç¡®ä¿å®ƒè‡³å°‘å¯ä»¥å®¹çº³ç”±minimum capacityå‚æ•°æŒ‡å®šçš„å…ƒç´ æ•°ã€‚</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span>   minCapacity   æ‰€éœ€çš„æœ€å°å®¹é‡</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ensureCapacity</span><span class="hljs-params">(<span class="hljs-type">int</span> minCapacity)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">minExpand</span> <span class="hljs-operator">=</span> (elementData != DEFAULTCAPACITY_EMPTY_ELEMENTDATA)<br>        <span class="hljs-comment">// any size if not default element table</span><br>        ? <span class="hljs-number">0</span><br>        <span class="hljs-comment">// larger than default for default empty table. It&#x27;s already</span><br>        <span class="hljs-comment">// supposed to be at default size.</span><br>        : DEFAULT_CAPACITY;<br><br>    <span class="hljs-keyword">if</span> (minCapacity &gt; minExpand) &#123;<br>        ensureExplicitCapacity(minCapacity);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ„æ€æ˜¯ï¼Œæˆ‘ä»¬åœ¨å‘ <code>ArrayList</code> æ·»åŠ å¤§é‡å…ƒç´ ä¹‹å‰ç”¨ <code>ensureCapacity</code> æ–¹æ³•å°†å®¹é‡æ‰©å®¹è‡³å¯ä»¥å®¹çº³å…ƒç´ çš„å¤§å°ï¼Œä»¥å‡å°‘å¢é‡æ—¶é‡æ–°åˆ†é…çš„æ¬¡æ•°ã€‚</p><p>é€šè¿‡ä¸‹é¢çš„ä»£ç å®é™…æµ‹è¯•ä»¥ä¸‹è¿™ä¸ªæ–¹æ³•çš„æ•ˆæœï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>       ArrayList&lt;Object&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Object&gt;();<br>       <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">N</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000000</span>;<br>       <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>       <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; N; i++) &#123;<br>           list.add(i);<br>       &#125;<br>       <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>       System.out.println(<span class="hljs-string">&quot;ä½¿ç”¨ensureCapacityæ–¹æ³•å‰ï¼š&quot;</span> + (endTime - startTime));<br>   &#125;<br><br><span class="hljs-comment">// æ‰§è¡Œäº”æ¬¡åˆ†åˆ«è·å¾—çš„ç»“æœ</span><br><span class="hljs-comment">// ä½¿ç”¨ensureCapacityæ–¹æ³•å‰ï¼š2295, 2291, 2308, 2305, 2306</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>       ArrayList&lt;Object&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Object&gt;();<br>       <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">N</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000000</span>;<br>       <span class="hljs-type">long</span> <span class="hljs-variable">startTime1</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>   <span class="hljs-comment">// ä½¿ç”¨ensureCapacityæ–¹æ³•</span><br>       list.ensureCapacity(N);<br>       <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; N; i++) &#123;<br>           list.add(i);<br>       &#125;<br>       <span class="hljs-type">long</span> <span class="hljs-variable">endTime1</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>       System.out.println(<span class="hljs-string">&quot;ä½¿ç”¨ensureCapacityæ–¹æ³•åï¼š&quot;</span> + (endTime1 - startTime1));<br>   &#125;<br><br><span class="hljs-comment">// æ‰§è¡Œäº”æ¬¡åˆ†åˆ«è·å¾—çš„ç»“æœ</span><br><span class="hljs-comment">// ä½¿ç”¨ensureCapacityæ–¹æ³•å‰ï¼š2163, 2113, 2156, 2150, 2164</span><br></code></pre></td></tr></table></figure><p>é€šè¿‡è¿è¡Œç»“æœï¼Œå¯ä»¥çœ‹å‡ºå‘ <code>ArrayList</code> æ·»åŠ å¤§é‡å…ƒç´ ä¹‹å‰ä½¿ç”¨<code>ensureCapacity</code> æ–¹æ³•å¯ä»¥ç¨ç¨æå‡æ€§èƒ½ã€‚</p><p>ä¸è¿‡ï¼Œè¿™ä¸ªæ€§èƒ½å·®è·å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚è€Œä¸”ï¼Œå®é™…é¡¹ç›®æ ¹æœ¬ä¹Ÿä¸å¯èƒ½å¾€ <code>ArrayList</code> é‡Œé¢æ·»åŠ è¿™ä¹ˆå¤šå…ƒç´ ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>æºç </category>
      
      <category>JDK</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é›†åˆ</tag>
      
      <tag>ArrayList</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¸ºä»€ä¹ˆConcurrentHashMapçš„key/valueä¸èƒ½ä¸ºç©ºï¼ŒHashMapå¯ä»¥ï¼Ÿ</title>
    <link href="/2023/09/23/%E4%B8%BA%E4%BB%80%E4%B9%88ConcurrentHashMap%E7%9A%84keyvalue%E4%B8%8D%E8%83%BD%E4%B8%BA%E7%A9%BA%EF%BC%8CHashMap%E5%8F%AF%E4%BB%A5%EF%BC%9F/"/>
    <url>/2023/09/23/%E4%B8%BA%E4%BB%80%E4%B9%88ConcurrentHashMap%E7%9A%84keyvalue%E4%B8%8D%E8%83%BD%E4%B8%BA%E7%A9%BA%EF%BC%8CHashMap%E5%8F%AF%E4%BB%A5%EF%BC%9F/</url>
    
    <content type="html"><![CDATA[<h3 id="ä¸ºä»€ä¹ˆConcurrentHashMapçš„key-valueä¸èƒ½ä¸ºç©ºï¼ŒHashMapå¯ä»¥ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆConcurrentHashMapçš„key-valueä¸èƒ½ä¸ºç©ºï¼ŒHashMapå¯ä»¥ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆConcurrentHashMapçš„key&#x2F;valueä¸èƒ½ä¸ºç©ºï¼ŒHashMapå¯ä»¥ï¼Ÿ"></a>ä¸ºä»€ä¹ˆConcurrentHashMapçš„key&#x2F;valueä¸èƒ½ä¸ºç©ºï¼ŒHashMapå¯ä»¥ï¼Ÿ</h3><p>ä»¥JDK8ä¸ºä¾‹ï¼Œåœ¨ConcurrentHashMapæºç çš„<code>putVal</code>æ–¹æ³•ä¸­å½“ä¼ å…¥çš„å‚æ•°keyæˆ–è€…valueä¸ºnullæ—¶ï¼Œä¼šæŠ›å‡º<code>NullPointerException</code></p><img src="https://image.seeyourface.cn/migrate/image-20230923222339494.png" alt="image-20230923222339494" style="zoom: 67%;" /><p><code>ConcurrentHashMap</code> çš„ key å’Œ value ä¸èƒ½ä¸º null ä¸»è¦æ˜¯ä¸ºäº†é¿å…äºŒä¹‰æ€§ã€‚</p><p>null æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å€¼ï¼Œè¡¨ç¤ºæ²¡æœ‰å¯¹è±¡æˆ–æ²¡æœ‰å¼•ç”¨ã€‚å¦‚æœä½ ç”¨ null ä½œä¸ºé”®ï¼Œé‚£ä¹ˆä½ å°±æ— æ³•åŒºåˆ†è¿™ä¸ªé”®æ˜¯å¦å­˜åœ¨äº ConcurrentHashMap ä¸­ï¼Œè¿˜æ˜¯æ ¹æœ¬æ²¡æœ‰è¿™ä¸ªé”®ã€‚åŒæ ·ï¼Œå¦‚æœä½ ç”¨ null ä½œä¸ºå€¼ï¼Œé‚£ä¹ˆä½ å°±æ— æ³•åŒºåˆ†è¿™ä¸ªå€¼æ˜¯å¦æ˜¯çœŸæ­£å­˜å‚¨åœ¨ ConcurrentHashMap ä¸­çš„ï¼Œè¿˜æ˜¯å› ä¸ºæ‰¾ä¸åˆ°å¯¹åº”çš„é”®è€Œè¿”å›çš„ã€‚</p><p>æ‹¿ get æ–¹æ³•å–å€¼æ¥è¯´ï¼Œè¿”å›çš„ç»“æœä¸º null å­˜åœ¨ä¸¤ç§æƒ…å†µï¼š</p><ul><li>å€¼æ²¡æœ‰åœ¨é›†åˆä¸­ ï¼›</li><li>å€¼æœ¬èº«å°±æ˜¯ nullã€‚</li></ul><p>è¿™ä¹Ÿå°±æ˜¯äºŒä¹‰æ€§çš„ç”±æ¥ã€‚</p><p>å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œ<strong>å­˜åœ¨</strong>ä¸€ä¸ªçº¿ç¨‹æ“ä½œè¯¥ <code>ConcurrentHashMap</code> æ—¶ï¼Œå…¶ä»–çš„çº¿ç¨‹å°†è¯¥ <code>ConcurrentHashMap</code> ä¿®æ”¹çš„æƒ…å†µï¼Œæ‰€ä»¥<strong>æ— æ³•é€šè¿‡</strong> <code>containsKey(key)</code> æ¥åˆ¤æ–­å¦å­˜åœ¨è¿™ä¸ªé”®å€¼å¯¹ï¼Œä¹Ÿå°±æ²¡<strong>åŠæ³•è§£å†³äºŒä¹‰æ€§</strong>é—®é¢˜äº†ã€‚</p><p>ä¸æ­¤å½¢æˆå¯¹æ¯”çš„æ˜¯ï¼Œ<code>HashMap</code> å¯ä»¥å­˜å‚¨ null çš„ key å’Œ valueï¼Œä½† null ä½œä¸ºé”®åªèƒ½æœ‰ä¸€ä¸ªï¼Œnull ä½œä¸ºå€¼å¯ä»¥æœ‰å¤šä¸ªã€‚å¦‚æœä¼ å…¥ null ä½œä¸ºå‚æ•°ï¼Œå°±ä¼šè¿”å› hash å€¼ä¸º 0 çš„ä½ç½®çš„å€¼ã€‚å•çº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œ<strong>ä¸å­˜åœ¨</strong>ä¸€ä¸ªçº¿ç¨‹æ“ä½œè¯¥ <code>HashMap</code> æ—¶ï¼Œå…¶ä»–çš„çº¿ç¨‹å°†è¯¥ <code>HashMap</code> ä¿®æ”¹çš„æƒ…å†µï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ <code>contains(key)</code>æ¥åšåˆ¤æ–­æ˜¯å¦å­˜åœ¨è¿™ä¸ªé”®å€¼å¯¹ï¼Œä»è€Œåšç›¸åº”çš„å¤„ç†ï¼Œä¹Ÿå°±ä¸å­˜åœ¨äºŒä¹‰æ€§é—®é¢˜ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>å¤šçº¿ç¨‹ä¸‹æ— æ³•æ­£ç¡®åˆ¤å®šé”®å€¼å¯¹æ˜¯å¦å­˜åœ¨</strong>ï¼ˆå­˜åœ¨å…¶ä»–çº¿ç¨‹ä¿®æ”¹çš„æƒ…å†µï¼‰ï¼Œå•çº¿ç¨‹æ˜¯å¯ä»¥çš„ï¼ˆä¸å­˜åœ¨å…¶ä»–çº¿ç¨‹ä¿®æ”¹çš„æƒ…å†µï¼‰ã€‚</p><p>å¦‚æœç¡®å®éœ€è¦åœ¨ <code>ConcurrentHashMap</code> ä¸­ä½¿ç”¨ null çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªç‰¹æ®Šçš„é™æ€ç©ºå¯¹è±¡æ¥ä»£æ›¿ nullã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">NULL</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br></code></pre></td></tr></table></figure><hr><p>å…³äº<code>ConcurrentHashMap</code> ä½œè€…æœ¬äºº (Doug Lea)å¯¹äºè¿™ä¸ªé—®é¢˜åšå‡ºçš„å›ç­”ï¼š</p><blockquote><p>The main reason that nulls arenâ€™t allowed in ConcurrentMaps (ConcurrentHashMaps, ConcurrentSkipListMaps) is that ambiguities that may be just barely tolerable in non-concurrent maps canâ€™t be accommodated. The main one is that if map.get(key) returns null, you canâ€™t detect whether the key explicitly maps to null vs the key isnâ€™t mapped. In a non-concurrent map, you can check this via map.contains(key), but in a concurrent one, the map might have changed between calls.</p></blockquote><p>ç¿»è¯‘ï¼š</p><p>ConcurrentMapsï¼ˆConcurrentHashMapsã€ConcurrentSkipListMapsï¼‰ä¸­ä¸å…è®¸ä½¿ç”¨ null çš„ä¸»è¦åŸå› æ˜¯ï¼Œæ— æ³•å®¹çº³åœ¨éå¹¶å‘æ˜ å°„ä¸­å‹‰å¼ºå¯ä»¥å®¹å¿çš„æ­§ä¹‰ã€‚ä¸»è¦çš„ä¸€ç‚¹æ˜¯ï¼Œå¦‚æœmap.get(key)è¿”å›nullï¼Œä½ æ— æ³•æ£€æµ‹è¯¥é”®æ˜¯å¦æ˜¾å¼æ˜ å°„åˆ°nullä¸è¯¥é”®æ˜¯å¦æœªæ˜ å°„ã€‚åœ¨éå¹¶å‘æ˜ å°„ä¸­ï¼Œæ‚¨å¯ä»¥é€šè¿‡ map.contains(key) æ£€æŸ¥è¿™ä¸€ç‚¹ï¼Œä½†åœ¨å¹¶å‘æ˜ å°„ä¸­ï¼Œæ˜ å°„å¯èƒ½åœ¨<strong>è°ƒç”¨ä¹‹é—´</strong>å‘ç”Ÿäº†å˜åŒ–ã€‚</p><h4 id="å¤åˆæ“ä½œ"><a href="#å¤åˆæ“ä½œ" class="headerlink" title="å¤åˆæ“ä½œ"></a>å¤åˆæ“ä½œ</h4><p>é‚£ä¹ˆ<strong>é—®é¢˜æ¥äº†</strong>ï¼Œä½ æœ‰å¯èƒ½ä¼šé—®ï¼šå…«è‚¡æˆ‘éƒ½èƒŒçƒ‚äº†<code>ConcurrentHashMap</code>ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Œä¸ºä»€ä¹ˆä¼šæœ‰å…¶ä»–çº¿ç¨‹é€ æˆå½±å“ï¼Ÿ</p><p><code>ConcurrentHashMap</code> æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ„å‘³ç€å®ƒå¯ä»¥ä¿è¯<strong>å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹å®ƒè¿›è¡Œè¯»å†™æ“ä½œ</strong>æ—¶ï¼Œä¸ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µï¼Œä¹Ÿä¸ä¼šå¯¼è‡´ JDK1.7 åŠä¹‹å‰ç‰ˆæœ¬çš„ HashMap å¤šçº¿ç¨‹æ“ä½œå¯¼è‡´æ­»å¾ªç¯é—®é¢˜ã€‚ä½†æ˜¯ï¼Œè¿™å¹¶ä¸æ„å‘³ç€å®ƒå¯ä»¥ä¿è¯æ‰€æœ‰çš„å¤åˆæ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ï¼Œä¸€å®šä¸è¦ææ··äº†ï¼</p><p>å¤åˆæ“ä½œæ˜¯æŒ‡ç”±å¤šä¸ª<strong>åŸºæœ¬æ“ä½œ</strong>(å¦‚putã€getã€removeã€containsKeyç­‰)ç»„æˆçš„æ“ä½œï¼Œä¾‹å¦‚å…ˆåˆ¤æ–­æŸä¸ªé”®æ˜¯å¦å­˜åœ¨<strong>containsKey(key)<strong>ï¼Œç„¶åæ ¹æ®ç»“æœè¿›è¡Œæ’å…¥æˆ–æ›´æ–°</strong>put(key, value)<strong>ã€‚è¿™ç§æ“ä½œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½ä¼šè¢«å…¶ä»–çº¿ç¨‹</strong>æ‰“æ–­</strong>ï¼Œå¯¼è‡´ç»“æœä¸ç¬¦åˆé¢„æœŸã€‚</p><p>ä¾‹å¦‚ï¼Œæœ‰ä¸¤ä¸ªçº¿ç¨‹ A å’Œ B åŒæ—¶å¯¹ <code>ConcurrentHashMap</code> è¿›è¡Œå¤åˆæ“ä½œï¼Œå¦‚ä¸‹ï¼š</p><img src="https://image.seeyourface.cn/migrate/image-20230923224919178.png" alt="image-20230923224919178" style="zoom: 67%;" /><p>å¦‚æœçº¿ç¨‹ A å’Œ B çš„æ‰§è¡Œé¡ºåºæ˜¯è¿™æ ·ï¼š</p><ol><li>çº¿ç¨‹ A åˆ¤æ–­ map ä¸­ä¸å­˜åœ¨ key</li><li>çº¿ç¨‹ B åˆ¤æ–­ map ä¸­ä¸å­˜åœ¨ key</li><li>çº¿ç¨‹ B å°† (key, anotherValue) æ’å…¥ map</li><li>çº¿ç¨‹ A å°† (key, value) æ’å…¥ map</li></ol><p>é‚£ä¹ˆæœ€ç»ˆçš„ç»“æœæ˜¯ (key, value)ï¼Œè€Œä¸æ˜¯é¢„æœŸçš„ (key, anotherValue)ã€‚è¿™å°±æ˜¯<strong>å¤åˆæ“ä½œçš„éåŸå­æ€§</strong>å¯¼è‡´çš„é—®é¢˜ã€‚</p><h4 id="é‚£å¦‚ä½•ä¿è¯-ConcurrentHashMap-å¤åˆæ“ä½œçš„åŸå­æ€§å‘¢ï¼Ÿ"><a href="#é‚£å¦‚ä½•ä¿è¯-ConcurrentHashMap-å¤åˆæ“ä½œçš„åŸå­æ€§å‘¢ï¼Ÿ" class="headerlink" title="é‚£å¦‚ä½•ä¿è¯ ConcurrentHashMap å¤åˆæ“ä½œçš„åŸå­æ€§å‘¢ï¼Ÿ"></a>é‚£å¦‚ä½•ä¿è¯ ConcurrentHashMap å¤åˆæ“ä½œçš„åŸå­æ€§å‘¢ï¼Ÿ</h4><p><code>ConcurrentHashMap</code> æä¾›äº†ä¸€äº›åŸå­æ€§çš„å¤åˆæ“ä½œï¼Œå¦‚ putIfAbsentã€computeã€computeIfAbsent ã€computeIfPresentã€mergeç­‰ã€‚</p><p>è¿™äº›æ–¹æ³•éƒ½å¯ä»¥æ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œæ ¹æ®ç»™å®šçš„ key å’Œ value æ¥è®¡ç®—ä¸€ä¸ªæ–°çš„ valueï¼Œå¹¶ä¸”å°†å…¶æ›´æ–°åˆ° map ä¸­ã€‚</p><img src="https://image.seeyourface.cn/migrate/image-20230923225542922.png" alt="image-20230923225542922" style="zoom:80%;" />]]></content>
    
    
    <categories>
      
      <category>JAVA</category>
      
      <category>é›†åˆ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ConcurrentHashMap</tag>
      
      <tag>HashMap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JDKå·¥å…·ä½¿ç”¨æŒ‡å—</title>
    <link href="/2023/09/23/JDK%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/"/>
    <url>/2023/09/23/JDK%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/</url>
    
    <content type="html"><![CDATA[<h3 id="JDKå·¥å…·ä½¿ç”¨æŒ‡å—"><a href="#JDKå·¥å…·ä½¿ç”¨æŒ‡å—" class="headerlink" title="JDKå·¥å…·ä½¿ç”¨æŒ‡å—"></a>JDKå·¥å…·ä½¿ç”¨æŒ‡å—</h3><h4 id="jps"><a href="#jps" class="headerlink" title="jps"></a>jps</h4><p><strong>è¯¥å‘½ä»¤ç”¨äºæ‰“å°å½“å‰JVMä¸­è¿è¡Œçš„Javaè¿›ç¨‹çŠ¶æ€ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">jps [options] [<span class="hljs-built_in">hostid</span>]<br></code></pre></td></tr></table></figure><p><code>options</code>è¡¨ç¤ºå‘½ä»¤å¯é€‰å‚æ•°ï¼š</p><ul><li>-qï¼šä»…æ˜¾ç¤ºpid</li><li>-mï¼šæ˜¾ç¤ºè¿›ç¨‹pidåŠmainæ–¹æ³•å‚æ•°</li><li>-lï¼šæ‰“å°è¿›ç¨‹å¯¹åº”JARæ–‡ä»¶æ‰€åœ¨çš„å®Œæ•´è·¯å¾„å</li><li>-vï¼šæŸ¥çœ‹è¿›ç¨‹pidåŠJVMå‚æ•°</li><li>-hï¼šæ‰“å°å¸®åŠ©ä¿¡æ¯</li></ul><h4 id="jinfo"><a href="#jinfo" class="headerlink" title="jinfo"></a>jinfo</h4><p><strong>ç”¨äºæ‰“å°å…¨éƒ¨å‚æ•°å’Œç³»ç»Ÿå±æ€§</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">jinfo [options] &lt;pid&gt;<br></code></pre></td></tr></table></figure><p>optionsè¡¨ç¤ºå‘½ä»¤å¯é€‰å‚æ•°ï¼š</p><ul><li>-[pid]ï¼šè¾“å‡ºå…¨éƒ¨å‚æ•°</li><li>-flag [name] pidï¼šæ‰“å°å¯¹åº”åç§°çš„å‚æ•°å†…å®¹</li><li>-flag [+|-] [name] pidï¼šä¸é‡å¯è™šæ‹Ÿæœºçš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€ä¿®æ”¹JVMå‚æ•°</li><li>-flag [name]&#x3D;[value]ï¼šä¸é‡å¯è™šæ‹Ÿæœºçš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€ä¿®æ”¹JVMå‚æ•°</li></ul><h4 id="jstat"><a href="#jstat" class="headerlink" title="jstat"></a>jstat</h4><p><strong>å¯¹Javaåº”ç”¨ç¨‹åºçš„æ€§èƒ½å’Œèµ„æºè¿›è¡Œå®æ—¶ç›‘æ§ï¼ŒåŒ…æ‹¬Heapå’Œåƒåœ¾å›æ”¶çŠ¶æ€çš„ç›‘æ§</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">jstat -[options] [-t] [-h&lt;lines&gt;] &lt;vmid&gt; [&lt;interval&gt; [&lt;count&gt;]]<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œvmidä¸ºè™šæ‹Ÿæœºidï¼ŒLiunx&#x2F;Unixä¸€èˆ¬ä¸ºpidï¼Œintervalä¸ºé‡‡æ ·é—´éš”ï¼ˆmsï¼‰ï¼Œcountä¸ºé‡‡æ ·æ•°</p><p><code>jstat -gc 54231 1000 3</code> è¡¨ç¤ºæ¯éš”1000msæ‰“å°ä¸€æ¬¡pidä¸º54231çš„è¿›ç¨‹GCä¿¡æ¯ï¼Œæ€»å…±æ‰“å°ä¸‰æ¬¡</p><p>optionsè¡¨ç¤ºå‘½ä»¤å¯é€‰å‚æ•°ï¼š</p><ul><li><p>-classï¼šæ˜¾ç¤ºåŠ è½½classçš„æ•°é‡åŠæ‰€å ç©ºé—´ç­‰ä¿¡æ¯</p></li><li><p>-compilerï¼šJITå³æ—¶ç¼–è¯‘å™¨ç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯</p></li><li><p>-gcï¼šæ‰“å°GCä¿¡æ¯ï¼ˆå±•å¼€æŸ¥çœ‹å‚æ•°è¯´æ˜ï¼‰</p></li><li><p>-gccapacityï¼šæ‰“å°å„ä¸ªå†…å­˜æ± åˆ†ä»£ç©ºé—´çš„å®¹é‡</p><table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>NGCMN</td><td>å¹´è½»ä»£(young)ä¸­åˆå§‹åŒ–(æœ€å°)çš„å¤§å°(å­—èŠ‚)</td></tr><tr><td>NGCMX</td><td>å¹´è½»ä»£(young)çš„æœ€å¤§å®¹é‡(å­—èŠ‚)</td></tr><tr><td>NGC</td><td>å¹´è½»ä»£(young)ä¸­å½“å‰çš„å®¹é‡(å­—èŠ‚)</td></tr><tr><td>S0C</td><td>å¹´è½»ä»£ä¸­ç¬¬ä¸€ä¸ªsurvivorï¼ˆå¹¸å­˜åŒºï¼‰çš„å®¹é‡(å­—èŠ‚)</td></tr><tr><td>S1C</td><td>å¹´è½»ä»£ä¸­ç¬¬äºŒä¸ªsurvivorï¼ˆå¹¸å­˜åŒºï¼‰çš„å®¹é‡(å­—èŠ‚)</td></tr><tr><td>EC</td><td>å¹´è½»ä»£ä¸­Edenï¼ˆä¼Šç”¸å›­ï¼‰çš„å®¹é‡(å­—èŠ‚)</td></tr><tr><td>OGCMN</td><td>oldä»£ä¸­åˆå§‹åŒ–(æœ€å°)çš„å¤§å°(å­—èŠ‚)</td></tr><tr><td>OGCMX</td><td>oldä»£çš„æœ€å¤§å®¹é‡(å­—èŠ‚)</td></tr><tr><td>OGC</td><td>oldä»£å½“å‰æ–°ç”Ÿæˆçš„å®¹é‡(å­—èŠ‚)</td></tr><tr><td>OC</td><td>Oldä»£çš„å®¹é‡(å­—èŠ‚)</td></tr><tr><td>MCMN</td><td>Metaspace åŒºåˆå§‹åŒ– ( æœ€å° ) å®¹é‡ (å­—èŠ‚)</td></tr><tr><td>MCMX</td><td>Metaspace åŒºçš„æœ€å¤§å®¹é‡(å­—èŠ‚)</td></tr><tr><td>MC</td><td>å½“å‰ Metaspace çš„å®¹é‡(å­—èŠ‚)</td></tr><tr><td>CCSMN</td><td>æœ€å°å‹ç¼©ç±»ç©ºé—´å¤§å°(å­—èŠ‚)</td></tr><tr><td>CCMSX</td><td>æœ€å¤§å‹ç¼©ç±»ç©ºé—´å¤§å°(å­—èŠ‚)</td></tr><tr><td>CCSC</td><td>å½“å‰å‹ç¼©ç±»ç©ºé—´å¤§å°(å­—èŠ‚)</td></tr><tr><td>YGC</td><td>ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶å¹´è½»ä»£ä¸­GC(minor GC)æ¬¡æ•°</td></tr><tr><td>FGC</td><td>ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶oldä»£GC(full GC)æ¬¡æ•°</td></tr></tbody></table></li><li><p>-gcutilï¼šGCç›¸å…³åŒºåŸŸçš„ä½¿ç”¨ç‡ç»Ÿè®¡</p><table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>S0</td><td>å¹´è½»ä»£ä¸­ç¬¬ä¸€ä¸ªsurvivorï¼ˆå¹¸å­˜åŒºï¼‰å·²ä½¿ç”¨çš„å å½“å‰å®¹é‡ç™¾åˆ†æ¯”</td></tr><tr><td>S1</td><td>å¹´è½»ä»£ä¸­ç¬¬äºŒä¸ªsurvivorï¼ˆå¹¸å­˜åŒºï¼‰å·²ä½¿ç”¨çš„å å½“å‰å®¹é‡ç™¾åˆ†æ¯”</td></tr><tr><td>E</td><td>å¹´è½»ä»£ä¸­Edenï¼ˆä¼Šç”¸å›­ï¼‰å·²ä½¿ç”¨çš„å å½“å‰å®¹é‡ç™¾åˆ†æ¯”</td></tr><tr><td>O</td><td>oldä»£å·²ä½¿ç”¨çš„å å½“å‰å®¹é‡ç™¾åˆ†æ¯”</td></tr><tr><td>M</td><td>Metaspaceä»£å·²ä½¿ç”¨çš„å å½“å‰å®¹é‡ç™¾åˆ†æ¯”</td></tr><tr><td>CCS</td><td>å‹ç¼©åŒºå·²ä½¿ç”¨çš„å å½“å‰å®¹é‡ç™¾åˆ†æ¯”</td></tr><tr><td>YGC</td><td>ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶å¹´è½»ä»£ä¸­gcæ¬¡æ•°</td></tr><tr><td>YGCT</td><td>ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶å¹´è½»ä»£ä¸­gcæ‰€ç”¨æ—¶é—´(s)</td></tr><tr><td>GCT</td><td>ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶gcç”¨çš„æ€»æ—¶é—´(s)</td></tr><tr><td>FGC</td><td>ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶oldä»£(å…¨gc)gcæ¬¡æ•°</td></tr><tr><td>FGCT</td><td>ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶oldä»£(å…¨gc)gcæ‰€ç”¨æ—¶é—´(s)</td></tr></tbody></table></li><li><p>-gccauseï¼šæŸ¥çœ‹ä¸Šæ¬¡GCå’Œæœ¬æ¬¡GCï¼ˆå¦‚æœæ­£åœ¨GCï¼‰äº§ç”Ÿçš„åŸå› ï¼Œå‚æ•°åŒ-gcutil</p></li><li><p>-gcnewï¼šå¹´è½»ä»£çš„ç»Ÿè®¡ä¿¡æ¯</p><table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>S0C</td><td>å¹´è½»ä»£ä¸­ç¬¬ä¸€ä¸ªsurvivorï¼ˆå¹¸å­˜åŒºï¼‰çš„å®¹é‡(å­—èŠ‚)</td></tr><tr><td>S1C</td><td>å¹´è½»ä»£ä¸­ç¬¬äºŒä¸ªsurvivorï¼ˆå¹¸å­˜åŒºï¼‰çš„å®¹é‡(å­—èŠ‚)</td></tr><tr><td>S0U</td><td>å¹´è½»ä»£ä¸­ç¬¬ä¸€ä¸ªsurvivorï¼ˆå¹¸å­˜åŒºï¼‰ç›®å‰å·²ä½¿ç”¨ç©ºé—´(å­—èŠ‚)</td></tr><tr><td>S1U</td><td>å¹´è½»ä»£ä¸­ç¬¬äºŒä¸ªsurvivorï¼ˆå¹¸å­˜åŒºï¼‰ç›®å‰å·²ä½¿ç”¨ç©ºé—´(å­—èŠ‚)</td></tr><tr><td>TT</td><td>æŒæœ‰æ¬¡æ•°é™åˆ¶(é»˜è®¤15)</td></tr><tr><td>MTT</td><td>Maximum tenuring thresholdï¼Œå¯ä»¥é€šè¿‡-XX:MaxTenuringThreshold&#x3D;Nè®¾ç½®ï¼Œé»˜è®¤ä¸º15</td></tr><tr><td>DSS</td><td>Desired survivor sizeï¼Œå•ä½ä¸ºKBï¼Œè¿™ä¸ªå€¼é»˜è®¤ä¸ºSurvivoråŒºçš„50%</td></tr><tr><td>EC</td><td>å¹´è½»ä»£ä¸­Edenï¼ˆä¼Šç”¸å›­ï¼‰çš„å®¹é‡(å­—èŠ‚)</td></tr><tr><td>EU</td><td>å¹´è½»ä»£ä¸­Edenï¼ˆä¼Šç”¸å›­ï¼‰ç›®å‰å·²ä½¿ç”¨ç©ºé—´(å­—èŠ‚)</td></tr><tr><td>YGC</td><td>ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶å¹´è½»ä»£ä¸­gcæ¬¡æ•°</td></tr><tr><td>YGCT</td><td>ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶å¹´è½»ä»£ä¸­gcæ‰€ç”¨æ—¶é—´(s)</td></tr></tbody></table></li><li><p>-gcoldcapacityï¼šè€å¹´ä»£ç©ºé—´å¤§å°ç»Ÿè®¡</p><table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>OGCMN</td><td>è€å¹´ä»£æœ€å°å®¹é‡</td></tr><tr><td>OGCMX</td><td>è€å¹´ä»£æœ€å¤§å®¹é‡</td></tr><tr><td>OGC</td><td>å½“å‰è€å¹´ä»£å¤§å°</td></tr><tr><td>OC</td><td>è€å¹´ä»£å¤§å°</td></tr><tr><td>YGC</td><td>å¹´è½»ä»£åƒåœ¾å›æ”¶æ¬¡æ•°</td></tr><tr><td>FGC</td><td>è€å¹´ä»£åƒåœ¾å›æ”¶æ¬¡æ•°</td></tr><tr><td>FGCT</td><td>è€å¹´ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´</td></tr><tr><td>GCT</td><td>åƒåœ¾å›æ”¶æ¶ˆè€—æ€»æ—¶é—´</td></tr></tbody></table></li><li><p>-gcmetacapacityï¼šmetaåŒºå¤§å°ç»Ÿè®¡</p><table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>MCMN</td><td>æœ€å°å…ƒæ•°æ®å®¹é‡</td></tr><tr><td>MCMX</td><td>æœ€å¤§å…ƒæ•°æ®å®¹é‡</td></tr><tr><td>MC</td><td>å½“å‰å…ƒç©ºé—´å¤§å°</td></tr><tr><td>CCSMN</td><td>æœ€å°å‹ç¼©ç±»ç©ºé—´å¤§å°</td></tr><tr><td>CCSMX</td><td>æœ€å¤§å‹ç¼©ç±»ç©ºé—´å¤§å°</td></tr><tr><td>CCSC</td><td>å½“å‰å‹ç¼©ç±»ç©ºé—´å¤§å°</td></tr><tr><td>YGC</td><td>å¹´è½»ä»£åƒåœ¾å›æ”¶æ¬¡æ•°</td></tr><tr><td>FGC</td><td>è€å¹´ä»£åƒåœ¾å›æ”¶æ¬¡æ•°</td></tr><tr><td>FGCT</td><td>è€å¹´ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´</td></tr><tr><td>GCT</td><td>åƒåœ¾å›æ”¶æ¶ˆè€—æ€»æ—¶é—´</td></tr></tbody></table></li><li><p>-printcompilationï¼šæ‰“å°JVMç¼–è¯‘ç»Ÿè®¡ä¿¡æ¯</p></li></ul><h4 id="jmap"><a href="#jmap" class="headerlink" title="jmap"></a>jmap</h4><p><strong>ç”¨äºæŸ¥çœ‹å †å†…å­˜çš„æƒ…å†µï¼Œæˆ–è€…å°†å †å†…å­˜è¾“å‡ºä¸ºäºŒè¿›åˆ¶æ–‡æœ¬</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">jmap [option] &lt;pid&gt;<br></code></pre></td></tr></table></figure><p>optionsè¡¨ç¤ºå‘½ä»¤å¯é€‰å‚æ•°ï¼š</p><ul><li><p>-heapï¼šæ‰“å°å †å†…å­˜é…ç½®å’Œä½¿ç”¨æƒ…å†µ</p></li><li><p>-histoï¼šæ‰“å°å †å†…å­˜ä¸­çš„å¯¹è±¡å¤§å°ã€æ•°é‡</p><table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>num</td><td>åºå·</td></tr><tr><td>instances</td><td>å®ä¾‹ä¸ªæ•°</td></tr><tr><td>bytes</td><td>å­—èŠ‚æ•°</td></tr><tr><td>class_name</td><td>ç±»å</td></tr></tbody></table></li><li><p><code>-dump:format=b,file=[filename].hprof</code> ï¼šdumpå †å†…å­˜åˆ°hprofæ–‡ä»¶</p></li></ul><h4 id="jhat"><a href="#jhat" class="headerlink" title="jhat"></a>jhat</h4><p><strong>ç”¨äºè®¿é—®jmapå‘½ä»¤ç”Ÿäº§çš„dumpæ–‡ä»¶ï¼Œé€šè¿‡æµè§ˆå™¨è®¿é—®</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">jhat [options] &lt;dump-file&gt;<br></code></pre></td></tr></table></figure><p>optionsè¡¨ç¤ºå‘½ä»¤å¯é€‰å‚æ•°ï¼š</p><ul><li>-portï¼šæŒ‡å®šjhatçš„httpæœåŠ¡ç«¯å£ï¼Œé»˜è®¤7000</li></ul><h4 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h4><p><strong>ç”¨äºæŸ¥çœ‹æŒ‡å®šJavaè¿›ç¨‹pidçš„å †æ ˆä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">jstack [options]<br></code></pre></td></tr></table></figure><p>optionsè¡¨ç¤ºå‘½ä»¤å¯é€‰å‚æ•°ï¼š</p><ul><li>-Fï¼šå¼ºåˆ¶çº¿ç¨‹è½¬å‚¨ã€‚å½“jstack æ²¡æœ‰å“åº”(è¿›ç¨‹æŒ‚èµ·)æ—¶ä½¿ç”¨</li><li>-mï¼šæ‰“å°Javaå’Œåº•å±‚C&#x2F;C++æ¡†æ¶æ‰€æœ‰æ ˆä¿¡æ¯</li><li>-l(å°å†™L)ï¼šé•¿åˆ—è¡¨æ¨¡å¼ï¼Œæ‰“å°é”çš„é™„åŠ ä¿¡æ¯</li></ul>]]></content>
    
    
    <categories>
      
      <category>JDK</category>
      
      <category>å·¥å…·</category>
      
    </categories>
    
    
    <tags>
      
      <tag>è°ƒä¼˜</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MySQLåˆ†é¡µæ€ä¹ˆä¼˜åŒ–ï¼Ÿ</title>
    <link href="/2023/09/22/MySQL%E5%88%86%E9%A1%B5%E6%80%8E%E4%B9%88%E4%BC%98%E5%8C%96%EF%BC%9F/"/>
    <url>/2023/09/22/MySQL%E5%88%86%E9%A1%B5%E6%80%8E%E4%B9%88%E4%BC%98%E5%8C%96%EF%BC%9F/</url>
    
    <content type="html"><![CDATA[<h3 id="å‰æƒ…æè¦"><a href="#å‰æƒ…æè¦" class="headerlink" title="å‰æƒ…æè¦"></a>å‰æƒ…æè¦</h3><p>æˆ‘ä»¬åˆ·ç½‘ç«™çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°éœ€è¦åˆ†é¡µæŸ¥è¯¢çš„åœºæ™¯ã€‚</p><p>æ¯”å¦‚ä¸‹å›¾è°·æ­Œçš„ç¿»é¡µåŠŸèƒ½ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230922223517480.png" alt="image-20230922223517480"></p><p>æˆ‘ä»¬å¾ˆå®¹æ˜“èƒ½è”æƒ³åˆ°å¯ä»¥ç”¨MySQLå®ç°ã€‚</p><p>å‡è®¾æˆ‘ä»¬çš„å»ºè¡¨SQLæ˜¯è¿™æ ·çš„:</p><p><img src="https://image.seeyourface.cn/migrate/image-20230922224514427.png" alt="image-20230922224514427"></p><p>å»ºè¡¨SQLå¤§å®¶ä¹Ÿä¸ç”¨æ‰£ç»†èŠ‚ï¼Œåªéœ€è¦çŸ¥é“<strong>idæ˜¯ä¸»é”®ï¼Œå¹¶ä¸”åœ¨user_nameå»ºäº†ä¸ªéä¸»é”®ç´¢å¼•</strong>å°±å¤Ÿäº†ï¼Œå…¶ä»–éƒ½ä¸é‡è¦ã€‚</p><p>ä¸ºäº†å®ç°åˆ†é¡µã€‚</p><p>å¾ˆå®¹æ˜“è”æƒ³åˆ°ä¸‹é¢è¿™æ ·çš„SQLè¯­å¥ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> page <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> id limit <span class="hljs-keyword">offset</span>, size;<br></code></pre></td></tr></table></figure><p>æ‰“ä¸ªæ¯”æ–¹æˆ‘ä»¬ä¸€é¡µéœ€è¦10æ¡æ•°æ®ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230922224640869.png" alt="image-20230922224640869"></p><p>ç¬¬ä¸€é¡µå°±æ˜¯ä¸‹é¢è¿™æ ·çš„sqlè¯­å¥ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> page <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> id limit <span class="hljs-number">0</span>, <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€ç™¾é¡µå°±æ˜¯:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> page <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> id limit <span class="hljs-number">990</span>, <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ã€‚</p><p>ç”¨è¿™ç§æ–¹å¼ï¼Œ<strong>åŒæ ·éƒ½æ˜¯æ‹¿10æ¡æ•°æ®ï¼ŒæŸ¥ç¬¬ä¸€é¡µå’Œç¬¬ä¸€ç™¾é¡µçš„æŸ¥è¯¢é€Ÿåº¦æ˜¯ä¸€æ ·çš„å—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ</strong></p><h3 id="ä¸¤ç§limitçš„æ‰§è¡Œè¿‡ç¨‹"><a href="#ä¸¤ç§limitçš„æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="ä¸¤ç§limitçš„æ‰§è¡Œè¿‡ç¨‹"></a>ä¸¤ç§limitçš„æ‰§è¡Œè¿‡ç¨‹</h3><p>ä¸Šé¢çš„ä¸¤ç§æŸ¥è¯¢æ–¹å¼ã€‚å¯¹åº” <code>limit offset, size</code> å’Œ <code>limit size</code> ä¸¤ç§æ–¹å¼ã€‚</p><p>è€Œå…¶å® <code>limit size</code> ï¼Œç›¸å½“äº <code>limit 0, size</code>ã€‚ä¹Ÿå°±æ˜¯ä»0å¼€å§‹å–sizeæ¡æ•°æ®</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸¤ç§æ–¹å¼çš„<strong>åŒºåˆ«åœ¨äºoffsetæ˜¯å¦ä¸º0</strong>ã€‚</p><p>å…ˆæ¥çœ‹ä¸‹<code>limit sql</code>çš„å†…éƒ¨æ‰§è¡Œé€»è¾‘ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230922225317030.png" alt="image-20230922225317030"></p><p>mysqlå†…éƒ¨åˆ†ä¸º<strong>serverå±‚</strong>å’Œ<strong>å­˜å‚¨å¼•æ“å±‚</strong>ã€‚ä¸€èˆ¬æƒ…å†µä¸‹å­˜å‚¨å¼•æ“éƒ½ç”¨innodbã€‚</p><p>serverå±‚æœ‰å¾ˆå¤šæ¨¡å—ï¼Œå…¶ä¸­éœ€è¦å…³æ³¨çš„æ˜¯<strong>æ‰§è¡Œå™¨</strong>æ˜¯ç”¨äºè·Ÿå­˜å‚¨å¼•æ“æ‰“äº¤é“çš„ç»„ä»¶</p><p>æ‰§è¡Œå™¨å¯ä»¥é€šè¿‡è°ƒç”¨å­˜å‚¨å¼•æ“æä¾›çš„æ¥å£ï¼Œå°†ä¸€è¡Œè¡Œæ•°æ®å–å‡ºï¼Œå½“è¿™äº›æ•°æ®å®Œå…¨ç¬¦åˆè¦æ±‚ï¼ˆæ¯”å¦‚æ»¡è¶³å…¶ä»–whereæ¡ä»¶ï¼‰ï¼Œåˆ™ä¼šæ”¾åˆ°<strong>ç»“æœé›†</strong>ä¸­ï¼Œæœ€åè¿”å›ç»™è°ƒç”¨mysqlçš„<strong>å®¢æˆ·ç«¯ï¼ˆgoã€javaå†™çš„åº”ç”¨ç¨‹åºï¼‰</strong>ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å¯¹ä¸‹é¢çš„sqlå…ˆæ‰§è¡Œä¸‹ <code>explain</code>ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> page <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> id limit <span class="hljs-number">0</span>, <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œexplainä¸­æç¤º key é‚£é‡Œï¼Œæ‰§è¡Œçš„æ˜¯<strong>PRIMARY</strong>ï¼Œä¹Ÿå°±æ˜¯èµ°çš„<strong>ä¸»é”®ç´¢å¼•</strong>ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230922225605773.png" alt="image-20230922225605773"></p><p>ä¸»é”®ç´¢å¼•æœ¬è´¨æ˜¯ä¸€æ£µB+æ ‘ï¼Œå®ƒæ˜¯æ”¾åœ¨innodbä¸­çš„ä¸€ä¸ªæ•°æ®ç»“æ„ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å›å¿†ä¸‹ï¼ŒB+æ ‘å¤§æ¦‚é•¿è¿™æ ·ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230922225637429.png" alt="image-20230922225637429"></p><p>åœ¨è¿™ä¸ªæ ‘çŠ¶ç»“æ„é‡Œï¼Œæˆ‘ä»¬éœ€è¦å…³æ³¨çš„æ˜¯ï¼Œæœ€ä¸‹é¢ä¸€å±‚èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯<strong>å¶å­ç»“ç‚¹</strong>ã€‚è€Œè¿™ä¸ªå¶å­ç»“ç‚¹é‡Œæ”¾çš„ä¿¡æ¯ä¼šæ ¹æ®å½“å‰çš„ç´¢å¼•æ˜¯<strong>ä¸»é”®ç´¢å¼•è¿˜æ˜¯éä¸»é”®ç´¢å¼•</strong>æœ‰æ‰€ä¸åŒã€‚</p><ul><li>å¦‚æœæ˜¯<strong>ä¸»é”®ç´¢å¼•</strong>ï¼Œå®ƒçš„å¶å­èŠ‚ç‚¹ä¼šå­˜æ”¾å®Œæ•´çš„è¡Œæ•°æ®ä¿¡æ¯ã€‚</li><li>å¦‚æœæ˜¯<strong>éä¸»é”®ç´¢å¼•</strong>ï¼Œé‚£å®ƒçš„å¶å­èŠ‚ç‚¹åˆ™ä¼šå­˜æ”¾ä¸»é”®ï¼Œå¦‚æœæƒ³è·å¾—è¡Œæ•°æ®ä¿¡æ¯ï¼Œåˆ™éœ€è¦å†è·‘åˆ°ä¸»é”®ç´¢å¼•å»æ‹¿ä¸€æ¬¡æ•°æ®ï¼Œè¿™å«<strong>å›è¡¨</strong>ã€‚</li></ul><p>æ¯”å¦‚æ‰§è¡Œ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> page <span class="hljs-keyword">where</span> user_name <span class="hljs-operator">=</span> &quot;å°ç™½10&quot;;<br></code></pre></td></tr></table></figure><p>ä¼šé€šè¿‡éä¸»é”®ç´¢å¼•å»æŸ¥è¯¢<strong>user_name</strong>ä¸ºâ€å°ç™½10â€çš„æ•°æ®ï¼Œç„¶ååœ¨å¶å­ç»“ç‚¹é‡Œæ‰¾åˆ°**â€å°ç™½10**â€çš„æ•°æ®å¯¹åº”çš„<strong>ä¸»é”®ä¸º10</strong>ã€‚</p><p>æ­¤æ—¶å›è¡¨åˆ°<strong>ä¸»é”®ç´¢å¼•</strong>ä¸­åšæŸ¥è¯¢ï¼Œæœ€åå®šä½åˆ°<strong>ä¸»é”®ä¸º10çš„è¡Œæ•°æ®</strong>ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230922230006225.png" alt="image-20230922230006225"></p><p>ä½†ä¸ç®¡æ˜¯ä¸»é”®è¿˜æ˜¯éä¸»é”®ç´¢å¼•ï¼Œä»–ä»¬çš„å¶å­ç»“ç‚¹æ•°æ®éƒ½æ˜¯<strong>æœ‰åºçš„</strong>ã€‚æ¯”å¦‚åœ¨ä¸»é”®ç´¢å¼•ä¸­ï¼Œè¿™äº›æ•°æ®æ˜¯æ ¹æ®ä¸»é”®idçš„å¤§å°ï¼Œä»å°åˆ°å¤§ï¼Œè¿›è¡Œæ’åºçš„ã€‚</p><h4 id="åŸºäºä¸»é”®ç´¢å¼•çš„limitæ‰§è¡Œè¿‡ç¨‹"><a href="#åŸºäºä¸»é”®ç´¢å¼•çš„limitæ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="åŸºäºä¸»é”®ç´¢å¼•çš„limitæ‰§è¡Œè¿‡ç¨‹"></a>åŸºäºä¸»é”®ç´¢å¼•çš„limitæ‰§è¡Œè¿‡ç¨‹</h4><p>å›åˆ°æ–‡ç« å¼€å¤´çš„é—®é¢˜é‡Œï¼Œå½“æˆ‘ä»¬å»æ‰<code>explain</code>ï¼Œæ‰§è¡Œè¿™æ¡sqlã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sq">select * from page order by id limit 0, 10;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢selectåé¢å¸¦çš„æ˜¯<strong>æ˜Ÿå·</strong>ï¼Œä¹Ÿå°±æ˜¯è¦æ±‚è·å¾—è¡Œæ•°æ®çš„æ‰€æœ‰å­—æ®µä¿¡æ¯ã€‚</p><p>serverå±‚ä¼šè°ƒç”¨innodbçš„æ¥å£ï¼Œåœ¨innodbé‡Œçš„ä¸»é”®ç´¢å¼•ä¸­è·å–åˆ°ç¬¬0åˆ°10æ¡<strong>å®Œæ•´è¡Œæ•°æ®</strong>ï¼Œä¾æ¬¡è¿”å›ç»™serverå±‚ï¼Œå¹¶æ”¾åˆ°serverå±‚çš„ç»“æœé›†ä¸­ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><p>è€Œå½“æˆ‘ä»¬æŠŠ<code>offset</code>æç¦»è°±ç‚¹ï¼Œæ¯”å¦‚æ‰§è¡Œçš„æ˜¯ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> page <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> id limit <span class="hljs-number">6000000</span>, <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure><p>serverå±‚ä¼šè°ƒç”¨innodbçš„æ¥å£ï¼Œç”±äºè¿™æ¬¡çš„offset&#x3D;6000000ï¼Œä¼šåœ¨innodbé‡Œçš„ä¸»é”®ç´¢å¼•ä¸­è·å–åˆ°ç¬¬0åˆ°ï¼ˆ6000000 + 10ï¼‰æ¡<strong>å®Œæ•´è¡Œæ•°æ®ï¼Œè¿”å›ç»™serverå±‚ä¹‹åæ ¹æ®offsetçš„å€¼æŒ¨ä¸ªæŠ›å¼ƒï¼Œæœ€ååªç•™ä¸‹æœ€åé¢çš„sizeæ¡</strong>ï¼Œä¹Ÿå°±æ˜¯10æ¡æ•°æ®ï¼Œæ”¾åˆ°serverå±‚çš„ç»“æœé›†ä¸­ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><p>å¯ä»¥çœ‹å‡ºï¼Œå½“offseté0æ—¶ï¼Œserverå±‚ä¼šä»å¼•æ“å±‚è·å–åˆ°å¾ˆå¤šæ— ç”¨çš„æ•°æ®ï¼Œè€Œè·å–çš„è¿™äº›æ— ç”¨æ•°æ®éƒ½æ˜¯è¦è€—æ—¶çš„ã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬å°±çŸ¥é“äº†æ–‡ç« å¼€å¤´çš„é—®é¢˜çš„ç­”æ¡ˆï¼Œ<strong>mysqlæŸ¥è¯¢ä¸­ limit 1000,10 ä¼šæ¯” limit 10 æ›´æ…¢ã€‚åŸå› æ˜¯ limit 1000,10 ä¼šå–å‡º1000+10æ¡æ•°æ®ï¼Œå¹¶æŠ›å¼ƒå‰1000æ¡ï¼Œè¿™éƒ¨åˆ†è€—æ—¶æ›´å¤§</strong>ã€‚</p><p><strong>é‚£è¿™ç§caseæœ‰åŠæ³•ä¼˜åŒ–å—ï¼Ÿ</strong></p><p>å¯ä»¥çœ‹å‡ºï¼Œå½“offseté0æ—¶ï¼Œserverå±‚ä¼šä»å¼•æ“å±‚è·å–åˆ°å¾ˆå¤šæ— ç”¨çš„æ•°æ®ï¼Œè€Œå½“selectåé¢æ˜¯**<em><strong>å·æ—¶ï¼Œå°±éœ€è¦æ‹·è´å®Œæ•´çš„è¡Œä¿¡æ¯ï¼Œ</strong>æ‹·è´å®Œæ•´æ•°æ®è·Ÿåªæ‹·è´è¡Œæ•°æ®é‡Œçš„å…¶ä¸­ä¸€ä¸¤ä¸ªåˆ—å­—æ®µè€—æ—¶æ˜¯ä¸åŒçš„</em>*ï¼Œè¿™å°±è®©åŸæœ¬å°±è€—æ—¶çš„æ“ä½œå˜å¾—æ›´åŠ ç¦»è°±ã€‚</p><p>å› ä¸ºå‰é¢çš„offsetæ¡æ•°æ®æœ€åéƒ½æ˜¯ä¸è¦çš„ï¼Œå°±ç®—å°†å®Œæ•´å­—æ®µéƒ½æ‹·è´æ¥äº†åˆæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†sqlè¯­å¥ä¿®æ”¹æˆä¸‹é¢è¿™æ ·ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> page  <span class="hljs-keyword">where</span> id <span class="hljs-operator">&gt;=</span>(<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> page  <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> id limit <span class="hljs-number">6000000</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> id limit <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢è¿™æ¡sqlè¯­å¥ï¼Œé‡Œé¢å…ˆæ‰§è¡Œå­æŸ¥è¯¢ <code>select id from page order by id limit 6000000, 1</code>, è¿™ä¸ªæ“ä½œï¼Œå…¶å®ä¹Ÿæ˜¯å°†åœ¨innodbä¸­çš„ä¸»é”®ç´¢å¼•ä¸­è·å–åˆ°<code>6000000+1</code>æ¡æ•°æ®ï¼Œç„¶åserverå±‚ä¼šæŠ›å¼ƒå‰6000000æ¡ï¼Œåªä¿ç•™æœ€åä¸€æ¡æ•°æ®çš„idã€‚</p><p>ä½†ä¸åŒçš„åœ°æ–¹åœ¨äºï¼Œåœ¨è¿”å›serverå±‚çš„è¿‡ç¨‹ä¸­ï¼Œåªä¼šæ‹·è´æ•°æ®è¡Œå†…çš„idè¿™ä¸€åˆ—ï¼Œè€Œä¸ä¼šæ‹·è´æ•°æ®è¡Œçš„æ‰€æœ‰åˆ—ï¼Œå½“æ•°æ®é‡è¾ƒå¤§æ—¶ï¼Œè¿™éƒ¨åˆ†çš„è€—æ—¶è¿˜æ˜¯æ¯”è¾ƒæ˜æ˜¾çš„ã€‚</p><p>åœ¨æ‹¿åˆ°äº†ä¸Šé¢çš„idä¹‹åï¼Œå‡è®¾è¿™ä¸ªidæ­£å¥½ç­‰äº6000000ï¼Œé‚£sqlå°±å˜æˆäº†è¿™æ ·</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> page  <span class="hljs-keyword">where</span> id <span class="hljs-operator">&gt;=</span>(<span class="hljs-number">6000000</span>) <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> id limit <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure><p>è¿™æ ·innodbå†èµ°ä¸€æ¬¡<strong>ä¸»é”®ç´¢å¼•</strong>ï¼Œé€šè¿‡B+æ ‘<strong>å¿«é€Ÿå®šä½</strong>åˆ°id&#x3D;6000000çš„è¡Œæ•°æ®ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯log(n)ï¼Œç„¶åå‘åå–10æ¡æ•°æ®ã€‚</p><p>è¿™æ ·æ€§èƒ½ç¡®å®æ˜¯æå‡äº†ï¼Œäº²æµ‹èƒ½å¿«ä¸€å€å·¦å³ï¼Œå±äºé‚£ç§è€—æ—¶ä»3så˜æˆ1.5sçš„æ“ä½œã€‚</p><p>å•Šè¿™Â·Â·Â·Â·Â·Â·</p><p>å±å®æœ‰äº›æ¯æ°´è½¦è–ªï¼Œæœ‰ç‚¹æ“ï¼Œå±äºæ²¡åŠæ³•ä¸­çš„åŠæ³•ã€‚</p><h4 id="åŸºäºéä¸»é”®ç´¢å¼•çš„limitæ‰§è¡Œè¿‡ç¨‹"><a href="#åŸºäºéä¸»é”®ç´¢å¼•çš„limitæ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="åŸºäºéä¸»é”®ç´¢å¼•çš„limitæ‰§è¡Œè¿‡ç¨‹"></a>åŸºäºéä¸»é”®ç´¢å¼•çš„limitæ‰§è¡Œè¿‡ç¨‹</h4><p>ä¸Šé¢æåˆ°çš„æ˜¯ä¸»é”®ç´¢å¼•çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹åŸºäºéä¸»é”®ç´¢å¼•çš„limitæ‰§è¡Œè¿‡ç¨‹ã€‚</p><p>æ¯”å¦‚ä¸‹é¢çš„sqlè¯­å¥ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> page <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> user_name limit <span class="hljs-number">0</span>, <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure><p>serverå±‚ä¼šè°ƒç”¨innodbçš„æ¥å£ï¼Œåœ¨innodbé‡Œçš„éä¸»é”®ç´¢å¼•ä¸­è·å–åˆ°ç¬¬0æ¡æ•°æ®å¯¹åº”çš„ä¸»é”®idåï¼Œ<strong>å›è¡¨</strong>åˆ°ä¸»é”®ç´¢å¼•ä¸­æ‰¾åˆ°å¯¹åº”çš„å®Œæ•´è¡Œæ•°æ®ï¼Œç„¶åè¿”å›ç»™serverå±‚ï¼Œserverå±‚å°†å…¶æ”¾åˆ°ç»“æœé›†ä¸­ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><p>è€Œå½“offset&gt;0æ—¶ï¼Œä¸”offsetçš„å€¼è¾ƒå°æ—¶ï¼Œé€»è¾‘ä¹Ÿç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äºï¼Œoffset&gt;0æ—¶ä¼šä¸¢å¼ƒå‰é¢çš„offsetæ¡æ•°æ®ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´<strong>éä¸»é”®ç´¢å¼•çš„limitè¿‡ç¨‹ï¼Œæ¯”ä¸»é”®ç´¢å¼•çš„limitè¿‡ç¨‹ï¼Œå¤šäº†ä¸ªå›è¡¨çš„æ¶ˆè€—</strong>ã€‚</p><p>ä½†å½“offsetå˜å¾—éå¸¸å¤§æ—¶ï¼Œæ¯”å¦‚600ä¸‡ï¼Œæ­¤æ—¶æ‰§è¡Œexplainã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230922231012627.png" alt="image-20230922231012627"></p><p>å¯ä»¥çœ‹åˆ°typeé‚£ä¸€æ æ˜¾ç¤ºçš„æ˜¯<strong>ALL</strong>ï¼Œä¹Ÿå°±æ˜¯<strong>å…¨è¡¨æ‰«æ</strong>ã€‚</p><p>è¿™æ˜¯å› ä¸ºserverå±‚çš„<strong>ä¼˜åŒ–å™¨</strong>ï¼Œä¼šåœ¨æ‰§è¡Œå™¨æ‰§è¡Œsqlè¯­å¥å‰ï¼Œåˆ¤æ–­ä¸‹å“ªç§æ‰§è¡Œè®¡åˆ’çš„ä»£ä»·æ›´å°ã€‚</p><p>å¾ˆæ˜æ˜¾ï¼Œä¼˜åŒ–å™¨åœ¨çœ‹åˆ°éä¸»é”®ç´¢å¼•çš„<strong>600wæ¬¡å›è¡¨</strong>ä¹‹åï¼Œæ‘‡äº†æ‘‡å¤´ï¼Œæˆ‘è¿˜ä¸å¦‚å…¨è¡¨ä¸€æ¡æ¡è®°å½•å»åˆ¤æ–­ç®—äº†ï¼Œäºæ˜¯é€‰æ‹©äº†å…¨è¡¨æ‰«æã€‚</p><p>å› æ­¤ï¼Œå½“<strong>limit offsetè¿‡å¤§æ—¶ï¼Œéä¸»é”®ç´¢å¼•æŸ¥è¯¢éå¸¸å®¹æ˜“å˜æˆå…¨è¡¨æ‰«æã€‚æ˜¯çœŸÂ·æ€§èƒ½æ€æ‰‹</strong>ã€‚</p><p>è¿™ç§æƒ…å†µä¹Ÿèƒ½é€šè¿‡ä¸€äº›æ–¹å¼å»ä¼˜åŒ–ã€‚æ¯”å¦‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> page t1, (<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> page <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> user_name limit <span class="hljs-number">6000000</span>, <span class="hljs-number">100</span>) t2  <span class="hljs-keyword">WHERE</span> t1.id <span class="hljs-operator">=</span> t2.id;<br></code></pre></td></tr></table></figure><p>é€šè¿‡<code>select id from page order by user_name limit 6000000, 100</code>ã€‚å…ˆèµ°innodbå±‚çš„user_nameéä¸»é”®ç´¢å¼•å–å‡ºidï¼Œå› ä¸ºåªæ‹¿ä¸»é”®idï¼Œä¸éœ€è¦å›è¡¨ï¼Œæ‰€ä»¥è¿™å—æ€§èƒ½ä¼šç¨å¾®å¿«ç‚¹ï¼Œåœ¨è¿”å›serverå±‚ä¹‹åï¼ŒåŒæ ·æŠ›å¼ƒå‰600wæ¡æ•°æ®ï¼Œä¿ç•™æœ€åçš„100ä¸ªidã€‚ç„¶åå†ç”¨è¿™100ä¸ªidå»è·Ÿt1è¡¨åšidåŒ¹é…ï¼Œæ­¤æ—¶èµ°çš„æ˜¯ä¸»é”®ç´¢å¼•ï¼Œå°†åŒ¹é…åˆ°çš„100æ¡è¡Œæ•°æ®è¿”å›ã€‚è¿™æ ·å°±ç»•å¼€äº†ä¹‹å‰çš„600wæ¡æ•°æ®çš„å›è¡¨ã€‚</p><p>å½“ç„¶ï¼Œè·Ÿä¸Šé¢çš„caseä¸€æ ·ï¼Œè¿˜æ˜¯æ²¡æœ‰è§£å†³è¦ç™½æ‹¿600wæ¡æ•°æ®ç„¶åæŠ›å¼ƒçš„é—®é¢˜ï¼Œè¿™ä¹Ÿæ˜¯éå¸¸æŒ«çš„ä¼˜åŒ–ã€‚</p><p>åƒè¿™ç§ï¼Œå½“offsetå˜å¾—è¶…å¤§æ—¶ï¼Œæ¯”å¦‚åˆ°äº†ç™¾ä¸‡åƒä¸‡çš„é‡çº§ï¼Œé—®é¢˜å°±çªç„¶å˜å¾—ä¸¥è‚ƒäº†ã€‚</p><p>è¿™é‡Œå°±äº§ç”Ÿäº†ä¸ªä¸“é—¨çš„æœ¯è¯­ï¼Œå«<strong>æ·±åº¦åˆ†é¡µ</strong>ã€‚</p><h3 id="æ·±åº¦åˆ†é¡µé—®é¢˜"><a href="#æ·±åº¦åˆ†é¡µé—®é¢˜" class="headerlink" title="æ·±åº¦åˆ†é¡µé—®é¢˜"></a>æ·±åº¦åˆ†é¡µé—®é¢˜</h3><p>æ·±åº¦åˆ†é¡µé—®é¢˜ï¼Œæ˜¯ä¸ªå¾ˆæ¶å¿ƒçš„é—®é¢˜ï¼Œæ¶å¿ƒå°±æ¶å¿ƒåœ¨ï¼Œè¿™ä¸ªé—®é¢˜ï¼Œå®ƒå…¶å®<strong>æ— è§£</strong>ã€‚</p><p>ä¸ç®¡ä½ æ˜¯ç”¨mysqlè¿˜æ˜¯esï¼Œä½ éƒ½åªèƒ½é€šè¿‡ä¸€äº›æ‰‹æ®µå»â€å‡ç¼“â€é—®é¢˜çš„ä¸¥é‡æ€§ã€‚</p><p>é‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°±è¯¥å›è¿‡å¤´æ¥æƒ³æƒ³ã€‚</p><p>ä¸ºä»€ä¹ˆæˆ‘ä»¬çš„ä»£ç ä¼šäº§ç”Ÿæ·±åº¦åˆ†é¡µé—®é¢˜ï¼Ÿ</p><p><strong>å®ƒèƒŒåçš„åŸå§‹éœ€æ±‚æ˜¯ä»€ä¹ˆ</strong>ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¿™ä¸ªåšä¸€äº›è§„é¿ã€‚</p><h4 id="å¦‚æœä½ æ˜¯æƒ³å–å‡ºå…¨è¡¨çš„æ•°æ®"><a href="#å¦‚æœä½ æ˜¯æƒ³å–å‡ºå…¨è¡¨çš„æ•°æ®" class="headerlink" title="å¦‚æœä½ æ˜¯æƒ³å–å‡ºå…¨è¡¨çš„æ•°æ®"></a>å¦‚æœä½ æ˜¯æƒ³å–å‡ºå…¨è¡¨çš„æ•°æ®</h4><p>æœ‰äº›éœ€æ±‚æ˜¯è¿™æ ·çš„ï¼Œæˆ‘ä»¬æœ‰ä¸€å¼ æ•°æ®åº“è¡¨ï¼Œä½†æˆ‘ä»¬å¸Œæœ›å°†è¿™ä¸ªæ•°æ®åº“è¡¨é‡Œçš„æ‰€æœ‰æ•°æ®å–å‡ºï¼Œå¼‚æ„åˆ°esï¼Œæˆ–è€…hiveé‡Œï¼Œè¿™æ—¶å€™å¦‚æœç›´æ¥æ‰§è¡Œ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> page;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªsqlä¸€æ‰§è¡Œï¼Œç‹—çœ‹äº†éƒ½æ‘‡å¤´ã€‚</p><p>å› ä¸ºæ•°æ®é‡è¾ƒå¤§ï¼Œmysqlæ ¹æœ¬æ²¡åŠæ³•ä¸€æ¬¡æ€§è·å–åˆ°å…¨éƒ¨æ•°æ®ï¼Œå¦¥å¦¥<strong>è¶…æ—¶æŠ¥é”™</strong>ã€‚</p><p>äºæ˜¯ä¸å°‘mysqlå°ç™½ä¼šé€šè¿‡<code>limit offset size</code>åˆ†é¡µçš„å½¢å¼å»åˆ†æ‰¹è·å–ï¼Œåˆšå¼€å§‹éƒ½æ˜¯å¥½çš„ï¼Œç­‰æ…¢æ…¢åœ°ï¼Œå“ªå¤©æ•°æ®è¡¨å˜å¾—å¥‡å¤§æ— æ¯”ï¼Œå°±æœ‰å¯èƒ½å‡ºç°å‰é¢æåˆ°çš„<code>æ·±åº¦åˆ†é¡µ</code>é—®é¢˜ã€‚</p><p>è¿™ç§åœºæ™¯æ˜¯æœ€å¥½è§£å†³çš„ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å°†æ‰€æœ‰çš„æ•°æ®<strong>æ ¹æ®idä¸»é”®è¿›è¡Œæ’åº</strong>ï¼Œç„¶ååˆ†æ‰¹æ¬¡å–ï¼Œå°†<strong>å½“å‰æ‰¹æ¬¡çš„æœ€å¤§idä½œä¸ºä¸‹æ¬¡ç­›é€‰çš„æ¡ä»¶</strong>è¿›è¡ŒæŸ¥è¯¢ã€‚</p><p>å¯ä»¥çœ‹ä¸‹ä¼ªä»£ç ï¼š</p><p><img src="https://image.seeyourface.cn/migrate/image-20230922231706442.png" alt="image-20230922231706442"></p><p>è¿™ä¸ªæ“ä½œï¼Œå¯ä»¥é€šè¿‡ä¸»é”®ç´¢å¼•ï¼Œæ¯æ¬¡å®šä½åˆ°idåœ¨å“ªï¼Œç„¶åå¾€åéå†100ä¸ªæ•°æ®ï¼Œè¿™æ ·ä¸ç®¡æ˜¯å¤šå°‘ä¸‡çš„æ•°æ®ï¼ŒæŸ¥è¯¢æ€§èƒ½éƒ½å¾ˆç¨³å®šã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230922231821926.png" alt="image-20230922231821926"></p><h4 id="å¦‚æœæ˜¯ç»™ç”¨æˆ·åšåˆ†é¡µå±•ç¤º"><a href="#å¦‚æœæ˜¯ç»™ç”¨æˆ·åšåˆ†é¡µå±•ç¤º" class="headerlink" title="å¦‚æœæ˜¯ç»™ç”¨æˆ·åšåˆ†é¡µå±•ç¤º"></a>å¦‚æœæ˜¯ç»™ç”¨æˆ·åšåˆ†é¡µå±•ç¤º</h4><p>å¦‚æœæ·±åº¦åˆ†é¡µèƒŒåçš„åŸå§‹éœ€æ±‚åªæ˜¯äº§å“ç»ç†å¸Œæœ›åšä¸€ä¸ªå±•ç¤ºé¡µçš„åŠŸèƒ½ï¼Œæ¯”å¦‚å•†å“å±•ç¤ºé¡µï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åº”è¯¥å¥½å¥½è·Ÿäº§å“ç»ç†battleä¸€ä¸‹äº†ã€‚</p><p>ä»€ä¹ˆæ ·çš„ç¿»é¡µï¼Œéœ€è¦ç¿»åˆ°10å¤šä¸‡ä»¥åï¼Œè¿™æ˜æ˜¾æ˜¯ä¸åˆç†çš„éœ€æ±‚ã€‚</p><p>æ˜¯ä¸æ˜¯å¯ä»¥æ”¹ä¸€ä¸‹éœ€æ±‚ï¼Œè®©å®ƒæ›´æ¥è¿‘ç”¨æˆ·çš„ä½¿ç”¨è¡Œä¸ºï¼Ÿ</p><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨è°·æ­Œæœç´¢æ—¶çœ‹åˆ°çš„ç¿»é¡µåŠŸèƒ½ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230922231926176.png" alt="image-20230922231926176"></p><p>ä¸€èˆ¬æ¥è¯´ï¼Œè°·æ­Œæœç´¢åŸºæœ¬ä¸Šéƒ½åœ¨20é¡µä»¥å†…ï¼Œä½œä¸ºä¸€ä¸ªç”¨æˆ·ï¼Œæˆ‘å°±å¾ˆå°‘ä¼šç¿»åˆ°ç¬¬10é¡µä¹‹åã€‚</p><p>å¦‚æœæˆ‘ä»¬è¦åšæœç´¢æˆ–ç­›é€‰ç±»çš„é¡µé¢çš„è¯ï¼Œå°±åˆ«ç”¨mysqläº†ï¼Œç”¨esï¼Œå¹¶ä¸”ä¹Ÿéœ€è¦æ§åˆ¶å±•ç¤ºçš„ç»“æœæ•°ï¼Œæ¯”å¦‚ä¸€ä¸‡ä»¥å†…ï¼Œè¿™æ ·ä¸è‡³äºè®©åˆ†é¡µè¿‡æ·±ã€‚</p><p>å¦‚æœå› ä¸ºå„ç§åŸå› ï¼Œå¿…é¡»ä½¿ç”¨mysqlã€‚é‚£åŒæ ·ï¼Œä¹Ÿéœ€è¦æ§åˆ¶ä¸‹è¿”å›ç»“æœæ•°é‡ï¼Œæ¯”å¦‚æ•°é‡1kä»¥å†…ã€‚</p><p>è¿™æ ·å°±èƒ½å‹‰å¼ºæ”¯æŒå„ç§ç¿»é¡µï¼Œè·³é¡µï¼ˆæ¯”å¦‚çªç„¶è·³åˆ°ç¬¬6é¡µç„¶åå†è·³åˆ°ç¬¬106é¡µï¼‰ã€‚</p><p>ä½†å¦‚æœèƒ½ä»äº§å“çš„å½¢å¼ä¸Šå°±åšæˆä¸æ”¯æŒè·³é¡µä¼šæ›´å¥½ï¼Œæ¯”å¦‚åª<strong>æ”¯æŒä¸Šä¸€é¡µæˆ–ä¸‹ä¸€é¡µ</strong>ã€‚</p><p><img src="https://image.seeyourface.cn/migrate/image-20230922232056893.png" alt="image-20230922232056893"></p><p>é€šè¿‡ä¸Šä¸‹é¡µçš„å½¢å¼æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ä¸Šé¢æåˆ°çš„<code>start_id</code>æ–¹å¼ï¼Œé‡‡ç”¨åˆ†æ‰¹è·å–ï¼Œæ¯æ‰¹æ•°æ®ä»¥<code>start_id</code>ä¸ºèµ·å§‹ä½ç½®ã€‚è¿™ä¸ªè§£æ³•æœ€å¤§çš„å¥½å¤„æ˜¯ä¸ç®¡ç¿»åˆ°å¤šå°‘é¡µï¼ŒæŸ¥è¯¢é€Ÿåº¦æ°¸è¿œç¨³å®šã€‚</p><p>å¬èµ·æ¥å¾ˆæŒ«ï¼Ÿ</p><p>æ€ä¹ˆä¼šå‘¢ï¼ŒæŠŠè¿™ä¸ªåŠŸèƒ½åŒ…è£…ä¸€ä¸‹ã€‚</p><p>å˜æˆåƒæŠ–éŸ³é‚£æ ·åªèƒ½ä¸Šåˆ’æˆ–ä¸‹åˆ’ï¼Œå®ƒæœ‰ä¸€ä¸ªä¸“ä¸šçš„åç§°å«<strong>ç€‘å¸ƒæµ</strong>ã€‚</p><p>æ˜¯ä¸æ˜¯ç¬é—´å°±é«˜å¤§ä¸Šäº†ï¼Ÿ</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li><code>limit offset, size</code> æ¯” <code>limit size</code> è¦æ…¢ï¼Œä¸”offsetçš„å€¼è¶Šå¤§ï¼Œsqlçš„æ‰§è¡Œé€Ÿåº¦è¶Šæ…¢ã€‚</li><li>å½“offsetè¿‡å¤§ï¼Œä¼šå¼•å‘<strong>æ·±åº¦åˆ†é¡µ</strong>é—®é¢˜ï¼Œç›®å‰ä¸ç®¡æ˜¯mysqlè¿˜æ˜¯eséƒ½æ²¡æœ‰å¾ˆå¥½çš„æ–¹æ³•å»è§£å†³è¿™ä¸ªé—®é¢˜ã€‚åªèƒ½é€šè¿‡é™åˆ¶æŸ¥è¯¢æ•°é‡æˆ–åˆ†æ‰¹è·å–çš„æ–¹å¼è¿›è¡Œè§„é¿ã€‚</li><li>é‡åˆ°æ·±åº¦åˆ†é¡µçš„é—®é¢˜ï¼Œå¤šæ€è€ƒå…¶åŸå§‹éœ€æ±‚ï¼Œå¤§éƒ¨åˆ†æ—¶å€™æ˜¯ä¸åº”è¯¥å‡ºç°æ·±åº¦åˆ†é¡µçš„åœºæ™¯çš„ï¼Œå¿…è¦æ—¶å¤šå»å½±å“äº§å“ç»ç†ã€‚</li><li>å¦‚æœæ•°æ®é‡å¾ˆå°‘ï¼Œæ¯”å¦‚1kçš„é‡çº§ï¼Œä¸”é•¿æœŸä¸å¤ªå¯èƒ½æœ‰å·¨å¤§çš„å¢é•¿ï¼Œè¿˜æ˜¯ç”¨<strong>limit offset, size</strong> çš„æ–¹æ¡ˆå§ï¼Œæ•´æŒºå¥½ï¼Œèƒ½ç”¨å°±è¡Œã€‚</li></ul><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="https://mp.weixin.qq.com/s/i6FL1iRECiWZ1CCf_juxQQ">https://mp.weixin.qq.com/s/i6FL1iRECiWZ1CCf_juxQQ</a><a href="#fnref:1" rev="footnote" class="footnote-backref"> â†©</a></span></span></li></ol></div></section>]]></content>
    
    
    <categories>
      
      <category>æ•°æ®åº“</category>
      
      <category>MySQL</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ•°æ®åº“</tag>
      
      <tag>MySQL</tag>
      
      <tag>æŸ¥è¯¢ä¼˜åŒ–</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
